name: Final Netlify build manual deploy comment

on:
  issue_comment:
    types: [created]
  # This is the new trigger that allows testing from a PR branch
  pull_request:
    types: [opened, synchronize]

jobs:
  deploy-preview:
    # This 'if' now runs for the 'netlify build' comment OR any 'pull_request' event
    if: |
      (github.event.comment.body == 'netlify build' && github.event.issue.pull_request)
      || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      # We use `jq` to parse the GH API response
      - name: Setup jq
        uses: dcarbone/install-jq-action@v2

      # This step only runs if the trigger was a comment, to do the fork and perm checks.
      - name: Check Permissions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERM_CHECK_TOKEN: ${{ secrets.DOCS_ENG_TEAM_MEMBERSHIP_CHECKER }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.PERM_CHECK_TOKEN }}
          script: |
            // 1. Check for forks
            const pr_url = "${{ github.event.issue.pull_request.url }}";
            const pr_response = await github.request(`GET ${pr_url}`);
            const is_fork = pr_response.data.head.repo.fork;

            if (is_fork) {
              core.setFailed("üõë Halting: This workflow only runs for branches in the main repository, not for forks.");
              return;
            }
            console.log("‚úÖ PR is not from a fork.");

            // 2. Check for member permission
            const commenter = context.payload.comment.user.login;
            const org = context.repo.owner;
            const team_slugs = ['doc', 'DOCS-ENG']; // <-- add your team slugs here
            
            console.log(`Checking permissions for ${commenter} in ${org}...`);

            async function isMemberOfAnyTeam() {
              for (const team_slug of team_slugs) {
                try {
                  const response = await github.rest.teams.getMembershipForUserInOrg({
                    org,
                    team_slug,
                    username: commenter,
                  });
                  if (response.data.state === 'active') {
                    console.log(`‚úÖ ${commenter} is an active member of the ${team_slug} team.`);
                    return true;
                  }
                } catch (error) {
                  if (error.status !== 404) {
                    console.log(`Error checking team_slug ${team_slug}: ${error.message}`);
                    core.setFailed(`Could not verify team membership for ${team_slug}: ${error.message}`);
                    return false;
                  }
                  console.log(`${commenter} is not a member of ${team_slug} (404)`);
                }
              }
              return false;
            }

            const isMember = await isMemberOfAnyTeam();
            if (!isMember) {
              core.setFailed(`${commenter} is not a member of any required team (${team_slugs.join(', ')})`);
            } else {
              console.log(`‚úÖ ${commenter} is authorized to trigger builds`);
            }
      
      # This step REPLACES the old build hook 'curl' command.
      # It uses the Netlify API to trigger a build and get the build/deploy IDs.
      - name: Trigger Netlify Build
        id: trigger_build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} # <-- MUST ADD THIS SECRET
        run: |
          # 1. Get PR info
          gh_api_url=$(echo ${{ github.event.issue.pull_request.url }} | sed 's/https:\/\/api.github.com\///')
          gh_api_response=$(gh api $gh_api_url)
          branch_name=$(echo $gh_api_response | jq -r .head.ref)
          sha=$(echo $gh_api_response | jq -r .head.sha)
          pr_number=$(echo $gh_api_response | jq -r .number)

          echo "Triggering build for branch $branch_name (SHA: $sha)..."

          # 2. Create the JSON payload for the Netlify API
          json_payload=$(jq -n \
            --arg branch "$branch_name" \
            --arg sha "$sha" \
            --arg title "Manual deploy preview for PR #$pr_number - $sha" \
            '{ "branch": $branch, "sha": $sha, "deploy_context": "branch-deploy", "clear_cache": false, "title": $title }')

          # 3. Call the Netlify API to trigger the build
          response=$(curl -s -X POST "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/builds" \
            -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$json_payload")

          # 4. Parse the response to get the IDs
          build_id=$(echo $response | jq -r .build_id)
          deploy_id=$(echo $response | jq -r .deploy_id)

          if [ -z "$build_id" ] || [ "$build_id" == "null" ]; then
            echo "::error::Failed to trigger Netlify build. Response:"
            echo $response
            exit 1
          fi

          echo "‚úÖ Build triggered!"
          echo "Build ID: $build_id"
          echo "Deploy ID: $deploy_id"

          # 5. Pass outputs to other steps
          echo "build_id=$build_id" >> $GITHUB_OUTPUT
          echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

      # This step gets the branch name for the final URL
      - name: Sanitize branch name for Netlify URL
        id: sanitize_branch
        run: |
          SANITIZED_BRANCH_NAME=$(echo "${{ steps.trigger_build.outputs.branch_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr 'A-Z' 'a-z')
          echo "name=$SANITIZED_BRANCH_NAME" >> $GITHUB_OUTPUT

      # This step posts the INITIAL "pending" comment with a link to the Netlify log
      - name: Post "Pending" Comment
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ### <span aria-hidden="true">‚è≥</span> Netlify Preview Build Triggered
            
            Building preview for PR #${{ steps.trigger_build.outputs.pr_number }}.
            This comment will auto-update when the build is complete (usually 15-20 minutes).

            **You can follow the live build log on Netlify:**
            **[https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys/${{ steps.trigger_build.outputs.deploy_id }}](https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys/${{ steps.trigger_build.outputs.deploy_id }})**
          comment_tag: manual-build-comment
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # This NEW step polls the Netlify API for the build status
      - name: Poll Netlify Build Status
        id: poll_build
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          build_id="${{ steps.trigger_build.outputs.build_id }}"
          timeout=2700 # 45 minutes (2700s)
          interval=30  # Poll every 30 seconds
          elapsed=0
          
          echo "Polling build status for Build ID: $build_id..."

          while [ $elapsed -lt $timeout ]; do
            response=$(curl -s "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/builds/$build_id" -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN")
            state=$(echo $response | jq -r .state)
            deploy_id=$(echo $response | jq -r .deploy_id) # Get the latest deploy_id, just in case

            echo "Current build state: $state (Elapsed: $elapsed s)"

            if [ "$state" == "done" ]; then
              echo "‚úÖ Build succeeded!"
              echo "build_state=done" >> $GITHUB_OUTPUT
              echo "final_deploy_id=$deploy_id" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$state" == "error" ] || [ "$state" == "cancelled" ]; then
              echo "::error::Build failed with state: $state"
              echo "build_state=$state" >> $GITHUB_OUTPUT
              echo "final_deploy_id=$deploy_id" >> $GITHUB_OUTPUT
              exit 0 # Exit successfully so the *next* step can post the failure comment
            fi

            sleep $interval
            elapsed=$((elapsed + interval))
          done

          echo "::error::Build timed out after 45 minutes."
          echo "build_state=timeout" >> $GITHUB_OUTPUT
          echo "final_deploy_id=${{ steps.trigger_build.outputs.deploy_id }}" >> $GITHUB_OUTPUT # Use original deploy_id
          exit 0 # Exit successfully so the next step can post the timeout failure

      # This final step UPDATES the "pending" comment with the result
      - name: Update PR comment with Build Status
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: manual-build-comment
          github_token: ${{ secrets.GITHUB_TOKEN }}
          message: |
            ${{ steps.poll_build.outputs.build_state == 'done' && format('### <span aria-hidden="true">‚úÖ</span> Build Succeeded: Preview Ready!

            Your deploy preview for PR #{0} is ready:
            **Preview URL: [https://{1}--docs-website-netlify.netlify.app](https://{1}--docs-website-netlify.netlify.app)**

            > You can view the final deploy log on Netlify [here](https://app.netlify.com/sites/{2}/deploys/{3}).', steps.trigger_build.outputs.pr_number, steps.sanitize_branch.outputs.name, secrets.NETLIFY_SITE_ID, steps.poll_build.outputs.final_deploy_id) || '' }}

            ${{ steps.poll_build.outputs.build_state != 'done' && format('### :rotating_light: **BUILD FAILED** :rotating_light:

            :stop_sign: **DO NOT MERGE THIS PULL REQUEST.** :stop_sign:

            The Netlify preview build failed for PR #{0} with state: `{1}`. Merging this **will** break the `develop` branch.

            **Action Required:**
            1.  **[Click here to view the full Netlify build log]({2}/sites/{3}/deploys/{4})**
            2.  Review the errors, push a fix to this PR.
            3.  Comment `netlify build` again to trigger a new build.
            
            > GitHub Action log for this job: [{5}/actions/runs/{6}](https://{5}/actions/runs/{6})', steps.trigger_build.outputs.pr_number, steps.poll_build.outputs.build_state, 'https://app.netlify.com', secrets.NETLIFY_SITE_ID, steps.poll_build.outputs.final_deploy_id, github.repository, github.run_id) || '' }}

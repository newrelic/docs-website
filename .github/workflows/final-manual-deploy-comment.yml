name: Final Netlify build manual deploy comment

on:
  issue_comment:
    types: [created]
  # This is the new trigger that allows testing from a PR branch
  pull_request:
    types: [opened, synchronize]

jobs:
  deploy-preview:
    # This 'if' now runs for the 'netlify build' comment OR any 'pull_request' event
    if: |
      (github.event.comment.body == 'netlify build' && github.event.issue.pull_request)
      || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”’ Verify Repository Source
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Checking if PR is from a forked repository..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          PR_URL="${{ github.event.issue.pull_request.url }}"
          IS_FORK=$(gh api "$PR_URL" --jq '.head.repo.fork')

          if [[ "$IS_FORK" == "true" ]]; then
            echo ""
            echo "ğŸ›‘ HALTING WORKFLOW"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "This workflow only runs for branches in the main repository."
            echo "Forks are not supported for security reasons."
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          else
            echo ""
            echo "âœ… Repository source verified"
            echo "ğŸ“ Source: Main repository (not a fork)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi

      - name: ğŸ” Validate Team Membership
        # Only run this check for issue_comment events (manual triggers)
        # For pull_request events, the PR author is implicitly authorized

        # ##########################################################################################
        # REMOVE THIS CONDITION AFTER TESTING THIS WORKFLOW, THIS SHOULD NOT MAKE IT TO THE MERGE
        # ##########################################################################################
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.DOCS_ENG_TEAM_MEMBERSHIP_CHECKER }}
        id: check_permission
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DOCS_ENG_TEAM_MEMBERSHIP_CHECKER }}
          script: |
            const commenter = context.payload.comment.user.login;
            const org = context.repo.owner;
            const team_slugs = ['doc', 'DOCS-ENG']; // <-- add your team slugs here

            console.log(`ğŸ” Checking permissions...`);
            console.log(`ğŸ“‹ Organization: ${org}`);
            console.log(`ğŸ‘¤ Commenter: ${commenter}`);

            try {
              const user = await github.rest.users.getAuthenticated();
              console.log('ğŸ”‘ Authenticated as:', user.data.login);
              
              const scopes = await github.request('GET /user');
              console.log('ğŸ« Token scopes:', scopes.headers['x-oauth-scopes']);
            } catch (error) {
              console.log('âŒ Auth check failed:', error.message);
            }

            // List all teams where the commenter is a member
            async function listUserTeams() {
              try {
                const teams = await github.paginate(github.rest.teams.listForAuthenticatedUser, {});
                const userTeams = teams.filter(team => team.organization.login.toLowerCase() === org.toLowerCase());
                if (userTeams.length === 0) {
                  console.log(`âš ï¸  ${commenter} is not a member of any team in org ${org}.`);
                } else {
                  console.log(`ğŸ‘¥ ${commenter} is a member of the following teams in ${org}:`);
                  userTeams.forEach(team => {
                    console.log(`   âœ“ ${team.slug} (${team.name})`);
                  });
                }
              } catch (err) {
                console.log(`âŒ Could not list teams for user ${commenter}: ${err.message}`);
              }
            }

            await listUserTeams();

            async function isMemberOfAnyTeam() {
              for (const team_slug of team_slugs) {
                console.log(`ğŸ” Checking team_slug: ${team_slug}`);
                try {
                  const response = await github.rest.teams.getMembershipForUserInOrg({
                    org,
                    team_slug,
                    username: commenter,
                  });
                  console.log(`ğŸ“Š API response for team_slug ${team_slug}:`, JSON.stringify(response.data, null, 2));
                  if (response.data.state === 'active') {
                    console.log(`âœ… ${commenter} is an active member of the ${team_slug} team.`);
                    return true;
                  }
                } catch (error) {
                  console.log(`âš ï¸  Error object for team_slug ${team_slug}:`, JSON.stringify(error, Object.getOwnPropertyNames(error)));
                  if (error.status !== 404) {
                    console.log(`âŒ Error checking team_slug ${team_slug}: ${error.message}`);
                    core.setFailed(`Could not verify team membership for ${team_slug}: ${error.message}`);
                    return false;
                  }
                  // If 404, user is not in this team, continue to next
                  console.log(`â„¹ï¸  ${commenter} is not a member of ${team_slug} (404)`);
                }
              }
              return false;
            }

            // Properly await the async function
            const isMember = await isMemberOfAnyTeam();
            if (!isMember) {
              core.setFailed(`âŒ ${commenter} is not a member of any required team (${team_slugs.join(', ')})`);
            } else {
              console.log(`âœ… ${commenter} is authorized to trigger builds`);
            }
        
      - name: ğŸ› ï¸  Initialize Dependencies
        uses: dcarbone/install-jq-action@v2

      - name: ğŸŒ Trigger Netlify Deployment
        id: netlify_build
        env: 
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ NETLIFY DEPLOYMENT TRIGGER"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          gh_api_url=$(echo ${{ github.event.issue.pull_request.url || github.event.pull_request.url }} | sed 's/https:\/\/api.github.com//')
          gh_api_response=$(gh api $gh_api_url)
          branch_name=$(echo $gh_api_response | jq -r .head.ref)
          sha=$(echo $gh_api_response | jq -r .head.sha)
          pr_number=$(echo $gh_api_response | jq -r .number)

          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "sha=$sha" >> $GITHUB_OUTPUT
          
          TRIGGER_TIME=$(date -u +%s)
          echo "trigger_time=$TRIGGER_TIME" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“‹ Deployment Details:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  ğŸ”– Branch:    $branch_name"
          echo "  ğŸ”¢ PR #:      $pr_number"
          echo "  ğŸ“ Commit:    $sha"
          echo "  ğŸ• Time (IST): $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:%M:%S')"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          echo ""
          echo "ğŸš€ Sending build request to Netlify..."
          curl -X POST \
          "https://api.netlify.com/build_hooks/${{ secrets.NETLIFY_BUILD_HOOK_ID }}?trigger_branch=$branch_name"'&trigger_title=Manual+deploy+preview+for+PR+%23'"$pr_number"'+-+'"$sha"
          
          echo ""
          echo "âœ… Build hook triggered successfully"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Sanitize branch name for Netlify URL
        id: sanitize_branch
        run: |
          # Replace all non-alphanumeric characters with '-' and convert to lowercase
          SANITIZED_BRANCH_NAME=$(echo "${{ steps.netlify_build.outputs.branch_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr 'A-Z' 'a-z')
          echo "name=$SANITIZED_BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ“ Create PR Status Comment
        id: initial_comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ Creating initial PR comment...');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.netlify_build.outputs.pr_number }},
              body: `### ğŸš€ Netlify Preview Building!

            Build triggered for PR #${{ steps.netlify_build.outputs.pr_number }} (commit: \`${{ steps.netlify_build.outputs.sha }}\`)
            
            â³ Monitoring deployment status... This usually takes 10-20 minutes.`
            });
            
            console.log('âœ… Comment created successfully');
            console.log('ğŸ†” Comment ID:', comment.id);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            core.setOutput('comment_id', comment.id);

      - name: ğŸ” Locate Netlify Deployment
        id: poll_netlify
        env:
          NETLIFY_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.netlify_build.outputs.branch_name }}"
          TRIGGER_TIME="${{ steps.netlify_build.outputs.trigger_time }}"
          SHA="${{ steps.netlify_build.outputs.sha }}"
          PR_NUMBER="${{ steps.netlify_build.outputs.pr_number }}"
          DEPLOY_ID=""
          DEPLOY_FOUND_VIA=""
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DEPLOYMENT DISCOVERY PROCESS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Search Parameters:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  ğŸ”– Branch:       $BRANCH_NAME"
          echo "  ğŸ“ Commit SHA:   $SHA"
          echo "  ğŸ• Trigger (UTC): $(date -u -d @$TRIGGER_TIME '+%Y-%m-%d %H:%M:%S')"
          echo "  ğŸ• Trigger (IST): $(TZ=Asia/Kolkata date -d @$TRIGGER_TIME '+%Y-%m-%d %H:%M:%S')"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "â³ Waiting 30 seconds for Netlify to register the deployment..."
          sleep 30
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         SEARCHING FOR DEPLOYMENT (COMMIT-BASED)                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          for i in {1..10}; do
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ğŸ”„ Attempt $i/10"
            echo "â”‚ ğŸ• Time: $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:%M:%S IST')"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            
            DEPLOYS=$(curl -s -H "Authorization: Bearer $NETLIFY_TOKEN" \
              "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/deploys")
            
            DEPLOY=$(echo "$DEPLOYS" | jq -r --arg branch "$BRANCH_NAME" --arg sha "$SHA" \
              '[.[] | select(.branch == $branch and (.commit_ref == $sha or .head == $sha))] | 
               sort_by(.created_at) | reverse | .[0]')
            
            if [ "$DEPLOY" != "null" ] && [ -n "$DEPLOY" ]; then
              DEPLOY_ID=$(echo "$DEPLOY" | jq -r '.id')
              CREATED_AT=$(echo "$DEPLOY" | jq -r '.created_at')
              CREATED_TIMESTAMP=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "$CREATED_AT" +%s 2>/dev/null || echo "$TRIGGER_TIME")
              
              BUILD_URL="https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys/$DEPLOY_ID"
              
              TIME_DIFF=$((CREATED_TIMESTAMP - TRIGGER_TIME))
              
              if [ $TIME_DIFF -ge -5 ]; then
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                  âœ… DEPLOYMENT FOUND!                          â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ğŸ“¦ Deployment Information:"
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                echo "  ğŸ†” Deploy ID:     $DEPLOY_ID"
                echo "  ğŸ”— Build URL:     $BUILD_URL"
                echo "  ğŸ“… Created (UTC):  $CREATED_AT"
                echo "  ğŸ“… Created (IST):  $(TZ=Asia/Kolkata date -d @$CREATED_TIMESTAMP '+%Y-%m-%d %H:%M:%S')"
                echo "  âœ… Method:         Commit-based validation"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                DEPLOY_FOUND_VIA="commit"
                
                echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
                echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
                echo "deploy_found_via=$DEPLOY_FOUND_VIA" >> $GITHUB_OUTPUT
                echo "created_at_ist=$(TZ=Asia/Kolkata date -d @$CREATED_TIMESTAMP '+%Y-%m-%d %H:%M:%S IST')" >> $GITHUB_OUTPUT
                break
              else
                echo "  âš ï¸  Found deployment but it's too old (${TIME_DIFF}s offset)"
              fi
            fi
            
            if [ $i -lt 10 ]; then
              echo "  â³ Not found yet, waiting 15 seconds..."
              sleep 15
            fi
          done
          
          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘          FALLBACK: SEARCHING BY BRANCH NAME                    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            DEPLOY=$(echo "$DEPLOYS" | jq -r --arg branch "$BRANCH_NAME" \
              '[.[] | select(.branch == $branch)] | sort_by(.created_at) | reverse | .[0]')
            
            if [ "$DEPLOY" != "null" ] && [ -n "$DEPLOY" ]; then
              DEPLOY_ID=$(echo "$DEPLOY" | jq -r '.id')
              CREATED_AT=$(echo "$DEPLOY" | jq -r '.created_at')
              CREATED_TIMESTAMP=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "$CREATED_AT" +%s 2>/dev/null || echo "$TRIGGER_TIME")
              BUILD_URL="https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys/$DEPLOY_ID"
              
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘            âœ… DEPLOYMENT FOUND (BRANCH-BASED)                  â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "ğŸ“¦ Deployment Information:"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "  ğŸ†” Deploy ID:     $DEPLOY_ID"
              echo "  ğŸ”— Build URL:     $BUILD_URL"
              echo "  ğŸ“… Created (UTC):  $CREATED_AT"
              echo "  ğŸ“… Created (IST):  $(TZ=Asia/Kolkata date -d @$CREATED_TIMESTAMP '+%Y-%m-%d %H:%M:%S')"
              echo "  âš ï¸  Method:         Branch-based validation (fallback)"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              DEPLOY_FOUND_VIA="branch"
              
              echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
              echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
              echo "deploy_found_via=$DEPLOY_FOUND_VIA" >> $GITHUB_OUTPUT
              echo "created_at_ist=$(TZ=Asia/Kolkata date -d @$CREATED_TIMESTAMP '+%Y-%m-%d %H:%M:%S IST')" >> $GITHUB_OUTPUT
            else
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘                  âŒ DEPLOYMENT NOT FOUND                       â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "No deployment could be located using either method."
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 1
            fi
          fi

      - name: ğŸ“ Update PR Comment (Deployment Found)
        if: steps.poll_netlify.outputs.deploy_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ Updating PR comment with deployment details...');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const deployFoundVia = '${{ steps.poll_netlify.outputs.deploy_found_via }}';
            const sha = '${{ steps.netlify_build.outputs.sha }}';
            const branchName = '${{ steps.netlify_build.outputs.branch_name }}';
            
            let detailLine = '';
            if (deployFoundVia === 'commit') {
              detailLine = `- **Commit SHA:** \`${sha}\``;
            } else {
              detailLine = `- **Branch Name:** \`${branchName}\``;
            }
            
            const commentBody = `### ğŸš€ Netlify Deployment In Progress

            The deployment was found via **${deployFoundVia}-based validation**.

            ${detailLine}
            - **Netlify Build URL:** [View Deployment](${{ steps.poll_netlify.outputs.build_url }})
            - **Deployment Created At (IST):** ${{ steps.poll_netlify.outputs.created_at_ist }}

            â³ Build is currently in progress. Monitoring status...`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.initial_comment.outputs.comment_id }},
              body: commentBody
            });
            
            console.log('âœ… PR comment updated successfully');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      - name: ğŸ“Š Monitor Deployment Status
        id: check_status
        env:
          NETLIFY_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          DEPLOY_ID="${{ steps.poll_netlify.outputs.deploy_id }}"
          BRANCH_NAME="${{ steps.netlify_build.outputs.branch_name }}"
          SHA="${{ steps.netlify_build.outputs.sha }}"
          PR_NUMBER="${{ steps.netlify_build.outputs.pr_number }}"
          MAX_WAIT_TIME=1800
          POLL_INTERVAL=90
          ELAPSED_TIME=0
          USE_FALLBACK=false
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š DEPLOYMENT STATUS MONITORING"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Monitoring Configuration:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  ğŸ†” Deploy ID:      $DEPLOY_ID"
          echo "  ğŸ”– Branch:         $BRANCH_NAME"
          echo "  â±ï¸  Max Wait Time:  30 minutes"
          echo "  ğŸ”„ Poll Interval:  90 seconds"
          echo "  ğŸ• Started (IST):  $(TZ=Asia/Kolkata date -d @${{ steps.netlify_build.outputs.trigger_time }} '+%Y-%m-%d %H:%M:%S')"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo ""
            echo "âš ï¸  WARNING: No Deploy ID found. Using branch-based fallback."
            USE_FALLBACK=true
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘               POLLING DEPLOYMENT STATUS                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          while [ $ELAPSED_TIME -lt $MAX_WAIT_TIME ]; do
            MINUTES_ELAPSED=$(awk "BEGIN {printf \"%.1f\", $ELAPSED_TIME/60}")
            
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ğŸ”„ Status Check"
            echo "â”‚ â±ï¸  Elapsed: ${MINUTES_ELAPSED}/30.0 minutes"
            echo "â”‚ ğŸ• Time (IST): $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:%M:%S')"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            
            if [ "$USE_FALLBACK" = "true" ]; then
              DEPLOYS=$(curl -s -H "Authorization: Bearer $NETLIFY_TOKEN" \
                "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/deploys")
              
              DEPLOY=$(echo "$DEPLOYS" | jq -r --arg branch "$BRANCH_NAME" \
                '[.[] | select(.branch == $branch)] | sort_by(.created_at) | reverse | .[0]')
            else
              DEPLOY=$(curl -s -H "Authorization: Bearer $NETLIFY_TOKEN" \
                "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/deploys/$DEPLOY_ID")
            fi
            
            if [ "$DEPLOY" != "null" ] && [ -n "$DEPLOY" ]; then
              STATE=$(echo "$DEPLOY" | jq -r '.state')
              CURRENT_DEPLOY_ID=$(echo "$DEPLOY" | jq -r '.id')
              DEPLOY_URL=$(echo "$DEPLOY" | jq -r '.deploy_ssl_url // .ssl_url // .url')
              ERROR_MESSAGE=$(echo "$DEPLOY" | jq -r '.error_message // ""')
              
              BUILD_URL="https://app.netlify.com/sites/$NETLIFY_SITE_ID/deploys/$DEPLOY_ID"
              
              if [ "$USE_FALLBACK" = "true" ] && [ -z "$DEPLOY_ID" ]; then
                DEPLOY_ID=$CURRENT_DEPLOY_ID
                echo "  ğŸ†” Deployment ID: $DEPLOY_ID"
              fi
              
              echo "  ğŸ“Š Current State: $STATE"
              
              if [ "$STATE" = "ready" ]; then
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘              âœ… DEPLOYMENT SUCCESSFUL!                         â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ğŸ‰ Deployment Details:"
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                echo "  ğŸŒ Preview URL:  $DEPLOY_URL"
                echo "  ğŸ”— Build URL:    $BUILD_URL"
                echo "  ğŸ†” Deploy ID:    $DEPLOY_ID"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                
                echo "status=success" >> $GITHUB_OUTPUT
                echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
                echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$STATE" = "error" ]; then
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘                âŒ DEPLOYMENT FAILED                            â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ğŸ’¥ Error Details:"
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                echo "  ğŸ”— Build URL:  $BUILD_URL"
                echo "  ğŸ†” Deploy ID:  $DEPLOY_ID"
                echo "  ğŸ“ Error:      $ERROR_MESSAGE"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                
                echo "status=failure" >> $GITHUB_OUTPUT
                echo "error_message=$ERROR_MESSAGE" >> $GITHUB_OUTPUT
                echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$STATE" = "building" ] || [ "$STATE" = "enqueued" ] || [ "$STATE" = "processing" ]; then
                echo "  â³ Status: In Progress ($STATE)"
                echo "  ğŸ”— Build: $BUILD_URL"
              else
                echo "  âš ï¸  Status: Unknown ($STATE)"
              fi
            else
              echo "  â“ No data returned from Netlify API"
            fi
            
            sleep $POLL_INTERVAL
            ELAPSED_TIME=$((ELAPSED_TIME + POLL_INTERVAL))
          done
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                  â±ï¸  TIMEOUT REACHED                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  The deployment is taking longer than 30 minutes."
          echo "Please check the Netlify dashboard for status updates."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "status=timeout" >> $GITHUB_OUTPUT
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT

      - name: âœ… Update PR Comment (Success)
        if: steps.check_status.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âœ… Updating PR comment with success status...');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const commentBody = `### âœ… Netlify Preview Deploy Successful!

            Your preview deployment has completed successfully and is now live!

            ğŸŒ **Preview URL:** [${{ steps.check_status.outputs.deploy_url }}](${{ steps.check_status.outputs.deploy_url }})
            ğŸ”— **Netlify Deployment:** [View Deployment](https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys/${{ steps.check_status.outputs.deploy_id }})
            ğŸ”— **GitHub Actions Job:** [View Job](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            The preview is ready for review. Please test your changes thoroughly before merging.`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.initial_comment.outputs.comment_id }},
              body: commentBody
            });
            
            console.log('âœ… Success comment posted');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      - name: âŒ Update PR Comment (Failure)
        if: steps.check_status.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âŒ Updating PR comment with failure status...');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const commentBody = `# ğŸš¨ â›” NETLIFY DEPLOYMENT FAILED â›” ğŸš¨
            
            ## âŒ **DO NOT MERGE THIS PR** âŒ
            
            The Netlify preview deployment has **FAILED**. This PR contains changes that break the build process.
            
            ### ğŸ”´ Critical Issue Details:
            
            - **Status:** Build Failed
            - **Deploy ID:** \`${{ steps.check_status.outputs.deploy_id }}\`
            - **Error Message:** 
            \`\`\`
            ${{ steps.check_status.outputs.error_message }}
            \`\`\`
            
            ğŸ”— **Netlify Deployment:** [View Deployment](https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys/${{ steps.check_status.outputs.deploy_id }})
            ğŸ”— **GitHub Actions Job:** [View Job](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### ğŸ› ï¸ Required Actions:
            
            1. **Review the error message above carefully**
            2. **Fix the build issues in your branch**
            3. **Test locally before pushing changes**
            4. **Trigger a new build with \`netlify build\` comment once fixed**
            
            ### âš ï¸ WARNING TO MAINTAINERS:
            
            **This PR has a failing build and should NOT be merged until:**
            - âœ… All build errors are resolved
            - âœ… A successful deployment preview is confirmed
            - âœ… The preview site has been manually tested
            
            ---
            
            **ğŸ”´ MERGING THIS PR IN ITS CURRENT STATE WILL BREAK PRODUCTION ğŸ”´**`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.initial_comment.outputs.comment_id }},
              body: commentBody
            });
            
            console.log('âŒ Failure comment posted');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      - name: â±ï¸  Update PR Comment (Timeout)
        if: steps.check_status.outputs.status == 'timeout'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('â±ï¸  Updating PR comment with timeout status...');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            const commentBody = `### â±ï¸ Netlify Deployment Status: Timeout
            
            âš ï¸ The deployment is taking longer than expected (>30 minutes).
            
            **Possible reasons:**
            - The build is still in progress
            - Netlify is experiencing delays
            - The build queue is backed up
            
            ğŸ”— **Netlify Deployment:** [View Deployment](https://app.netlify.com/sites/${{ secrets.NETLIFY_SITE_ID }}/deploys/${{ steps.check_status.outputs.deploy_id }})
            ğŸ”— **GitHub Actions Job:** [View Job](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Next steps:**
            1. Check the [Netlify dashboard](https://app.netlify.com) manually for deployment status
            2. Look for branch: ${{ steps.netlify_build.outputs.branch_name }}
            3. If the build is still running, please wait for it to complete
            4. If needed, you can re-trigger with another \`netlify build\` comment
            
            **Expected preview URL (once ready):**
            https://${{ steps.sanitize_branch.outputs.name }}--docs-website-netlify.netlify.app`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.initial_comment.outputs.comment_id }},
              body: commentBody
            });
            
            console.log('â±ï¸  Timeout comment posted');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      - name: Fail workflow on deployment failure
        if: steps.check_status.outputs.status == 'failure'
        run: |
          echo "::error::Netlify deployment failed. This PR should not be merged."
          exit 1
name: Manual Netlify Deploy Preview

on:
  issue_comment:
    types: [created]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, 'netlify build')
    steps:
      - name: Check for member permission
        id: check_permission
        uses: actions/github-script@v6
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const org = context.repo.owner;
            const team_slug = 'DOCS-ENG'; // ** CHANGE THIS TO YOUR TEAM'S SLUG **
            try {
              const { data: teams } = await github.rest.teams.listForAuthenticatedUser({
                org: org,
              });
              const isMember = teams.some(team => team.slug === team_slug);
              if (!isMember) {
                core.setFailed('User is not a member of the required team.');
                return;
              }
              const { data: userTeams } = await github.rest.teams.listMembersInOrg({
                org,
                team_slug,
              });
              const isTeamMember = userTeams.some(member => member.login === commenter);
              if (!isTeamMember) {
                 core.setFailed('User is not a member of the required team.');
              }
            } catch (error) {
              core.setFailed(`Could not verify team membership: ${error.message}`);
            }
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Netlify Deploy
        if: steps.check_permission.outcome == 'success'
        run: |
          curl -X POST -d '{}' "${{ secrets.NEW_NETLIFY_BUILD_HOOK }}"?trigger_branch=${{ github.event.issue.pull_request.head.ref }}&trigger_title=Deploy+preview+for+PR+%23${{ github.event.issue.number }}+by+${{ github.actor }}
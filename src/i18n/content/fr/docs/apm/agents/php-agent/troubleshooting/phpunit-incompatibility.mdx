---
title: PHPUnit manque de mémoire
type: troubleshooting
tags:
  - Agents
  - PHP agent
  - Troubleshooting
metaDescription: Troubleshooting PHPUnit out-of-memory errors
freshnessValidatedDate: never
translationType: machine
---

## Problème

Lorsque vous utilisez [PHPUnit](https://phpunit.de/) version 11 ou plus récente pour gérer et exécuter vos tests unitaires, et que l&apos;agent New Relic PHP est installé et activé, l&apos;exécution du script `phpunit` (l&apos;exécuteur de tests en ligne de commande PHPUnit) entraînera la consommation de toute la mémoire système disponible avant même l&apos;exécution effective des tests.

## Solution

Pour éviter les erreurs de mémoire insuffisante, vous devez <DNT>**explicitly disable**</DNT> l&apos;agent en définissant `newrelic.enabled` sur `false`. Vous pouvez le désactiver tout en utilisant `phpunit` comme ceci :

```bash
php -d newrelic.enabled=false vendor/bin/phpunit tests/
```

Par exemple, pour exécuter un fichier de test spécifique :

```bash
php -d newrelic.enabled=false vendor/bin/phpunit tests/Unit/ExampleTest.php
```

<Callout variant="important">
  Cette solution de contournement désactive toute l&apos;instrumentation New Relic pendant l&apos;exécution des tests unitaires, ce qui signifie qu&apos;aucune donnée APM ne sera collectée pendant l&apos;exécution des tests.
</Callout>

Vous pouvez également désactiver l&apos;agent dans votre fichier de configuration `php.ini` si vous avez besoin de ce paramètre de manière permanente pour votre environnement de développement :

```ini
newrelic.enabled = false
```

## Cause

La raison de cette incompatibilité est un nouveau code ajouté dans PHPUnit 11.x : [Réappliquer « Vérifier et restaurer les gestionnaires globaux d’erreurs/exceptions » · sebastianbergmann/phpunit@0214cf8](https://github.com/sebastianbergmann/phpunit/commit/0214cf81d8b12a1191932e6096d22c8496943911). Ce nouveau code récupère la liste des gestionnaires d&apos;exceptions actifs à l&apos;aide d&apos;une méthode qui nécessite de retirer chaque gestionnaire d&apos;exceptions de la stack des gestionnaires d&apos;exceptions. Cependant, l&apos;agent PHP de New Relic installe par défaut son propre gestionnaire d&apos;exceptions et empêche sa suppression de la stack de gestionnaires d&apos;exceptions. L&apos;agent détecte la suppression de son gestionnaire d&apos;exceptions et le réenregistre immédiatement. Cela provoque une boucle infinie dans le script `phpunit` : PHPUnit ne peut jamais terminer de retirer les gestionnaires de la stack car l&apos;agent PHP New Relic réenregistre continuellement son gestionnaire !
---
title: Monitorer NGINX auto-hébergé avec OpenTelemetry
metaDescription: 'Complete step-by-step guide to configure NGINX monitoring with OpenTelemetry. Includes prerequisites, configuration, environment setup, and troubleshooting.'
freshnessValidatedDate: never
translationType: machine
---

Ce guide fournit des instructions complètes pour la configuration du monitoring de NGINX auto-hébergé avec OpenTelemetry. Suivez ces étapes pour configurer votre serveur NGINX, le collecteur OpenTelemetry et l&apos;intégration New Relic.

{/* &lt;Callout variant=&quot;important&quot;&gt; \*\*Avant de commencer\*\*: Consultez la \[vue d&apos;ensemble de NGINX OpenTelemetry]\(/docs/opentelemetry/nginx/nginx-otel-overview/) pour comprendre ce que vous allez monitorer et les avantages de cette intégration. \*\*Autres options de monitoring NGINX :\*\* - Pour monitorer \*\*NGINX Plus\*\*, consultez \[Monitorer NGINX Plus avec OpenTelemetry]\(/docs/opentelemetry/nginx-plus/nginx-plus-otel/). - Pour monitorer \*\*NGINX sur Kubernetes\*\*, consultez \[Monitorer NGINX sur Kubernetes avec OpenTelemetry]\(/docs/opentelemetry/nginx/nginx-otel-kubernetes/). &lt;/Callout&gt; &lt;Callout variant=&quot;tip&quot;&gt; \*\*Temps d&apos;installation\*\*: environ 20 minutes | \*\*Niveau de compétence\*\*: Intermédiaire (nécessite des connaissances de base de Linux/NGINX) &lt;/Callout&gt; */}

## Avant de commencer [#prerequisites]

Avant de commencer, assurez-vous d&apos;avoir :

* Un [compte New Relic](https://newrelic.com/signup) avec un<InlinePopover type="licenseKey" />

* NGINX avec le module [HTTP stub status](https://nginx.org/en/docs/http/ngx_http_stub_status_module.html) activé

* [OpenTelemetry Collector Contrib](https://github.com/open-telemetry/opentelemetry-collector-contrib/releases/latest) installé et en cours d&apos;exécution sur un hôte Linux

* Accès réseau de l&apos;hôte Linux vers :

  * Point de terminaison d&apos;état stub HTTP NGINX
  * Le [point de terminaison OTLP](https://docs.newrelic.com/docs/opentelemetry/best-practices/opentelemetry-otlp/#configure-endpoint-port-protocol)de New Relic

### Vérifiez votre configuration

Vérifiez le module d&apos;état NGINX :

```bash
nginx -V 2>&1 | grep -o with-http_stub_status_module
```

Résultat attendu : `with-http_stub_status_module`

Vérifier OpenTelemetry Collector :

```bash
otelcol-contrib --version
```

Sortie attendue : Informations de version (minimum v0.88.0 requis)

Testez la connectivité réseau :

```bash
# For US region
curl -I https://otlp.nr-data.net:443
```

Résultat attendu : En-têtes de réponse HTTP (pas de refus de connexion)

<Callout variant="tip">
  Si une étape de vérification échoue, installez les composants manquants avant de continuer. Besoin d&apos;aide pour installer le collecteur ? Consultez le [guide d&apos;installation d&apos;OpenTelemetry Collector](https://github.com/open-telemetry/opentelemetry-collector-contrib).
</Callout>

## Étape 1 : Configurer l&apos;état stub NGINX [#configure-nginx]

Configurez le module [stub\_status](https://nginx.org/en/docs/http/ngx_http_stub_status_module.html) pour exposer les métriques de votre serveur NGINX. Ce module fournit des statistiques de performance de base qu&apos;OpenTelemetry collectera.

<CollapserGroup>
  <Collapser id="step1-add-config" title="Ajouter la configuration de l'état du stub">
    Ajoutez cette configuration à votre fichier de configuration NGINX (`/etc/nginx/nginx.conf`) :

    ```nginx
    server {
        listen 8080;
        server_name localhost;

        location /nginx_status {
            stub_status;
        }
    }
    ```
  </Collapser>

  <Collapser id="step1-apply-config" title="Appliquer la configuration">
    1. Testez votre configuration NGINX :

       ```bash
       sudo nginx -t
       ```

    2. Si le test réussit, rechargez NGINX :

       ```bash
       sudo nginx -s reload
       ```
  </Collapser>

  <Collapser id="step1-verify" title="Vérifiez que l'état du stub fonctionne">
    Testez le point de terminaison :

    ```bash
    curl http://127.0.0.1:8080/nginx_status
    ```

    Résultat attendu :

    ```
    Active connections: 1
    server accepts handled requests
     16 16 16
    Reading: 0 Writing: 1 Waiting: 0
    ```

    Testez la réponse HTTP :

    ```bash
    curl -I http://127.0.0.1:8080/nginx_status
    ```

    Résultat attendu : Doit commencer par `HTTP/1.1 200 OK`
  </Collapser>
</CollapserGroup>

## Étape 2 : Configurer le collecteur OpenTelemetry [#configure-collector]

Configurez le collecteur OpenTelemetry pour extraire les métriques de votre point de terminaison d&apos;état stub NGINX et les envoyer à New Relic.

<CollapserGroup>
  <Collapser id="step2-understanding" title="Comprendre la configuration">
    Le collecteur OpenTelemetry utilise trois composants principaux pour le monitoring NGINX :

    * **Receivers** - Connectez-vous à votre point de terminaison d&apos;état stub NGINX pour collecter des métriques
    * **Processeurs** - Ajouter l&apos;identification du serveur et les métriques par lots pour une transmission efficace
    * **Exportateurs** - Envoyer les métriques traitées à votre compte New Relic via OTLP HTTP
  </Collapser>

  <Collapser id="step2-prepare" title="Préparez votre environnement">
    Avant de modifier la configuration, vous aurez besoin de deux informations clés :

    1. **Votre URL d&apos;état stub** - De l&apos;étape 1 (par défaut : `http://127.0.0.1:8080/nginx_status`)
    2. **Un nom de déploiement unique** - Choisissez un nom qui identifie ce serveur NGINX spécifique (par exemple, `production-web-01`, `staging-api`, `prod-lb-01`)

    Le nom du déploiement apparaîtra dans les dashboards New Relic et vous aidera à identifier des serveurs spécifiques lorsque vous avez plusieurs instances NGINX.
  </Collapser>

  <Collapser id="step2-configuration" title="Ajoutez la configuration du collecteur">
    <Callout variant="important">
      **Avant de modifier :** sauvegardez votre configuration existante : `sudo cp /etc/otelcol-contrib/config.yaml /etc/otelcol-contrib/config.yaml.backup`
    </Callout>

    Modifiez votre fichier de configuration du collecteur (généralement `/etc/otelcol-contrib/config.yaml`) et ajoutez les sections suivantes. Si vous avez déjà des sections de récepteurs, de processeurs ou d&apos;exportateurs, fusionnez-les avec votre configuration existante :

    **1. Configurez le récepteur NGINX :**

    ```yaml
    receivers:
      nginx:
        endpoint: http://127.0.0.1:8080/nginx_status  # Replace with your stub status URL
        collection_interval: 30s                      # How often to collect metrics
        metrics:
          nginx.requests:
            enabled: true
          nginx.connections_accepted:
            enabled: true
          nginx.connections_handled:
            enabled: true
          nginx.connections_current:
            enabled: true
    ```

    **2. Configurez les processeurs pour les métadonnées et le traitement par lots :**

    ```yaml
    processors:
      # Detect system information (hostname, etc.)
      resourcedetection:
        detectors: [system]
        system:
          resource_attributes:
            host.name:
              enabled: true
            host.id:
              enabled: true

      # Add NGINX-specific identification
      resource:
        attributes:
          - key: nginx.server.endpoint
            value: "http://127.0.0.1:8080/nginx_status"  # Replace with your endpoint
            action: upsert
          - key: nginx.deployment.name
            value: "production-web-01"                    # Replace with your server name
            action: upsert

      # Batch metrics for efficient sending
      batch:
        timeout: 30s
        send_batch_size: 1024

      # Transform metrics for better display in New Relic
      transform/nginx_metrics:
        metric_statements:
          - context: resource
            statements:
              # Customize the display name as needed for your New Relic dashboard
              - set(attributes["nginx.display.name"], Concat(["server", attributes["nginx.deployment.name"]], ":"))
    ```

    **3. Configurez l&apos;exportateur New Relic :**

    ```yaml
    exporters:
      # Send metrics to New Relic via OTLP
      otlphttp/newrelic:
        endpoint: ${env:NEWRELIC_OTLP_ENDPOINT}
        headers:
          api-key: ${env:NEWRELIC_LICENSE_KEY}
    ```

    **4. Connectez le tout avec un pipeline :**

    ```yaml
    service:
      pipelines:
        metrics:
          receivers: [nginx]
          processors: [resourcedetection, resource, batch, transform/nginx_metrics]
          exporters: [otlphttp/newrelic]
    ```
  </Collapser>

  <Collapser id="step2-customize" title="Personnaliser la configuration">
    **Remplacez ces valeurs dans la configuration ci-dessus :**

    1. **URL du point de terminaison**: Remplacez `http://127.0.0.1:8080/nginx_status` pour correspondre à votre configuration d&apos;état factice de l&apos;étape 1
    2. **Nom du déploiement**: Remplacez `production-web-01` par un identifiant unique pour ce serveur NGINX

    **Choisir un bon nom de déploiement :**

    * Utilisez des noms descriptifs comme `production-web-01`, `staging-api` ou `prod-lb-01`
    * Doit être unique pour tous les serveurs NGINX de votre compte New Relic
    * Ce nom apparaîtra dans les dashboards et vous aidera à identifier des serveurs spécifiques
    * Gardez-le court mais significatif pour faciliter le filtrage et les alertes
  </Collapser>
</CollapserGroup>

## Étape 3 : Configurer l&apos;authentification [#set-environment]

Configurez l&apos;authentification sécurisée afin que l&apos;OpenTelemetry Collector puisse envoyer des données à votre compte New Relic. Cette étape configure les variables d&apos;environnement pour sécuriser vos informations d&apos;identification.

<CollapserGroup>
  <Collapser id="step3-get-credentials" title="Obtenez vos informations d'identification New Relic">
    Avant de configurer l&apos;authentification, rassemblez ces deux informations :

    1. \*\* Votre clé de licence :\*\*

       * Accédez à [one.newrelic.com](https://one.newrelic.com) → **API Keys**
       * Recherchez la section &quot;Ingest - License&quot; → Cliquez sur **Show key**
       * Copiez la clé de licence (commence par &quot;NRAK-...&quot;)

    2. \*\* Votre point de terminaison OTLP :\*\* Utilisez le point de terminaison approprié pour votre région New Relic. Consultez [Configurer le point de terminaison, le port et le protocole](https://docs.newrelic.com/docs/opentelemetry/best-practices/opentelemetry-otlp/#configure-endpoint-port-protocol) pour la liste complète des points de terminaison et des ports pris en charge pour votre région. Par exemple :

       * **Région US**: `https://otlp.nr-data.net:4318`
       * **Région UE**: `https://otlp.eu01.nr-data.net:4318`
  </Collapser>

  <Collapser id="step3-configure-credentials" title="Configurez les identifiants">
    1. **Créer un répertoire de remplacement systemd :**

       ```bash
       sudo mkdir -p /etc/systemd/system/otelcol-contrib.service.d
       ```

    2. **Créez le fichier de configuration de l&apos;environnement :**

       ```bash
       cat <<EOF | sudo tee /etc/systemd/system/otelcol-contrib.service.d/environment.conf
       [Service]
       Environment="NEWRELIC_OTLP_ENDPOINT=https://otlp.nr-data.net:4318"
       Environment="NEWRELIC_LICENSE_KEY=YOUR_LICENSE_KEY_HERE"
       EOF
       ```

    3. **Mettez à jour la configuration avec vos informations d&apos;identification :**

       * Remplacez `https://otlp.nr-data.net:4318` par le point de terminaison de votre région
       * Remplacez `YOUR_LICENSE_KEY_HERE` par votre clé de licence réelle ci-dessus
  </Collapser>
</CollapserGroup>

## Étape 4 : Démarrer le monitoring [#start-monitoring]

Maintenant que tout est configuré, démarrez le collecteur OpenTelemetry et vérifiez que les données sont acheminées vers New Relic.

<CollapserGroup>
  <Collapser id="step4-start-collector" title="Démarrer le collecteur">
    1. **Appliquer les modifications de configuration :**

       ```bash
       sudo systemctl daemon-reload
       sudo systemctl restart otelcol-contrib.service
       ```

    2. **Vérifiez que le service est en cours d&apos;exécution :**

       ```bash
       sudo systemctl status otelcol-contrib.service
       ```

       Sortie attendue : `Active: active (running)` sans erreurs récentes
  </Collapser>

  <Collapser id="step4-verify-data" title="Vérifier la collecte de données">
    3. **Vérifiez les logs de démarrage :**

       ```bash
       sudo journalctl -u otelcol-contrib.service -n 20
       ```

       **Recherchez ces indicateurs de réussite :**

       * ✅ `"Everything is ready. Begin running and processing data."`
       * ✅ `"Scraping metrics"` - Collecte réussie depuis NGINX
       * ✅ `"Exporting metrics"` - Envoi réussi à New Relic

    4. **Générez du trafic de test (pour créer des métriques) :**

       ```bash
       # Make a few requests to your NGINX server
       curl http://localhost
       ```

    5. Laissez le temps aux données initiales d&apos;apparaître dans New Relic, puis [accédez à votre dashboard NGINX](/docs/opentelemetry/nginx/find-and-query-your-data#find-data) pour vérifier la collecte des données.
  </Collapser>
</CollapserGroup>

## Étape 5 : (Facultatif) Transférer les logs NGINX [#forward-logs]

En plus des métriques, vous pouvez envoyer les [logs d&apos;accès et d&apos;erreurs](https://docs.nginx.com/nginx/admin-guide/monitoring/logging/) NGINX à New Relic pour un monitoring et un dépannage complets. Ces logs complètent les [métriques NGINX de base](/docs/opentelemetry/nginx/nginx-otel-metrics-reference#core-metrics) et fournissent des informations détaillées au niveau des requêtes.

<Callout variant="tip">
  **Ignorez cette étape si :** vous n&apos;avez besoin que des métriques NGINX de base et que vous n&apos;avez pas besoin de logs de requêtes détaillés.
</Callout>

<CollapserGroup>
  <Collapser id="step5-configure-nginx-logs" title="Configurez le logging structurée dans NGINX">
    Tout d&apos;abord, configurez NGINX pour qu&apos;il génère des logs au format JSON, qui sont plus faciles à analyser et à interroger.

    **Ajoutez ceci à votre configuration NGINX (`/etc/nginx/nginx.conf`) :**

    ```nginx
    http {
        # JSON log format for better parsing
        log_format json_combined escape=json
        '{'
          '"time":"$time_local",'
          '"remote_addr":"$remote_addr",'
          '"request":"$request",'
          '"status":$status,'
          '"bytes_sent":$body_bytes_sent,'
          '"request_time":$request_time,'
          '"referer":"$http_referer",'
          '"user_agent":"$http_user_agent"'
        '}';

        # Use the JSON format for access logs
        access_log /var/log/nginx/access.log json_combined;
        error_log /var/log/nginx/error.log warn;

        # Your existing configuration...
    }
    ```

    **Rechargez NGINX pour appliquer les modifications :**

    ```bash
    sudo nginx -t && sudo nginx -s reload
    ```
  </Collapser>

  <Collapser id="step5-configure-collector-logs" title="Configurer le collecteur pour le transfert de logs">
    **Ajoutez ces sections à votre `/etc/otelcol-contrib/config.yaml`:**

    ```yaml
    receivers:
      # Your existing nginx receiver...
      nginx:
        # existing configuration...

      # Add log receivers
      filelog/nginx_access:
        include:
          - /var/log/nginx/access.log

      filelog/nginx_error:
        include:
          - /var/log/nginx/error.log

    processors:
      # Your existing processors...

      # Add log processor
      transform/nginx_access_logs:
        log_statements:
        - context: resource
          statements:
            - set(attributes["nginx.display.name"], Concat(["server", attributes["nginx.deployment.name"]], ":"))
            - set(attributes["logtype"], "nginx")
      transform/nginx_error_logs:
        log_statements:
        - context: resource
          statements:
            - set(attributes["nginx.display.name"], Concat(["server", attributes["nginx.deployment.name"]], ":"))
            - set(attributes["logtype"], "nginx-error")

    service:
      pipelines:
        # Your existing metrics pipeline...
        metrics:
          receivers: [nginx]
          processors: [resourcedetection, resource, batch, transform/nginx_metrics]
          exporters: [otlphttp/newrelic]

        # Add log pipelines
        logs/nginx-access:
          receivers: [filelog/nginx_access]
          processors: [resource, batch, transform/nginx_access_logs]
          exporters: [otlphttp/newrelic]

        logs/nginx-error:
          receivers: [filelog/nginx_error]
          processors: [resource, batch, transform/nginx_error_logs]
          exporters: [otlphttp/newrelic]
    ```
  </Collapser>

  <Collapser id="step5-permissions-apply" title="Définir les autorisations et appliquer la configuration">
    **Autoriser le collecteur à lire les fichiers logs NGINX :**

    ```bash
    # Add collector user to adm group (has read access to logs)
    sudo usermod -a -G adm otelcol-contrib

    # Ensure log files are readable
    sudo chmod 644 /var/log/nginx/access.log
    sudo chmod 644 /var/log/nginx/error.log
    ```

    **Redémarrer le collecteur :**

    ```bash
    sudo systemctl restart otelcol-contrib.service
    ```
  </Collapser>
</CollapserGroup>

## Affichez vos données dans New Relic [#find-data]

Une fois votre configuration terminée et que les données circulent, vous pouvez accéder à vos métriques NGINX dans les dashboards New Relic et créer des alertes personnalisées.

Pour des instructions complètes sur l&apos;accès aux dashboards, l&apos;interrogation des données avec NRQL et la création d&apos;alertes, consultez [Trouver et interroger vos données NGINX](/docs/opentelemetry/nginx/find-and-query-your-data).

## Dépannage [#troubleshooting]

Si vous rencontrez des problèmes lors de l&apos;installation, utilisez ce guide de dépannage pour diagnostiquer et résoudre les problèmes courants.

<CollapserGroup>
  <Collapser id="troubleshoot-nginx-stub-status" title="Problèmes de statut stub NGINX">
    **Obtention de 404 Not Found :**

    ```bash
    curl http://127.0.0.1:8080/nginx_status
    ```

    **Solutions :**

    * Vérifiez que le chemin d&apos;accès correspond à l&apos;URL de votre requête
    * Vérifiez que la configuration a été ajoutée au bloc serveur correct
    * Exécutez `sudo nginx -T | grep -A5 nginx_status` pour confirmer que la configuration est chargée

    **Obtention d&apos;une erreur 403 Interdit :**

    * Assurez-vous que vous testez depuis localhost (127.0.0.1)
    * Vérifiez vos directives `allow`/`deny` dans la configuration NGINX
    * Vérifiez qu&apos;aucune autre restriction d&apos;accès ne bloque la requête

    **Connexion refusée :**

    * Vérifiez si NGINX est en cours d&apos;exécution : `sudo systemctl status nginx`
    * Vérifiez que le port 8080 n&apos;est pas bloqué : `sudo netstat -tlnp | grep :8080`
    * Vérifiez les règles de pare-feu, le cas échéant
  </Collapser>

  <Collapser id="troubleshoot-collector-service" title="Le service Collector ne démarrera pas">
    **Vérifiez l&apos;état du service :**

    ```bash
    sudo systemctl status otelcol-contrib.service
    sudo journalctl -u otelcol-contrib.service -n 50
    ```

    **Causes et corrections courantes :**

    * **Erreurs de syntaxe YAML** - Corrigez les problèmes d&apos;indentation et de syntaxe
    * **Variables d&apos;environnement manquantes** - Vérifiez que les informations d&apos;identification sont définies dans le fichier d&apos;environnement
    * **Problèmes de permissions de fichiers** - Exécuter `sudo chown otelcol-contrib:otelcol-contrib /etc/otelcol-contrib/config.yaml`
    * **URL de point de terminaison non valides** - Vérifiez le point de terminaison NGINX et le point de terminaison OTLP New Relic
    * **Configurations de composants manquantes** - Assurez-vous que tous les récepteurs, processeurs et exportateurs référencés dans la section des pipelines de service sont réellement définis dans leurs sections de configuration respectives ci-dessus

    **Redémarrer après les corrections :**

    ```bash
    sudo systemctl restart otelcol-contrib.service
    ```
  </Collapser>

  <Collapser id="troubleshoot-no-data" title="Aucune donnée n'apparaît dans New Relic">
    **Diagnostic étape par étape :**

    1. **Vérifiez que le statut stub NGINX fonctionne :**

       ```bash
       curl http://127.0.0.1:8080/nginx_status
       ```

       Doit renvoyer les statistiques de connexion.

    2. **Vérifiez que le collecteur est en cours d&apos;exécution et en bonne santé :**

       ```bash
       sudo systemctl status otelcol-contrib.service
       sudo journalctl -u otelcol-contrib -n 20
       ```

       Les logs fourniront un contexte détaillé en cas de problèmes de configuration ou d&apos;exécution avec OpenTelemetry Collector.

    3. **Vérifiez les données avec NRQL :**

       ```sql
       FROM Metric SELECT * WHERE nginx.deployment.name LIKE '%production%' LIMIT 1
       ```
  </Collapser>

  <Collapser id="troubleshoot-log-forwarding" title="Problèmes de transfert de logs">
    **Aucun log n&apos;apparaît dans New Relic :**

    ```bash
    # Check Collector logs for file errors
    sudo journalctl -u otelcol-contrib -f | grep -i "filelog\|error"
    ```

    **Problèmes courants :**

    * **Erreurs d&apos;autorisation de fichier** - Ajouter le collecteur au groupe adm : `sudo usermod -a -G adm otelcol-contrib`
    * **Chemins de fichiers incorrects** - Vérifiez les emplacements des fichiers logs dans votre configuration
  </Collapser>
</CollapserGroup>

### Obtenir de l&apos;aide

Si vous continuez à rencontrer des problèmes :

1. Consultez les [meilleures pratiques OpenTelemetry de New Relic](/docs/opentelemetry/best-practices/opentelemetry-otlp/)
2. Recherchez dans le [New Relic Explorers Hub](https://discuss.newrelic.com/) les problèmes similaires

## Prochaines étapes [#next-steps]

**En savoir plus sur vos données :**

* [Trouvez et interrogez vos données NGINX](/docs/opentelemetry/nginx/find-and-query-your-data/) - Accédez aux dashboards, créez des requêtes personnalisées et configurez des alertes
* [Référence des métriques et attributs NGINX OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-metrics-reference/) - Référence complète des métriques avec descriptions et exemples
* [Présentation d&apos;NGINX OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-overview/) - Comprendre les métriques, les attributs et les cas d&apos;utilisation collectés
* [Documentation du récepteur NGINX](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/nginxreceiver/documentation.md) - Détails techniques et configuration avancée

**Explorer le monitoring connexe :**

* [Monitorer NGINX Plus avec OpenTelemetry](/docs/opentelemetry/nginx-plus/nginx-plus-otel/) - Pour les déploiements commerciaux NGINX Plus
* [Monitorer NGINX sur Kubernetes](/docs/opentelemetry/nginx/nginx-otel-kubernetes/) - Pour les environnements conteneurisés
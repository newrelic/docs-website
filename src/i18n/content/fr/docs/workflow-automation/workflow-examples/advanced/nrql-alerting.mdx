---
title: Alertes NRQL complexes
tags:
  - workflow automation
  - workflow
  - nrql
  - alerting
metaDescription: Compare NRQL results across time windows to detect anomalies standard alerts can't catch.
freshnessValidatedDate: never
translationType: machine
---

Comparez les résultats NRQL sur des fenêtres temporelles pour détecter les anomalies que les alertes standard ne peuvent pas détecter.

**Exigences:**

* Compte New Relic
* Destination de messagerie (voir [Envoyer des notifications](/docs/workflow-automation/setup-and-configuration/create-destinations))
* Planifier via l&apos;API [CreateSchedule](/docs/workflow-automation/workflow-automation-apis/create-schedule).

**Actions clés**: `newrelic.nrdb.query`, `newrelic.notification.sendEmail`

**Cas d&apos;utilisation**: Utilisez ce modèle lorsque les alertes standard ne peuvent pas répondre aux exigences, telles que :

* Comparaison des métriques sur plusieurs fenêtres temporelles
* Application d&apos;opérations mathématiques personnalisées sur les résultats de requête
* Déclenchement uniquement lorsque des seuils ou des modèles spécifiques sont détectés
* Combinaison de données provenant de plusieurs requêtes avec une logique conditionnelle

```yaml
  name: Complex_Alert_Workflow
  description: 'Compares NRQL results across time windows and sends alerts when new events are detected'

  workflowInputs:
    destinationId:
      type: String
    query:
      type: String
      defaultValue: 'FROM Span SELECT count(*)'

  steps:
    - name: query1
      type: action
      action: newrelic.nrdb.query
      version: 1
      inputs:
        query: "${{ .workflowInputs.query }} SINCE 10 minutes ago UNTIL 5 minutes ago"
        accountIds:
          - 7401815
        selectors:
          - name: length
            expression: '[ .results[] | length ]'
          - name: count
            expression: '[ .results[0].count ]'

    - name: query2
      type: action
      action: newrelic.nrdb.query
      version: 1
      inputs:
        query: "${{ .workflowInputs.query }} SINCE 5 minutes ago"
        accountIds:
          - 7401815
        selectors:
          - name: length
            expression: '[ .results[] | length ]'
          - name: count
            expression: '[ .results[0].count ]'

    - name: CheckForNewEvents
      type: switch
      switch:
        - condition: >-
            ${{ (.steps.query2.outputs.count - .steps.query1.outputs.count) > 0 }}
          next: sendEmail
      next: end

    - name: sendEmail
      type: action
      action: newrelic.notification.sendEmail
      version: 1
      inputs:
        destinationId: ${{ .workflowInputs.destinationId }}
        subject: Hello there!
        message: >-
          More spans incoming!!!
          There are --- ${{ (.steps.query2.outputs.count - .steps.query1.outputs.count) }} ---
          new Spans that were ingested in the last 5 minutes
        attachments:
          - type: QUERY
            query: ${{ .workflowInputs.query }} SINCE 5 minutes ago
            format: CSV
            filename: span_count.csv
      next: end
```

**Pour planifier**, utilisez l&apos;API [CreateSchedule](/docs/workflow-automation/create-a-workflow-automation/start-schedule#scheduled) avec l&apos;expression cron `*/10 * * * *` (toutes les 10 minutes). L&apos;intervalle minimum est de 10 minutes. Consultez les [limites du workflow](/docs/workflow-automation/limitations-and-faq/workflow-limits) pour plus de détails.

## Et ensuite ?

* **[Restauration du déploiement](/docs/workflow-automation/workflow-examples/advanced/deployment-rollback)**: Monitoring automatisée du déploiement
* **[Gestion EC2](/docs/workflow-automation/workflow-examples/advanced/ec2-management)**: Automatisation de l&apos;infrastructure
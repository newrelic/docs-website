---
subject: Java agent
releaseDate: '2025-05-29'
version: 8.21.0
downloadLink: 'https://download.newrelic.com/newrelic/java-agent/newrelic-agent/8.21.0/'
features:
  - “Enhances visibility into Reactor flatMap calls”
  - ”Adds new instrumentation for Spring-Kafka”
  - “Adds kafka-clients-spans-consumer instrumentation with distributed tracing support“
  - “Adds KafkaConsumerConfig event support for Kafka 3.7+”
bugs:
  - “Fixes the distributed_tracing.sampler config”
  - “Fixes an Illegal Access Error that can occur when using Scala 2.12 and JDK 11”
  - “Fixes the netty.http2.frame_read_listener.start_transaction configuration”
  - “Adds a restriction on when to add distributed trace headers for SQS messages”
  - “Allows the org.crac JAR to be shadowed”
  - “Backports NullPointerException fix to older versions of vertx-core instrumentation”
  - “Prevents excessive transaction segments from being created by HttpUrlConnection method calls”
security:
  - '“Upgrades the com.newrelic.agent.java:infinite-tracing-protobuf for better security with infinite tracing”'
  - '“Replaces snakeyaml with com.konloch:safeyaml to address a security vulnerability”'
translationType: machine
---

<Callout variant="caution">
  **Problèmes connus**: Cette sortie présente un problème connu avec certaines utilisations de Netty Reactor qui peuvent provoquer des fuites de mémoire. Veuillez envisager d&apos;utiliser une autre version.
</Callout>

<ButtonGroup>
  <ButtonLink role="button" to="https://download.newrelic.com/newrelic/java-agent/newrelic-agent/8.21.0/" variant="primary">
    Téléchargez cette version de l&apos;agent
  </ButtonLink>
</ButtonGroup>

## Nouvelle fonctionnalité et améliorations

* Améliore la visibilité des appels Reactor `Mono.flatMap` [2308](https://github.com/newrelic/newrelic-java-agent/pull/2308)
* Ajoute une nouvelle instrumentation pour Spring-Kafka et le traçage distribué lors de l&apos;utilisation du client Kafka de base (bibliothèque [2312).](https://github.com/newrelic/newrelic-java-agent/pull/2312)
* Ajoute la prise en charge de `KafkaConsumerConfig` événements pour Kafka 3.7+ [2358](https://github.com/newrelic/newrelic-java-agent/pull/2358)

## Corrections

* Corrige la configuration `distributed_tracing.sampler` [2330](https://github.com/newrelic/newrelic-java-agent/pull/2330)

* Corrige une erreur d&apos;accès illégal pouvant survenir lors de l&apos;utilisation de Scala 2.12 et JDK 11. Dans les cas où Scala 2.12 n&apos;est pas détectable par l&apos;agent (nous vérifions le chargeur de classes système à cet effet - notamment, sbt charge les classes Scala dans des chargeurs Scala personnalisés), il existe également un indicateur de fonctionnalité permettant d&apos;activer manuellement le correctif via la propriété système `-Dnewrelic.config.class_transformer.illegal_access_fix=true` [2334](https://github.com/newrelic/newrelic-java-agent/pull/2334)

* Correction des transactions « Inconnues » de netty [ : 2274](https://github.com/newrelic/newrelic-java-agent/pull/2274) [et 2355](https://github.com/newrelic/newrelic-java-agent/pull/2355)

  * Ce correctif déplace les modifications d&apos;instrumentation Netty précédentes derrière un indicateur de fonctionnalité, ce qui offre une visibilité supplémentaire dans certains cas impliquant des transactions HTTP2. Pour réactiver cette granularité (au prix possible de voir des transactions « inconnues »), utilisez le paramètre de configuration :

  ```yaml
    netty:
      http2:
        frame_read_listener:
          start_transaction: true
  ```

  * La version 8.20 comporte une erreur logique dans la configuration de l&apos;agent ; le correctif n&apos;est donc officiel que pour la version 8.21 et les versions ultérieures.

* Ajoute une restriction sur le moment où il faut ajouter des en-têtes tracedistribuée pour les messages SQS. Cela dépend de la taille du contenu d&apos;un message en octets et de la taille de l&apos;attribut. Les messages d&apos;une taille supérieure à 251 Ko et/ou comportant 9 attributs ou plus sont exclus du calcul traceen-têtes distribués ajoutés [(ligne 2353).](https://github.com/newrelic/newrelic-java-agent/pull/2353)

* Permet de masquer le fichier JAR `org.crac` afin d&apos;éviter les conflits avec les environnements clients. [2344](https://github.com/newrelic/newrelic-java-agent/pull/2344)

* Intégration des modifications apportées dans la PR #1927 pour empêcher `NullPointerExceptions` vers les anciennes versions de l&apos;instrumentation `vertx-core` [2327](https://github.com/newrelic/newrelic-java-agent/pull/2327)

* Empêche la création de segments de transaction excessifs par les appels de méthode `HttpUrlConnection` (par exemple `getInputStream`) lorsqu&apos;ils ne sont pas associés à un appel externe. Ce comportement peut être contrôlé par les options de configuration suivantes : `NEW_RELIC_CLASS_TRANSFORMER_COM_NEWRELIC_INSTRUMENTATION_HTTPURLCONNECTION_VERBOSE=false`, sys prop `-Dnewrelic.config.class_transformer.com.newrelic.instrumentation.httpurlconnection.verbose=false`, ou strophe équivalente dans `newrelic.yml`. La valeur par défaut est `true` (c&apos;est-à-dire Les méthodes de gestion des réponses non externes `getInputStream` et autres seront signalées comme précédemment). [2365](https://github.com/newrelic/newrelic-java-agent/pull/2365)

## Sécurité

* Améliore la sécurité grâce à la traçabilité infinie [(2339)](https://github.com/newrelic/newrelic-java-agent/pull/2339) `com.newrelic.agent.java:infinite-tracing-protobuf`
* Remplace `snakeyaml` par `com.konloch:safeyaml` pour corriger une faille de sécurité [2333](https://github.com/newrelic/newrelic-java-agent/pull/2333)

## Dépréciations

Les modules d&apos;instrumentation suivants sont obsolètes et seront supprimés lors de la prochaine sortie majeure :

* `aws-wrap-0.7.0`
* `java.completable-future-jdk8`
* `play-2.3`
* `netty-3.4`
* `Struts v1`

## IAST

Mise à jour de la version CSEC vers la version 1.7.0 [2348](https://github.com/newrelic/newrelic-java-agent/pull/2348)\
Log des modifications : [https://github.com/newrelic/csec-java-agent/releases/tag/1.7.0](https://github.com/newrelic/csec-java-agent/releases/tag/1.7.0)

## Mise à jour vers la dernière version [#procedures]

Pour identifier la version de l’agent Java que vous utilisez actuellement, exécutez `java -jar newrelic.jar -v`. Votre version d&apos;agent Java sera imprimée sur votre console.

Ensuite, pour mettre à jour vers la dernière version de l&apos;agent Java :

1. Sauvegardez l’ **intégralité** du [répertoire racine de l’agent Java](/docs/agents/manage-apm-agents/troubleshooting/find-agent-root-directory#java-agent) vers un autre emplacement. Renommez ce répertoire en `NewRelic_Agent#.#.#`, où `#.#.#` est le numéro de version de l&apos;agent.
2. [Téléchargez l&apos;agent.](/docs/release-notes/agent-release-notes/java-release-notes).
3. Décompressez le nouveau fichier de téléchargement de l&apos;agent, puis copiez `newrelic-api.jar` et `newrelic.jar` dans le [répertoire racine de l&apos;agent Java](/docs/agents/manage-apm-agents/troubleshooting/find-agent-root-directory#java-agent) d&apos;origine.
4. Comparez votre ancien `newrelic.yml` avec le `newrelic.yml` nouvellement téléchargé à partir du zip et [mettez à jour le fichier si nécessaire](#diff).
5. Redémarrez votre répartiteur Java.

Si vous rencontrez des problèmes après la mise à jour de l&apos;agent Java, effectuez la restauration à partir du répertoire de l&apos;agent New Relic sauvegardé.

## Différences de configuration de l&apos;agent de mise à jour [#diff]

Nous ajoutons de nouveaux paramètres à `newrelic.yml` à mesure que nous sortons de nouvelles versions de l&apos;agent. Vous pouvez utiliser `diff` ou un autre utilitaire de comparaison pour voir ce qui a changé et ajouter les nouveaux paramètres de configuration à votre ancien fichier. Assurez-vous de ne pas écraser les personnalisations que vous avez apportées au fichier, telles que votre clé de licence, le nom de l&apos;application ou les modifications apportées aux paramètres par défaut.

Par exemple, si vous `diff` les fichiers par défaut `newrelic.yml` pour les versions 7.10.0 et 7.11.0 de l&apos;agent Java, les résultats imprimés sur la console seront comme suit :

```yaml
➜ diff newrelic_7.10.0.yml newrelic_7.11.0.yml
...
107a108,119
>       # Whether the log events should include context from loggers with support for that.
>       include_context_data:
>
>         # When true, application logs will contain context data.
>         enabled: false
>
>         # A comma separated list of attribute keys whose values should be sent to New Relic.
>         #include:
>
>         # A comma separated list of attribute keys whose values should not be sent to New Relic.
>         #exclude:
>
125a138
>
128c141
<     enabled: false
---
>     enabled: true
...
```

Dans cet exemple, ces lignes ont été ajoutées à la valeur par défaut `newrelic.yml` dans la version 7.11.0 de l&apos;agent Java. Si vous passez à la version 7.11.0 ou supérieure, vous devez ajouter ces nouvelles lignes à votre `newrelic.yml` d&apos;origine.

## Déclaration de soutien :

* New Relic vous recommande de mettre à niveau l&apos;agent régulièrement pour vous assurer de bénéficier des dernières fonctionnalités et avantages en termes de performances. De plus, les anciennes sorties ne seront plus prises en charge lorsqu&apos;elles atteindront leur [fin de vie](https://docs.newrelic.com/docs/using-new-relic/cross-product-functions/install-configure/notification-changes-new-relic-saas-features-distributed-software/).
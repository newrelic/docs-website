---
title: Prometheusリモート書込みインテグレーションのセットアップ
tags:
  - Integrations
  - Prometheus integrations
  - Install and configure remote write
metaDescription: How to set up or remove your Prometheus remote write integration to New Relic.
---

いくつかの簡単のステップで、New RelicでPrometheusデータフローを取得できます。このページでは、リモート書込みインテグレーションの基本的な設定や、いくつかの一般的なトラブルシューティングのトピックを取り上げます。高可用性（HA）設定でのPrometheusサーバーのインテグレーションに関する情報は、[Prometheusの高可用性](/docs/prometheus-high-availability-ha)ドキュメントをご覧ください。

## インテグレーションの設定 [#setup]

[New Relic OneのPrometheusリモート書込みセットアップランチャーに移動](https://one.newrelic.com/launcher/nr1-core.settings?pane=eyJuZXJkbGV0SWQiOiJwcm9tZXRoZXVzLXJlbW90ZS13cml0ZS1pbnRlZ3JhdGlvbi1uZXJkbGV0cy5zZXR1cC1wcm9tZXRoZXVzIn0=)してから、これらのステップを実行します。

<ButtonLink
  data-tessen="stitchedPathLinkClick"
  role="button"
  to="https://one.newrelic.com/launcher/nr1-core.settings?pane=eyJuZXJkbGV0SWQiOiJwcm9tZXRoZXVzLXJlbW90ZS13cml0ZS1pbnRlZ3JhdGlvbi1uZXJkbGV0cy5zZXR1cC1wcm9tZXRoZXVzIn0="
  variant="primary"
>
  Prometheusデータを追加する
</ButtonLink>

1. 接続するPrometheusサーバーの名前と`remote_write` URLを入力します。**重要：**サーバーに対して入力する名前で、データに属性が作成されます。これは、New Relicにデータを送信しているPrometheusサーバーを識別する名前にもなります。

2. 新たな`remote_write` URLを、Prometheus YMLファイルに追加します。`グローバル`セクションと同じインデントにあるファイル内の`global_config`にこの情報を追加します。

   以下の構文を使用します。

   ```
   remote_write: 
   - url: https://metric-api.newrelic.com/prometheus/v1/write?prometheus_server=<var>YOUR_DATA_SOURCE_NAME</var>  
     bearer_token:<var>YOUR_LICENSE_KEY</var>
   ```

   または

   ```
   remote_write: 
   - url: https://metric-api.newrelic.com/prometheus/v1/write?X-License-Key=<var>YOUR_LICENSE_KEY</var>&prometheus_server=<var>YOUR_DATA_SOURCE_NAME</var>
   ```

   **欧州連合のアカウント：**EUから接続している場合は、以下のURLを使用してください。

   ```
   https://metric-api.eu.newrelic.com/prometheus/v1/write
   ```

   **KubernetesとHelmのリモート書き込みインテグレーション：**リモート書き込みURLをHelm [`values.yaml`](https://github.com/helm/charts/blob/c40486ab2eba0391119b7cc1509d6958fd21c31d/stable/prometheus/values.yaml#L631)ファイルに追加します。`remoteWrite: []`を以下の例のような2行で置き換えます。リモート書き込みURLを使用し、残りのファイルに一致するインデントを使用してください。

   ```
   remoteWrite: 
   - url: https://metric-api.newrelic.com/prometheus/v1/write?prometheus_server=<var>YOUR_DATA_SOURCE_NAME</var> 
     bearer_token:<var>YOUR_LICENSE_KEY</var>
   ```

3. Prometheusサーバーを再起動します。

4. New Relic UIでデータを表示するたとえば、インテグレーションをセットアップするときに自動的に作成されるリモート書き込み[ダッシュボード](/docs/query-your-data/explore-query-data/dashboards/introduction-dashboards)を使用します。

## PrometheusおよびNew Relicメトリックタイプのマッピング [#mapping]

Prometheusリモート書き込みプロトコルには、New Relicにメトリクスを送信するときに、[メトリクスタイプ](/docs/telemetry-data-platform/ingest-manage-data/understand-data/metric-data-type#metric-types)の情報や、その他の有用なメトリクスメタデータは含まれません。リモート書き込みプロトコルにこの情報は含まれていないため、New RelicはPrometheusの命名規則に基づきメトリクスタイプを推測します。これらの命名規則に従わないメトリクスは、正しくマッピングされない場合があります。

New Relicは、以下に示すPrometheusメトリクスの命名規則に基づき、PrometheusメトリクスタイプをNewRelicメトリクスタイプにマッピングします。

* `metricName_bucket`はNew Relicカウントメトリクスタイプとして保存されます。
* `metricName_count`はNew Relicカウントメトリクスタイプとして保存されます。
* `metricName_total`はNew Relicカウントメトリクスタイプとして保存されます。
* `metricName_sum`はNew Relic概要メトリクスタイプとして保存されます。

それ以外はすべて、New Relicゲージメトリクスタイプとして保存されます。

## メトリクスタイプマッピングを上書きする [#override-mapping]

Prometheus命名規則に従っていないメトリクスがある場合、メトリクスタイプを示す`newrelic_metric_type`ラベル付きのメトリクスでリモート書き込みをタグに設定できます。このラベルは、New Relicによって受信されると無効になります。

**例：**`my_counter`という名前のカウンターメトリクスがあります。これには、`_bucket`、`_count`または`_total`という当社の命名規則のサフィックスがありません。この状況では、メトリクスはカウンターではなくゲージとして識別されます。これを修正するには、以下の再ラベル設定を`prometheus.yml`に追加します。

```
- url: https://metric-api.newrelic.com/prometheus/v1/write?X-License-Key=...
  write_relabel_configs:
  - source_labels: [__name__]
    regex: ^my_counter$
    target_label: newrelic_metric_type
    replacement: "counter"
    action: replace
```

このルールは`my_counter`という名前のメトリクスに一致し、そのメトリクスをカウンターとして識別する`newrelic_metric_type`ラベルを追加します。以下の（大文字と小文字を区別する）値を代替値として使用できます。

* counter
* ゲージ
* 概要

`newrelic_metric_type`ラベルが受け取ったメトリクス上にあり、有効な値の1つに設定されている場合、New Relicは、データパイプライン内のダウンストリーム消費前に、示されたタイプをメトリクスに割り当てます（また、ラベルを無効化します）。上記の命名規則に従わない複数のメトリクスがある場合、複数の規則を追加でき、各規則はさまざまなソースラベルに一致します。

## 送信済みメトリクスの許可リストまたは拒否リストの設定 [#allow-deny]

New Relicに送信するデータをより細かく制御する必要がある場合は、メトリクスのサブセットを送信できます。これを行うには、`keep`または`deny`のサブパラメーター`アクション`値を持つ`write_relabel_configs`パラメーターで`リモート書き込み`を構成します。

この例では、正規表現に一致するメトリクスのみを送信します。一致しないメトリクスは送信されません。または、`action: drop` を使用して、正規表現に一致するすべてのメトリクスを削除することもできます。

```
- url: https://metric-api.newrelic.com/prometheus/v1/write?X-License-Key=...
  write_relabel_configs:
  - source_labels: [__name__]
    regex: "coredns_(.*)|etcd_(.*)"
    action: keep
```

このKubernetesの例は、このHelmチャートの[`values.yaml`](https://github.com/helm/charts/blob/c40486ab2eba0391119b7cc1509d6958fd21c31d/stable/prometheus/values.yaml#L631)ファイルを使用します。別のHelmチャートを使用している場合は、その`remoteWrite`ドキュメントを確認してください（例えば、一部のHelmファイルでは代わりにcamelcase `writeRelabelConfigs`を使用します）。

```
  remoteWrite:
    - url: https://metric-api.newrelic.com/prometheus/v1/write?X-License-Key=...
      write_relabel_configs:
      - source_labels: [__name__]
        regex: "coredns_(.*)|etcd_(.*)"
        action: keep
```

## リモート書込みの動作をカスタマイズする [#customize]

New Relicで複数のアカウントに書き込みを行っている場合、または複数のPrometheusデータソースをNew Relicの同じアカウントに接続している場合、以下のパラメーターをカスタマイズできます。詳細については、[リモート書き込みチューニングに関するドキュメント](https://prometheus.io/docs/practices/remote_write/)を参照してください。

<CollapserGroup>
  <Collapser
    id="x-license-key"
    title="X-ライセンスキー"
  >
    アカウントの[ライセンスキー](/docs/accounts/install-new-relic/account-setup/license-key)は、APIキーではありません。ライセンスキーは、認証とどのアカウントにデータを書き込むかの特定に使用します。さまざまなNew Relicアカウントに書き込むPrometheusを設定している場合は、それぞれのリモート書込みURLで異なるキーを使用します。
  </Collapser>

  <Collapser
    id="prometheus_server-url-parameter"
    title={<><InlineCode>prometheus_server</InlineCode> URLパラメーター</>}
  >
    `prometheus_server`パラメーターは、[NRDB](https://newrelic.com/resources/ebooks/inside-nrdb-flexible-unified-database)に書き込まれる統計の追加に使用するラベルまたは属性です。[Grafanaデータソースを設定](/docs/configure-prometheus-data-source-grafana)して、結果を特定の`prometheus_server`からのものに限定する場合、これと同じラベルを使用します。
  </Collapser>

  <Collapser
    id="optimize-throughput"
    title="スループットとメモリ消費を最適化する"
  >
    リモート書き込み[を使用すると、Prometheusサーバーの合計メモリ消費量](https://prometheus.io/docs/practices/remote_write/#memory-usage)が増加します。

    問題が発生している場合は、次の手順をお勧めします。

    * スループットの高いワークロードの場合は、[`容量`](https://prometheus.io/docs/practices/remote_write/#capacity)の増加に比例して、[`max_samples_per_send`](https://prometheus.io/docs/practices/remote_write/#max_samples_per_send)を増やします。
    * それでもメモリ消費が問題になる場合は、サーバーあたりの[`max_shards`](https://prometheus.io/docs/practices/remote_write/#max_shards)の数を制限してください。
  </Collapser>
</CollapserGroup>

## エラーメッセージのトラブルシューティング [#error-messages]

New Relicからインテグレーションのエラーメッセージを受信、またはPrometheusサーバーを再起動後にPrometheusサーバーログでエラーメッセージを受信する場合は、[リモート書き込みのトラブルシューティングドキュメント](/docs/integrations/prometheus-integrations/install-configure-remote-write/remote-write-errors-error-messages)を確認してください。これには、欠落した文字や不正な文字、不正なリクエスト、長すぎるリクエストエンティティ、レート制限エラーなど、一般的なエラーの修正方法が含まれています。

## インテグレーションを削除する [#remove-integration]

Prometheusリモート書き込みインテグレーションを削除すると、新規データのフローを停止しますが、過去データのパージや削除はされません。インテグレーションを削除するには、Prometheus YMLファイルから設定コードスニペットを削除してから、サーバーを再起動します。
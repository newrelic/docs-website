---
title: SNMPモニタリングの結果、メトリクスが見つからない
tags:
  - Integrations
  - Network monitoring
  - Troubleshooting
metaDescription: 'SNMP monitoring is working, but expected metrics are missing.'
translationType: machine
---

## 問題 [#problem]

SNMPモニタリングでは、デバイスに期待されるメトリクスがすべて表示されるわけではありません。

## ソリューション [#solutions]

次のNRQLクエリを実行して、NewRelicに存在するメトリックを特定します。

```sql
FROM Metric SELECT 
uniques(metricName) 
WHERE instrumentation.provider = 'kentik' 
AND device_name = '$DEVICE_NAME'
SINCE 1 HOUR AGO LIMIT MAX
```

<Callout variant="important">
  `$DEVICE_NAME`をデバイスの名前に置き換えます。
</Callout>

このクエリは、過去1時間にあなたのデバイスで収集されているすべての次元メトリックのリストを提供します。メトリックがリストアップされていない場合は、試してみてください。

* [デバイスがターゲットOIDに応答することを確認する](#verify-device-response)
* [デバイスが正しいプロファイルにマッチしていることを確認する](#verify-device-matches)
* [KTranslate が期待どおりにデバイスをポーリングしていることを確認します](#verify-ktranslate-polling)
* [デバイスプロファイルにOIDが記載されていることを確認する](#verify-listed-profile)

### デバイスがターゲットOIDに応答することを確認する [#verify-device-response]

[snmpwalkユーティリティ](/docs/network-performance-monitoring/troubleshooting/snmp-walk)を使用して、 `snmp-base.yaml`構成ファイルで構成したSNMPクレデンシャルを使用してDockerホストからメトリックを収集します。

テストが失敗した場合、そのデバイスは収集したいOIDをサポートしていない可能性が高い。これは、ベンダーが管理しているデバイス自体の制限です。

<Callout variant="tip">
  SNMPv3を使用している場合は、機器のv3ユーザーの設定を確認してください。ほとんどの場合、デバイス管理者はv3ユーザーアカウントのMIBへのアクセスを明示的に許可する必要があります。
</Callout>

### デバイスが正しいプロファイルにマッチしていることを確認する [#verify-device-matches]

前のテストに合格した場合は、 `snmp-base.yaml`ファイルの`mib_profile`に構成された値が正しいプロファイルファイル名と一致することを確認してください。例えば：

```yaml
devices:
  deviceOne:
    ...
    mib_profile: cisco-catalyst.yml
    ...
```

New Relicで、次のNRQLクエリを使用してこれを確認できます。

```sql
FROM Metric SELECT 
latest(instrumentation.name) 
WHERE instrumentation.provider = 'kentik' 
AND device_name = '$DEVICE_NAME'
```

<Callout variant="important">
  `$DEVICE_NAME`をデバイスの名前に置き換えます。
</Callout>

SNMPプロファイルのライブラリは常に更新されており、使用しているコンテナイメージに目的のプロファイル設定がない場合があります。 `mib_profile`が期待されるプロファイルと一致しない場合は、構成ファイルを手動で更新するか、新しい検出を実行できます。

`docker pull kentik/ktranslate:v2`を実行して変更を加える前に、常にコンテナの最新のイメージをプルする必要があります。

### KTranslate が期待どおりにデバイスをポーリングしていることを確認します [#verify-ktranslate-polling]

前のテストに合格した場合は、デバイスから特定のメトリックを収集する際に問題が発生していることを示す**&#x7B;** `Warn`重大度エラーがないかアカウントを確認する必要があります。

Logs UIです。

```shell
collector.name:"ktranslate" message:"*OID failed to return results*"
```

NRQL。

```sql
FROM Log SELECT * WHERE `collector.name` = 'ktranslate' AND `message` LIKE '%OID failed to return results%'
```

期待される成果

```
KTranslate>cisco-7513 OID failed to return results, Metric Name: ipIfStatsHCInOctets, Profile: cisco-asr
```

<Callout variant="tip">
  この例では、ターゲットデバイス`cisco-7513`が`cisco-asr` SNMPプロファイルにある`ipIfStatsHCInOctets` OIDのメトリックを返さないことがわかります。
</Callout>

次に、お使いのデバイスに対して単一のSNMPポールを実行し、供給された設定を使用して、リクエストから **ktranslate** が受け取るものを正確に確認する必要があります。

これを行うには、 **ktranslate**を短期間のコンテナとして実行し、 `-snmp_poll_now`フラグを使用して、 `snmp-base.yaml`構成ファイル内の名前に基づいてデバイスをターゲットにします。例えば：

```shell
docker run -d --name ktranslate-poll_now --rm --net=host \
-v `pwd`/snmp-base.yaml:/snmp-base.yaml \
-e NEW_RELIC_API_KEY=$YOUR_NR_LICENSE_KEY  \
kentik/ktranslate:v2 \
  -snmp /snmp-base.yaml \
  -nr_account_id=$YOUR_NR_ACCOUNT_ID \
  -tee_logs=true \
  -service_name=poll_now \
  -snmp_poll_now=$TARGET_DEVICE_NAME \
  -format=new_relic_metric
```

このポーリングの結果は、を使用してコンテナログで確認できます。 `docker logs --follow ktranslate-poll_now`

デバイス・メタデータ・ポーリングの成功例

```
2022-01-03T23:08:50.583 ktranslate/poll_now [Info] KTranslate SNMP Device Metadata: Data received: {SysName:router123 SysObjectID:.1.3.6.1.4.1.9.1.46 SysDescr:Cisco Internetwork Operating System Software ...}
2022-01-03T23:08:50.585 ktranslate/poll_now [Info] nrmFormat New Metadata for router123
```

デバイスの統計情報のポーリングが成功した例。

```
[{"metrics":[{"name":"kentik.snmp.ifInErrors","type":"count","value":0,"attributes":{"if_Speed":2,"mib-name":"IF-MIB","poll_duration_sec":60,"if_Type":"proppointtopointserial","if_AdminStatus":"up","objectIdentifier":".1.3.6.1.2.1.2.2.1.14","mib-table":"if","if_OperStatus":"up","device_name":"router123","provider":"kentik-router","if_interface_name":"Se11/0/0:16","instrumentation.name":"cisco-asr","if_Index":"63","if_Address":"10.201.0.65","eventType":"KSnmpInterfaceMetric","if_Netmask":"255.255.255.252","if_Alias":"pkt.ds1"}}]...}]
```

_" prettified"_ JSONを見ると、このデバイスではポーリングが期待通りに機能していることがわかります。

```json
[
  {
    "metrics": [
      {
        "name": "kentik.snmp.ifInErrors",
        "type": "count",
        "value": 0,
        "attributes": {
          "if_Speed": 2,
          "mib-name": "IF-MIB",
          "poll_duration_sec": 60,
          "if_Type": "proppointtopointserial",
          "if_AdminStatus": "up",
          "objectIdentifier": ".1.3.6.1.2.1.2.2.1.14",
          "mib-table": "if",
          "if_OperStatus": "up",
          "device_name": "router123",
          "provider": "kentik-router",
          "if_interface_name": "Se11/0/0:16",
          "instrumentation.name": "cisco-asr",
          "if_Index": "63",
          "if_Address": "10.201.0.65",
          "eventType": "KSnmpInterfaceMetric",
          "if_Netmask": "255.255.255.252",
          "if_Alias": "pkt.ds1"
        }
      }
    ]
  }
]
```

### デバイスプロファイルにOIDが記載されていることを確認する [#verify-listed-profile]

これまでのテストにすべて合格した場合、デバイスプロファイル自体にOIDが存在するかどうかを確認します。OIDが記載されていても期待通りに動作しない場合や、OIDをプロファイルに追加する必要がある場合は、 [GitHub issue](https://github.com/kentik/snmp-profiles/issues/new/choose) を開いてリポジトリのメンテナに連絡し、解決に向けて動いてもらいます。
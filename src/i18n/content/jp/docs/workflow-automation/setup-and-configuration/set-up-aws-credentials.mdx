---
title: AWS認証情報を設定する
metaDescription: 'Configure AWS credentials for workflow automation using IAM roles, IAM users, or temporary session tokens.'
freshnessValidatedDate: never
translationType: machine
---

<Callout title="プレビュー">
  この機能はまだ開発中ですが、ぜひお試しください。

  この機能は現在、弊社の[プレリリース ポリシー](/docs/licenses/license-information/referenced-policies/new-relic-pre-release-policy)に従ってプレビュー プログラムの一部として提供されています。
</Callout>

New Relic ワークフロー自動化が AWS アカウントでアクションを実行することを承認します。認証情報をハードコーディングしたり、セキュリティを侵害したりすることなく、ワークフローが EC2、SQS、DynamoDB などのAWSサービスと安全にやり取りできるようにする認証方法を設定します。

## 前提条件

AWS 認証情報を設定する前に、次のものを用意してください。

* IAM ロールまたはユーザーを作成する権限を持つ AWS アカウント。
* [New Relic アカウント ID](/docs/accounts/accounts-billing/account-structure/account-id) 。
* [AWS IAM コンソール](https://console.aws.amazon.com/iam/)への管理者アクセス。
* [AWS CLI がインストールおよび設定されている](https://aws.amazon.com/cli/)
* 引き受けることができる既存のIAMロール

## 必要な権限を理解する [#required-permissions]

資格情報を作成する前に、ワークフローに必要な権限を理解してください。ワークフローが実際に使用する権限のみを付与します。これにより、最小権限の原則が遵守され、セキュリティ リスクが最小限に抑えられます。

### 一般的なワークフロー権限

<table>
  <thead>
    <tr>
      <th style={{ width: "200px" }}>
        **ワークフロータイプ**
      </th>

      <th>
        **必要なAWS権限**
      </th>

      <th>
        **説明**
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        **EC2管理**
      </td>

      <td>
        `ec2:DescribeInstances`

        `ec2:StopInstances`

        `ec2:StartInstances`

        `ec2:ModifyInstanceAttribute`
      </td>

      <td>
        アラートに応じて EC2 インスタンスを停止、開始、または変更する
      </td>
    </tr>

    <tr>
      <td>
        **SQSメッセージング**
      </td>

      <td>
        `sqs:SendMessage`

        `sqs:GetQueueAttributes`
      </td>

      <td>
        下流処理のために SQS キューにメッセージを送信する
      </td>
    </tr>

    <tr>
      <td>
        **APIゲートウェイ**
      </td>

      <td>
        `apigateway:GET`

        `apigateway:PUT`
      </td>

      <td>
        API Gateway のデプロイメントまたは設定をロールバックする
      </td>
    </tr>

    <tr>
      <td>
        **システムマネージャー**
      </td>

      <td>
        `ssm:CreateDocument`

        `ssm:DeleteDocument`

        `ssm:StartAutomationExecution`

        `ssm:GetAutomationExecution`
      </td>

      <td>
        自動化ランブックを実行する
      </td>
    </tr>

    <tr>
      <td>
        **DynamoDB**
      </td>

      <td>
        `dynamodb:Query`

        `dynamodb:GetItem`

        `dynamodb:PutItem`
      </td>

      <td>
        DynamoDB テーブルからの読み取りまたは書き込み
      </td>
    </tr>
  </tbody>
</table>

<Callout variant="tip">
  読み取り専用権限 ( `Describe*` 、 `Get*` 、 `List*` ) から開始し、必要に応じて書き込み権限 ( `Put*` 、 `Create*` 、 `Delete*` ) を追加します。これにより、テスト中の偶発的な破壊的な操作を防止できます。
</Callout>

## 認証を設定する

上の表から、ユースケースに合った方法を選択してください。

<Tabs>
  <TabsBar>
    <TabsBarItem id="iam-role-1">IAM ロール（推奨）</TabsBarItem> <TabsBarItem id="iam-user-1">アクセスキーを持つ IAM ユーザー</TabsBarItem><TabsBarItem id="session-tokens-1">セッショントークン</TabsBarItem>
  </TabsBar>

  <TabsPages>
    <TabsPageItem id="iam-role-1">
      IAM ロールを使用すると、New Relic は永続的なアクセスキーを必要とせずに AWS アカウントの一時的な認証情報を引き受けることができます。

      ### IAM ロールの特性:

      * 資格情報は自動的に更新されます
      * アクセスは設計上、時間制限があります
      * すべてのアクションはAWS CloudTrailにログとして記録されます
      * AWS セキュリティのベストプラクティスに準拠

      ### AWSでロールを作成する

      1. [AWS IAMコンソール](https://console.aws.amazon.com/iam/)にサインインする

      2. **Roles &gt; Create role &gt; Trusted entity type**に移動し、 **AWS account &gt; another AWS account**を選択します。

      3. **Account ID** \[アカウント ID]フィールドに次のように入力します。 `253490767857`

      4. **Options** \[オプション]で**Require external ID** \[外部IDを要求するに]チェックを入れます

      5. **External ID** \[外部 ID]フィールドに New Relic アカウント ID を入力し、 **Next** \[次へ]をクリックします。
         * 持っていないですか？[アカウントIDはこちら](/docs/accounts/accounts-billing/account-structure/account-id)

      6. **Add permissions** \[権限の追加]ページで、ワークフローに基づいてポリシーを添付します。

         * EC2 ワークフローの場合: `AmazonEC2ReadOnlyAccess`をアタッチするか、カスタムポリシーを作成します
         * SQS ワークフローの場合: `AmazonSQSFullAccess`を添付するか、特定のキューに制限します
         * その他のサービスについては、 [「必要なAWS権限」](#required-aws-permissions)を参照してください。

      7. **Next**\[次へ]をクリックします。

      8. ロール名を入力してください: `NewRelicWorkflowAutomationRole` (または希望する名前)

      9. オプションで説明「New Relic ワークフロー自動化が AWS でアクションを実行できるようにする」を追加し、 **Create role** \[ロールの作成]をクリックします。

      ### 信頼ポリシーを確認する

      ロールを作成したら、信頼関係を確認します。

      1. IAMコンソールで、新しく作成したロールを選択します。
      2. **Trust relationships** \[信頼関係]タブをクリックします
      3. ポリシーがこの構造と一致していることを確認します ( `<YOUR_NR_ACCOUNT_ID>`実際のアカウント ID に置き換えます)。

      ```json
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Action": "sts:AssumeRole",
                    "Principal": {
                        "AWS": "arn:aws:iam::253490767857:root"
                    },
                    "Condition": {
                        "StringEquals": {
                            "sts:ExternalId": "<YOUR_NR_ACCOUNT_ID>"
                        }
                    }
                }
            ]
        }
      ```

      ### ロールARNをコピーする

      ワークフローを構成するには、ロール ARN が必要です。

      1. IAMコンソールでロールを選択します
      2. **Summary** \[概要]セクションで、 **ARN**フィールドを見つけます。
      3. 完全な ARN をコピーします。次のようになります。 `arn:aws:iam::123456789012:role/NewRelicWorkflowAutomationRole`
      4. このARNを安全に保存します。ワークフロー設定に直接貼り付けます。

      <Callout variant="tip">
        **重要:**ロール ARN はワークフロー入力に直接渡されます。[シークレット マネージャー](/docs/workflow-automation/limitations-and-faq/workflow-best-practices/#secure-credentials)には保存しないでください。これらは機密性の高い資格情報ではなく、リソース識別子です。
      </Callout>

      ロールが設定されました。AWSアクセスが必要なワークフロー設定で ARN を使用します。
    </TabsPageItem>

    <TabsPageItem id="iam-user-1">
      この方法は、テスト環境の場合や IAM ロールがサポートされていない場合に使用します。アクセス キーは手動でのローテーションを必要とする長期にわたる資格情報です。

      **使用例:**

      * テストおよび開発環境
      * クロスアカウントロールの引き継ぎをサポートしないAWS設定
      * 簡素化された認証ワークフロー

      <Callout variant="caution">
        アクセス キーは長期間有効な資格情報です。定期的に（90 日ごとに）ローテーションし、ワークフローに必要なものだけにアクセスを制限します。
      </Callout>

      ### IAM ユーザーを作成する

      1. [AWS IAMコンソール](https://console.aws.amazon.com/iam/)にサインインする

      2. **Users &gt; Create user**に移動し、ユーザー名: `workflow-automation-user` (または任意の名前) を入力します。

      3. **Next**をクリックします

      4. **Set permissions** \[権限の設定]ページで、**Attach policies directly** \[ポリシーを直接アタッチするを]選択します。

      5. ワークフローに基づいてポリシーを検索して選択します。

         * SQSの場合: 選択 `AmazonSQSFullAccess`
         * EC2の場合: 選択 `AmazonEC2ReadOnlyAccess`
         * または、権限を制限したカスタムポリシーを作成します（推奨）

      6. **Next** \[次へ]をクリックし、 **Create user** \[ユーザーを作成]をクリックします。

      ### アクセスキーを生成する

      1. ユーザーリストで、新しく作成したユーザーを選択します

      2. **Security credentials** \[セキュリティ資格情報]タブをクリックします

      3. **Access keys** \[アクセスキー]セクションで、**Create access key** \[アクセスキーの作成を]選択します。

      4. **Application running outside AWS** \[AWS外で実行されているアプリケーション]を選択し、 **Next** \[次へ]をクリックします。

      5. (オプション) 説明タグを追加します:「New Relic ワークフロー自動化」

      6. **Create access key** \[アクセスキーの作成を]選択

      7. 両方の資格情報をすぐにコピーします。

         * **アクセスキーID** （ `AKIA...`で始まる）
         * **秘密アクセスキー**（一度だけ表示）

      <Callout variant="important">
        AWS は、作成時にシークレットアクセスキーを 1 回だけ表示します。保存しない場合は、新しいキー ペアを生成する必要があります。
      </Callout>

      ### 資格情報を安全に保存する

      ワークフローで AWS 認証情報をハードコードしないでください。代わりに、New Relic の[シークレット マネージャー](/docs/workflow-automation/limitations-and-faq/workflow-best-practices/#secure-credentials)に保存します。

      1. [NerdGraph GraphiQLエクスプローラー](https://one.newrelic.com/nerdgraph-graphiql)を開く
      2. このミューテーションを実行してアクセス キー ID を保存します (プレースホルダーの値を置き換えます)。

      ```yaml
        mutation {
          secretsManagementCreateSecret(
            scope: {type: ACCOUNT id: "YOUR_NR_ACCOUNT_ID"}
            namespace: "aws"
            key: "awsAccessKeyId"
            description: "AWS Access Key ID for workflow automation"
            value: "YOUR_AWS_ACCESS_KEY_ID"
          ) {
            key
          }
        }
      ```

      3. シークレット アクセス キーに対して別のミューテーションを実行します。

      ```yaml
        mutation {
          secretsManagementCreateSecret(
            scope: {type: ACCOUNT id: "YOUR_NR_ACCOUNT_ID"}
            namespace: "aws"
            key: "awsSecretAccessKey"
            description: "AWS Secret Access Key for workflow automation"
            value: "YOUR_AWS_SECRET_ACCESS_KEY"
          ) {
            key
          }
        }
      ```

      次の構文を使用して**、ワークフローでこれらのシークレットを参照します**。 `${{ :secrets:awsAccessKeyId }}`

      <Callout variant="tip">
        `namespace`フィールドを使用して、環境 ( `aws-prod` 、 `aws-staging` ) またはチーム名別にシークレットを整理します。
      </Callout>
    </TabsPageItem>

    <TabsPageItem id="session-tokens-1">
      セッション トークンは、自動的に期限が切れる一時的な資格情報を提供します。

      **使用例:**

      * ローカル開発とテスト
      * 資格情報のローテーションが必要なCI/CDパイプライン
      * 時間制限付きアクセス（通常 1 ～ 12 時間）のコンプライアンス要件がある環境

      ### 一時的な認証情報を生成する

      1. ターミナルを開き、次のコマンドを実行します (ロール ARN に置き換えます)。

      ```yaml
        aws sts assume-role \
          --role-arn "arn:aws:iam::YOUR_ACCOUNT:role/YOUR_ROLE" \
          --role-session-name "WorkflowAutomationSession"
      ```

      AWS CLI を初めて使用する場合は、 `aws configure`を使用して設定し、アクセス認証情報を入力する必要がある場合があります。

      <img title="Image of the Static Access credentials" alt="Image of the Static Access credentials" src="/images/static-access.webp" />

      2. AWS は 3 つの値を返します。3 つすべてが必要です。

      ```json
        {
          "Credentials": {
              "AccessKeyId": "ASIAIOSFODNN7EXAMPLE",
              "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
              "SessionToken": "FQoGZXIvYXdzEBk...",
              "Expiration": "2025-01-25T12:00:00Z"
          }
        }
      ```

      3. 3 つの資格情報すべてを[シークレット マネージャー](/docs/workflow-automation/limitations-and-faq/workflow-best-practices/#secure-credentials)に保存します。

      * `AccessKeyId` 保存先 `awsAccessKeyId`
      * `SecretAccessKey` 保存先 `awsSecretAccessKey`
      * `SessionToken` 保存先 `awsSessionToken`

      <Callout variant="caution">
        セッション トークンは期限切れになります (通常 1 時間後)。`Expiration`タイムスタンプの前に更新するようにリマインダーを設定してください。そうしないと、認証エラーが発生してワークフローが失敗します。
      </Callout>
    </TabsPageItem>
  </TabsPages>
</Tabs>

## ワークフローで資格情報を使用する [#use-credentials]

認証を設定したら、ワークフロー構成で資格情報を参照します。

### IAM ロール（推奨）

ロール ARN をワークフロー入力に直接貼り付けます。[シークレット マネージャーは](/docs/workflow-automation/limitations-and-faq/workflow-best-practices/#secure-credentials)必要ありません。

```yaml
  awsRoleArn: arn:aws:iam::123456789012:role/NewRelicWorkflowAutomationRole
```

<Callout variant="important">
  ロール ARN はリソース識別子であり、機密性の高い認証情報ではありません。これらを Secrets Manager に保存せず、ワークフロー設定に直接貼り付けてください。
</Callout>

### IAM ユーザーまたはセッショントークン

アクセス キーの参照[シークレット マネージャー](/docs/workflow-automation/limitations-and-faq/workflow-best-practices/#secure-credentials):

```yaml
  awsAccessKeyId: ${{ :secrets:awsAccessKeyId }}
  awsSecretAccessKey: ${{ :secrets:awsSecretAccessKey }}
  awsSessionToken: ${{ :secrets:awsSessionToken }}  # Only for session tokens
```

New Relic は実行時にシークレットを取得し、AWS で認証してから、シークレットを破棄します。資格情報はログやワークフロー履歴に表示されることはありません。

## ポリシーの例

一般的なワークフロー タイプには、これらの完全な IAM ポリシー テンプレートを使用します。それぞれは、特定のリソースへのアクセスを制限することで、最小権限の原則に従います。

<CollapserGroup>
  <Collapser id="sqs-policy" title="SQS メッセージングワークフロー">
    特定のキューへのアクセスを制限します。

    ```json
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": "sqs:SendMessage",
            "Resource": "arn:aws:sqs:us-west-2:123456789012:my-workflow-queue"
          },
          {
            "Effect": "Allow",
            "Action": "sqs:GetQueueAttributes",
            "Resource": "arn:aws:sqs:us-west-2:123456789012:my-workflow-queue"
          }
        ]
      }
    ```

    `us-west-2`リージョンに、 `123456789012` AWS アカウント ID に、 `my-workflow-queue`キュー名に置き換えます。
  </Collapser>

  <Collapser id="ec2-policy" title="EC2管理ワークフロー">
    タグによって特定のインスタンスへのアクセスを制限します。

    ```json
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "ec2:DescribeInstances",
              "ec2:DescribeTags"
            ],
            "Resource": "*"
          },
          {
            "Effect": "Allow",
            "Action": [
              "ec2:StopInstances",
              "ec2:StartInstances",
              "ec2:ModifyInstanceAttribute"
            ],
            "Resource": "arn:aws:ec2:us-east-1:123456789012:instance/*",
            "Condition": {
              "StringEquals": {
                "aws:ResourceTag/Environment": "production"
              }
            }
          }
        ]
      }
    ```

    このポリシーでは、ワークフローが`Environment=production`を持つ EC2 インスタンス タグのみを*停止/開始/変更できる*ようにします。
  </Collapser>

  <Collapser id="dynamodb-policy" title="DynamoDB ワークフロー">
    特定のテーブルへのアクセスを制限します。

    ```json
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "dynamodb:Query",
              "dynamodb:GetItem",
              "dynamodb:PutItem"
            ],
            "Resource": "arn:aws:dynamodb:us-east-1:123456789012:table/WorkflowData"
          }
        ]
      }
    ```

    `WorkflowData`テーブル名に置き換えます。
  </Collapser>

  <Collapser id="ssm-policy" title="システムマネージャーのワークフロー">
    特定の自動化ドキュメントへのアクセスを制限します。

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "ssm:CreateDocument",
            "ssm:DeleteDocument"
          ],
          "Resource": "arn:aws:ssm:us-east-1:123456789012:document/WorkflowAutomation-*"
        },
        {
          "Effect": "Allow",
          "Action": [
            "ssm:StartAutomationExecution",
            "ssm:GetAutomationExecution"
          ],
          "Resource": [
            "arn:aws:ssm:us-east-1:123456789012:automation-definition/WorkflowAutomation-*:*",
            "arn:aws:ssm:us-east-1:123456789012:automation-execution/*"
          ]
        }
      ]
    }
    ```

    これにより、自動化ドキュメントは、プレフィックスが`WorkflowAutomation-`の付いたものに制限されます。
  </Collapser>

  <Collapser id="apigateway-policy" title="APIゲートウェイワークフロー">
    特定の API へのアクセスを制限します。

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "apigateway:GET",
            "apigateway:PUT"
          ],
          "Resource": "arn:aws:apigateway:us-west-2::/restapis/abc123xyz/*"
        }
      ]
    }
    ```

    `abc123xyz` API Gateway ID に置き換えます。
  </Collapser>
</CollapserGroup>

### 追加リソース

包括的な AWS 権限リファレンス:

* **[AWSインテグレーション管理ポリシー](/docs/infrastructure/amazon-integrations/get-started/integrations-managed-policies/)**: サービス別のAWS権限の完全なリストと、適応できる CloudFormation テンプレート
* **[AWS APIポーリングの設定](/docs/infrastructure/amazon-integrations/connect/set-up-aws-api-polling/)**：追加の設定パターン

<Callout variant="important">
  これらのリソースは、クラウド統合 (監視) にアカウント ID `754728514883`を使用します。 ワークフローの自動化には、常に`253490767857`を使用します。
</Callout>

## 次のステップ

* **[宛先の作成](/docs/workflow-automation/setup-and-configuration/create-destinations)**: Slack、電子メール、または Webhook 通知を設定します。
* **[アクション カタログ](/docs/workflow-automation/setup-and-configuration/actions-catalog/actions-catalog)**: 利用可能なすべてのAWS 、 New Relic 、および統合アクションを表示します。
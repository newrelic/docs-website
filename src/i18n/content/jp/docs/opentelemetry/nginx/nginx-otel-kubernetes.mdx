---
title: OpenTelemetryを使用してKubernetes上の NGINX を監視する
metaDescription: Send your NGINX metrics from Kubernetes to New Relic using the OpenTelemetry Collector.
freshnessValidatedDate: never
translationType: machine
---

[OpenTelemetry Collector](https://github.com/open-telemetry/opentelemetry-collector-contrib)使用して、 Kubernetesで実行されている NGINX サーバーを監視し、メトリクスとテレメトリーデータをNew Relicに送信します。

このKubernetes固有の統合は、クラスタ内の NGINX ポッドを自動的に検出し、インスタンスごとに手動で設定することなくメトリクスを収集します。 OpenTelemetry [nginxreceiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/nginxreceiver)と[Receivercreator](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/receivercreator)を利用して、コンテナ化された環境全体で NGINX パフォーマンス メトリクス、接続統計、サーバーの健全性を動的に監視します。

## あなたが始める前に [#prerequisites]

以下のものを用意してください:

* [New Relicアカウント](https://newrelic.com/signup)<InlinePopover type="licenseKey" />
* 監視する必要がある NGINX ポッド上の[HTTP スタブ ステータス](https://nginx.org/en/docs/http/ngx_http_stub_status_module.html)モジュールを有効にします
* 監視する必要がある各 NGINX ポッドにラベル`app`と`role`を追加します。

## OpenTelemetry Collector をインストールして設定する [#install-collector]

Helmを使用してOpenTelemetry CollectorをKubernetesクラスタにデプロイします。 コレクターは、NGINX ポッドからメトリクスを自動的に検出して収集します。

<CollapserGroup>
  <Collapser id="k8s-create-secret" title="資格情報用のKubernetesシークレットを作成する">
    New Relic の認証情報を保存するための Kubernetes シークレットを作成します。`YOUR_LICENSE_KEY`と`YOUR_OTLP_ENDPOINT`を実際の値に置き換えます。OTLP エンドポイント設定[ドキュメント](https://docs.newrelic.com/docs/opentelemetry/best-practices/opentelemetry-otlp/#configure-endpoint-port-protocol)を参照して、地域に適したエンドポイントを選択してください。

    ```bash
    kubectl create namespace newrelic
    kubectl create secret generic newrelic-licenses --from-literal=NEWRELIC_LICENSE_KEY=YOUR_LICENSE_KEY --from-literal=NEWRELIC_OTLP_ENDPOINT=YOUR_OTLP_ENDPOINT
    ```
  </Collapser>

  <Collapser id="k8s-values-yaml" title="value.yaml の作成">
    OpenTelemetry Collector を構成するには、 `values.yaml`ファイルを作成します。クラスター名、NGINX ポッド ラベル、スタブ ステータス ポート、パスのプレースホルダーを更新します。

    ```yaml
    opentelemetry-collector:
      mode: deployment

      image:
        repository: otel/opentelemetry-collector-contrib
        pullPolicy: IfNotPresent

      command:
        name: otelcol-contrib

      resources:
        limits:
          cpu: 500m
          memory: 300Mi
        requests:
          cpu: 100m
          memory: 100Mi

      extraEnvs:
        - name: NEWRELIC_LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: newrelic-licenses
              key: NEWRELIC_LICENSE_KEY
        - name: NEWRELIC_OTLP_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: newrelic-licenses
              key: NEWRELIC_OTLP_ENDPOINT
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: K8S_CLUSTER_NAME
          value: nginx-cluster # Update with your cluster name

      clusterRole:
        create: true
        rules:
          - apiGroups: [""]
            resources: ["pods", "nodes", "nodes/stats", "nodes/proxy"]
            verbs: ["get", "list", "watch"]
          - apiGroups: ["apps"]
            resources: ["replicasets"]
            verbs: ["get", "list", "watch"]
        clusterRoleBinding:
          name: ""

      config:
        extensions:
          health_check:
            endpoint: 0.0.0.0:13133
          k8s_observer:
            auth_type: serviceAccount
            observe_pods: true
            observe_nodes: true

        receivers:
          receiver_creator/nginx:
            watch_observers: [k8s_observer]
            receivers:
              nginx:
                rule: type == "pod" && labels["app"] == "nginx" && labels["role"] == "reverse-proxy" # Update with your labels
                config:
                  endpoint: 'http://`endpoint`:<stub_status_port>/status'
                  metrics:
                    nginx.requests:
                      enabled: true
                    nginx.connections_accepted:
                      enabled: true
                    nginx.connections_handled:
                      enabled: true
                    nginx.connections_current:
                      enabled: true
                  collection_interval: 30s
                resource_attributes:
                  nginx.server.endpoint: 'http://`endpoint`:<stub_status_port>/status'
                  nginx.port: '<stub_status_port>'

        processors:
          batch:
            send_batch_size: 1024
            timeout: 30s

          resource/cluster:
            attributes:
              - key: k8s.cluster.name
                value: "${env:K8S_CLUSTER_NAME}"
                action: insert

          transform/nginx:
            metric_statements:
              - context: resource
                statements:
                  - set(attributes["nginx.display.name"], Concat([
                      "server",
                      "k8s",
                      attributes["k8s.cluster.name"],
                      attributes["k8s.namespace.name"],
                      "pod",
                      attributes["k8s.pod.name"],
                      "nginx",
                      attributes["nginx.port"]
                      ], ":"))
                  - set(attributes["nginx.deployment.name"], attributes["k8s.pod.name"])

        exporters:
          otlphttp:
            endpoint: "${env:NEWRELIC_OTLP_ENDPOINT}"
            headers:
              api-key: "${env:NEWRELIC_LICENSE_KEY}"

        service:
          extensions: [health_check, k8s_observer]
          pipelines:
            metrics/nginx:
              receivers: [receiver_creator/nginx]
              processors: [batch, resource/cluster, transform/nginx]
              exporters: [otlphttp]
    ```
  </Collapser>

  <Collapser id="k8s-install-helm" title="Helmでインストール">
    values.yaml ファイルを使用して[Helm チャート](https://github.com/open-telemetry/opentelemetry-helm-charts)をインストールします。

    ```bash
    helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
    helm repo update
    helm upgrade --install nginx-otel-collector open-telemetry/opentelemetry-collector --namespace newrelic --create-namespace -f values.yaml
    ```
  </Collapser>

  <Collapser id="k8s-verify-deployment" title="デプロイメントとデータ収集を検証する">
    1. **ポッドが正常に起動したことを確認します。**

       ```bash
       kubectl get pods -n newrelic --watch
       ```

       `newrelic`ネームスペースには、 `nginx-otel-collector-<hash>`のような名前のポッドが`Running`状態にあることが表示されます。

    2. **New Relic で NRQL クエリを実行して、データが到着していることを確認します。**クラスター名を、値ファイルで設定した値に置き換えます。

       ```sql
       FROM Metric
       SELECT *
       WHERE metricName LIKE 'nginx.%'
         AND instrumentation.provider = 'opentelemetry'
         AND k8s.cluster.name = 'nginx-cluster'
       SINCE 10 minutes ago
       ```
  </Collapser>
</CollapserGroup>

## データを見つけて使用する [#find-data]

1. **[one.newrelic.com](https://one.newrelic.com) &gt; Integrations &amp; Agents**に移動します。
2. **Dashboards**を選択し、 **NGINX OTel overview dashboard** \[NGINX OTel 概要] ダッシュボードをクリックします。
3. ポップアップウィンドウでアカウントを選択します。
4. 「ダッシュボードの表示」をクリックして、New Relic で NGINX データを表示します。

NGINX メトリクスは、 `Metric`[イベント タイプ](/docs/using-new-relic/data/understand-data/new-relic-data-types#events-new-relic)に関連付けられています。 [このデータは、トラブルシューティングの目的で、またはカスタム チャートやダッシュボードを作成するために書き込むこと](/docs/using-new-relic/data/understand-data/query-new-relic-data)ができます。

## メトリクスとプロパティのリファレンス [#metrics]

この統合は、オンホスト デプロイメントと同じコア NGINX メトリクスを収集し、クラスタ、ネームスペース、およびポッド識別用の追加のKubernetes固有のリソース プロパティを収集します。

**メトリクスとプロパティの完全なリファレンスについては、** Kubernetesデプロイメントのすべてのメトリクス、タイプ、リソース プロパティの詳細な説明については、 [「NGINX OpenTelemetryメトリクスとプロパティ リファレンス」を](/docs/opentelemetry/nginx/nginx-otel-metrics-reference/)参照してください。

## 次のステップ [#next-steps]

**データについて詳しくはこちらをご覧ください:**

* [NGINX データを見つけて書きます](/docs/opentelemetry/nginx/find-and-query-your-data/)- ダッシュボードにアクセスし、カスタム書き込みを作成し、アラートを設定します
* [NGINX OpenTelemetry のメトリクスと属性のリファレンス](/docs/opentelemetry/nginx/nginx-otel-metrics-reference/)- 説明と例を含む完全なメトリクス リファレンス
* [NGINX OpenTelemetry概要](/docs/opentelemetry/nginx/nginx-otel-overview/)- 収集されたメトリクス、プロパティ、ユースケースを理解する
* [NGINX レシーバーのドキュメント](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/nginxreceiver/documentation.md)- 技術的な詳細と高度な設定

**関連する監視を調べます:**

* [OpenTelemetryを使用した NGINX Plus のモニター](/docs/opentelemetry/nginx-plus/nginx-plus-otel/)- 商用 NGINX Plus デプロイメント用
* [OpenTelemetryを使用したセルフホスト型 NGINX の監視](/docs/opentelemetry/nginx/nginx-otel-host/)- 従来のサーバー展開の場合
* [OpenTelemetryのベストプラクティス](/docs/opentelemetry/best-practices/opentelemetry-otlp/)- OpenTelemetryの設定を最適化する

**Kubernetes 固有のリソース:**

* [Kubernetes上のOpenTelemetry Collector](https://opentelemetry.io/docs/kubernetes/) - Advanced Collector 設定
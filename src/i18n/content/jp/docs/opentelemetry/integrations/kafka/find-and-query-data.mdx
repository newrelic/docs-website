---
title: New RelicでKafkaデータを検索してクエリする
tags:
  - Integrations
  - OpenTelemetry
  - Kafka
  - Query data
metaDescription: Learn how to find your Kafka metrics in New Relic UI and write NRQL queries to analyze your data.
freshnessValidatedDate: never
translationType: machine
---

Kafka 監視がOpenTelemetryで設定されると、メトリクスがNew Relicの複数の場所に表示されるようになります。 このガイドでは、データの場所と効果的なクエリの実行方法を説明します。

## Kafkaデータに移動する [#find-data]

Kafka メトリクスは、New Relic プラットフォームの複数の場所に表示されます。それぞれ異なるユースケースに合わせて最適化されています。

### 1. エンティティエクスプローラー

最適な用途: 迅速なヘルスチェックとエンティティ関係

1. に行く <DNT>**[one.newrelic.com](https://one.newrelic.com) &gt; All capabilities &gt; On host integrations**</DNT>
2. Kafka ブローカー、クラスター、トピックのエンティティ タイプを表示する

<img title="OTel Kafka Entity Explorer" alt="Entity explorer showing Kafka broker, cluster, and topics entity types" src="/images/otel-kafka-entityexplorer.webp" />

### 2. キューとストリーム

最適な用途: メッセージキューに重点を置いた監視

1. に行く <DNT>**[one.newrelic.com](https://one.newrelic.com) &gt; All capabilities &gt; Queues &amp; Streams**</DNT>
2. `provider=opentelemetry`でフィルターし、Kafka をインストゥルメントしたアカウント行をクリックしてデータを表示します

<img title="OTel Kafka Queues & Streams" alt="Queues & Streams view showing Kafka data filtered by OpenTelemetry provider" src="/images/otel-kafka-queues-streams.webp" />

/\* ### 3. Third-party services Best for: Integration-focused monitoring 1. Go to &lt;DNT&gt;\*\*\[one.newrelic.com]\(https\://one.newrelic.com) &gt; All capabilities &gt; Infrastructure &gt; Third-party services\*\*&lt;/DNT&gt; 2. Select &lt;DNT&gt;\*\*Kafka (OpenTelemetry)\*\*&lt;/DNT&gt; &gt; &lt;DNT&gt;\*\*OpenTelemetry Kafka\*\*&lt;/DNT&gt; &lt;img title=&quot;OTel Kafka Third-party Services&quot; alt=&quot;Third-party services view showing Kafka (OpenTelemetry) integration&quot; src=&quot;/images/infrastructure\_screenshot-crop\_otel-kafka-third-party-integrations.webp&quot; /&gt; \*/

### 3. あらかじめ構築されたダッシュボード

最適な用途: 包括的な監視と可視化

1. に行く <DNT>**[one.newrelic.com](https://one.newrelic.com) &gt; Dashboards &gt; Recommended dashboards (View all)**</DNT>
2. 検索する <DNT>**&quot;OpenTelemetry Kafka&quot;**</DNT>

<img title="OpenTelemetry Kafka" alt="Pre-built dashboard showing Kafka cluster health, network throughput, and broker metrics" src="/images/otel-kafka-prebuilt-dashboards.webp" />

## NRQL で Kafka データをクエリする [#query-data]

[NRQL](/docs/nrql/get-started/introduction-nrql-new-relics-query-language)を使用して、Kafka データのカスタム クエリとダッシュボードを作成します。

<CollapserGroup>
  <Collapser id="basic-queries" title="基本的なクエリ">
    **すべての Kafka メトリクスを表示:**

    ```sql
    FROM Metric SELECT *
    WHERE instrumentation.provider='opentelemetry'
    AND kafka.cluster.name IS NOT NULL
    LIMIT 100
    ```

    **モニター固有のクラスタ:**

    ```sql
    FROM Metric SELECT *
    WHERE kafka.cluster.name = 'production-cluster'
    AND instrumentation.provider='opentelemetry'
    ```
  </Collapser>

  <Collapser id="consumer-lag-queries" title="消費者ラグ監視">
    **グループ別の消費者の遅れ:**

    ```sql
    FROM Metric SELECT latest(kafka.consumer_group.lag)
    WHERE instrumentation.provider='opentelemetry'
    FACET group, topic
    SINCE 1 hour ago TIMESERIES
    ```

    **高い消費者ラグ集計:**

    ```sql
    FROM Metric SELECT max(kafka.consumer_group.lag)
    WHERE instrumentation.provider='opentelemetry'
    AND group = 'your-consumer-group'
    ```
  </Collapser>

  <Collapser id="broker-health-queries" title="ブローカーの健全性に関するクエリ">
    **アクティブなブローカー数:**

    ```sql
    FROM Metric SELECT latest(kafka.brokers)
    WHERE instrumentation.provider='opentelemetry'
    AND kafka.cluster.name = 'your-cluster'
    TIMESERIES
    ```

    **複製不足のパーティション:**

    ```sql
    FROM Metric SELECT latest(kafka.partition.under_replicated)
    WHERE instrumentation.provider='opentelemetry'
    FACET broker.id SINCE 1 hour ago
    ```
  </Collapser>

  <Collapser id="performance-queries" title="性能監視">
    **トピック別のメッセージスループット:**

    ```sql
    FROM Metric SELECT rate(sum(kafka.prod.msg.count), 1 minute) as 'Messages/min'
    WHERE instrumentation.provider='opentelemetry'
    FACET topic SINCE 1 hour ago TIMESERIES
    ```

    **ブローカーによるネットワーク I/O:**

    ```sql
    FROM Metric SELECT rate(sum(kafka.network.io), 1 minute) as 'Bytes/min'
    WHERE instrumentation.provider='opentelemetry'
    FACET broker.id, direction SINCE 1 hour ago TIMESERIES
    ```
  </Collapser>
</CollapserGroup>

## 高度なクエリ [#advanced-queries]

監視の焦点領域別に整理されたより包括的なクエリ例については、以下を参照してください。

<CollapserGroup>
  <Collapser id="cluster-overview-queries" title="Cluster概要">
    Get high-level cluster statistics and health:

    ```sql
    FROM Metric SELECT
      max(kafka.brokers) AS 'Active Brokers',
      max(kafka.cluster.topic.count) AS 'Total Topics',
      max(kafka.cluster.partition.count) AS 'Total Partitions',
      latest(kafka.partition.offline) AS 'Offline Partitions'
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    TIMESERIES
    ```
  </Collapser>

  <Collapser id="broker-health-queries" title="ブローカーの健全性">
    個々のブローカーの健全性とリーダーシップを監視します。

    ```sql
    FROM Metric SELECT
      latest(kafka.partition.under_replicated) AS 'Under-replicated Partitions',
      latest(kafka.broker.leader.count) AS 'Leader Count',
      latest(kafka.partition.count) AS 'Total Partitions'
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET broker.id
    TIMESERIES
    ```
  </Collapser>

  <Collapser id="topic-throughput-queries" title="トピックのスループットとI/O">
    トピックごとにメッセージ レートとデータ スループットを監視します。

    ```sql
    FROM Metric SELECT
      rate(sum(kafka.prod.msg.count), 1 minute) AS 'Messages/min',
      rate(filter(sum(kafka.topic.io), WHERE direction = 'in'), 1 minute) AS 'Bytes In/min',
      rate(filter(sum(kafka.topic.io), WHERE direction = 'out'), 1 minute) AS 'Bytes Out/min'
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET topic
    TIMESERIES
    ```
  </Collapser>

  <Collapser id="consumer-lag-queries" title="消費者の遅れ">
    消費者のグループラグと処理遅延を追跡します。

    ```sql
    FROM Metric SELECT
      latest(kafka.consumer_group.lag_sum) AS 'Total Lag'
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET group
    TIMESERIES
    ```
  </Collapser>

  <Collapser id="request-latency-queries" title="レイテンシをリクエストする">
    リクエストの処理時間とパフォーマンスを監視します。

    ```sql
    FROM Metric SELECT
      latest(kafka.request.time.avg) AS 'Avg Latency',
      latest(`kafka.request.time.99p`) AS '99th Percentile'
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET type
    TIMESERIES
    ```
  </Collapser>

  <Collapser id="jvm-health-queries" title="JVMの健全性">
    Kafka ブローカーのモニターJVM :

    ```sql
    FROM Metric SELECT
      (latest(jvm.memory.heap.used) / latest(jvm.memory.heap.max)) * 100 AS 'Heap Usage %',
      rate(sum(jvm.gc.collections.count), 1 minute) AS 'GC Count/min'
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET broker.id
    TIMESERIES
    ```
  </Collapser>
</CollapserGroup>

## カスタムダッシュボードを作成する [#custom-dashboards]

複数のクエリを組み合わせて包括的な Kafka 監視ダッシュボードを作成します。

1. [one.newrelic.com](https://one.newrelic.com) &gt; Dashboardsにアクセスしてください

2. 「ダッシュボードを作成」をクリックします

3. 上記のNRQL書き込みを使用してウィジェットを追加します

4. ウィジェットをフォーカス領域別に整理します。

   * Cluster健全性: ブローカー数、レプリケーション不足のパーティション、コントローラーのステータス
   * 消費者のパフォーマンス: ラグ、スループット、グループメンバーシップ
   * トピックメトリクス: メッセージレート、パーティション数、レプリケーションステータス
   * リソース使用率: ネットワークI/O 、 JVMメトリクス、ディスク使用率

## アラートの設定 [#alerts]

<Callout variant="tip">
  New Relic Kafka 用に事前構成された GoldenMetriks Araート を提供します。 新しいアラート条件を作成するときは、**Guided mode** → **Host integrations** → **Kafka** (ブローカー、クラスタ、またはトピック) を選択して、推奨されるテンプレートを表示します。
</Callout>

NRQL クエリを使用してカスタム アラートを作成することもできます。

<CollapserGroup>
  <Collapser id="consumer-lag-alert" title="消費者の遅延が大きい">
    消費者のラグが許容できる閾値を超えた場合:

    ```sql
    FROM Metric SELECT
      latest(kafka.consumer_group.lag_sum)
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET group
    ```

    **推奨値**: クリティカルな消費者グループのラグが 10,000 メッセージを超える場合。
  </Collapser>

  <Collapser id="under-replicated-alert" title="複製不足のパーティション">
    パーティションがレプリケーションを失った場合の合計:

    ```sql
    FROM Metric SELECT
      sum(kafka.partition.under_replicated)
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    ```

    **推奨値**: いずれかのパーティションがレプリケート不足 (&gt; 0) になった場合。
  </Collapser>

  <Collapser id="offline-partitions-alert" title="オフラインパーティション">
    パーティションがオフラインになったときにすぐに集計:

    ```sql
    FROM Metric SELECT
      latest(kafka.partition.offline)
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    ```

    **推奨値**: いずれかのパーティションがオフラインになった場合 (&gt; 0)、直ちに集計します。
  </Collapser>

  <Collapser id="min-isr-alert" title="最小ISR以下のパーティション">
    パーティションが最小同期レプリカを下回る場合の合計:

    ```sql
    FROM Metric SELECT
      latest(kafka.partition.under_min_isr)
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET broker.id
    ```

    **推奨値**: いずれかのパーティションが最小 ISR (&gt; 0) を下回る場合。
  </Collapser>

  <Collapser id="jvm-memory-alert" title="JVMメモリの使用量が多い">
    ヒープ使用量が重要な場合の集計:

    ```sql
    FROM Metric SELECT
      (latest(jvm.memory.heap.used) / latest(jvm.memory.heap.max)) * 100
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET broker.id
    ```

    **推奨値**: ヒープ使用量が継続的に 85% を超える場合。
  </Collapser>

  <Collapser id="request-failures-alert" title="リクエストの失敗">
    リクエストの失敗率が高い場合にまとめます:

    ```sql
    FROM Metric SELECT
      rate(sum(kafka.request.failed), 1 minute)
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    FACET type
    ```

    **推奨値**: 失敗率が総requestsの 1% を超える場合の合計。
  </Collapser>

  <Collapser id="unclean-elections-alert" title="不潔なリーダー選挙">
    汚れたリーダー選挙に関する集計 (ブローカーの失敗を示します):

    ```sql
    FROM Metric SELECT
      rate(sum(kafka.unclean.election.rate), 1 minute)
    WHERE kafka.cluster.name = 'production-cluster'
      AND instrumentation.provider='opentelemetry'
    ```

    **推奨値**: 汚れたリーダー選挙に関する集計 (&gt; 0)。
  </Collapser>
</CollapserGroup>

## 次のステップ [#next-steps]

* **[Kafka メトリクス リファレンス](/docs/opentelemetry/integrations/kafka/metrics-reference)**- 利用可能なメトリクスの完全なリストと説明
* **[NRQLアラート条件の作成](/docs/alerts/create-alert/create-alert-condition/create-nrql-alert-conditions/)**- プロアクティブ監視の設定
* **[NRQLチュートリアル](/docs/query-your-data/nrql-new-relic-query-language/get-started/introduction-nrql-new-relics-query-language)**- 高度なクエリテクニックを学ぶ
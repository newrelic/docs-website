---
title: Kubernetes 用に ATP を構成する
metaDescription: Step-by-step guide to install and configure the Adaptive Telemetry Processor (ATP) with NRDOT Collector in Kubernetes environments.
tags:
  - Open source telemetry integrations
  - OpenTelemetry
  - NRDOT
  - Adaptive Telemetry Processor
  - ATP
  - Kubernetes
  - Helm
  - Manifests
freshnessValidatedDate: never
translationType: machine
---

<Callout title="プレビュー">
  この機能はまだ開発中ですが、ぜひお試しください。

  この機能は現在、弊社の[プレリリース ポリシー](/docs/licenses/license-information/referenced-policies/new-relic-pre-release-policy/)に従ってプレビューの一部として提供されています。
</Callout>

Kubernetes環境で NRDOT Collector使用して Adaptive telemory Processor (ATP) をインストールおよび構成する方法を学習します。 ATP は、アプリケーションに対する重要な可視性を維持しながら、テレメトリーデータのボリュームを削減します。

<Callout variant="important">
  ATP for Kubernetes は実験的なビルドを使用します。このビルド全体は、プレビュー中の ATP 機能だけでなく、 Kubernetesインストレーションの実験的なものです。
</Callout>

## インストレーションの方法 [#installation-methods]

Helm (推奨) または Kubernetes マニフェストを使用して、ATP で OpenTelemetry Collector をインストールできます。

<Tabs>
  <TabsBar>
    <TabsBarItem id="helm">Helm インストール（推奨）</TabsBarItem> <TabsBarItem id="manifest">マニフェスト インストール</TabsBarItem>
  </TabsBar>

  <TabsPages>
    <TabsPageItem id="helm">
      Helmメソッドは、 Kubernetesのデプロイ ATP 対応コレクターに推奨されるアプローチです。

      <Steps>
        <Step>
          ### あなたが始める前に [#helm-prereq]

          以下のものを用意してください:

          * あなたのNew Relicライセンスキー
          * クラスターにアクセスできるように構成された kubectl
          * Cluster管理者の権限
        </Step>

        <Step>
          ### values.yaml をダウンロードしてカスタマイズする [#helm-values]

          1. Helm チャート`values.yaml`ファイルをダウンロードします:

             ```bash
             curl -o values.yaml https://raw.githubusercontent.com/newrelic/helm-charts/master/charts/nr-k8s-otel-collector/values.yaml
             ```

          2. 特定の設定を使用して`values.yaml`ファイルを編集します。

             ```yaml
             # Required: Set your cluster name and license key
             cluster: "YOUR_CLUSTER_NAME"
             licenseKey: "YOUR_NEW_RELIC_LICENSE_KEY"

             # Enable ATP
             enable_atp: true

             # IMPORTANT: Use experimental collector image for ATP
             images:
               collector:
                 repository: "newrelic/nrdot-collector"  # Changed from nrdot-collector-k8s
                 tag: "<NRDOT_COLLECTOR_LATEST_VERSION>"  # Use latest version from releases page
             ```

          3. [リリース ページ](https://github.com/newrelic/nrdot-collector-releases/releases)で最新の NRDOT Collector バージョンを見つけて、 `tag`値を更新します。

          4. 追加の設定オプションについては、 [「設定の問題」を](/docs/kubernetes-pixie/k8s-otel/install/#config-params)参照してください。
        </Step>

        <Step>
          ### Helmチャートをインストールする [#helm-install]

          1. New Relic Helm リポジトリを追加します。

             ```bash
             helm repo add newrelic https://helm-charts.newrelic.com
             helm repo update
             ```

          2. カスタマイズした`values.yaml`ファイルを使用してチャートをインストールします。

             ```bash
             helm upgrade nr-k8s-otel-collector newrelic/nr-k8s-otel-collector \
               -f values.yaml \
               -n newrelic \
               --create-namespace \
               --install
             ```
        </Step>

        <Step>
          ### インストレーションを確認する [#helm-verify]

          1. ポッドが実行されていることを確認します。

             ```bash
             kubectl get pods -n newrelic --watch
             ```

             `newrelic`ネームスペースに、 `nr-k8s-otel-collector-<hash>`のような名前のポッドが表示されるはずです。

          2. [書き込み](/docs/query-your-data/explore-query-data/query-builder/introduction-query-builder/)ビルダーで次の書き込みを実行して、 New Relicプロセス データを受信していることを確認します。

             ```sql
             FROM Metric SELECT *
             WHERE k8s.cluster.name='YOUR_CLUSTER_NAME'
             AND metricName LIKE 'process.%'
             LIMIT 100
             ```

             ```sql
             FROM Metric SELECT uniqueCount(metricName)
             WHERE k8s.cluster.name='YOUR_CLUSTER_NAME'
             AND metricName LIKE 'process.%'
             ```
        </Step>

        <Step>
          ### New RelicでATPデータにアクセスする [#access-data]

          ATP が構成されると、 Kubernetesクラスタからのデータの収集が開始されます。 このデータには New Relic OpenTelemetry UI からアクセスできます。New Relic OpenTelemetry UI の詳細については、 [OpenTelemetry APM UI](/docs/opentelemetry/get-started/apm-monitoring/opentelemetry-apm-ui)を参照してください。

          **New Relicで ATP プロセスのメトリクス データを表示するには:**

          1. **<DNT>[one.newrelic.com](https://one.newrelic.com) &gt; All Entities</DNT>**へ移動します。

             また

             <DNT>**[one.newrelic.com](https://one.newrelic.com) &gt; Catalogs &gt; Infrastructure**</DNT>に移動します。

          2. ATP を使用して NRDOT コレクターをインストールしたエンティティを検索します。

          3. エンティティを選択し、左側のペインで**<DNT>Process</DNT>**をクリックします。

             <DNT>Process</DNT>ページでは、実行中のすべてのプロセスとその ID、CPU およびメモリ使用率のメトリクスを表示できます。 また、プロセスが他のプロセスを生成する場合、プロセス間の親子関係も表示されます。

             <img style={{ align: 'left' }} title="ATP process metrics in New Relic OpenTelemetry UI" alt="ATP process metrics in New Relic OpenTelemetry UI" src="/images/atp-process-metrics.webp" />
        </Step>
      </Steps>
    </TabsPageItem>

    <TabsPageItem id="manifest">
      マニフェスト インストレーション メソッドは、 Helmを使用せずにKubernetes用にOpenTelemetryセットアップする方法を提供します。 この方法は、より実践的なアプローチを好むユーザーや、手動設定を必要とする特定の要件を持つユーザーに適しています。

      <Steps>
        <Step>
          ### あなたが始める前に [#manifest-prereq]

          以下のものを用意してください:

          * あなたのNew Relicライセンスキー
          * クラスターにアクセスできるように構成された kubectl
          * Cluster管理者の権限
        </Step>

        <Step>
          ### マニフェストファイルをダウンロードして準備する [#manifest-download]

          1. `nr-k8s-otel-collector`のレンダリングされたサンプル ディレクトリの内容をローカル ワークスペースにコピーします。

             ```bash
             git clone https://github.com/newrelic/helm-charts.git
             cd helm-charts/charts/nr-k8s-otel-collector/examples/k8s-with-atp/rendered
             ```

          2. `daemonset.yaml`と`deployment.yaml`ファイルの両方でコレクター イメージを更新します。

             変更前:

             ```yaml
             image: docker.io/newrelic/nrdot-collector-k8s
             ```

             に：

             ```yaml
             image: docker.io/newrelic/nrdot-collector:<NRDOT_COLLECTOR_LATEST_VERSION>
             ```

             <Callout variant="important">
               これはKubernetesインストレーションの実験用ビルドです。 最新バージョンは[リリース ページ](https://github.com/newrelic/nrdot-collector-releases/releases)からご確認ください。
             </Callout>
        </Step>

        <Step>
          ### ライセンスキーとクラスター名を設定する [#manifest-config]

          1. Base64 でエンコードされたNew Relicライセンスキーを使用して`secret.yaml`ファイルを更新します。

             ```yaml
             data:
               licenseKey: <YOUR_BASE64_ENCODED_LICENSE_KEY>
             ```

             ライセンスキーをエンコードするには:

             * **Linux / macOS：** `echo -n "<YOUR_LICENSE_KEY>" | base64`
             * **Windows (PowerShell):** `[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes("<YOUR_LICENSE_KEY>"))`

          2. `daemonset-configmap.yaml`ファイルと`deployment-configmap.yaml`ファイルの両方でクラスター名を更新します。

             `k8s.cluster.name`のインスタンスを探し、 `<YOUR_CLUSTER_NAME>`希望のクラスター名に置き換えます。

             ```yaml
             - key: k8s.cluster.name
               action: upsert
               value: YOUR_CLUSTER_NAME  # Replace with your cluster name
             ```
        </Step>

        <Step>
          ### マニフェストをデプロイする [#manifest-deploy]

          1. `newrelic`ネームスペースを作成し、マニフェストを適用します。

             ```bash
             kubectl create namespace newrelic
             kubectl apply -n newrelic -R -f .
             ```

          2. ポッドが実行されていることを確認します。

             ```bash
             kubectl get pods -n newrelic --watch
             ```

          3. [書き込み](https://docs.newrelic.com/docs/query-your-data/explore-query-data/query-builder/introduction-query-builder/)ビルダーで次の書き込みを実行して、 New Relicプロセス データを受信していることを確認します。

             ```sql
             FROM Metric SELECT *
             WHERE k8s.cluster.name='<YOUR_CLUSTER_NAME>'
             AND metricName LIKE 'process.%'
             LIMIT 100
             ```

             ```sql
             FROM Metric SELECT uniqueCount(metricName)
             WHERE k8s.cluster.name='<YOUR_CLUSTER_NAME>'
             AND metricName LIKE 'process.%'
             ```
        </Step>

        <Step>
          ### New RelicでATPデータにアクセスする [#access-data]

          ATP が構成されると、 Kubernetesクラスタからのデータの収集が開始されます。 このデータには New Relic OpenTelemetry UI からアクセスできます。New Relic OpenTelemetry UI の詳細については、 [OpenTelemetry APM UI](/docs/opentelemetry/get-started/apm-monitoring/opentelemetry-apm-ui)を参照してください。

          **New Relicで ATP プロセスのメトリクス データを表示するには:**

          1. **<DNT>[one.newrelic.com](https://one.newrelic.com) &gt; All Entities</DNT>**へ移動します。

             また

             <DNT>**[one.newrelic.com](https://one.newrelic.com) &gt; Catalogs &gt; Infrastructure**</DNT>に移動します。

          2. ATP を使用して NRDOT コレクターをインストールしたエンティティを検索します。

          3. エンティティを選択し、左側のペインで**<DNT>Process</DNT>**をクリックします。

             <DNT>Process</DNT>ページでは、実行中のすべてのプロセスとその ID、CPU およびメモリ使用率のメトリクスを表示できます。 また、プロセスが他のプロセスを生成する場合、プロセス間の親子関係も表示されます。

             <img style={{ align: 'left' }} title="ATP process metrics in New Relic OpenTelemetry UI" alt="ATP process metrics in New Relic OpenTelemetry UI" src="/images/atp-process-metrics.webp" />
        </Step>
      </Steps>
    </TabsPageItem>
  </TabsPages>
</Tabs>

## ATP設定オプション [#atp-config]

ATP を有効にすると、次の設定が自動的に適用されます。

<table>
  <thead>
    <tr>
      <th>
        パラメータ
      </th>

      <th>
        説明
      </th>

      <th>
        デフォルト値
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        `enable_atp`
      </td>

      <td>
        ATP 機能を有効/無効にします。ATP を有効にするには

        `true`

        に設定します。
      </td>

      <td>
        `false`
      </td>
    </tr>

    <tr>
      <td>
        `images.collector.repository`
      </td>

      <td>
        ATP を使用するには

        `newrelic/nrdot-collector`

        に変更する必要があります。
      </td>

      <td>
        `newrelic/nrdot-collector-k8s`
      </td>
    </tr>

    <tr>
      <td>
        `images.collector.tag`
      </td>

      <td>
        ATP 対応コレクターのイメージタグ。
      </td>

      <td>
        `<TO_BE_CONFIRMED>`
      </td>
    </tr>
  </tbody>
</table>

/\* ## トラブルシューティング ATP \[トラブルシューティング] ### ATP がメトリクスをフィルタリングしていません \*\*問題\*\*: すべてのプロセス メトリクスが送信されており、フィルタリングされていません。 \*\*解決策\*\*: 1. \*\*ATP が有効であることを確認します\*\*: \`\`\`bash kubectl get configmap -n newrelic nr-k8s-otel-コレクター-daemonset-config -o yaml | grepadaptivetelemetry \`\`\` 2. \*\*ATP がパイプラインにあることを確認します\*\*: \`Metriks/nr\` パイプラインで \`adaptivetelemetry\` を探します。 3. \*\*正しいコレクター イメージを使用していることを確認します\*\*: \`\`\`bash kubectl get daemonset -n newrelic nr-k8s-otel-コレクター-daemonset -o yaml | grep &quot;image:&quot; \`\`\` 期待されるもの: \`newrelic/nrdot-collectors:1.11.0\` (またはそれ以降) \*\*NOT\*\*: \`newrelic/nrdot-collector-k8s:1.11.0\` 4. \*\*\`values.yaml\` または ConfigMap で \`enable\_atp\` が \`true\` に設定されていることを確認します\*\*。 ### ポッドが起動しない \*\*問題\*\*: Collectorが起動に失敗します。 \*\*解決策\*\*: 1. \*\*ポッドログを確認します\*\*: \`\`\`bash kubectl ログ -n newrelic -l app.kubernetes.io/name=nr-k8s-otel-collector \`\`\` 2. \*\*ライセンスキーが正しくエンコードされていることを確認します\*\*: \`\`\`bash kubectl get secret -n newrelic nr-k8s-otel-コレクター-config -o yaml \`\`\` 3. \*\*リソース制限を確認します\*\*: クラスタにコレクター ポッド用の十分なリソースがあることを確認してください。 ### New Relicにデータがない \*\*問題\*\*: 導入後にNew Relicにメトリクスが表示されません。 \*\*解決策\*\*: 1. \*\*New Relic UI にデータが表示されるまで \*\*2～5 分待ちます\*\*。 2. \*\*クラスター名\*\* が設定で設定した名前と一致していることを確認します\*\*。3. \*\*コレクター ログ\*\*で接続エラーを確認します: \`\`\`bash kubectl ログ -n newrelic -l app.kubernetes.io/name=nr-k8s-otel-コレクター | grep -i エラー \`\`\` \*/

## 関連資料 [#related-resources]

<DocTiles>
  <DocTile title="トラブルシューティング" path="/docs/opentelemetry/nrdot/atp/troubleshooting">
    ご使用の環境における ATP の問題をトラブルシューティングする方法を学びます。
  </DocTile>

  <DocTile title="データのクエリ" path="/docs/opentelemetry/nrdot/atp/query">
    NRQL を使用して New Relic で ATP データをクエリする方法を学びます。
  </DocTile>

  <DocTile title="高度な機能" path="/docs/opentelemetry/nrdot/atp/advanced-features">
    ATP デプロイメントの高度な機能を有効にする方法を学びます。
  </DocTile>
</DocTiles>
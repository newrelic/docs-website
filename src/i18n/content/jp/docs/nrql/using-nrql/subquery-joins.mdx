---
title: サブクエリ結合を使用してクエリを組み合わせる
tags:
  - Query your data
  - 'NRQL: New Relic Query Language'
  - NRQL query tutorials
metaDescription: 'For New Relic query language (NRQL): how to use subquery joins.'
freshnessValidatedDate: '2024-03-19T00:00:00.000Z'
translationType: human
---

New Relic 内に保存されるデータの多くは、他のデータ（`Transaction`と`TransactionError` 、 `PageView`と`PageAction` 、 `Log`とインフラストラクチャイベントなど）に関連しています。サブクエリ結合を使用して分析を実行し、これらのイベント間の相関関係を計算できます。

## サブクエリ結合の書き方

[サブクエリ](/docs/query-your-data/nrql-new-relic-query-language/get-started/subqueries-in-nrql)は、別のクエリ内にネストされたクエリです。サブクエリの結合を使用すると、キーに基づいてサブクエリの結果とその外部クエリの結果を組み合わせることができ、データセット全体の分析と拡充が可能になります。

サブクエリ結合には、2つのデータセットとその2つをリンクする主キーという、3つのコンポーネントが必要です。

```sql
FROM Event [INNER|LEFT] JOIN (subquery) ON [key =] key SELECT ...
```

サブクエリ結合には、構文に対する簡単なルールが含まれます。

* `JOIN`句は、常に`FROM`句の直後に続く必要があります。
* `JOIN`の前に結合タイプを付けることができます。`INNER`または`LEFT`はオプションであり、省略された場合はデフォルトで`INNER`になります。
* サブクエリを含む括弧は、 `JOIN`句の直後に続く必要があります。
* `ON`句はサブクエリの直後に続く必要があり、2つの形式があります（詳細は下記を参照）。

1つのクエリに複数の`JOIN`句を含めることもできます。たとえば、次のクエリではサブクエリ内で2つの`JOIN`を使用します。

```sql
FROM JavaScriptError
  JOIN (
    FROM PageAction
      JOIN (
        FROM PageView SELECT count(*) FACET session AS pageViewSession, city
        LIMIT MAX
      ) ON session = pageViewSession
    SELECT count(*) FACET city, currentUrl, session AS pageActionSession
  ) ON session = pageActionSession
SELECT count(*) FACET city, currentUrl, session, errorClass
```

以下の画像には、インフラストラクチャコンテナ（`ProcessSample`）の平均CPUパーセンテージと、コンテナによるアプリの平均継続時間という、2つのデータセットが含まれています。

<img title="Datasets related by container ID" alt="Datasets Related by Container ID" src="/images/nrql-join-tutorial-rows-sidebyside.webp" />

多くの場合、異なるソースからのデータは相関しています。この場合、次のサブクエリ結合を使用して、コンテナのCPU使用率が高いことがトランザクションの速度低下の原因になっているかどうかを判断できます。

```sql
FROM Transaction
  JOIN (FROM ProcessSample SELECT average(cpuPercent) AS cpu
  FACET containerId LIMIT MAX) ON containerId
SELECT average(duration)/latest(cpu) FACET containerId, containerName
```

<img title="Datasets Joined by Container ID" alt="Datasets Joined by Container ID" src="/images/nrql-join-tutorial-rows-joined.webp" />

このクエリを使用すると、CPU 使用率を考慮して平均トランザクション期間が長いコンテナを確認し、外れ値を調査して、修正すべきバグや最適化を行う必要があるかどうかを確認できます。

## サブクエリ結合の制限 [#subquery-join-limitations]

サブクエリ結合には次の制限があります。

* 結合されたサブクエリのデフォルトの[`LIMIT`](#sel-limit)は10で、最大`LIMIT`は5,000です。外部クエリの`LIMIT`は内部クエリに影響を及ぼしません。
* 結合サブクエリでの`TIMESERIES`の使用はサポートされていません。外部クエリで`TIMESERIES`を使用する場合、結合されたサブクエリはクエリの全期間に単一の結果を提供することに注意してください。
* 結合サブクエリでは、`COMPARE WITH`の使用はサポートされていません。外部クエリで`COMPARE WITH`を使用する場合、結合されたサブクエリはクエリの基本タイムスパンに基づいて単一の結果を提供し、タイムスパンと比較した外部クエリの個別の値を提供しないことに注意してください。
* すべてのサブクエリと同様に、結合されたサブクエリはアラート条件では使用できません。
* `SELECT *`は親クエリではサポートされていますが、結合されたサブクエリではサポートされていません。
* 結合のカーディナリティは1:100に制限されています。つまり、1つの結合キーはサブクエリ結果の100行以上にマップできません。
* `ON`句は等価条件のみをサポートします。
* `JOIN`キーは、メトリクス値のような複雑な属性にすることはできません。
* `JOIN`条件では属性タイプの強制変換は行われません。`JOIN`の`ON`条件の左側は、 `ON`条件の右側と同じタイプである必要があります。
* メトリクスワイルドカードは、 `JOIN`の`ON`条件ではサポートされていません
* サブクエリをメトリクスの行単位のクエリにすることはできません。
* `JOIN`の`ON`条件の右側は、クエリによって投影された識別子である必要があります。関数や数学演算は使用できません。
* 結合されたサブクエリは`uniques()`結果を投影できません。

## サブクエリ結合の例 [#subquery-join-examples]

以下にサブクエリ結合の例を示します。

<CollapserGroup>
  <Collapser id="add-missing-data" title="不足しているデータを追加する">
    この例では、APMデータは2つの場所に存在します。 `PageView`エンドユーザーがアクセスしたページに関する情報を提供し、 `PageAction`ページで実行されたアクションを提供します。これら2つのイベントには両方ともエンドユーザーのセッションを識別するセッションIDがありますが、一部のデータは一方のイベントに含まれ、もう一方のイベントには含まれません。

    ここで、 `city`は`PageView`属性ですが`PageAction`属性ではありません。一方、 `currentUrl`は`PageAction`の属性ですが`PageView`属性ではありません。

    <img title="Datasets Related by Session ID" alt="Datasets Related by Session ID" src="/images/nrql-join-tutorial-aggregates-sidebyside.webp" />

    サブクエリ結合を使用すると、欠落しているデータで`PageAction`データセットを拡充できます。セッションIDを使用してデータを組み合わせると、クリック数が最も多いURLだけでなく、これらのアクションが世界中のどこから発生したかを確認できます。

    ```sql
    FROM PageAction
      JOIN (FROM PageView SELECT count(*) FACET session, city
      LIMIT MAX) ON session
    SELECT count(*) FACET city, currentUrl
    ```

    <img title="Datasets Joined by Session ID" alt="Datasets Joined by Session ID" src="/images/nrql-join-tutorial-aggregates-joined.webp" />

    ヒント：外部クエリに結合される結果の数を最大化するには、内部サブクエリに`LIMIT MAX`を含めます。現在の最大結果制限は 5,000 行です。
  </Collapser>

  <Collapser id="calculations-across-datasets" title="データセット間の計算">
    この例では、2 つのログデータセットが互いに一致するように解析され、計算が実行されてログエラーの割合が調べられます。

    ログには、ログメッセージ内にデータが埋め込まれている場合があります。`aparse()`のような強化された文字列解析関数を使用すると、キーの値を抽出できます。 この場合、主キーのアプリケーションIDは、 `Log`と`Log_Error`の両方のログメッセージ内にあります。

    <img title="Datasets Related by App ID" alt="Datasets Related by App ID" src="/images/nrql-join-tutorial-calculations-sidebyside.webp" />

    アプリケーション別のエラー率を調べるには、 `LEFT JOIN`が必要です。これは、すべてのアプリケーションにエラーがあるわけではなく、 `INNER JOIN`によってこれらのアプリケーションが除外されるためです。

    ```sql
    WITH numeric(aparse(message, '%applicationId: * %')) AS application_Id
    FROM Log
      LEFT JOIN (FROM Log_Error SELECT count(*) AS errCnt
         FACET numeric(aparse(message, '%appId: * %')) AS app_Id
         SINCE 1 day ago LIMIT MAX) ON application_Id=app_Id
    SELECT (latest(errorCount) OR 0)/count(*) AS errorPercentage
    FACET app_name, application_Id SINCE 1 day ago
    ```

    <img title="Datasets Joined by App ID" alt="Datasets Joined by App ID" src="/images/nrql-join-tutorial-calculations-joined.webp" />

    データが2つの異なるログパーティションに保存されており、アプリケーションIDがログメッセージに隠されていたとしても、サブクエリ結合により必要なデータを解析し、エラーの割合を計算することができました。`latest()`を使用すると、内部クエリの集計が外部クエリで正しく計算されていることを確認するのにも役立ちました。
  </Collapser>
</CollapserGroup>
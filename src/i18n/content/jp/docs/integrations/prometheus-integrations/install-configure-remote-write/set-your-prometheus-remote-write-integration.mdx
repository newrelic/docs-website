---
title: Prometheusリモート書込みインテグレーションのセットアップ
tags:
  - Integrations
  - Prometheus integrations
  - Install and configure remote write
metaDescription: How to set up or remove your Prometheus remote write integration to New Relic.
---

いくつかの簡単のステップで、New RelicでPrometheusデータフローを取得できます。このページでは、リモート書込みインテグレーションの基本的な設定や、いくつかの一般的なトラブルシューティングのトピックを取り上げます。高可用性（HA）設定でのPrometheusサーバーのインテグレーションに関する情報は、[Prometheusの高可用性](/docs/prometheus-high-availability-ha)ドキュメントをご覧ください。

<Callout variant="tip">
  Prometheusインテグレーションとinfrastructureモニタリング、およびその他の[オブザーバビリティプラットフォーム](https://one.newrelic.com)を使用するには、New Relicファミリーに参加してください。[サインアップ](https://newrelic.com/signup)して、わずか数秒で無料アカウントを作成できます。次に、毎月最大で100GBのデータを無料で取り込みます。期間無制限です。
</Callout>

## インテグレーションの設定 [#setup]

[New Relic OneのPrometheusリモート書込みセットアップランチャーに移動](https://one.newrelic.com/launcher/nr1-core.settings?pane=eyJuZXJkbGV0SWQiOiJwcm9tZXRoZXVzLXJlbW90ZS13cml0ZS1pbnRlZ3JhdGlvbi1uZXJkbGV0cy5zZXR1cC1wcm9tZXRoZXVzIn0=)してから、これらのステップを実行します。

<ButtonLink
  data-tessen="stitchedPathLinkClick"
  role="button"
  to="https://one.newrelic.com/launcher/nr1-core.settings?pane=eyJuZXJkbGV0SWQiOiJwcm9tZXRoZXVzLXJlbW90ZS13cml0ZS1pbnRlZ3JhdGlvbi1uZXJkbGV0cy5zZXR1cC1wcm9tZXRoZXVzIn0="
  variant="primary"
>
  Prometheusデータを追加する
</ButtonLink>

1. 接続するPrometheusサーバーの名前と`remote_write` URLを入力します。**重要:** サーバーに対して入力した名前によって、データに属性が作成されます。これは、New Relicにデータを送信しているPrometheusサーバーを識別する名前にもなります。
2. 新たな`remote_write` URLを、Prometheus YMLファイルに追加します。`グローバル`セクションと同じインデントにあるファイル内の`global_config`の下にこの情報を追加します。

   以下の構文を使用します.

   ```
   remote_write: 
   - url: https://metric-api.newrelic.com/prometheus/v1/write?prometheus_server=<var>YOUR_DATA_SOURCE_NAME</var>  
     bearer_token:<var>YOUR_LICENSE_KEY</var>
   ```

   または

   ```
   remote_write: 
   - url: https://metric-api.newrelic.com/prometheus/v1/write?X-License-Key=<var>YOUR_LICENSE_KEY</var>&prometheus_server=<var>YOUR_DATA_SOURCE_NAME</var>
   ```

   **EUのアカウント：** EUから接続している場合は、以下のURLを使用してください.

   ```
   https://metric-api.eu.newrelic.com/prometheus/v1/write
   ```

   **KubernetesおよびHelmリモート書き込みインテグレーション：** リモート書き込みURLをHelm [`values.yaml`](https://github.com/helm/charts/blob/c40486ab2eba0391119b7cc1509d6958fd21c31d/stable/prometheus/values.yaml#L631)ファイルに追加します。`remoteWrite: []`を以下の例のような2行で置き換えます。リモート書き込みURLを使用し、残りのファイルに一致するインデントを使用してください。

   ```
   remoteWrite: 
   - url: https://metric-api.newrelic.com/prometheus/v1/write?prometheus_server=<var>YOUR_DATA_SOURCE_NAME</var> 
     bearer_token:<var>YOUR_LICENSE_KEY</var>
   ```
3. Prometheusサーバーを再起動します。
4. New Relic UIでデータを表示する例えば、インテグレーションをセットアップするときに自動的に作成されるリモート書き込み[ダッシュボード](/docs/query-your-data/explore-query-data/dashboards/introduction-dashboards)を使用します。

## Prometheusメトリックタイプのマッピング [#mapping]

Prometheusリモート書き込みプロトコルでは、New Relicにメトリックを送信するときに、[メトリックタイプ](/docs/telemetry-data-platform/ingest-manage-data/understand-data/metric-data-type#metric-types)の情報や、その他の有用なメトリックメタデータが含まれません。リモート書き込みプロトコルにはこの情報が含まれていないため、New RelicはPrometheusの命名規則に基づいてメトリックタイプを推測します。これらの命名規則に従わないメトリクスは、正しくマッピングされない場合があります。

New Relicは、以下に示すPrometheusメトリックの命名規則に基づいてPrometheusメトリックタイプをNewRelicメトリックタイプにマッピングします。

* `metricName_bucket`はNew Relicカウントメトリクスタイプとして保存されます。
* `metricName_count`はNew Relicカウントメトリクスタイプとして保存されます。
* `metricName_total`はNew Relicカウントメトリクスタイプとして保存されます。
* `metricName_sum`はNew Relicサマリーメトリクスタイプとして保存されます。

それ以外はすべて、New Relicゲージメトリックタイプとして保存されます。

## メトリクスタイプマッピングを上書きする [#override-mapping]

Prometheus命名規則に従っていないメトリクスがある場合、メトリクスタイプを示す`newrelic_metric_type`ラベル付きのメトリクスでリモート書き込みをタグに設定できます。このラベルは、New Relicによって受信されると無効になります。

**例:** `my_counter`という名前のカウンターメトリクスがあります。これには、`_bucket`, `_count`または`_total`という当社の命名規則のサフィックスがありません。この状況では、メトリクスはカウンターではなくゲージとして識別されます。これを修正するには、以下の再ラベル設定を`prometheus.yml`に追加します。

```
- url: https://metric-api.newrelic.com/prometheus/v1/write?X-License-Key=...
  write_relabel_configs:
  - source_labels: [__name__]
    regex: ^my_counter$
    target_label: newrelic_metric_type
    replacement: "counter"
    action: replace
```

このルールは`my_counter`という名前のメトリクスに一致し、そのメトリクスをカウンターとして識別する`newrelic_metric_type`ラベルを追加します。以下の（大文字と小文字を区別する）値を代替値として使用できます。

* counter
* ゲージ
* 概要

`newrelic_metric_type`ラベルが受け取ったメトリクス上にあり、有効な値の1つに設定されている場合、New Relicは、データパイプライン内のダウンストリーム消費前に、示されたタイプをメトリクスに割り当てます（また、ラベルを無効化します）。上記の命名規則に従わない複数のメトリクスがある場合、複数の規則を追加でき、各規則は様々なソースラベルに一致させます。

## リモート書込みの動作をカスタマイズする [#customize]

New Relicで複数のアカウントに書き込みを行っている場合、または複数のPrometheusデータソースをNew Relicの同じアカウントに接続している場合、以下のパラメーターをカスタマイズできます。詳細については、[リモート書き込みチューニングに関するドキュメント](https://prometheus.io/docs/practices/remote_write/)を参照してください。

<CollapserGroup>
  <Collapser
    id="x-license-key"
    title="X-ライセンスキー"
  >
    アカウントの[ライセンスキー](/docs/accounts/install-new-relic/account-setup/license-key)は、APIキーではありません。ライセンスキーは、認証と、どのアカウントにデータを書き込むかの特定に使用します。様々なNew Relicアカウントやサブアカウントに書き込むようPrometheusを設定している場合、それぞれのリモート書込みURLで異なるキーを使用します。
  </Collapser>

  <Collapser
    id="prometheus_server-url-parameter"
    title={<><InlineCode>prometheus_server</InlineCode> URLパラメーター</>}
  >
    `prometheus_server`パラメーターは、[NRDB](https://newrelic.com/resources/ebooks/inside-nrdb-flexible-unified-database)に書き込まれる統計を追加するのに使用するラベルまたは属性です。[Grafanaデータソースを設定](/docs/configure-prometheus-data-source-grafana)して、結果を特定の`prometheus_server`からのものに限定する場合、これと同じラベルを使用します。
  </Collapser>

  <Collapser
    id="optimize-throughput"
    title="スループットとメモリ消費を最適化する"
  >
    リモート書き込み[を使用すると、Prometheusサーバーの合計メモリ消費量](https://prometheus.io/docs/practices/remote_write/#memory-usage)が増加します。

    問題が発生している場合は、次の手順をお勧めします。

    * スループットの高いワークロードの場合は[`容量`](https://prometheus.io/docs/practices/remote_write/#capacity)の増加に比例して、[`max_samples_per_send`](https://prometheus.io/docs/practices/remote_write/#max_samples_per_send)を増やします。
    * それでもメモリ消費が問題になる場合は、サーバーあたりの [`max_shards`](https://prometheus.io/docs/practices/remote_write/#max_shards)の数を制限してください。
  </Collapser>
</CollapserGroup>

## エラーメッセージのトラブルシューティング [#error-messages]

New Relicからインテグレーションのエラーメッセージを受信、またはPrometheusサーバーの再起動後にPrometheusサーバーログでエラーメッセージを受信した場合、[リモート書き込みのトラブルシューティング ドキュメント](/docs/integrations/prometheus-integrations/install-configure-remote-write/remote-write-errors-error-messages)を確認してください。これには、欠落した文字や不正な文字、不正なリクエスト、長すぎるリクエストエンティティ、レート制限エラーなど、一般的なエラーの修正方法が含まれています。

## インテグレーションを削除する [#remove-integration]

Prometheusリモート書き込みインテグレーションを削除すると、新規データのフローが停止しますが、過去データのパージや削除は行われません。インテグレーションを削除するには、Prometheus YMLファイルから設定コードスニペットを削除してから、サーバーを再起動します。

## その他のヘルプ [#more_help]

さらに支援が必要な場合は、これらのサポートと学習リソースを確認してください：

* [Explorers Hub](https://discuss.newrelic.com/)を参照して、コミュニティから支援を受け、ディスカッションに参加してください。
* [当社のサイトで回答を見つけ、サポートポータルの使用方法について学びます](/docs/using-new-relic/welcome-new-relic/get-started/find-help-use-support-portal)。
* Linux、Windows、およびmacOSのトラブルシューティングツールである[New Relic Diagnosticsを実行します](/docs/using-new-relic/cross-product-functions/troubleshooting/new-relic-diagnostics)。
* New Relicの[データセキュリティ](/docs/security)と[ライセンス](/docs/licenses)ドキュメントを見直してください。

---
title: セキュリティデータクエリの例
metaDescription: Ready-to-use NRQL queries for analyzing vulnerability data in Security RX.
freshnessValidatedDate: never
translationType: machine
---

このガイドでは、一般的なセキュリティ監視および分析シナリオですぐに使用できる NRQL クエリを提供します。これらの書き込みを書き込みビルダーにコピーするか、カスタムダッシュボードに追加して、インサイトの脆弱性データをより深く取得します。

基礎となるデータ構造の詳細については、 [「セキュリティ データ構造リファレンス」を](/docs/vulnerability-management/advanced/data-structure)参照してください。

## 経営報告

### 深刻度別の未解決の脆弱性の総数

脆弱性の露出についての概要を取得します。

```sql
FROM Vulnerability
SELECT count(*) as 'Total Vulnerabilities'
WHERE state = 'OPEN'
FACET severity
SINCE 1 day ago
```

### 重大かつ深刻な傾向

重大な脆弱性が時間の経過とともにどのように変化するかを追跡します。

```sql
FROM Vulnerability
SELECT count(*) as 'Critical & High Vulnerabilities'
WHERE severity IN ('CRITICAL', 'HIGH')
AND state = 'OPEN'
TIMESERIES AUTO
SINCE 30 days ago
```

### エンティティ別の脆弱性

最も脆弱性のあるアプリケーションまたはホストを特定します。

```sql
FROM Vulnerability
SELECT count(*) as 'Vulnerability Count'
WHERE state = 'OPEN'
FACET entity.name
LIMIT 20
SINCE 1 day ago
```

### ポートフォリオ全体の脆弱性分布

脆弱性の拡散を理解する:

```sql
FROM Vulnerability
SELECT percentage(count(*), WHERE severity = 'CRITICAL') as 'Critical %',
       percentage(count(*), WHERE severity = 'HIGH') as 'High %',
       percentage(count(*), WHERE severity = 'MEDIUM') as 'Medium %',
       percentage(count(*), WHERE severity = 'LOW') as 'Low %'
WHERE state = 'OPEN'
SINCE 1 day ago
```

## 優先順位付けとリスク評価

### 優先度の高い脆弱性

悪用される可能性が高い脆弱性を見つける:

```sql
FROM Vulnerability
SELECT cveId, affectedPackage, affectedVersion, cvssScore, epssPercentile
WHERE epssPercentile > 90
AND state = 'OPEN'
ORDER BY epssPercentile DESC
LIMIT 50
SINCE 7 days ago
```

### アクティブなランサムウェアの脆弱性

ランサムウェア キャンペーンで使用される脆弱性を特定します。

```sql
FROM Vulnerability
SELECT cveId, affectedPackage, cvssScore, entity.name
WHERE activeRansomware = true
AND state = 'OPEN'
FACET cveId, entity.name
SINCE 30 days ago
```

### 新たに検出された重大な脆弱性

新しい重要な発見を監視する:

```sql
FROM Vulnerability
SELECT cveId, affectedPackage, affectedVersion, entity.name, detectedAt
WHERE severity = 'CRITICAL'
AND state = 'OPEN'
AND detectedAt > ago(24 hours)
ORDER BY detectedAt DESC
```

### 早急な対応が必要な脆弱性

複数のリスク要因を組み合わせる:

```sql
FROM Vulnerability
SELECT cveId, entity.name, affectedPackage, cvssScore, epssPercentile
WHERE (
  (severity = 'CRITICAL' AND epssPercentile > 85) OR
  (activeRansomware = true) OR
  (epssPercentile > 95)
)
AND state = 'OPEN'
FACET cveId, entity.name
SINCE 7 days ago
```

## 露出と修復の追跡

### 脆弱性露出時間の平均

平均修復時間 (MTTR) を計算します。

```sql
FROM Vulnerability
SELECT average((resolvedAt - detectedAt) / 86400) as 'Avg Days to Resolve'
WHERE state = 'CLOSED'
FACET severity
SINCE 90 days ago
```

### 最も長く放置されている脆弱性

長期間にわたって未解決となっている脆弱性を見つけます。

```sql
FROM Vulnerability
SELECT cveId, entity.name, affectedPackage, detectedAt,
       (max(timestamp) - detectedAt) / 86400 as 'Days Open'
WHERE state = 'OPEN'
FACET cveId, entity.name
ORDER BY 'Days Open' DESC
LIMIT 20
SINCE 90 days ago
```

### 修復速度

脆弱性をどれだけ早く解決しているかを追跡します。

```sql
FROM NrAiIncidentTimeline
SELECT count(*) as 'Vulnerabilities Resolved'
WHERE event = 'STATUS_CHANGED'
AND newState = 'CLOSED'
FACET weekOf(timestamp)
SINCE 90 days ago
TIMESERIES 1 week
```

### 年齢区分別の脆弱性

脆弱性を、公開されてからどのくらいの期間が経過したかによってグループ化します。

```sql
FROM Vulnerability
SELECT count(*) as 'Count'
WHERE state = 'OPEN'
FACET cases(
  WHERE (now() - detectedAt) / 86400 <= 7 as '0-7 days',
  WHERE (now() - detectedAt) / 86400 <= 30 as '8-30 days',
  WHERE (now() - detectedAt) / 86400 <= 90 as '31-90 days',
  WHERE (now() - detectedAt) / 86400 > 90 as '> 90 days'
)
SINCE 180 days ago
```

## パッケージとライブラリの分析

### 最も脆弱なライブラリ

最も多くの脆弱性をもたらすライブラリを特定します。

```sql
FROM Vulnerability
SELECT count(*) as 'Vulnerability Count'
WHERE state = 'OPEN'
FACET affectedPackage
ORDER BY count(*) DESC
LIMIT 10
SINCE 30 days ago
```

### アップグレードが必要なライブラリ

利用可能な修正を含むパッケージを検索します。

```sql
FROM Vulnerability
SELECT affectedPackage, affectedVersion, fixedVersion, count(*) as 'Vulnerable Entities'
WHERE state = 'OPEN'
AND fixedVersion IS NOT NULL
FACET affectedPackage, affectedVersion, fixedVersion
ORDER BY count(*) DESC
LIMIT 20
SINCE 7 days ago
```

### ソース別の脆弱性検出

どの統合に脆弱性があるかを理解します。

```sql
FROM Vulnerability
SELECT count(*) as 'Detections'
FACET source
SINCE 30 days ago
```

### Java依存関係分析

Java 固有の脆弱性に焦点を当てる:

```sql
FROM Vulnerability
SELECT count(*) as 'Vulnerabilities'
WHERE affectedPackage LIKE '%.jar'
OR affectedPackage LIKE '%maven%'
FACET affectedPackage, severity
SINCE 30 days ago
```

## エンティティ固有のクエリ

### アプリケーションの脆弱性の概要

特定のアプリケーションの脆弱性の数を取得します。

```sql
FROM Vulnerability
SELECT count(*) as 'Total',
       filter(count(*), WHERE severity = 'CRITICAL') as 'Critical',
       filter(count(*), WHERE severity = 'HIGH') as 'High',
       filter(count(*), WHERE severity = 'MEDIUM') as 'Medium',
       filter(count(*), WHERE severity = 'LOW') as 'Low'
WHERE entity.name = 'YOUR_APP_NAME'
AND state = 'OPEN'
SINCE 1 day ago
```

### ホストの脆弱性の内訳

インフラストラクチャ ホストの脆弱性を分析します。

```sql
FROM Vulnerability
SELECT count(*) as 'Vulnerabilities'
WHERE entityType = 'HOST'
AND state = 'OPEN'
FACET entity.name, severity
LIMIT 50
SINCE 7 days ago
```

### 最近スキャンされていないエンティティ

脆弱性データを報告していない可能性のあるエンティティを特定します。

```sql
FROM Vulnerability
SELECT entity.name, max(timestamp) as 'Last Scan'
FACET entity.name
HAVING max(timestamp) < ago(7 days)
SINCE 30 days ago
```

## ステータスとワークフローの追跡

### 検討が必要な脆弱性を無視

レビュー日が近づいている無視された脆弱性を見つけます。

```sql
FROM NrAiIncidentTimeline
SELECT incidentId, entity.name, reason, timestamp as 'Ignored At'
WHERE event = 'STATUS_CHANGED'
AND newState = 'IGNORED'
AND timestamp < ago(60 days)
FACET incidentId, entity.name
SINCE 90 days ago
```

### ステータス変更監査証跡

ステータスの変更を行っているユーザーを追跡します。

```sql
FROM NrAiIncidentTimeline
SELECT timestamp, entity.name, previousState, newState, changedBy, reason
WHERE event = 'STATUS_CHANGED'
ORDER BY timestamp DESC
LIMIT 100
SINCE 30 days ago
```

### 誤認率

無視されている脆弱性と影響を受けている脆弱性の数を計算します。

```sql
FROM NrAiIncidentTimeline
SELECT filter(count(*), WHERE newState = 'IGNORED') as 'Ignored',
       filter(count(*), WHERE newState = 'AFFECTED') as 'Affected',
       percentage(filter(count(*), WHERE newState = 'IGNORED'), count(*)) as 'Ignore Rate %'
WHERE event = 'STATUS_CHANGED'
SINCE 90 days ago
```

## コンプライアンスと報告

### 30日以上経過した脆弱性（SLA追跡）

修復SLAを超える脆弱性を監視:

```sql
FROM Vulnerability
SELECT count(*) as 'Overdue Vulnerabilities',
       entity.name,
       severity
WHERE state = 'OPEN'
AND detectedAt < ago(30 days)
FACET entity.name, severity
SINCE 180 days ago
```

### クリティカル脆弱性の応答時間

重大な脆弱性がどれだけ迅速に解決されたかを追跡します。

```sql
FROM Vulnerability
SELECT percentile((resolvedAt - detectedAt) / 86400, 50, 75, 90, 95) as 'Days to Resolve'
WHERE severity = 'CRITICAL'
AND state = 'CLOSED'
SINCE 90 days ago
```

### 月刊脆弱性メトリクス

月次レポートを生成します:

```sql
FROM Vulnerability
SELECT count(*) as 'Total Detected',
       uniqueCount(entity.guid) as 'Affected Entities',
       filter(count(*), WHERE severity IN ('CRITICAL', 'HIGH')) as 'High Risk'
FACET monthOf(detectedAt)
SINCE 180 days ago
TIMESERIES 1 month
```

## 高度な分析

### 脆弱性爆発半径

多くのエンティティに影響を与える脆弱性を特定します。

```sql
FROM Vulnerability
SELECT cveId, count(entity.guid) as 'Affected Entities', max(cvssScore) as 'CVSS'
WHERE state = 'OPEN'
FACET cveId
HAVING count(entity.guid) > 5
ORDER BY count(entity.guid) DESC
LIMIT 20
SINCE 30 days ago
```

### セキュリティ衛生スコア

カスタム セキュリティ スコアを計算します。

```sql
FROM Vulnerability
SELECT 100 - (
  filter(count(*), WHERE severity = 'CRITICAL') * 10 +
  filter(count(*), WHERE severity = 'HIGH') * 5 +
  filter(count(*), WHERE severity = 'MEDIUM') * 2 +
  filter(count(*), WHERE severity = 'LOW') * 0.5
) as 'Security Score'
WHERE state = 'OPEN'
FACET entity.name
SINCE 1 day ago
```

### 脆弱性の種類別の傾向

アプリケーションとインフラストラクチャの脆弱性を比較します。

```sql
FROM Vulnerability
SELECT count(*) as 'Vulnerabilities'
WHERE state = 'OPEN'
FACET entityType
TIMESERIES AUTO
SINCE 30 days ago
```

## これらのクエリを使用する

### クエリビルダーで

1. **[one.newrelic.com &gt; All capabilities](https://one.newrelic.com/all-capabilities)&gt; Query your data**にアクセスしてください
2. このページからクエリをコピーして貼り付けます
3. **Run** \[実行]をクリックして結果を確認します
4. 必要に応じて時間範囲とフィルターを調整します

### カスタムダッシュボード

1. 新しいダッシュボードを作成するか、既存のダッシュボードを編集します
2. ウィジェットを追加し、**Query builder** \[クエリビルダー]を選択します
3. クエリを貼り付けて視覚化を構成する
4. ウィジェットをダッシュボードに保存する

### アラートで

1. **Alerts &gt; Create a condition**に進みます
2. 条件タイプとして**NRQL query** \[NRQLを]選択します
3. カウントまたは閾値を返す都度を使用します
4. 一括閾値と通知チャネルを設定する

アラートの詳細については、 [「脆弱性アラートの設定」を](/docs/vulnerability-management/advanced/set-up-alerts)参照してください。

## クエリをカスタマイズするためのヒント

### プレースホルダーを置き換える

* `'YOUR_APP_NAME'` - 実際のアプリケーション名に置き換えます
* `'YOUR_ENTITY_GUID'` - エンティティのGUIDに置き換えます
* 時間範囲（例： `SINCE 30 days ago` ） - ニーズに合わせて調整します

### 他のデータと組み合わせる

APMまたはインフラストラクチャ メトリクスを使用して脆弱性データを結合します。

```sql
FROM Vulnerability, Transaction
SELECT count(Vulnerability.cveId), average(Transaction.duration)
WHERE Vulnerability.entity.guid = Transaction.appId
AND Vulnerability.state = 'OPEN'
FACET Vulnerability.entity.name
SINCE 1 day ago
```

### 結果をエクスポート

すべてのクエリ結果は次のようになります。

* CSVとしてダウンロード
* ダッシュボードに追加
* API経由でエクスポート
* チームと共有

## 次は何ですか？

<DocTiles>
  <DocTile title="データ構造リファレンス" path="/docs/vulnerability-management/advanced/data-structure">
    イベントの種類と属性について詳しく学ぶ
  </DocTile>

  <DocTile title="アラートの設定" path="/docs/vulnerability-management/advanced/set-up-alerts">
    これらのクエリに基づいてアラートを作成する
  </DocTile>

  <DocTile title="NRQLドキュメント" path="/docs/nrql/get-started/introduction-nrql-new-relics-query-language">
    NRQL構文の詳細
  </DocTile>
</DocTiles>
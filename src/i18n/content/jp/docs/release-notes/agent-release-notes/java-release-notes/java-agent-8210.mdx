---
subject: Java agent
releaseDate: '2025-05-29'
version: 8.21.0
downloadLink: 'https://download.newrelic.com/newrelic/java-agent/newrelic-agent/8.21.0/'
features:
  - “Enhances visibility into Reactor flatMap calls”
  - ”Adds new instrumentation for Spring-Kafka”
  - “Adds kafka-clients-spans-consumer instrumentation with distributed tracing support“
  - “Adds KafkaConsumerConfig event support for Kafka 3.7+”
bugs:
  - “Fixes the distributed_tracing.sampler config”
  - “Fixes an Illegal Access Error that can occur when using Scala 2.12 and JDK 11”
  - “Fixes the netty.http2.frame_read_listener.start_transaction configuration”
  - “Adds a restriction on when to add distributed trace headers for SQS messages”
  - “Allows the org.crac JAR to be shadowed”
  - “Backports NullPointerException fix to older versions of vertx-core instrumentation”
  - “Prevents excessive transaction segments from being created by HttpUrlConnection method calls”
security:
  - '“Upgrades the com.newrelic.agent.java:infinite-tracing-protobuf for better security with infinite tracing”'
  - '“Replaces snakeyaml with com.konloch:safeyaml to address a security vulnerability”'
translationType: machine
---

<Callout variant="caution">
  **既知の問題**: このリリースには、Netty Reactor の特定の使用法でメモリ リークを引き起こす可能性がある既知の問題があります。別のバージョンの使用を検討してください。
</Callout>

<ButtonGroup>
  <ButtonLink role="button" to="https://download.newrelic.com/newrelic/java-agent/newrelic-agent/8.21.0/" variant="primary">
    このエージェントのバージョンをダウンロード
  </ButtonLink>
</ButtonGroup>

## 新機能と改善点

* Reactor `Mono.flatMap`呼び出し[2308](https://github.com/newrelic/newrelic-java-agent/pull/2308)の可視性が向上します
* コア Kafka クライアント ライブラリ[2312](https://github.com/newrelic/newrelic-java-agent/pull/2312)を使用する場合に Spring-Kafka とディストリビューティッド（分散）トレーシング用の新しい計装を追加します
* Kafka 3.7+ [2358](https://github.com/newrelic/newrelic-java-agent/pull/2358)の`KafkaConsumerConfig`イベント サポートを追加します

## 修正

* `distributed_tracing.sampler`構成[2330](https://github.com/newrelic/newrelic-java-agent/pull/2330)を修正しました

* Scala 2.12 および JDK 11 の使用時に発生する可能性のある不正アクセス エラーを修正しました。Scala 2.12 がエージェントによって検出できない場合 (システム クラスローダーをチェックします - 特に、sbt は Scala クラスをカスタム Scala ローダーにロードします)、システム プロパティ`-Dnewrelic.config.class_transformer.illegal_access_fix=true` [2334](https://github.com/newrelic/newrelic-java-agent/pull/2334)を介して修正を手動で有効にする機能フラグもあります。

* nettyの「不明」トランザクション[2274](https://github.com/newrelic/newrelic-java-agent/pull/2274) [2355](https://github.com/newrelic/newrelic-java-agent/pull/2355)を修正

  * この修正により、以前の netty 計装の変更が機能フラグの背後に移動され、HTTP2 トランザクションに関連する一部のケースで追加の可視性が提供されます。 この粒度を再度有効にするには (「不明」なトランザクションが表示される可能性があります)、次の構成設定を使用します。

  ```yaml
    netty:
      http2:
        frame_read_listener:
          start_transaction: true
  ```

  * 8.20 にはエージェント構成のロジック エラーがあるため、修正はエージェント バージョン 8.21 以降でのみ公式になります。

* SQS メッセージのディストリビューティッド（分散）トレーシング ヘッダーを追加するタイミングに関する制限を追加します。 これは、メッセージの内容のバイト数と属性のサイズに基づいています。・2353 サイズが 251 KB を超えるメッセージ、および/または 9 以上のプロパティを持つメッセージは、ディストリビューティッド（分散）トレーシング ヘッダーの追加の取得から除外されます[。](https://github.com/newrelic/newrelic-java-agent/pull/2353)

* 顧客環境との競合を防ぐために、 `org.crac` JAR をシャドウイングできるようにします。[2344](https://github.com/newrelic/newrelic-java-agent/pull/2344)

* PR #1927 で行われた変更をバックポートして、 `NullPointerExceptions`が`vertx-core`計装[2327](https://github.com/newrelic/newrelic-java-agent/pull/2327)の古いバージョンに渡されるのを防ぎます。

* `HttpUrlConnection`メソッド呼び出しによって過剰なトランザクションセグメントが作成されるのを防ぎます (例:`getInputStream` ) は、外部呼び出しに関連付けられていない場合に使用されます。この動作は、次の構成オプションによって制御できます: `NEW_RELIC_CLASS_TRANSFORMER_COM_NEWRELIC_INSTRUMENTATION_HTTPURLCONNECTION_VERBOSE=false` 、 sys prop `-Dnewrelic.config.class_transformer.com.newrelic.instrumentation.httpurlconnection.verbose=false` 、または`newrelic.yml`内の同等のスタンザ。デフォルト設定は`true` （つまり非外部`getInputStream`およびその他のレスポンス ハンドラー メソッドは以前と同じように報告されます。[2365](https://github.com/newrelic/newrelic-java-agent/pull/2365)

## セキュリティ

* 無限トレース[2339](https://github.com/newrelic/newrelic-java-agent/pull/2339)でセキュリティを強化するために`com.newrelic.agent.java:infinite-tracing-protobuf`をアップグレードします
* セキュリティ上の脆弱性[2333](https://github.com/newrelic/newrelic-java-agent/pull/2333)に対処するため、 `snakeyaml` `com.konloch:safeyaml`に置き換えます

## 廃止予定

次の 計算モジュールは非推奨であり、次のメジャー リリースで削除されます。

* `aws-wrap-0.7.0`
* `java.completable-future-jdk8`
* `play-2.3`
* `netty-3.4`
* `Struts v1`

## IAST

CSEC バージョン 1.7.0 [2348](https://github.com/newrelic/newrelic-java-agent/pull/2348)へのアップデート\
変更ログ: [https://github.com/newrelic/csec-java-agent/releases/tag/1.7.0](https://github.com/newrelic/csec-java-agent/releases/tag/1.7.0)

## 最新バージョンへのアップデート [#procedures]

現在使用中のJavaエージェントのバージョンを特定するには、`java -jar newrelic.jar -v`を実行します。Javaエージェントのバージョンがコンソールに出力されます。

次に、最新バージョンのJavaエージェントにアップデートするには、以下の手順に従います。

1. **すべて**の[Javaエージェントのルートディレクトリ](/docs/agents/manage-apm-agents/troubleshooting/find-agent-root-directory#java-agent)を別の場所にバックアップします。そのディレクトリの名前を`NewRelic_Agent#.#.#`に変更します。ここで、`#.#.#`はエージェントのバージョン番号です。
2. [エージェントをダウンロードします](/docs/release-notes/agent-release-notes/java-release-notes)。
3. 新しいエージェントのダウンロードファイルを解凍し、`newrelic-api.jar`と`newrelic.jar`を元の[Javaエージェントのルートディレクトリ](/docs/agents/manage-apm-agents/troubleshooting/find-agent-root-directory#java-agent)にコピーします。
4. 古い`newrelic.yml`とzipからダウンロードした新しい`newrelic.yml`を比較し、[必要に応じてファイルを更新します](#diff)。
5. Javaディスパッチャを再起動します。

Javaエージェントのアップデート後に問題が発生する場合は、バックアップしたNew Relicエージェントディレクトリから復元します。

## エージェント設定の差分のアップデート [#diff]

エージェントの新しいバージョンをリリースする際に、`newrelic.yml`に新しい設定を追加します。`diff`または別の差分ユーティリティを使用して変更内容を確認してから、新しい設定を古いファイルに追加できます。ライセンスキー、アプリ名、デフォルト設定の変更など、ファイルに対して行ったカスタマイズを上書きしないようにしてください。

たとえば、 Javaバージョン 7.10.0 および 7.11.0 のデフォルトの`newrelic.yml`ファイルを`diff`すると、コンソールに表示される結果は次のようになります。

```yaml
➜ diff newrelic_7.10.0.yml newrelic_7.11.0.yml
...
107a108,119
>       # Whether the log events should include context from loggers with support for that.
>       include_context_data:
>
>         # When true, application logs will contain context data.
>         enabled: false
>
>         # A comma separated list of attribute keys whose values should be sent to New Relic.
>         #include:
>
>         # A comma separated list of attribute keys whose values should not be sent to New Relic.
>         #exclude:
>
125a138
>
128c141
<     enabled: false
---
>     enabled: true
...
```

この例では、これらの行はJavaエージェント バージョン 7.11.0 のデフォルトの`newrelic.yml`に追加されました。 7.11.0 以降に移行する場合は、これらの新しい行を元の`newrelic.yml`に追加する必要があります。

## サポートステートメント:

* New Relic では、最新の機能とパフォーマンス上のメリットを確実に得られるよう、エージェントを定期的にアップグレードすることをお勧めします。さらに、古いリリースは[サポート終了](https://docs.newrelic.com/docs/using-new-relic/cross-product-functions/install-configure/notification-changes-new-relic-saas-features-distributed-software/)になるとサポートされなくなります。
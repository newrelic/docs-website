---
title: APMエクスペリエンスへのアップグレード
metaDescription: Learn how to upgrade your Lambda monitoring to the New Relic APM experience.
freshnessValidatedDate: never
translationType: machine
---

既存のLambda関数を最小限の労力で新しい統合監視エクスペリエンスにアップグレードできます。 この移行によりNew Relicの強化されたオブザーバビリティ機能を使用してLambda関数を監視できるようになります。 既存のLambda関数を一括でアップグレードすることも、一度に 1 つずつアップグレードすることもできます。 アップグレード プロセスは非侵入的であり、既存の機能のコード変更は必要ありません。

**前提条件**

* あなたのLambda関数はすでにNew Relicでインストゥルメントされています。
* Lambda関数は、 `python` 、 `nodejs` 、 `ruby` 、 `go` 、または`.NET`ランタイムで実行されています。 これらのランタイムのサポートされているバージョンの一覧を表示するには、 [互換性と要件のドキュメント](/docs/serverless-function-monitoring/aws-lambda-monitoring/instrument-lambda-function/compatibility-requirement-lambda-monitoring/)を参照してください。

## インストゥルメンテーション方法

次のいずれかの方法を使用して、既存のLambda関数をアップグレードできます。

* [New Relic UI](#ui)
* [CLIを使用して更新する](#cli)

<Callout variant="tip">
  New Relic [、 AWS](/docs/infrastructure/amazon-integrations/get-started/introduction-aws-integrations/)インテグレーションを使用してAWSアカウントをNew Relicに統合し、 Lambda関数を自動的に検出して監視することをお勧めします。 これにより、サーバーレス機能に New Relic APM の全機能を活用できるようになります。
</Callout>

#### New Relic UI [#ui]

New Relic UIを使用して既存のLambda関数をアップグレードできます。

**既存のLambda関数をNew Relicプラットフォームからアップグレードするには、次の手順に従います。**

1. [one.newrelic.com &gt; All capabilities &gt; Serverless Functions](https://one.newrelic.com/nr1-core?state=23b04845-da13-2b11-5826-9c20326276d9)に移動し、 Lambda関数 エンティティを選択します。
2. Summary \[概要]ページで、 **Instrument for APM** \[APMの計装]をクリックします。
3. APM用のLambda関数] ページで、 APIキーを入力し、 **Continue** \[続行]をクリックします。
4. デフォルトでは、現在の Lambda エンティティがアップグレード対象として選択されます。他のLambda関数を選択してアップグレードすることもできます。 **Generate New Relic CLI command** \[New Relic CLI コマンドの生成を]クリックします。
5. コマンドをコピーして、ターミナルまたは AWS ターミナルで実行します。このコマンドは、選択した関数に New Relic Lambda レイヤーをインストールします。
6. **Continue** \[続行]をクリックしてインストレーションをテストします。 このテストでは、New Relic Lambda レイヤーが正しくインストールされているかどうか、および関数が New Relic にデータを送信しているかどうかを確認します。
7. テストが成功すると、成功メッセージが表示されます。New Relic APMインターフェースでLambda関数を表示するには、 **See your data in APM** \[APMでデータを表示]をクリックします。

#### CLIを使用して更新する [#cli]

<CollapserGroup>
  <Collapser id="nr-cli" title="New Relic CLI">
    <Callout variant="important">
      New Relic CLI のバージョンが`0.9.8`以降であることを確認してください。`newrelic-lambda --version`を実行すると CLI のバージョンを確認できます。CLI を更新する必要がある場合は、CLI を更新します。たとえば、 `pip3`を使用して CLI をインストールした場合は、次のコマンドで更新できます。

      ```bash
          pip3 install --upgrade newrelic-lambda
      ```
    </Callout>

    1. Lambda関数をアップグレードするには、ここに示すように`newrelic-lambda` CLI クイックスタートを使用します。

       ```bash
       newrelic-lambda layers install --nr-account-id YOUR_NEW_RELIC_ACCOUNT_ID --function my-function --upgrade --apm
       ```

       <Callout variant="tip">
         このコマンドは、Lambdaのリージョンとランタイムに合わせて、利用可能な最新のレイヤーを自動的に見つけます。
       </Callout>

    2. アラートを既存のLambda関数からAPMに移行するには、次のコマンドを実行します。

       ```bash
       newrelic-lambda apm alerts-migrate \
           --nr-account-id <YOUR_NEW_RELIC_ACCOUNT_ID> \
           --nr-api-key <YOUR_NEW_RELIC_API_KEY>
           --function <YOUR_LAMBDA_FUNCTION_NAME>
       ```
  </Collapser>

  <Collapser id="cdk" title="AWS CDK、AWS SAM、またはTerraformの場合">
    1. [AWS CDK](/docs/serverless-function-monitoring/aws-lambda-monitoring/instrument-lambda-function/instrument-your-own/#cdk) 、[ AWS](/docs/serverless-function-monitoring/aws-lambda-monitoring/instrument-lambda-function/instrument-your-own/#cloudformation) SAM 、または[ Terraform](/docs/serverless-function-monitoring/aws-lambda-monitoring/instrument-lambda-function/instrument-your-own/#terraform) を使用して、プロジェクトの[ 最新の New Relic Lambda レイヤー](https://layers.newrelic-external.com/) に更新します。
    2. Lambda関数設定で、 `NEW_RELIC_APM_LAMBDA_MODE` [環境変数](/docs/serverless-function-monitoring/aws-lambda-monitoring/instrument-lambda-function/env-variables-lambda/)を`true`に設定します。 これにより、New Relic Lambda レイヤーの APM モードが有効になります。
    3. 更新された設定を使用してLambda関数をデプロイします。
    4. <DNT>AWS Management Console</DNT>の<DNT>Configuration</DNT>タブで、 Lambda関数に`NR.Apm.Lambda.Mode: true`タグを追加します。
    5. CloudWatch タグの同期に[AWSイン クラウドテグレーション](/docs/infrastructure/amazon-integrations/get-started/introduction-aws-integrations/)(メトリクス ストリームまたはAPIポーリング) を使用していない場合は、 `NR_TAGS`環境変数を`NR.Apm.Lambda.Mode:true`に設定します。 これにより、New Relic Lambda Extension は必要なメタデータを New Relic に直接送信できるようになります。
  </Collapser>
</CollapserGroup>

## 既存のLambdaアラートとダッシュボードを更新する [#alerts-dashboards]

既存のLambda関数を`APM + Serverless Convergence`にアップグレードした後、アラート条件とダッシュボード ウィジェットでNRQL付与を更新することが重要です。 この新しいアップグレードにより、 Lambdaデータのメトリクス パスが変更されます。 アラートとダッシュボードがこれらの新しいパスを使用し、正確な監視と通知を継続的に提供できるようにするには、クエリを変更する必要があります。これは、 `APM + Serverless Convergence`に移行した既存のLambda関数に必要です。

* アラートについては、既存の Lambda アラート条件を確認してください。レイヤーから取得したメトリクスを使用するNRQL書き込みを新しいメトリクスで更新します。 アラート条件の更新方法の詳細については、 [「集計の更新」](https://docs.newrelic.com/docs/alerts/create-alert/create-alert-condition/alert-conditions/#edit-existing-alert-condition)を参照してください。

* ダッシュボードについては、既存のLambdaダッシュボード ウィジェットを確認してください。 レイヤーから取得したメトリクスを使用するNRQL書き込みを新しいメトリクスで更新します。 ダッシュボード ウィジェットを更新する方法の詳細については、 [「ダッシュボードの管理」](https://docs.newrelic.com/docs/query-your-data/explore-query-data/dashboards/manage-your-dashboard/)を参照してください。

## データを見つけて使用する [#find-data]

AWS Lambda 関数をセットアップしたら、 New Relic APMインターフェースでデータを検索して使用できるようになります。 データはいくつかの主要な領域に編成されており、それぞれがLambda関数のパフォーマンスと状態に異なるインサイトを提供します。

APMインターフェイスでは、[ディストリビューティッド（分散）ト](/docs/distributed-tracing/concepts/introduction-distributed-tracing/)レーシング、[サービス マップ](/docs/new-relic-solutions/new-relic-one/ui-data/service-maps/service-maps/)、[トランザクション](/docs/apm/transactions/intro-transactions/transactions-new-relic-apm/)、[エラー分析](/docs/errors-inbox/getting-started/)など、 Lambda関数のさまざまな側面を探索できます。 これらの各エリアでは、 Lambda関数のパフォーマンス、レイテンシ、エラー率に関する詳細なインサイトが提供され、問題を迅速に特定して解決できるようになります。

<Callout variant="tip">
  呼び出しエクスペリエンスは、 APM対話トレースと統合されました。 これにより、特定の`AWS RequestId`を使用してAPMマッカーサー トレースにドリルダウンし、特定のLambda実行に関する詳細情報を得ることができます。
</Callout>

New Relic APMインターフェースでLambda関数を表示するには:

1. <DNT>[https://one.newrelic.com](https://one.newrelic.com) &gt; APM &amp; Services</DNT>に移動します。
2. 検索条件を`isLambdaFunction = true`に設定します。
3. 表示されたリストから、 Lambda関数を選択してデータを表示します。

<Callout variant="tip">
  New Relic APM UIは、 `APM + Serverless Convergence`アップグレード前にインストルメントされたLambda関数の履歴データが表示されません。 履歴データを表示するには、 <DNT>APM Summary</DNT>ページで**see serverless functions** \[サーバーレス機能を参照]オプションをクリックします。
</Callout>

### ロールバック [#rollback]

Lambda関数を以前のサーバーレス監視エクスペリエンスに戻す必要がある場合は、 `NEW_RELIC_APM_LAMBDA_MODE`環境変数を`false`に設定することで実行できます。

## 関連記事 [#related-docs]

<DocTiles>
  <DocTile title="互換性と要件" path="/docs/serverless-function-monitoring/aws-lambda-monitoring/instrument-lambda-function/compatibility-requirement-lambda-monitoring">
    サポートされているランタイムと前提条件の詳細
  </DocTile>

  <DocTile title="トラブルシューティング" path="/docs/serverless-function-monitoring/aws-lambda-monitoring/troubleshooting/troubleshoot-enabling-serverless-monitoring-aws-lambda">
    インストール関連の問題のトラブルシューティング方法を学ぶ
  </DocTile>
</DocTiles>
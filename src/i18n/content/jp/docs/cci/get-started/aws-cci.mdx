---
title: Cloud Cost Intelligence - Amazon Web Services
tags:
  - cloud cost intelligence
  - aws
  - amazon web services
  - aws cost management
  - cloud cost optimization
  - cci aws
metaDescription: 'Set up AWS for CCI with consolidated billing, CUR, IAM roles, and region activation to optimize cost analysis in New Relic.'
redirect:
  - /docs/cci/prerequisites
  - /docs/cci/setup
freshnessValidatedDate: never
translationType: machine
---

<Callout title="プレビュー">
  この機能はまだ開発中ですが、ぜひお試しください。

  この機能は現在、弊社の[プレリリース ポリシー](/docs/licenses/license-information/referenced-policies/new-relic-pre-release-policy)に従ってプレビュー プログラムの一部として提供されています。
</Callout>

統合請求、コストと使用状況レポート、IAM ロールとポリシー、必要な AWS リージョンを構成して、Cloud Cost Intelligence 用の AWS 環境をセットアップします。

## あなたが始める前に

### 適切な権限を持つAWSアカウント [#aws-account]

[統合請求がAWS組織に対して設定されていること](https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/consolidated-billing.html)を確認します。

## セットアップ手順

<Steps>
  <Step>
    ### コストと使用状況レポート用の S3 バケットを作成する [#create-s3-bucket]

    AWS コストと使用状況レポート (CUR) を保存するための S3 バケットを作成します。`us-east-2`リージョンの使用をお勧めします。

    1. **AWS マネジメントコンソール (AWS Management Console)**にサインインします。

    2. **S3 service**に移動し、 **Create bucket** \[バケットの作成]をクリックします。

    3. 一意のバケット名を入力します (例: `<your-company-name>-billing` )。

    4. バケット設定を構成します。

       * バージョン管理を有効にする
       * パブリックアクセスを無効にする（推奨）
       * デフォルトの暗号化を有効にする（推奨）

    5. **タグ (オプション)** : 組織のリソース管理に必要な場合はタグを追加し、 **Create bucket** \[バケットの作成]をクリックします。

    <Callout variant="important">
      次の手順のためにバケット名を覚えておいてください。
    </Callout>
  </Step>

  <Step>
    ### AWS コストと使用状況レポートを構成する [#create-cur]

    S3 バケットに配信される**Cost and Usage Report** \[コストと使用状況レポート]を作成します。

    1. **AWS マネジメントコンソール (AWS Management Console)**にサインインします。

    2. **Billing Dashboard** &gt; **Cost &amp; Usage Analysis** &gt; **Data Exports**に移動し、 **Create** \[作成]をクリックします。

    3. レポート設定を構成します。

       <table>
         <thead>
           <tr>
             <th width={250}>
               **設定**
             </th>

             <th>
               **価値**
             </th>

             <th>
               **説明**
             </th>
           </tr>
         </thead>

         <tbody>
           <tr>
             <td>
               エクスポートタイプ
             </td>

             <td>
               `Standard Data Export`
             </td>

             <td>
               課金とコスト分析のための詳細な使用状況とコストの情報。
             </td>
           </tr>

           <tr>
             <td>
               エクスポート名
             </td>

             <td>
               `Name`
             </td>

             <td>
               CUR レポートの名前 (例: `<company-name>-billing-cci`)。
             </td>
           </tr>

           <tr>
             <td>
               データテーブル
             </td>

             <td>
               `CUR 2.0`
             </td>

             <td>
               最新の FOCUS 形式のテーブル構造をサポートします。
             </td>
           </tr>

           <tr>
             <td>
               リソースIDを含める
             </td>

             <td>
               `ON`
             </td>

             <td>
               個々の AWS リソースごとのコストの詳細な追跡を可能にします。
             </td>
           </tr>

           <tr>
             <td>
               分割コスト配分データ
             </td>

             <td>
               `OFF`
             </td>

             <td>
               データ構造を簡素化します。詳細なコスト配分分割が必要な場合を除き、省略してください。
             </td>
           </tr>

           <tr>
             <td>
               時間の粒度
             </td>

             <td>
               `Hourly`
             </td>

             <td>
               詳細なコストと使用状況の分析に必要です。
             </td>
           </tr>

           <tr>
             <td>
               圧縮タイプ
             </td>

             <td>
               `Parquet`
             </td>

             <td>
               クエリのパフォーマンスを向上させ、ストレージ スペースを削減する列指向のストレージ形式。
             </td>
           </tr>

           <tr>
             <td>
               ファイルのバージョン管理
             </td>

             <td>
               `Create New Report Version`
             </td>

             <td>
               更新ごとに新しいバージョンを作成し、監査用の履歴レポートを保持します。
             </td>
           </tr>

           <tr>
             <td>
               データ更新設定
             </td>

             <td>
               `AUTOMATIC`
             </td>

             <td>
               CUR データを自動的に最新の状態に保ちます。
             </td>
           </tr>

           <tr>
             <td>
               データエクスポート設定 S3バケット
             </td>

             <td>
               [コストと使用状況レポート用のS3バケットの作成](#create-s3-bucket)で作成したバケットを選択します。
             </td>

             <td>
               CUR ファイルは S3 バケットに保存されます。ポリシーを上書きすることに同意します。
             </td>
           </tr>

           <tr>
             <td>
               S3 パスプレフィックス
             </td>

             <td>
               `cost-and-usage-reports`
             </td>

             <td>
               S3 バケット内のコストと使用状況レポートを整理します。
             </td>
           </tr>
         </tbody>
       </table>

    4. **Next** \[次へ]をクリックし、 **Create report** \[レポートの作成]をクリックします。

    <Callout variant="important">
      CCI インテグレーションのエクスポート名を覚えておいてください。 S3 パス プレフィックスが`cost-and-usage-reports`であることを確認します。最初のレポートは 24 時間以内に配信され、後続のレポートは定期的に配信されます。
    </Callout>
  </Step>

  <Step>
    ### CCI アクセス用の IAM ポリシーを作成する [#create-iam-policy]

    CUR データにアクセスするための CCI 権限を付与する IAM ポリシーを作成します。

    1. **AWS マネジメントコンソール (AWS Management Console)**にサインインします。
    2. **IAM service** &gt; **Policies**に移動し、**Create policy** \[ポリシーの作成を]クリックします。
    3. **JSON エディター (JSON editor)**に切り替えて、次のポリシーを貼り付けます。

    ```json
    {
    "Version": "2012-10-17",
    "Statement": [
        {
        "Action": ["s3:Get*", "s3:List*"],
        "Effect": "Allow",
        "Resource": [
            "arn:aws:s3:::<bucket-name>/*",
            "arn:aws:s3:::<bucket-name>"
        ],
        "Sid": "AccessMasterPayerBillingBucket"
        },
        {
        "Effect": "Allow",
        "Action": [
            "pricing:DescribeServices",
            "pricing:GetAttributeValues",
            "pricing:GetProducts",
            "pricing:GetPriceListFileUrl",
            "pricing:ListPriceLists"
        ],
        "Resource": ["*"]
        }
    ]
    }
    ```

    <Callout variant="important">
      `bucket-name`[コストと使用状況レポート用の S3 バケットの作成](#create-s3-bucket)の S3 バケット名に置き換えます。
    </Callout>

    4. **Next**\[次へ]をクリックします。
    5. ポリシーに`CCI-Access-Policy` (または任意の名前) という名前を付け、説明を追加して、 **Create policy** \[ポリシーの作成] をクリックします。
  </Step>

  <Step>
    ### CCIが引き受けるIAMロールを作成する [#create-iam-role]

    CCI が CUR データにアクセスするために引き受ける IAM ロールを作成します。

    1. **AWS マネジメントコンソール (AWS Management Console)**にサインインします。
    2. **IAM service** &gt; **Roles**に移動し、**Create role** \[ロールの作成を]クリックします。
    3. 信頼されたエンティティ タイプ セクションで**Custom Trust Policy** \[カスタム信頼ポリシー]を選択し、次のロール定義を貼り付けます。
       ```json
       {
       "Version": "2012-10-17",
       "Statement": [
           {
           "Effect": "Allow",
           "Principal": {
               "AWS": "arn:aws:iam::207192125115:user/cci_global_user"
           },
           "Action": "sts:AssumeRole",
           "Condition": {
               "StringEquals": {
               "sts:ExternalId": "<externalID>"
               }
           }
           }
       ]
       }
       ```

    <Callout variant="important" title="注記">
      `externalId`は、CCI インテグレーションを開始すると生成されます。
    </Callout>

    4. **Next**\[次へ]をクリックします。
    5. [「CCI アクセス用の IAM ポリシーの作成」](#create-iam-policy)で作成したポリシーを添付し、 **Next** \[次へ]をクリックします。
    6. ロールに`CCI-Access-Role` (または任意の名前) という名前を付け、説明 (オプション) を追加して、 **Create role** \[ロールの作成]をクリックします。
    7. ロールの概要ページからロール ARN をメモします。

    <Callout variant="important">
      CCI 統合中にロール ARN が必要になります。
    </Callout>
  </Step>

  <Step>
    ### Integration にアクセスし、 New Relicアカウントを選択します [#access-integration]

    1. 左側のパネルで**Cloud Cost Intelligence**に移動し、 **Add the integration** \[統合の追加]をクリックします。
    2. New Relic アカウントを選択し、 **Continue** \[続行]をクリックします。
  </Step>

  <Step>
    ### 接続の詳細を入力する [#provide-connection-details]

    必要な詳細を入力してください:

    * **Connection name** - デフォルト名が提供されます。カスタム名を編集します。
    * **Cross-account IAM role ARN** - Cloud Cost Intelligence が S3 バケットにアクセスするための IAM ロール ARN (形式: `arn:aws:iam::<account-id>:role/<role-name>`)。
    * **External ID** - 外部 ID をコピーし、AWS の IAM ロール信頼ポリシーに追加します。
    * **Data export name** - データ エクスポート ファイルの名前。レポート`cci-ingestion-test`の場合、パスは`cost-and-usage-reports/cci-ingestion-test/data`です。
    * **S3 bucket name**- 正確なバケット名。最適なパフォーマンスを得るには、 `us-east-2`リージョンを使用してください。
  </Step>

  <Step>
    ### 信頼ポリシーを構成する [#configure-trust-policy]

    New Relic グローバル ユーザー (`arn:aws:iam::207192125115:user/cci_global_user`) を IAM ロール信頼ポリシーに追加します。

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "AWS": "arn:aws:iam::207192125115:user/cci_global_user"
          },
          "Action": "sts:AssumeRole",
          "Condition": {
            "StringEquals": {
              "sts:ExternalId": "<externalID>"
            }
          }
        }
      ]
    }
    ```

    <Callout variant="important">
      `sts:ExternalId` [「接続の詳細を提供」](#provide-connection-details)の外部 ID に設定します。デフォルトでアクティブになっていないリージョン (例: `ap-east-1` 、 `eu-south-1`) に対して STS をアクティブにします。
    </Callout>
  </Step>

  <Step>
    ### テスト接続 [#test-connection]

    **Test connection** \[テスト接続]をクリックして、AWS 環境への接続を確認します。

    <Callout variant="important">
      初期データ処理にはセットアップ後数時間かかる場合があります。
    </Callout>
  </Step>
</Steps>

## オプション: 高度な機能を有効にする

これらのオプション機能を有効にすると、AWS コスト分析が強化されます。

### リアルタイムのコスト見積もり [#real-time-cost-estimation]

CCI での予想コストの表示を有効にするには、計装方法の前提条件を満たします。

<table>
  <thead>
    <tr>
      <th>
        方法
      </th>

      <th>
        説明
      </th>

      <th>
        いつ選ぶか
      </th>

      <th>
        前提条件
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        インフラストラクチャエージェントと統合
      </td>

      <td>
        詳細な監視にはNew Relic Infrastructureエージェントを使用します。
      </td>

      <td>
        詳細な可視性と制御を実現するため、スタンドアロンの EC2、EKS/EC2、または ECS/EC2 セットアップに最適です。
      </td>

      <td>
        * スタンドアロン EC2: New Relic Infrastructure エージェントをインストールします。
        * EKS/EC2: Kubernetesインテグレーションをインストールします。
        * ECS/EC2: ECS インテグレーションをインストールします。 AWS Fargate ではサポートされていません。
      </td>
    </tr>

    <tr>
      <td>
        クラウドインテグレーション（メトリクス）
      </td>

      <td>
        直近の監視にはAWS CloudWatchメトリクスを利用します。
      </td>

      <td>
        動的な環境でリアルタイムのデータが不可欠な場合。
      </td>

      <td>
        [Amazon CloudWatch Metric Streams](/install/aws-cloudwatch/)

        を設定します。
      </td>
    </tr>

    <tr>
      <td>
        クラウドインテグレーション (ポーリング) - レガシー
      </td>

      <td>
        AWSサービスを定期的にポーリングしてデータを収集します。
      </td>

      <td>
        あまり頻繁な更新を許容しない環境向け。
      </td>

      <td>
        [AWSポーリング統合](/docs/infrastructure/amazon-integrations/connect/set-up-aws-api-polling/)

        をセットアップします。
      </td>
    </tr>
  </tbody>
</table>

### Kubernetesのコスト配分 [#k8s-cost-allocation]

* [Kubernetesインテグレーションをインストールします](https://docs.newrelic.com/install/kubernetes/)。 AWS Fargate 統合はサポートされていません。
* 標準の Kubernetes ラベル (`app.kubernetes.io/name` 、 `app.kubernetes.io/instance` 、 `app.kubernetes.io/component` 、 `app.kubernetes.io/part-of`) に加えて、 `environment`や`team`などのカスタム ラベルや、 `project`や`costCenter`などのカスタム リソース タグを追加して、コストの細分化と分析を改善します。

## 推奨事項

* AWS アカウントで[コスト配分タグ](https://docs.aws.amazon.com/tag-editor/latest/userguide/tagging.html)を設定します。効果的なコストのフィルタリングとグループ化を実現するには、AWS リソース全体で少なくとも 2 つのカスタム リソース タグを一貫して適用します。
* 最適なパフォーマンスとコスト効率を得るには、 `us-east-2`リージョンの S3 バケットを使用します。

## アクセス制御に関するアドバイス

指定されたNew Relicアカウント/組織にアクセスできるすべてのユーザーは、 AWSクラウドのコスト データを表示できます。 社内のアクセス制御ポリシーに適合する適切な New Relic アカウント/組織を選択します。

<Callout variant="important">
  **S3バケットアクセス**

  New Relic では、S3 バケットへの読み取りアクセスのみが必要であり、単一の IAM ロールに制限されています。データを保護するためにこのアクセス レベルを維持してください。
</Callout>

<DocTiles numbered>
  <DocTile title="Set up AWS" label={{text: 'You are here', color: '#FCD672'}} path="/docs/cci/get-started/aws-cci" />

  <DocTile title="Set up Azure" path="/docs/cci/get-started/azure-cci" />

  <DocTile title="Set up Google Cloud Platform" path="/docs/cci/get-started/gcp-cci" />
</DocTiles>
---
title: Instrument Go セグメント
tags:
  - Agents
  - Go agent
  - Instrumentation
metaDescription: 'With APM''s Go agent, you can set up segments, which measure the timing of specific blocks of code in your Golang app.'
translationType: machine
---

New Relic for Go を使用すると、Go アプリケーションの [トランザクション](/docs/apm/transactions/intro-transactions/transactions-new-relic-apm) の特定のセグメントを監視して、特定の機能やコードブロックについてより詳細な情報を得ることができます。

## 機能やコードブロックの計測時間 [#go-segments]

**セグメント** は、アプリケーションにおける [トランザクション](/docs/apm/transactions/intro-transactions/transactions-new-relic-apm) の特定の部分を指します。セグメントを計測することで、外部呼び出し、データストア呼び出し、キューへのメッセージ追加、バックグラウンドタスクなどの関数やコードブロックにかかる時間を計測することができます。

**例:** 出荷情報とクレジットカード情報の両方を処理する、チェックアウトプロセスに関連するトランザクションがあります。このトランザクションを、配送用のセグメントと支払い用のセグメントの2つに分割するようにアプリケーションを作成することができます。

## ブロック・オブ・コード・セグメント [#segment-code-block]

[トランザクション](/docs/agents/go-agent/get-started/instrument-go-transactions) をインストルメントすると、そのトランザクション内の1つまたは複数のセグメントをインストルメントする準備が整います。

コードの任意のブロックをセグメントとして計測するには、次のパターンを使用し、トランザクションに設定された変数名として[`txn`](/docs/agents/go-agent/get-started/instrument-go-transactions)を含めます。

```go
segment := newrelic.Segment{}
segment.Name = "mySegmentName"
segment.StartTime = txn.StartSegmentNow()
// ... code you want to time here ...
segment.End()
```

`StartSegment` 便利なヘルパーです。セグメントを作成して開始します。

```go
segment := txn.StartSegment("mySegmentName")
// ... code you want to time here ...
segment.End()
```

## 機能セグメント [#segment-function]

関数をセグメントとしてインスツルメントすることは、任意のコードブロックをセグメントとしてインスツルメントすることと基本的に同じです。主な違いは、関数には個別の終わりがあるので、Go の [defer ステートメント](https://gobyexample.com/defer) を使用できることです。

関数をセグメントとして計測するには、関数の先頭に次のコードを追加し、トランザクションに設定された変数名として[`txn`](/docs/agents/go-agent/get-started/instrument-go-transactions)を含めます。

```go
defer txn.StartSegment("mySegmentName").End()
```

## ネストセグメント [#go-nesting-segments]

セグメントはネストすることができます。終了するセグメントは、最後に開始されたセグメントでなければなりません。

以下は、あるセグメントが別のセグメントの中で始まり、終わる例です。

```go
s1 := txn.StartSegment("outerSegment")
s2 := txn.StartSegment("innerSegment")
// s2 must end before s1
s2.End()
s1.End()
```

ゼロ値のセグメントは安全に終了することができます。したがって、次のコードは、条件付きで失敗しても安全です。

```go
var s newrelic.Segment
if recordSegment {
    s.StartTime = txn.StartSegmentNow()
}
// ... code you wish to time here ...
s.End()
```

## データストアのセグメント [#go-datastore-segments]

Go アプリケーションのデータストア呼び出しを計測することができます。データストアセグメントは、New Relic の APM **Transactions breakdown** テーブルと **Databases** タブの [**Transactions** ページ](/docs/apm/applications-menu/monitoring/transactions-page) に表示されます。

MySQL、PostgreSQL、または SQLite データベース ドライバを使用している場合、Datastore セグメントを追加する最も簡単な方法は、あらかじめ組み込まれている統合パッケージを使用することです。それ以外の場合は、データベースを呼び出すたびに手動で Datastore セグメントを作成することができます。

<CollapserGroup>
  <Collapser
    id="instrumentation-pkg"
    title="計装パッケージの使用"
  >
    サポートしているデータベースドライバごとに統合パッケージを用意しています。

    <table>
      <thead>
        <tr>
          <th width={250}>
            対応データベースライブラリ
          </th>

          <th>
            インテグレーションパッケージ
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            [go-sql-driver/mysql](https://github.com/go-sql-driver/mysql)
          </td>

          <td>
            [v3/integrations/nrmysql](https://godoc.org/github.com/newrelic/go-agent/v3/integrations/nrmysql)
          </td>
        </tr>

        <tr>
          <td>
            [lib/pq](https://github.com/lib/pq)
          </td>

          <td>
            [v3/integrations/nrpq](https://godoc.org/github.com/newrelic/go-agent/v3/integrations/nrpq)
          </td>
        </tr>

        <tr>
          <td>
            [mattn/go-sqlite3](https://github.com/mattn/go-sqlite3)
          </td>

          <td>
            [v3/integrations/nrsqlite3](https://godoc.org/github.com/newrelic/go-agent/v3/integrations/nrsqlite3)
          </td>
        </tr>
      </tbody>
    </table>

    これらの統合機能を使用するには、まずドライバーを当社の統合バージョンに置き換えてください。

    ```go
    import (
    	// import our integration package in place of "github.com/go-sql-driver/mysql"
    	_ "github.com/newrelic/go-agent/v3/integrations/nrmysql"
    )

    func main() {
    	// open "nrmysql" in place of "mysql"
    	db, err := sql.Open("nrmysql", "user@unix(/path/to/socket)/dbname")
    }
    ```

    次に、 [sql.DB](https://golang.org/pkg/database/sql/#DB) 、 [sql.Conn](https://golang.org/pkg/database/sql/#Conn) 、 [sql.Tx](https://golang.org/pkg/database/sql/#Tx) 、および[sql.Stmt](https://golang.org/pkg/database/sql/#Stmt)の`ExecContext` 、 `QueryContext` 、および`QueryRowContext`メソッドを使用して、トランザクションを含むコンテキストを提供します。`Exec` 、 `Query` 、および`QueryRow`への呼び出しは計測されません。

    ```go
    ctx := newrelic.NewContext(context.Background(), txn)
    row := db.QueryRowContext(ctx, "SELECT count(*) from tables")
    ```

    上記以外の [database/sql](https://golang.org/pkg/database/sql/) データベースを使用している場合は、 [InstrumentConnector](https://godoc.org/github.com/newrelic/go-agent/v3/newrelic#InstrumentConnector) 、 [InstrumentDriver](https://godoc.org/github.com/newrelic/go-agent/v3/newrelic#InstrumentDriver) 、 [DriverSegmentBuilder](https://godoc.org/github.com/newrelic/go-agent/v3/newrelic#DriverSegmentBuilder) を使用して、独自のインスツルメンテーションを記述することができます。統合パッケージは、この方法の例として機能します。

    <Callout variant="important">
      MySQL、PostgreSQL、および SQLite のデータストア統合パッケージは、Go エージェント v2.8.0 で追加され、Go v1.10 以降が必要です。
    </Callout>
  </Collapser>

  <Collapser
    id=""
    title={<>使用する <InlineCode>DatastoreSegment</InlineCode></>}
  >
    基本セグメントと同様に、データストア セグメントは、 `StartTime`フィールドにデータが入力されると開始し、 `End`メソッドが呼び出されると終了します。データストア セグメントを計測するには、監視する関数の先頭に次を配置します。

    ```go
    s := newrelic.DatastoreSegment{
        Product: newrelic.DatastoreMySQL,
        Collection: "users",
        Operation: "INSERT",
        ParameterizedQuery: "INSERT INTO users (name, age) VALUES ($1, $2)",
        QueryParameters: map[string]interface{}{
            "name": "Dracula",
            "age": 439,
        },
        Host: "mysql-server-1",
        PortPathOrID: "3306",
        DatabaseName: "my_database",
    }
    s.StartTime = txn.StartSegmentNow()
    // ... make the datastore call
    s.End()
    ```

    については、こちらをご覧ください。

    * `Collection` 、 `Operation` 、 `DatabaseName` 、およびその他のパラメーター値の割り当て: [GoDoc の New Relic データストア セグメントのドキュメントを](https://godoc.org/github.com/newrelic/go-agent#DatastoreSegment)参照してください。
    * `Product`に使用できる値: [GitHub の New Relic ドキュメントを](https://github.com/newrelic/go-agent/blob/master/datastore.go)参照してください。

    関数呼び出し全体に渡るデータストア呼び出しをインストゥルメンテーションする場合、defer文を使用してインストゥルメンテーションを簡素化することができます。

    ```go
    s := newrelic.DatastoreSegment{
        StartTime: txn.StartSegmentNow(),
        Product: newrelic.DatastoreMySQL,
        Collection: "users",
        Operation: "INSERT",
        ParameterizedQuery: "INSERT INTO users (name, age) VALUES ($1, $2)",
        QueryParameters: map[string]interface{}{
            "name": "Dracula",
            "age": 439,
        },
        Host: "mysql-server-1",
        PortPathOrID: "3306",
        DatabaseName: "my_database",
    }
    defer s.End()
    ```
  </Collapser>
</CollapserGroup>

## 外部セグメント [#go-external-segments]

Web サービス、クラウド内のリソース、その他のネットワーク呼び出しなどの外部サービスへの Go アプリケーション呼び出しを計測できます。外部セグメントが <InlinePopover type="apm"/>**トランザクション内訳** 表と New Relic の [**外部サービス** ページ](/docs/apm/applications-menu/monitoring/external-services-page) 。

外部セグメントのインストルメントには2つの方法があります。

<CollapserGroup>
  <Collapser
    id="start-external-segment"
    title={<>使用する <InlineCode>StartExternalSegment()</InlineCode></>}
  >
    **推奨事項:** `StartExternalSegment`ヘルパーを使用してください。New Relic は[クロス アプリケーション トレース](/docs/agents/go-agent/features/cross-application-tracing-go)を使用してアプリケーション間のアクティビティをトレースするために使用するためです。

    ```go
    func external(txn *newrelic.Transaction, req *http.Request) (*http.Response, error) {
        s := newrelic.StartExternalSegment(txn, req)
        response, err := http.DefaultClient.Do(req)
        s.Response = response
        s.End()
        return response, err
    }
    ```
  </Collapser>

  <Collapser
    id="new-round-tripper"
    title={<>使用する <InlineCode>NewRoundTripper()</InlineCode></>}
  >
    `NewRoundTripper` [http.RoundTripper](https://golang.org/pkg/net/http/#RoundTripper)を返します。これにより、 `http.Client`の`Transport`フィールドを変更することで、 `StartExternalSegment`を呼び出さずに外部呼び出しを計測できます。返された`RoundTripper`は、 [FromContext](https://godoc.org/github.com/newrelic/go-agent#FromContext)を使用してリクエストのコンテキストで`Transaction`を探します。

    `NewRoundTripper`インストルメンテーションの例を次に示します。

    ```go
    client := &http.Client{}
    client.Transport = newrelic.NewRoundTripper(client.Transport)

    request, _ := http.NewRequest("GET", "http://example.com", nil)
    request = newrelic.RequestWithTransactionContext(request, txn)

    response, err := client.Do(request)
    ```
  </Collapser>
</CollapserGroup>

## メッセージ・プロデューサー・セグメント [#go-message-producer-segments]

RabbitMQやKafkaなどのキューイングシステムにメッセージを追加するGoアプリケーションコールを計測することができます。メッセージプロデューサーのセグメントは、New Relic の APM **Transactions breakdown** に表示されます。

メッセージ・プロデューサー・セグメントを計測する方法は一つしかありません。

<CollapserGroup>
  <Collapser
    id="start-external-segment"
    title={<>使用する <InlineCode>MessageProducerSegment</InlineCode></>}
  >
    基本セグメントと同様に、メッセージ プロデューサ セグメントは、 `StartTime`フィールドにデータが入力されると開始し、 `End`メソッドが呼び出されると終了します。メッセージ プロデューサ セグメントをインストルメント化するには、監視する関数の先頭に以下を配置します。

    ```go
    s := newrelic.MessageProducerSegment{
        Library:              "RabbitMQ",
        DestinationType:      newrelic.MessageExchange,
        DestinationName:      "myExchange",
        DestinationTemporary: false,
    }
    s.StartTime = txn.StartSegmentNow()
    // ... add message to queue
    s.End()
    ```

    `Library` 、 `DestinationType` 、 `DestinationName` 、または`DestinationTemporary`フィールドの割り当ての詳細については[、GoDoc の New Relic メッセージ プロデューサー セグメントのドキュメントを](https://godoc.org/github.com/newrelic/go-agent#MessageProducerSegment)参照してください。

    関数呼び出し全体にまたがるメッセージ・プロデューサー・コールをインスツルメンテーションする場合、deferステートメントを使用してインスツルメンテーションを簡素化することができます。

    ```go
    s := newrelic.MessageProducerSegment{
        StartTime:            txn.StartSegmentNow(),
        Library:              "RabbitMQ",
        DestinationType:      newrelic.MessageExchange,
        DestinationName:      "myExchange",
        DestinationTemporary: false,
    }
    defer s.End()
    // ... add message to queue
    ```

    <Callout variant="important">
      メッセージ プロデューサー セグメントは、Go エージェント バージョン 2.14.0 で追加されました。
    </Callout>
  </Collapser>
</CollapserGroup>
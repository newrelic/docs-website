---
title: Go エージェントのコードレベルのメトリクス構成
tags:
  - Agents
  - Go agent
  - Configuration
metaDescription: 'For the New Relic Go language agent, you can add source code context to your application traces, associating the trace data with the specific code being instrumented.'
translationType: machine
---

コードレベルのメトリクスを有効にすると、Go エージェントは属性をトレース データに添付します。これらの属性は、これらのトレースによってインストルメント化されたアクションを担当するアプリケーション ソース コード内の場所を示します。表示できるデータは次のとおりです。

* ソースファイル名
* ソースファイルの行番号
* 関数名
* 名前空間

コードレベルのメトリクスの収集を制御するために、Go エージェントの構成設定を確認してください。構成を完了した後、データを見つけるのにサポートが必要な場合は[、メトリックを表示する](#view-metrics)を参照してください。メトリクスの収集方法をさらに制御したい場合は、 [Go エージェントのコードレベルのメトリクス インストルメンテーション](/docs/apm/agents/go-agent/instrumentation/go-agent-code-level-metrics-instrument)を参照してください。

<Callout variant="important">
  この機能は、Go エージェント バージョン 3.18.0 以降のトランザクションで利用できます。デフォルトではオフになっています。有効にするには、以下で説明するように、アプリケーションの構成に`newrelic.ConfigCodeLevelMetricsEnabled(true)`を追加する必要があります。
</Callout>

## 設定方法 [#config]

アプリケーションで Go エージェントを構成するために`newrelic.NewApplication`を呼び出す場合、次のように`newrelic.ConfigCodeLevelMetricsEnabled`オプションを含めることでコードレベルの指標を有効にできます。

```go
app, err := newrelic.NewApplication(
   newrelic.ConfigAppName("Your Application Name"),
   newrelic.ConfigLicense(os.Getenv("NEW_RELIC_LICENSE_KEY")),
   newrelic.ConfigCodeLevelMetricsEnabled(true),
)
```

この簡単な手順で、Go エージェントはトランザクションの次のエージェント属性にソース コード コンテキスト情報を追加します。

<table>
  <thead>
    <tr>
      <th style={{ width: "200px" }}>
        名前
      </th>

      <th>
        説明
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        `code.function`
      </td>

      <td>
        トランザクションを開始した関数の名前。これは、Go コンパイラによって自動的に生成される場合があることに注意してください。
      </td>
    </tr>

    <tr>
      <td>
        `code.namespace`
      </td>

      <td>
        関数が配置されているパッケージ/名前空間。ドット ( 

        `.`

         ) などの区切り文字で結合された

        `code.namespace`

        と

        `code.function`

        の組み合わせは、関数を一意に識別することが期待されます。
      </td>
    </tr>

    <tr>
      <td>
        `code.filepath`
      </td>

      <td>
        報告される関数を含むソース ファイルのパス名。通常、これは完全な絶対パス名です。これを相対パスに変更できる構成オプションについては、以下を参照してください。
      </td>
    </tr>

    <tr>
      <td>
        `code.lineno`
      </td>

      <td>
        トランザクションが開始された

        `code.filepath`

        内の行番号。これを制御する方法について

        [は、インストルメンテーション ガイドを参照して](/docs/apm/agents/go-agent/instrumentation/go-agent-code-level-metrics-instrument)

        ください。
      </td>
    </tr>
  </tbody>
</table>

アプリケーションのコード レベルのメトリックのコレクションをさらに絞り込むために使用できる追加の構成オプションがあります。

<CollapserGroup>
  <Collapser
    id="go-clm-config-ignore-prefix"
    title={<>インストルメント化されたパッケージを特定する</>}
  >
    デフォルトでは、コード レベルのメトリクスが有効になっている場合、エージェントはコール スタック内でエージェント自体の内部にあると思われる関数を無視し、報告された関数が意図したものであることを確認します。コードレベルのメトリクス インストルメンテーション コードに入るために呼び出されます。デフォルトでは、パッケージ名が`github.com/newrelic/go-agent/`で始まる関数は無視されます。独自の`IgnoredPrefixes`値を設定することで、これを任意の名前のリストに変更できます。

    これを行うには、次のいずれかを実行します。

    * `NewApplication`関数を使用して構成する場合は、 `ConfigCodeLevelMetricsIgnoredPrefix`オプションを追加して、任意の数のプレフィックス文字列を個別の文字列引数として渡します。

      ```go
      app, err := newrelic.NewApplication(
         newrelic.ConfigAppName("Your Application Name"),
         newrelic.ConfigLicense("YOUR_NEW_RELIC_LICENSE_KEY"),
         newrelic.ConfigCodeLevelMetricsEnabled(true),
         newrelic.ConfigCodeLevelMetricsIgnoredPrefix("github.com/some/other/name/"),
      )
      ```

    * 環境変数を使用して構成する場合は、 `NEW_RELIC_CODE_LEVEL_METRICS_IGNORED_PREFIX`を目的のプレフィックス (またはコンマ区切りのプレフィックスのリスト) に設定します。

      ```
      NEW_RELIC_CODE_LEVEL_METRICS_IGNORED_PREFIX="github.com/some/other/name/"
      ```

      アプリケーションを設定するときは、忘れずに`newrelic.ConfigFromEnvironmet`オプションも含めてください。

      ```go
      app, err := newrelic.NewApplication(
         newrelic.ConfigAppName("Your Application Name"),
         newrelic.ConfigLicense("YOUR_NEW_RELIC_LICENSE_KEY"),
         newrelic.ConfigCodeLevelMetricsEnabled(true),
         newrelic.ConfigFromEnvironment(),
      )
      ```

    * `Config`構造体の`CodeLevelMetrics.IgnoredPrefixes`メンバー ( `[]string`値) を直接設定することもできますが、 `Config`構造体を直接操作する代わりに、上記の方法のいずれかを使用することをお勧めします。
  </Collapser>

  <Collapser
    id="go-clm-config-path-prefix"
    title={<>ソース パスのプレフィックスを切り詰める</>}
  >
    デフォルトでは、コード レベルのメトリックが有効になっているため、エージェントは各ソース ファイルのフル パス名を報告します。ただし、これは望ましくない場合があります。たとえば、プロジェクト ソース ツリーのルートに関連するアプリケーション パスのみをレポートし、ファイル システムのどこにインストールされているかに関係なく、インスタンス間でデータを関連付けることができます。

    これを行うには、ローカル プロジェクト ソース パスの開始を示す`PathPrefix`文字列を指定します。その文字列がソース ファイルのパス名に含まれている場合、その文字列より前にあるものはすべて削除されます。たとえば、 `PathPrefix`パラメーターが`myproject/src`に設定されている場合、 `/usr/local/projects/myproject/src/widget/main.go`はコードレベルのメトリックで`myproject/src/widget/main.go`として報告されます。

    `PathPrefix`が空の場合、またはソース ファイルにプレフィックス文字列がまったく含まれていない場合は、完全なパス名が報告されます。

    次のうち1つを行います。

    * `NewApplication`関数を介して構成する場合は、 `ConfigCodeLevelMetricsPathPrefix`オプションを追加します。

      ```go
      app, err := newrelic.NewApplication(
         newrelic.ConfigAppName("Your Application Name"),
         newrelic.ConfigLicense("YOUR_NEW_RELIC_LICENSE_KEY"),
         newrelic.ConfigCodeLevelMetricsEnabled(true),
         newrelic.ConfigCodeLevelMetricsPathPrefix("myprojects/src/"),
      )
      ```

    * 環境変数を介して構成する場合は、 `NEW_RELIC_CODE_LEVEL_METRICS_PATH_PREFIX`を目的のプレフィックスに設定します。

      ```
      NEW_RELIC_CODE_LEVEL_METRICS_PATH_PREFIX="myprojects/src/"
      ```

      アプリケーションを設定するときは、忘れずに`newrelic.ConfigFromEnvironment`オプションも含めてください。

      ```go
      app, err := newrelic.NewApplication(
         newrelic.ConfigAppName("Your Application Name"),
         newrelic.ConfigLicense("YOUR_NEW_RELIC_LICENSE_KEY"),
         newrelic.ConfigCodeLevelMetricsEnabled(true),
         newrelic.ConfigFromEnvironment(),
      )
      ```
  </Collapser>
</CollapserGroup>

## 指標を表示する [#view-metrics]

コードレベルのメトリクスを設定したら、New Relic UI でデータを確認できます。特定のサービスのトレースを表示する 1 つの方法を次に示します。

1. **[one.newrelic.com](https://one.newrelic.com/)**にアクセスします。
2. 左側のペインで、\[ **APMとサービス**]をクリックします。
3. エンティティ（サービス）をクリックします。
4. 左ペインの \[**監視**] セクションで、\[**トランザクション**] をクリックします。
5. \[ **Transaction traces** ] で、個々のトレースをクリックします。
6. `code.`で始まる 4 つの**属性については、\[エージェント**の属性] を参照してください。
---
title: Ruby 9.x から 10.x への移行ガイド
tags:
  - Agents
  - Ruby agent
  - Getting started
freshnessValidatedDate: never
translationType: machine
---

このガイドでは、Ruby エージェントの 9.x シリーズと 10.x シリーズの間の主な変更点と、移行を成功させる方法について説明します。

## 概要 [#summary]

v10.0 の主な変更点は次のとおりです。

* [Ruby 2.4および2.5のサポートを削除しました](#ruby_2425)
* [クロスアプリケーショントレーシング（CAT）と関連APIを削除しました](#cat_removal)
* [エージェント経由のデプロイメント記録のサポートを削除しました](#removed_record_deployments)
* [`NewRelic::Agent::SqlSampler#notice_sql`を削除し、 `NewRelic::Agent::Datastores` API を簡素化しました](#removed_and_simplified_apis)
* [Puma バージョン &apos;&lt;&apos; 3.9.0 のサポートを削除しました](#puma_version_removal)
* [実験的な機能設定可能なセキュリティ ポリシー (CSP) を削除しました](#csp_removal)
* [ActiveJob メトリクスとセグメントの名前が変更されました](#activejob_rename)
* [`bin/newrelic`コマンドの名前を `bin/newrelic_rpm`](#renamed_cli_command)

詳細については、 [10.0 のマイルストーン](https://github.com/newrelic/newrelic-ruby-agent/milestone/119?closed=1)を参照してください。

これらの重大な変更に加えて、他のいくつかの改善も行われています。詳細については[CHANGELOGを](https://github.com/newrelic/newrelic-ruby-agent/blob/main/CHANGELOG.md#v1000)参照してください。

## Ruby 2.4および2.5のサポートを削除しました [#ruby\_2425][#ruby_2425]

Ruby 2.4 および 2.5 は、Ruby エージェントではサポートされなくなりました。最新の Ruby エージェント バージョンを引き続き使用するには、Ruby 2.6.0 以上に更新してください。

New Relic は、Ruby 言語開発チームによって公式にサポートされるメンテナンス期間が終了した後も、特定の古い Ruby バージョンのサポートを継続します。たとえば、2026 年 3 月 31 日時点で Ruby チームがサポートする最も古い Ruby バージョンは 3.3 になりますが、Ruby エージェント バージョン 10.0 では Ruby バージョン 2.6 以降が引き続きサポートされます。Ruby バージョンに対する公式 Ruby チームのサポートの詳細については、 [「Ruby メンテナンス ブランチ」](https://www.ruby-lang.org/en/downloads/branches/)を参照してください。

## クロスアプリケーショントレース（CAT）と関連APIを削除しました [#cat\_removal][#cat_removal]

クロスアプリケーション トレーシング (CAT)[は、ディストリビューティッド（分散）トレーシング](/docs/distributed-tracing/concepts/introduction-distributed-tracing/)に代わって削除されました。 CAT は、 APMモニター アプリケーション間のトランザクションをリンクするためにNew Relic固有のヘッダーを使用しましたが、ディストリビューティッド（分散）トレーシングは W3Ctrace コンテキストを採用しました。 ディストリビューティッド（分散）トレースを有効にするには、設定オプション`distributed_tracing.enabled`を`true`に設定します。

```yaml
distributed_tracing.enabled: true
```

設定オプション`cross_application_tracer.enabled`は、次のパブリックAPIメソッドとともに削除されました:

| CAT APIを削除しました                                                                   | ディストリビューティッド（分散）トレーシング交換                                               | コンテクスト                                                   |
| :------------------------------------------------------------------------------- | :--------------------------------------------------------------------- | :------------------------------------------------------- |
| `NewRelic::Agent::External.process_request_metadata`                             | `NewRelic::Agent::DistributedTracing.accept_distributed_trace_headers` | 受信リクエストから W3Ctracecontext ヘッダーを読み取り、サービスを上流のトレースにリンクします。 |
| `NewRelic::Agent::External.get_response_metadata`                                | 同等のものは必要ありません                                                          | 応答メタデータは廃止されており、リンクはリクエスト内の W3C ヘッダーによって処理されます。          |
| `NewRelic::Agent::Transaction::ExternalRequestSegment#process_response_metadata` | 同等のものは必要ありません                                                          | 応答ベースの処理は削除され、代わりにリクエスト ヘッダーの伝播が採用されます。                  |
| `NewRelic::Agent::Transaction::ExternalRequestSegment#get_request_metadata`      | `NewRelic::Agent::DistributedTracing.insert_distributed_trace_headers` | W3Ct レースコンテキスト ヘッダーを作成し、送信要求ヘッダーに追加します。                  |
| `NewRelic::Agent::Transaction::ExternalRequestSegment#read_response_headers`     | 同等のものは必要ありません                                                          | トレース リンクでは、応答ヘッダーを読み取る必要はありません。                          |

[ディストリビューティッド（分散）トレーシング API の](https://www.rubydoc.info/gems/newrelic_rpm/NewRelic/Agent/DistributedTracing)使用について詳しくは、こちらをご覧ください。

## エージェント経由のデプロイメント記録のサポートを削除しました [#removed\_record\_deployments][#removed_record_deployments]

エージェントは、Capistrano レシピまたは`newrelic deployments` CLI コマンドを使用してアプリケーションのデプロイメント情報を送信する機能をサポートしなくなりました。New Relicの変更とデプロイメントを追跡するには、利用可能なオプションのリストについては[、変更追跡 (変更追跡機能)](/docs/change-tracking/change-tracking-introduction/)のガイドを参照してください。

## `NewRelic::Agent::SqlSampler#notice_sql`を削除して簡素化しました `NewRelic::Agent::Datastores` [#removed\_and\_simplified\_apis][#removed_and_simplified_apis]

### NewRelic::エージェント::SqlSampler#notice\_sql メソッドを削除しました

`NewRelic::Agent::SqlSampler#notice_sql`メソッドは削除されました。SQL クエリを追跡するには、代わりに`NewRelic::Agent::Datastores.notice_sql`メソッドを使用する必要があります。

### さまざまな`NewRelic::Agent::Datastores` API から未使用の引数を削除しました

いくつかの`NewRelic::Agent::Datastores` API は、冗長な引数を削除することで簡素化されました。タイミング (`elapsed`) およびメトリクス スコープ情報は、現在のセグメントから自動的に取得されます。

次の API が更新されました:

| 古いAPI                                                                              | 新しいAPI                                                    | 変化                                                    |
| :--------------------------------------------------------------------------------- | :-------------------------------------------------------- | :---------------------------------------------------- |
| `NewRelic::Agent::Datastores.notice_sql(query, scoped_metric, elapsed)`            | `NewRelic::Agent::Datastores.notice_sql(query)`           | `scoped_metric`および`elapsed`引数が削除されました。                |
| `NewRelic::Agent::Datastores.notice_statement(statement, elapsed)`                 | `NewRelic::Agent::Datastores.notice_statement(statement)` | `elapsed`引数を削除しました。                                   |
| `NewRelic::Agent::Datastores.wrap(...) do \|result, scoped_metric, elapsed_time\|` | `NewRelic::Agent::Datastores.wrap(...) do \|result\|`     | コールバック ブロック引数から`scoped_metric`と`elapsed_time`を削除しました。 |

## Puma バージョン &apos;&lt;&apos; のサポートを削除しました [#puma\_version\_removal][#puma_version_removal]

現在サポートされている Puma の最小バージョンは 3.9.0 以上です。Puma を使用している場合は、エージェントをアップグレードする前にバージョン 3.9.0 以降にアップグレードしてください。

## 実験的な機能設定可能なセキュリティ ポリシー (CSP) を削除しました [#csp\_removal][#csp_removal]

実験的機能である設定可能なセキュリティ ポリシー (CSP) はサポートされなくなり、削除されました。 エージェントのデフォルトのセキュリティ設定により、APM データのセキュリティが[自動的に](/docs/apm/new-relic-apm/getting-started/apm-agent-data-security/)確保されますが、[高セキュリティ モード](/docs/apm/agents/manage-apm-agents/configuration/high-security-mode/)を使用して、New Relic が受信する情報をさらに制限できます。

## ActiveJob メトリクスとセグメントの名前が変更されました [#activejob\_rename][#activejob_rename]

ActiveJob メトリックとセグメントが更新され、より具体的なレポートのためにジョブのクラス名が含まれるようになりました。 新しいフォーマットを反映するように、ActiveJob メトリクスとセグメントを書き込むすべてのカスタムダッシュボードとNRQLアラートを更新します。

古い形式:

```ruby
"Ruby/ActiveJob/#{QueueName}/#{Method}" # metrics
"ActiveJob/#{Adapter}/Queue/#{Event}/Named/#{JobQueueName}" # segments
```

新しいフォーマット:

```ruby
"Ruby/ActiveJob/#{QueueName}/#{JobClassName}/#{Method}" # metrics
"ActiveJob/#{Adapter}/Queue/#{Event}/Named/#{JobQueueName}/#{JobClassName}" # segments
```

## `bin/newrelic`コマンドの名前を `bin/newrelic_rpm` [#renamed\_cli\_command][#renamed_cli_command]

エージェントの CLI の実行可能ファイルの名前が`bin/newrelic`から`bin/newrelic_rpm`に変更されました。この変更により、スタンドアロンの New Relic CLI ツールとの名前の競合が解決されます。

古いコマンド:

```bash
bin/newrelic install
```

新しいコマンド:

```bash
bin/newrelic_rpm install
```
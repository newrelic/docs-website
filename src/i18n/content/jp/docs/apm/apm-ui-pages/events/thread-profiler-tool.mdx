---
title: スレッドプロファイラツール
tags:
  - APM
  - APM UI pages
  - Events
metaDescription: 'New Relic Java, .NET, Python, Ruby agents: You can use the thread profiler in production to identify bottlenecks in an application.'
translationType: machine
---

スレッドプロファイラは、アプリケーションのボトルネックを特定するために実運用環境で使用できる、影響の少ないプロファイリングツールです。スレッドプロファイラは、各スレッドのスタックトレースを定期的（100ms）にキャプチャし、指定された期間で動作します。指定された期間が終了すると、スタックトレースが集約され、ツリーが構築されます。ツリー内のコールカウントは、同じコンテキストでスタックトレース内にその関数が存在した回数に対応します。

コールツリーは実行全体を捉えることはできませんが、十分に大きなサンプルはアプリケーションの動作をよく表しています。これにより、ほとんどの時間が費やされているアプリの"ホット" の機能についての洞察が得られます。この範囲では、0.05%未満しかサンプリングされていないエントリは省略されます。

## 対応エージェント [#agents]

この機能は、特定のエージェントやバージョンでのみ利用可能です。

* Javaです。Agentバージョン1.2.004.6以上

* .NETに対応しています。

  * フレームワーク。Agentバージョン2.12.146.0以上
  * .NET Core 2.0を使用しています。Agentバージョン8.3.360.0以降（Windowsのみ）
  * Linux: .NET Core 3.0以上、エージェントバージョン8.23以上

* Pythonです。Agentバージョン1.7.0以上

* Rubyを使用しています。Agentバージョン3.5.5以上

## プロファイラーの起動 [#starting]

スレッドプロファイラ機能は、デフォルトで有効になっています。また、エージェントの設定ファイルでオン/オフを切り替えることができる場合もあります。

* Java: `thread_profiler.enabled`
* .NETの場合 ****.NETアプリでスレッドプロファイラを無効にすることはできません。
* Python: `thread_profiler.enabled`
* Ruby: `thread_profiler.enabled`

この機能を有効にすると、ユーザーインターフェースからスレッドプロファイラを表示することができます。

1. **[one.newrelic.com](https://one.newrelic.com) > APM> (select an app)> Events> Thread profiler** にアクセスします。
2. プロファイラーを実行するホストを選択します。
3. プロファイリングセッションの継続時間を設定します。
4. Select **Start profiler**.

これにより、エージェントは次のハーベストサイクル（1分ごと）にスレッドプロファイラを起動し、指定された期間のデータを取得するようになります。サンプル取得時に実行可能な状態であるかどうかに関わらず、スレッドのバックトレースを記録します。スリープしているスレッドやIOでブロックされているスレッドがコールツリーに表示されることがあります。

![スレッドプロファイラーのイメージです。](./images/thread-profiler-session.png "スレッドプロファイラの概要")

<figcaption>
  **[one.newrelic.com](https://one.newrelic.com) > APM> (select an app)> Events> Thread profiler**: このページを使って、スレッドプロファイラーの期間の設定を定義し、結果を表示します。
</figcaption>

## プロフィールデータを見る [#viewing]

プロファイラの実行が終了すると、エージェントがプロファイルデータを報告します。コールツリーは、 **Thread profiler** ページに自動的に表示されます。コールツリーのパーセンテージは、プロファイリングセッション中に各コールパスが出現したスレッドバックトレースサンプルのパーセンテージを表しています。データ収集はPROFILE COLLECTEDの時間に開始されました。

このページでは、ツリーの結果を色分けしています。

* 赤。30％以上の割合
* 黄色。割合が10％を超えるもの
* ブラック割合が10％未満

<table>
  <thead>
    <tr>
      <th width={200}>
        **以下を行う場合...**
      </th>

      <th>
        **操作...**
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        スレッドのプロフィール情報の表示方法の変更
      </td>

      <td>
        **Tree settings** で利用可能なオプションを選択し、 **Refresh tree** を選択します。
      </td>
    </tr>

    <tr>
      <td>
        情報表示量の変更
      </td>

      <td>
        コールツリーの上にある「 **Expand** 」または「 **Collapse** 」オプションを選択するか、コールツリーの任意の行で名前または矢印を選択します。
      </td>
    </tr>

    <tr>
      <td>
        コールツリー内の任意の行のサマリー情報を表示する
      </td>

      <td>
        ラインにマウスオーバーします。
      </td>
    </tr>

    <tr>
      <td>
        スレッドプロファイルの結果を他の人にメールで送信
      </td>

      <td>
        Select **Share this profile**.
      </td>
    </tr>

    <tr>
      <td>
        別のセッションを開始したり、別のスレッドプロファイルを表示する
      </td>

      <td>
        選択 **すべてのプロファイルに戻る**.
      </td>
    </tr>
  </tbody>
</table>

## エージェントの考慮事項 [#agent-requirements]

どのエージェントを使用するかによって、スレッドプロファイリング機能には追加の考慮事項があります。

<CollapserGroup>
  <Collapser
    id="net"
    title=".NET特有の注意点"
  >
    .NET Frameworkのエージェントでスレッドプロファイリングを使用する場合、以下の点に注意してください。

    <table>
      <thead>
        <tr>
          <th width={200}>
            **.NETエージェント**
          </th>

          <th>
            **スレッドプロファイラーの注意点**
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            **Linuxでサポートされています。**
          </td>

          <td>
            **Linux** 上のスレッドプロファイリングは、.NETエージェントバージョン8.23以降を実行する場合、.NET Core 3.0以降のアプリケーションでサポートされます。
          </td>
        </tr>

        <tr>
          <td>
            管理されたスレッドのみ
          </td>

          <td>
            .NETエージェントの場合、スレッドプロファイラは管理されたスレッドのスタックトレースのみをキャプチャします。管理されていないスレッドのスタックトレースはキャプチャされません。管理されていない関数への呼び出しが管理されているスレッド上で発生した場合、スレッドプロファイラはコールツリーに `Native:Function Call` を表示します。
          </td>
        </tr>

        <tr>
          <td>
            ラインナンバーなし
          </td>

          <td>
            .NETスレッドプロファイルでは、コールツリーに行番号が含まれていません。ツリーの設定にある **Show line numbers** チェックボックスは何の効果もありません。
          </td>
        </tr>

        <tr>
          <td>
            64bit v4.0 .NET CLRの不具合について
          </td>

          <td>
            64ビット版の4.0 .NET共通言語ランタイム（CLR）には、エージェントが管理されたスタックトレースを取得する機能を妨害するバグがあります。アプリケーションにこのバグがある場合、APMは空のスレッドプロファイルを表示します。このバグは、32ビットアプリケーションには影響しません。

            このバグは、.NET 4.5 の CLR リリースで修正されています。お使いの64ビットアプリケーションが修正されたバージョンであるかどうかを確認するには、 **C:Japanese Windows\\Microsoft.NET\\Framework64\\v4.0.30319** ディレクトリにある `mscorlib.dll` のフルバージョンをご覧ください。修正されたバージョンは 4.0.30319.17379 以上です。
          </td>
        </tr>

        <tr>
          <td>
            **その他** カテゴリーのみ
          </td>

          <td>
            すべてのスレッドは、 **Other** カテゴリに入れられます。 **Web Request** と **Background** のカテゴリはサポートされていません。
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>

  <Collapser
    id="agent-thread-profiling"
    title="Python特有の注意点"
  >
    Pythonエージェントでスレッドプロファイリングを使用する場合、以下の点に注意してください。

    <table>
      <thead>
        <tr>
          <th width={200}>
            **Pythonエージェント**
          </th>

          <th>
            **スレッドプロファイラーの注意点**
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            コルーティンベースのシステム
          </td>

          <td>
            gunicorn の gevent や eventlet モードのようなコルーチンベースのシステムを使用している場合、詳細をキャプチャするには限界があります。新しいスレッドを作成する場合、Pythonエージェントはスレッドプロファイラのバックグラウンドスレッドではなく、実際にグリーンレットを作成します。そのため、スレッドプロファイラは、スレッドプロファイラページ上のWebリクエストとバックグラウンドトランザクションをキャプチャしません。
          </td>
        </tr>

        <tr>
          <td>
            グリーンレット
          </td>

          <td>
            グリーンレットは，他のグリーンレットがブロックしたときなど，明示的に制御を放棄したときにのみ実行できます。例えば、スレッドサンプラが実行された場合、他のグリーンレットがブロックされた時点でのみスタックをサンプリングします。他のグリーンレットが任意のコードを実行しているときにはサンプリングしません。グリーンレットがブロックされたり、他のグリーンレットに譲ったりしていなければ、グリーンレット内の実行を完全に見逃すことができます。
          </td>
        </tr>

        <tr>
          <td>
            Pythonコードの時間
          </td>

          <td>
            リクエストをブロックしていない純粋なPythonコードに費やされた時間はピックアップされず、情報は記録されず、報告もされません。これは、コルーチンが使用されている場合、結果が誤解を招くためです。
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>

  <Collapser
    id="ruby"
    title="Ruby特有の注意点"
  >
    Rubyエージェントでスレッドプロファイリングを使用する場合、以下の点に注意してください。

    <table>
      <thead>
        <tr>
          <th width={200}>
            **Rubyエージェント**
          </th>

          <th>
            **スレッドプロファイラーの注意点**
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            バックトレース
          </td>

          <td>
            スレッドプロファイラは、Ruby アプリケーション内からスレッドのバックトレースを取得できるかどうかに依存しています。そのため、 **MRI 1.9.2 以上** (for `Thread#backtrace` メソッド) が必要です。
          </td>
        </tr>

        <tr>
          <td>
            Resque
          </td>

          <td>
            Rubyエージェントは現在、Resqueのバックグラウンド・ジョブでのスレッド・プロファイルをサポートしていません。Resqueに対して開始されたスレッド・プロファイリング・セッションは、ジョブ・プロセスではなく、親プロセスからのトレースのみをキャプチャします。
          </td>
        </tr>

        <tr>
          <td>
            JRuby
          </td>

          <td>
            JRuby のサポートは、現時点では実験的なものと考えられています。JRuby の `Thread#backtrace` の実装には、JRuby で収集されるバックトレースの精度や信頼性に影響を与える既知の問題があります。
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>
---
title: 外部サービスのセットアップ
metaDescription: Here are steps to enable and configure external services
freshnessValidatedDate: never
translationType: machine
---

外部サービス機能は、New Relic APM エージェントと [OpenTelemetry](/docs/more-integrations/open-source-telemetry-integrations/opentelemetry/introduction-opentelemetry-new-relic)で利用できます。

できるだけ早く立ち上げて実行したい場合は、APM エージェントを使用することをお勧めします。

ロゴをクリックすると New Relic プラットフォームに移動し、ガイドに従ってエージェントのインストールと構成を行います。

<TechTileGrid>
  <TechTile
    name="Go agent"
    icon="logo-go"
    to="https://one.newrelic.com/nr1-core?state=985d4005-ba90-a8c7-1da1-2af34539b03b"
  />

  <TechTile
    name="Java agent"
    icon="logo-java"
    to="https://one.newrelic.com/nr1-core?state=80d18bcb-4919-1fcb-2b77-9406838eb916"
  />

  <TechTile
    name=".NET agent"
    icon="logo-dotnet"
    to="https://one.newrelic.com/nr1-core?state=30e93090-6dfa-6b70-8e75-472f54414355"
  />

  <TechTile
    name="Node.js agent"
    icon="logo-nodejs"
    to="https://one.newrelic.com/marketplace/install-data-source?state=be2e62fa-cc3b-c428-27c4-8d662c9e80a1"
  />

  <TechTile
    name="PHP agent"
    icon="logo-php"
    to="https://one.newrelic.com/nr1-core?state=aa633b41-72d4-009c-3abf-55dcf64894fe"
  />

  <TechTile
    name="Python agent"
    icon="logo-python"
    to="https://one.newrelic.com/nr1-core?state=20fda75b-58fb-a92a-f9e1-7b052035c6e8"
  />

  <TechTile
    name="Ruby agent"
    icon="logo-ruby"
    to="https://one.newrelic.com/nr1-core?state=d69143ab-605c-579b-25bf-cc6e5fee5b80"
  />
</TechTileGrid>

## 外部サービスの設定

次の手順では、外部サービスをセットアップする手順を説明します。

<Steps>
  <Step>
    ### データの送信を開始する

    外部サービスのセットアップは、APM エージェントを使用しているか OpenTelemetry を使用しているかによって異なります。お使いのシステムに合ったインストール オプションのタブを選択します。

    <Tabs>
      <TabsBar>
        <TabsBarItem id="send-data-apm">
          APMエージェント
        </TabsBarItem>

        <TabsBarItem id="send-data-otel">
          OpenTelemetry
        </TabsBarItem>
      </TabsBar>

      <TabsPages>
        <TabsPageItem id="send-data-apm">
          外部サービスで表示するサービスごとに、以下を実行します。

          1. まだ行っていない場合は、適切なNewRelicAPM[エージェント](/docs/distributed-tracing/enable-configure/quick-start)をインストールします。

          2. エージェントで分散トレースがオンになっていることを確認します。

             * 新しいエージェントをインストールした場合、標準の分散トレースはデフォルトでオンになっています。サービスがInfiniteTracingを使用する他のサービスと通信する場合は、InfiniteTracingのヘルプについてエージェントのドキュメントを参照してください。
             * 古いエージェントを使用している場合は、構成手順に従って、標準の分散トレースまたは無限トレースを有効にします。分散トレースを有効にすると、古いクロスアプリケーショントレースが上書きされます。

          3. エージェントに追加のセットアップ手順が必要かどうかを確認します。

             <table>
               <thead>
                 <tr>
                   <th style={{ width: "200px" }}>
                     エージェント
                   </th>

                   <th>
                     最小バージョン
                   </th>

                   <th>
                     セットアップ
                   </th>
                 </tr>
               </thead>

               <tbody>
                 <tr>
                   <td>
                     Go
                   </td>

                   <td>
                     3.6.0
                   </td>

                   <td>
                     [`NewRoundTripper()`](/docs/apm/agents/go-agent/instrumentation/instrument-go-segments/)の使用に関するドキュメントを参照してください。
                   </td>
                 </tr>

                 <tr>
                   <td>
                     Java
                   </td>

                   <td>
                     5.13.0
                   </td>

                   <td>
                     [JavaエージェントAPI](/docs/apm/agents/java-agent/api-guides/java-agent-api-instrument-external-calls-messaging-datastore-web-frameworks/)を使用して外部呼び出しを計測する方法については、ドキュメントを参照してください。
                   </td>
                 </tr>

                 <tr>
                   <td>
                     .NET
                   </td>

                   <td>
                     8.29.0
                   </td>

                   <td>
                     Azureの.NETエージェントと.NETエージェントは、外部呼び出しを自動的にインストルメントしますが、トランザクションのメソッドはインストルメントしません。トランザクションを表示するには、次の組み合わせを使用する必要があります。

                     * [カスタムトランザクション](/docs/agents/net-agent/instrumentation/net-custom-transactions/)
                     * [計装された労働者の役割](/docs/apm/agents/net-agent/azure-installation/install-net-agent-azure-cloud-services/#requirements)
                   </td>
                 </tr>

                 <tr>
                   <td>
                     Node.js
                   </td>

                   <td>
                     6.9.0
                   </td>

                   <td>
                     [Node.jsエージェントAPI](/docs/apm/agents/nodejs-agent/api-guides/guide-using-nodejs-agent-api/#external-services)の使用に関するドキュメントを参照してください。
                   </td>
                 </tr>

                 <tr>
                   <td>
                     PHP
                   </td>

                   <td>
                     9.12.0.268
                   </td>

                   <td>
                     [PHPエージェントAPI](/docs/apm/agents/php-agent/php-agent-api/guide-using-php-agent-api/#datastore)を使用して外部呼び出しを計測する方法についてのドキュメントを参照してください。
                   </td>
                 </tr>

                 <tr>
                   <td>
                     Python
                   </td>

                   <td>
                     5.14.0.142
                   </td>

                   <td>
                     追加の手順は必要ありません。外部通話は自動的に計測されます。
                   </td>
                 </tr>

                 <tr>
                   <td>
                     Ruby
                   </td>

                   <td>
                     6.12.0.367
                   </td>

                   <td>
                     [RubyエージェントAPI](/docs/apm/agents/ruby-agent/api-guides/guide-using-ruby-agent-api/#externals)を使用して外部呼び出しを計測する方法についてのドキュメントを参照してください。
                   </td>
                 </tr>
               </tbody>
             </table>

             <Callout variant="tip">
               従来の外部サービスをすでに使用しているエージェントのチェーンに新しいサービスを追加する必要がある場合は、従来のバージョンの外部サービスを引き続き使用できます。従来の外部サービスをインストールするには、以下の手順で分散トレースの代わりに[クロスアプリケーショントレース](/docs/apm/transactions/cross-application-traces/introduction-cross-application-traces)を有効にします。
             </Callout>
        </TabsPageItem>

        <TabsPageItem id="send-data-otel">
          サービスの OpenTelemetry インストルメンテーションをセットアップする手順と、他のサービスへの [呼び出しを](https://opentelemetry.io/docs/java/manual_instrumentation/#span-attributes) 完了すると、New Relic UI に外部サービスの詳細が表示されます。 外部サービス機能は、サービス間の呼び出しを、各サービスのトランザクション エンドポイント別に分類して表示します。各トランザクションの名前は、プロセスのエントリ スパン ( `span.kind = "server"` ) から派生します。

          APMサービスがOpenTelemetryサービス（アップストリームまたはダウンストリーム）に接続されている場合、そのOpenTelemetryサービスはそのAPMサービスのビューに表示されません。これは、APMサービスを表示するときに、この機能がAPMエージェントによってのみ報告されるメトリックを使用するためです。 OpenTelemetryサービスを表示すると、APMサービスが接続として表示されます。

          表示される情報の品質は、コレクターで使用しているサンプリング戦略によって異なります。サンプリングを使用してUIに表示される内容を制御する方法については、次のセクションを参照してください。

          <Callout variant="tip">
            OpenTelemetryデータの100％をTrace APIに送信する場合、組織に特定のレート制限がある場合、またはデフォルトのレート制限をトリガーするのに十分なデータを送信する場合を除き、そのデータの100％が保存されます。
          </Callout>
        </TabsPageItem>
      </TabsPages>
    </Tabs>
  </Step>

  <Step>
    ### より多くのUIデータを表示するには、サンプリングを調整します [#adjust-sampling]

    APM エージェントを使用していて、マップの最初のページを超えてドリルを開始したときにデータがほとんど、またはまったく表示されない場合は、より多くのデータをサンプリングするためにスパン リザーバーを調整する必要がある場合があります。これは、トランザクション レベルのデータがサンプリングされたトレース データによって設定されるためです。

    OpenTelemetry の場合、最初のページとすべてのドリルダウン ページの両方にサンプリングされたデータが入力されるため、必要なデータを取得するにはサンプリングでいくつかの調整が必要になる場合があります。

    ここでは、APM エージェントのリザーバーを調整するためのさまざまなルーチンに関する情報と、OpenTelemetry のサンプリングを調整するためのヒントを示します。

    <Tabs>
      <TabsBar>
        <TabsBarItem id="agent-sample">
          APMエージェントのサンプリング
        </TabsBarItem>

        <TabsBarItem id="otel-sample">
          OpenTelemetryサンプリング
        </TabsBarItem>
      </TabsBar>

      <TabsPages>
        <TabsPageItem id="agent-sample">
          すべてのAPMエージェントにはスパンを格納するリザーバーがあり、これらのエージェントリザーバーのほとんどは構成可能です。このリザーバーのサイズは、エージェントが作成するすべてのスパンを送信できる可能性に影響します。詳細については、 [断片化されたトレース](/docs/distributed-tracing/ui-data/understand-use-distributed-tracing-ui/#fragmented-traces)を参照してください。

          この機能のデータは、あるサービスから別のサービスへの外部呼び出しが行われる隣接するクライアントおよびサーバースパンから取得されます。エージェントがスパンリザーバの制限に達すると、これらのコールを表すいくつかのスパンをドロップする可能性があります。

          デフォルトのエージェント設定値2000は、エージェントが1分間に収集するイベントの最大数を定義します。この数よりも多くのスパンがある場合、エージェントは統計サンプリングを収集し、外部サービスマップで使用されるデータの量を本質的に低下させます。

          UIに必要な種類の詳細が表示されない場合は、リザーバーのサイズを最大10,000まで増やすことができます。エージェントリザーバーを調整するには、以下を確認してください。

          <table>
            <thead>
              <tr>
                <th style={{ width: "200px" }}>
                  APMエージェント
                </th>

                <th>
                  ドキュメント
                </th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <td>
                  Go
                </td>

                <td>
                  リザーバーは現在構成できません
                </td>
              </tr>

              <tr>
                <td>
                  Java
                </td>

                <td>
                  [Java構成](/docs/apm/agents/java-agent/configuration/java-agent-configuration-config-file/#cfg-span-events-max-samples-stored)
                </td>
              </tr>

              <tr>
                <td>
                  .NET
                </td>

                <td>
                  [.NET構成](/docs/apm/agents/net-agent/configuration/net-agent-configuration/#paragrp-max-samples-stored)
                </td>
              </tr>

              <tr>
                <td>
                  Node.js
                </td>

                <td>
                  [Node.js構成](/docs/apm/agents/nodejs-agent/installation-configuration/nodejs-agent-configuration/#span-events-max-samples-stored)
                </td>
              </tr>

              <tr>
                <td>
                  PHP
                </td>

                <td>
                  リザーバーは現在構成できません
                </td>
              </tr>

              <tr>
                <td>
                  Python
                </td>

                <td>
                  [Python 構成](/docs/apm/agents/python-agent/configuration/python-agent-configuration/#environment-variables) ( `NEW_RELIC_SPAN_EVENTS_MAX_SAMPLES_STORED`を参照)
                </td>
              </tr>

              <tr>
                <td>
                  Ruby
                </td>

                <td>
                  [Ruby構成](/docs/apm/agents/ruby-agent/configuration/ruby-agent-configuration/#span_events-max_samples_stored)
                </td>
              </tr>
            </tbody>
          </table>
        </TabsPageItem>

        <TabsPageItem id="otel-sample">
          <Callout variant="tip">
            このセクションは、サービスが OpenTelemetry Collector 経由で New Relic にデータを送信している場合にのみ適用されます。これは、データが OpenTelemetry Collector でサンプリングされていないためです。
          </Callout>

          OpenTelemetryの場合、すべての外部サービスビューにはサンプリングされたトレースが入力されます。これは、十分な有用なデータが表示されない可能性があることを意味します。これを解決するには、コレクターのサンプリングを変更して、より多くのデータをNewRelicに入れることができます。

          詳細については、 [「サンプリング」](https://opentelemetry.io/docs/concepts/sampling/)を参照してください。
        </TabsPageItem>
      </TabsPages>
    </Tabs>
  </Step>
</Steps>

## 次は何ですか？ [#next]

* 外部サービスを使用して [API の問題をトラブルシューティングする](/docs/tutorial-external-services/respond-external)方法を学ぶ
* [外部サービス UI の操作](/docs/apm/apm-ui-pages/monitoring/external-services/external-services-ui)について詳しくは、こちらをご覧ください。
* UIを理解する方法について質問がある場合は、[ヒント](/docs/apm/apm-ui-pages/monitoring/external-services/external-services-ui)を参照してください。

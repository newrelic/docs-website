---
title: Configuração
metaDescription: Overview of the Agent Control configuration
freshnessValidatedDate: never
translationType: machine
---

<Callout title="visualização">
  Ainda estamos trabalhando nesse recurso, mas adoraríamos que você experimentasse!

  Atualmente, esse recurso é fornecido como parte de um programa de visualização de acordo com nossas [políticas de pré-lançamento](/docs/licenses/license-information/referenced-policies/new-relic-pre-release-policy).
</Callout>

O arquivo [`values-newrelic.yaml`](https://github.com/newrelic/helm-charts/blob/master/charts/agent-control/values.yaml) , que tradicionalmente definia as configurações do agente New Relic , agora também inclui configuração para o Agent Control. O parâmetro que você define neste arquivo determina como o Agent Control e seu agente gerenciado operam. Este arquivo é chamado de **configuração local**.

Aqui está um exemplo de configuração:

<CollapserGroup>
  <Collapser id="agent-control-config" title="Configuração de Agent Control">
    ```yaml
    global:
      cluster: "YOUR_CLUSTER_NAME"
      licenseKey: "YOUR_LICENSE_KEY"
      userKey: "YOUR_USER_KEY"

    # Values related to the agent control's Helm chart release.
    # `https://github.com/newrelic/helm-charts/blob/master/charts/agent-control/values.yaml`
    agent-control-deployment:
      identityClientId: ""
      identityClientSecret: ""
      config:
        fleet_control:
          # Optional: Specify a fleet_id (entity guid) to automatically connect to an existing fleet.
          fleet_id: ""
          auth:
            # New Relic organization ID where agent will connect to.
            organizationId: "YOUR_ORGANIZATION_ID"

        # List of managed agents that will be deployed. The key represents the name of the agent and the value holds the configuration.
        subAgents:
          infrastructure:
            type: newrelic/com.newrelic.infrastructure:0.1.0
            content:
              # Ref: `https://github.com/newrelic/helm-charts/tree/master/charts/nri-bundle`
              # Recommended: check and define an explicit chart version (latest stable)
              chart_version: "*"
              chart_values:
                newrelic-infrastructure:
                enableProcessMetrics: true
          logs:
            type: newrelic/io.fluentbit:0.1.0
            content:
              # Ref: `https://github.com/newrelic/helm-charts/tree/master/charts/newrelic-logging`
              # Recommended: check and define an explicit chart version (latest stable)
              chart_version: "*"
              chart_values:
                newrelic-logging:
                  sendMetrics: true
          agent-operator:
            type: com.newrelic.k8s_agent_operator:0.1.0
            content:
              chart_version: "*"
    ```
  </Collapser>
</CollapserGroup>

O exemplo demonstra como configurar o Agent Control junto com dois agentes gerenciados: o agente de infraestrutura Kubernetes e Fluent Bit para encaminhamento de logs. Por exemplo, se você não quiser enviar métricas de saúde para seu coletor de log Fluent Bit , basta definir `sendMetrics: false` no arquivo YAML antes de executar o comando de instalação.

Para implantar a configuração centralmente no cluster, defina esse mesmo conteúdo YAML na seção **Configurations** do [Controle de Agentes](/docs/new-relic-control/fleet-control/overview). Você pode então aplicar a configuração a uma frota inteira de clusters como parte de uma implantação remota. Isso é chamado de arquivo de **configuração remota** .

A configuração remota garante um comportamento consistente do agente em todo o seu ambiente, simplifica o gerenciamento de alterações e permite que você dimensione a observabilidade sem gerenciar manualmente os arquivos YAML locais.

O Agent Control usa Kubernetes `ConfigMaps` para armazenar e aplicar configurações de configuração. Se houver configuração local e remota, **a configuração remota** terá precedência por padrão. Para substituir intencionalmente as configurações remotas e voltar à configuração local, você pode implantar uma **configuração remota vazia** através do Controle de Agentes. Tenha em mente que essa alteração será aplicada a **todos os clusters** da frota selecionada.

Para explorar todas as configurações disponíveis, consulte [`values-newrelic.yaml`](https://github.com/newrelic/helm-charts/blob/master/charts/agent-control/values.yaml).

## Configuração de amostra

Os exemplos a seguir mostram como configurar o Agent Control para gerenciar diferentes conjuntos de agentes. Essas configurações podem ser utilizadas durante a instalação inicial ou como parte de uma configuração remota no Controle de Agentes.

### Infraestrutura New Relic e Fluent Bit

Este exemplo implanta Agent Control com monitoramento de infraestrutura e Fluent Bit para coleta de logs.

<CollapserGroup>
  <Collapser id="agent-control-config" title="Configuração local para infraestrutura e Fluent Bit">
    ```yaml
    global:
      cluster: "YOUR_CLUSTER_NAME"
      licenseKey: "YOUR_LICENSE_KEY"
      userKey: "YOUR_USER_KEY"

    # See `https://github.com/newrelic/helm-charts/blob/master/charts/agent-control/values.yaml`
    agent-control-deployment:
      identityClientId: ""
      identityClientSecret: ""
      config:
        fleet_control:
          # Optional
          # fleet_id: YOUR_FLEET_ENTITY_GUID
          auth:
            organizationId: "YOUR_ORGANIZATION_ID"
        subAgents:
          infrastructure:
            type: newrelic/com.newrelic.infrastructure:0.1.0
            content:
              # Ref: `https://github.com/newrelic/helm-charts/tree/master/charts/nri-bundle`
              # Recommended: check and define an explicit chart version (latest stable)
              chart_version: "*"

              #chart_values:
              #  newrelic-infrastructure:
              #    enableProcessMetrics: true
          logs:
            type: newrelic/io.fluentbit:0.1.0
            content:
              # Ref: `https://github.com/newrelic/helm-charts/tree/master/charts/newrelic-logging`
              # Recommended: check and define an explicit chart version (latest stable)
              chart_version: "*"

              #chart_values:
              #  newrelic-logging:
              #    sendMetrics: true
          agent-operator:
            type: com.newrelic.k8s_agent_operator:0.1.0
            chart_version: "*"
    ```
  </Collapser>
</CollapserGroup>

### OpenTelemetry com configurações de coletor personalizadas

Este exemplo implanta o Agent Control com a distribuição New Relic do OpenTelemetry (NRDOT) coleta e desabilita o receptor `filelog` no [gráfico Helm gerenciado`nr-k8s-otel-collector` ](https://github.com/newrelic/helm-charts/tree/master/charts/nr-k8s-otel-collector#values).

<CollapserGroup>
  <Collapser id="otel-config" title="Configuração OpenTelemetry">
    ```yaml
    global:
      cluster: "YOUR_CLUSTER_NAME"
      licenseKey: "YOUR_LICENSE_KEY"
    # Values related to the agent control's Helm chart release.
    # `https://github.com/newrelic/helm-charts/blob/master/charts/agent-control/values.yaml`
    agent-control-deployment:
      identityClientId: ""
      identityClientSecret: ""
      config:
        fleet_control:
          # Optional: Specify a fleet_id (entity guid) to automatically connect to an existing fleet.
          fleet_id: ""
          auth:
            # New Relic organization ID where agent will connect to.
            organizationId: "YOUR_ORGANIZATION_ID"

        # List of managed agents that will be deployed. The key represents the name of the agent and the value holds the configuration.
        subAgents:
          infrastructure:
            type: newrelic/com.newrelic.infrastructure:0.1.0
            content:
              # Ref: `https://github.com/newrelic/helm-charts/tree/master/charts/nri-bundle%60
              # Recommended: check and define an explicit chart version (latest stable)
              chart_version: "*"
          agent-operator:
            type: newrelic/com.newrelic.k8s_agent_operator:0.1.0
            content:
              chart_version: "*"
          fluentbit:
            type: newrelic/io.fluentbit:0.1.0
            content:
              # Ref: `https://github.com/newrelic/helm-charts/tree/master/charts/newrelic-logging`
              # Recommended: check and define an explicit chart version (latest stable)
              chart_version: "*"
              chart_values:
                global:
                  lowDataMode: true
          prometheus:
            type: newrelic/com.newrelic.prometheus:0.1.0
            content:
              chart_version: "*"
              chart_values:
                global:
                  lowDataMode: true
                newrelic-prometheus-agent:
                  config:
                    kubernetes:
                      integrations_filter:
                        enabled: false
    ```
  </Collapser>
</CollapserGroup>

### Configuração remota: New Relic Infrastructure

Este exemplo mostra como configurar remotamente o agente da New Relic Infrastructure para Kubernetes usando o Controle de Agentes. Ele permite a coleta de métricas do processo definindo `enableProcessMetrics: true`.

<CollapserGroup>
  <Collapser id="infra-remote-config" title="configuração remota de infraestrutura">
    ```yaml
    chart_version: "*"
    chart_values:
      newrelic-infrastructure:
        enableProcessMetrics: true
    ```
  </Collapser>
</CollapserGroup>

### Configuração remota: Fluent Bit

Este exemplo configurou Fluent Bit remotamente via Controle de Agentes. Ele habilita relatórios métricos de saúde do coletor de logs definindo `sendMetrics: true`.

<CollapserGroup>
  <Collapser id="fluentbit-remote-config" title="Configuração Fluent Bit">
    ```yaml
    chart_version: "*"
    chart_values:
      newrelic-logging:
        sendMetrics: true
    ```
  </Collapser>
</CollapserGroup>

### Configuração remota: Prometheus

Este exemplo configura o agente Prometheus remotamente usando o Controle de Agentes. Ele permite que `low-data mode` reduza o volume de telemetria e desabilite a integração padrão.

<CollapserGroup>
  <Collapser id="prometheus-config" title="Configuração do Prometheus">
    ```yaml
    chart_version: "*"
    chart_values:
      newrelic-prometheus-agent:
        lowDataMode: true
    ```
  </Collapser>
</CollapserGroup>

### Configuração remota: OpenTelemetry

<CollapserGroup>
  <Collapser id="prometheus-config" title="Configuração do Prometheus">
    <Callout variant="important">
      Crie um segredo do Kubernetes para armazenar com segurança a chave de licença do New Relic e usá-la em `chart_values` em substituição ao valor `licenseKey` :

      ```yaml
      customSecretName: "your-secret-name"
      customSecretLicenseKey: "your-secret-key"
      ```
    </Callout>

    Recomendamos utilizar o Controle de Agentes para definir e implantar a configuração OpenTelemetry em suas frotas. Para configurar OpenTelemetry remotamente, crie uma configuração no Controle de Agentes com a estrutura mostrada abaixo. Você pode ajustar valores como `lowDataMode` ou `receivers.filelog.enabled` e incluir quaisquer outras configurações relevantes do gráfico Helm com base em suas necessidades.

    ```yaml
    chart_version: "*"
    chart_values:
      newrelic-prometheus-agent:
        lowDataMode: true
    ```
  </Collapser>
</CollapserGroup>

## Configuração de proxy

Agent Control suporta configuração de proxy para rotear tráfego por meio de proxies corporativos ou intermediários de rede. A configuração do proxy pode ser definida por meio de variáveis de ambiente ou diretamente no arquivo de configuração.

### Precedência de proxy

Agent Control usará as configurações de proxy na seguinte ordem de precedência:

1. `proxy` Campo de configuração na configuração de Agent Control
2. `HTTP_PROXY` variável de ambiente
3. `HTTPS_PROXY` variável de ambiente

<Callout variant="important">
  A configuração do proxy atualmente não é compatível com a busca do certificado para validação da assinatura. Se precisar configurar um proxy, você tem estas opções:

  * Adicione uma exceção firewall a `https://newrelic.com` para que requests para esse endpoint possam ignorar o proxy (recomendado)
  * Use um certificado local por meio de `fleet_control.signature_validation.certificate_pem_file_path` (a rotação do certificado deve ser tratada manualmente)
  * Desabilite a validação de assinatura definindo `fleet_control.signature_validation.enabled: false` (altamente desencorajado por motivos de segurança)
</Callout>

### Configuração de proxy com certificados autoassinados

Para configurações de proxy usando autenticação HTTPS com certificados autoassinados, você precisa fornecer o pacote de certificado da CA e configurar a autenticação de proxy:

<CollapserGroup>
  <Collapser id="k8s-proxy-config" title="Exemplo de configuração de proxy do Kubernetes">
    ```yaml
    global:
      cluster: "YOUR_CLUSTER_NAME"
      licenseKey: "YOUR_LICENSE_KEY"

    agent-control-deployment:
      config:
        agentControl:
          content:
            proxy:
              url: https://proxy-service:8080
        subAgents: {}

      # Mount CA certificate bundle to Agent Control
      extraVolumeMounts:
        - mountPath: /etc/ssl/certs/
          name: ca-certs
      extraVolumes:
        - name: ca-certs
          secret:
            secretName: ca-certs

    # Configure Flux components to use proxy
    agent-control-cd:
      flux2:
        sourceController:
          extraEnv:
            # Configure Flux source-controller to proxy all requests
            - name: HTTPS_PROXY
              value: https://proxy-service:8080
            # Except for in-cluster requests
            - name: "NO_PROXY"
              value: ".cluster.local.,.cluster.local,cluster.local,.svc,127.0.0.0/8,10.0.0.0/8"
          volumeMounts:
            # Mount CA certificate bundle to source-controller trust root store. The bundle should contain the
            # proxy CA cert.
            - mountPath: /etc/ssl/certs/
              name: ca-certs
          volumes:
            - name: ca-certs
              secret:
                secretName: ca-certs


    ```
  </Collapser>
</CollapserGroup>

### Configuração de proxy para agente gerenciado

<Callout variant="caution">
  Configurar um proxy no Agent Control **não** configura automaticamente as mesmas configurações de proxy para o agente que ele gerencia. Cada agente tem sua própria configuração de proxy, que deve ser definida separadamente, de acordo com o formato de configuração e os requisitos específicos do agente.
</Callout>

Ao usar um proxy, você também deve configurar as definições de proxy para cada agente gerenciado individualmente. Consulte a documentação específica de cada agente para obter opções de configuração de proxy.

## Gerenciamento de segredos

Agent Control provides a robust mechanism for managing sensitive data, such as passwords and API keys, by retrieving them from dedicated secret providers. This ensures that sensitive information is not hard-coded directly into configuration files. The system currently supports the following secret providers:

* HashiCorp Vault: referred to as `nr-vault` in configurations.
* Kubernetes Secrets: referred to as `nr-kubesec` in configurations.

### Defining Secrets in Configuration

To utilize secrets, define them within your Agent-Control configuration YAML file by following these steps:

1. **Define the `secrets_providers` section:** Configure your secret providers centrally in this section. Ensure each entry corresponds to a supported provider.
2. **Configure secret sources:** For each provider, specify one or more sources. A source includes the necessary configuration details (e.g., URL, token) for Agent control to connect to and retrieve a group of secrets.
3. **Use placeholders in agent configurations:** Instead of the actual sensitive data, Use a placeholder string within your agent&apos;s configuration. Agent control automatically replaces these placeholders with the retrieved secrets during the rendering process.

<Callout variant="important">
  If Agent control fails to retrieve a secret, the configuration rendering will fail, and the agent will not be executed. This is a critical security feature to prevent agents from running with incomplete or incorrect configurations.
</Callout>

The following agent-control configuration example demonstrates how to configure for retrieving secrets from two Vault sources within the `secrets_providers` section:

```yaml
secrets_providers:
  vault:
    sources:
      local-instance:
        url: http://localhost:8200/v1/
        token: root
        engine: kv2
      remote:
        url: http://my-remote-server:8200/v1/
        token: root
        engine: kv1

fleet_control:
  ...

agents:
  ...
```

#### Using Secrets in an Agent Configuration

After the sources are defined, in an agent configuration, you can reference the vault using a specific placeholder syntax with the correct path. Agent control retrieves the secret and uses it to render the final configuration file that the agent is going to use.

Example of agent configuration using vault placeholders:

```yaml
config_agent: |+
  enable_process_metrics: true
  custom_attributes:
    username: "${nr-vault:local-instance:secret:my_secret:username}"
    organization: "${nr-vault:remote:my_mount:my_path:organization}"
```

Neste exemplo:

The placeholder `${nr-vault:local-instance:secret:my_secret:username}` instructs Agent control to retrieve the value associated with the key username from the secret at the path `secret/my_secret` using the local-instance vault source. The placeholder `${nr-vault:remote:my_mount:my_path:organization}` similarly retrieves the value for the organization key from the remote source.

After successful retrieval, Agent control renders these secrets from the specified source and path, storing the result in a K8s secret or private config file for use by the corresponding agent.

### Segredos do cofre

Set up the vault sources with the following settings:

<table>
  <thead>
    <tr>
      <th style={{ width: "250px" }}>
        Chave YAML
      </th>

      <th>
        Descrição
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        `url`
      </td>

      <td>
        URL para solicitar dados
      </td>
    </tr>

    <tr>
      <td>
        `token`
      </td>

      <td>
        Used to authenticate to the endpoint.
      </td>
    </tr>

    <tr>
      <td>
        `engine`
      </td>

      <td>
        Specify **`kv1`** or **`kv2`**.
      </td>
    </tr>
  </tbody>
</table>

In the configuration file, each secret stored in Vault can be accessed by setting a placeholder with:

* **source\_name**: The name of the Vault source defined in `secrets_providers`.
* **mount**: The name of the secrets engine mount.
* **path**: The specific path to the secret.
* **specific key**: The specific key within the secret to be retrieved.

Example of full placeholder format:

```
"${nr-vault:source_name:my_mount:my_path:my_value}"
```

### Kubernetes secrets

If the agent-control pod has permissions, such as through a Service Account and Role-Based Access Control (RBAC), to access the required secrets and namespaces, Agent control can directly access secrets from the Kubernetes API without needing a separate sources configuration.

In the agent configuration file, retrieve each secret value using a placeholder specifying:

* **namespace**: The Kubernetes namespace where the secret is located.
* **name**: The name of the Kubernetes secret object.
* **specific key**: The specific key within the secret from which to retrieve the value.

For example, use the placeholder format:

```
"${nr-kubesec:my_namespace:my_secret:my_value}"
```

## Configuração de repositório privado

O agente Control suporta a configuração do repositório Helm privado para implantar o próprio agente Control e o agente gerenciado. Isso permite ambientes onde os gráficos do New Relic Helm não são diretamente acessíveis.

<Callout variant="caution">
  Ao usar o repositório privado Helm, os gráficos precisam ser compatíveis e as imagens referenciadas dentro dos gráficos devem ser acessíveis. Caso contrário, o agente não trabalhará como esperado.
</Callout>

### 1. Habilite repositório privado para agente

Por razões de segurança, somente o repositório explicitamente habilitado será permitido na configuração remota. Para habilitar repositório específico, é necessário atualizar a configuração do agente Control:

<CollapserGroup>
  <Collapser id="k8s-private-repository-config" title="Habilitar repositório privado">
    ```yaml
    # values-newrelic.yaml

    global:
      cluster: "YOUR_CLUSTER_NAME"
      licenseKey: "YOUR_LICENSE_KEY"

    # ...

    agent-control-deployment:
      config:
        allowedChartRepositoryUrl:
          - https://my-private-repository-1
          - https://my-private-repository-2
        # ...
    ```
  </Collapser>
</CollapserGroup>

A configuração do repositório permitida pode então ser usada em sua configuração remota dentro do New Relic Control. Exemplo:

```yaml
chart_version: "1.2.3"
chart_repository:
  url: "https://my-private-repository-1"
  name: "my-chart-name" # Optional: use only if the chart name doesn't match New Relic's chart name
```

Além disso, você precisa configurar a instalação Helm do agente Control para usar seu repositório privado se o próprio gráfico `agent-control` estiver em um repositório privado. Isso é separado da configuração do agente gerenciado. Consulte `agent-control` Helm chart [values.yaml](https://github.com/newrelic/helm-charts/blob/master/charts/agent-control/values.yaml) para configurar a seção `installationJob`. Especificamente:

* `chartRepositoryUrl` contendo a URL do seu repositório
* `name` se estiver usando um nome de gráfico diferente
* `repositorySecretReferenceName` e `repositoryCertificateSecretReferenceName` para autenticação (veja a seção de autenticação abaixo para detalhes)

### 2. Configure autenticação para repositório privado

Você precisa configurar recursos adicionais para habilitar a autenticação para acessar seu repositório privado:

<CollapserGroup>
  <Collapser id="k8s-private-repository-basic-auth" title="Autenticação básica">
    Para autenticar usando autenticação básica (nome de usuário e senha), você precisa criar um segredo no namespace do agente Control contendo os valores esperados em `data.username` e `data.password`.

    Exemplo:

    ```yaml
    apiVersion: v1
    kind: Secret
    metadata:
      name: my-secret
    stringData:
      username: "myUser"
      password: "myPassword"
    ```

    Para mais detalhes, consulte a [documentação do Flux](https://fluxcd.io/flux/components/source/helmrepositories/#secret-reference).

    Ao usar a autenticação básica, a configuração remota deve ser definida da seguinte maneira:

    ```yaml
    chart_repository:
      url: "https://my-private-repository-1"
      secret_reference:
        name: my-secret
    ```
  </Collapser>

  <Collapser id="k8s-private-repository-tls-cert" title="Autenticação de certificado TLS">
    Para autenticar usando TLS, você precisa criar um segredo contendo:

    * `tls.crt` e `tls.key`: certificado do cliente e chave privada usados para autenticação do cliente TLS
    * `ca.crt`: Certificado CA usado para verificar o servidor (obrigatório se o servidor usar um certificado autoassinado)

    O segredo deve ser do tipo `Opaque` ou `kubernetes.io/tls`. Espera-se que todos os arquivos no Secret sejam codificados em PEM.

    Exemplo:

    ```yaml
    apiVersion: v1
    kind: Secret
    metadata:
      name: my-secret
      namespace: newrelic-agent-control
    type: kubernetes.io/tls # or Opaque
    data:
      tls.crt: <BASE64>
      tls.key: <BASE64>
      # NOTE: Can be supplied without the above values
      ca.crt: <BASE64>
    ```

    Para mais detalhes, consulte a [documentação do Flux](https://fluxcd.io/flux/components/source/helmrepositories/#secret-reference).

    Ao usar a autenticação de certificado TLS, a configuração remota deve ser definida da seguinte maneira:

    ```yaml
    chart_repository:
      url: "https://my-private-repository-1"
      certificate_secret_reference:
        name: my-secret
    ```
  </Collapser>
</CollapserGroup>
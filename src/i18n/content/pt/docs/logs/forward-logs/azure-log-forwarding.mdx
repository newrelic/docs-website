---
title: Log de encaminhamento e log de atividades do Azure
tags:
  - Logs
  - Enable log management in New Relic
  - Enable log monitoring in New Relic
  - Azure
  - Cloud logs
  - EventHub
  - Event Hub
  - Blob Storage
metaDescription: 'Install and configure New Relic logging for Microsoft Azure Resources Manager (ARM), so you can use enhanced log management capabilities.'
freshnessValidatedDate: never
translationType: machine
---

Se o seu log já estiver sendo coletado no Azure, você poderá usar nossos modelos [Microsoft Azure Resource Manager (ARM)](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/overview) para encaminhá-los e enriquecê-los no New Relic.

Encaminhar seu registro do Azure para New Relic proporcionará <InlinePopover type="logs" />recursos aprimorados para coletar, processar, explorar, consultar e alertar sobre seus dados log .

Atualmente, oferecemos dois modelos ARM para conseguir isso: os modelos baseados em EventHub (recomendado) e os modelos baseados em Blob Storage.

## Enviar log de um Hub de eventos do Azure (recomendado) [#azure-eventhub]

O [modelo ARM do Hub de eventos New Relic ](https://github.com/newrelic/newrelic-azure-functions/blob/master/armTemplates/azuredeploy-eventhubforwarder.json)permite anexar um consumidor a um Hub de eventos novo ou existente para encaminhar o fluxo de entrada de log para New Relic. Ao utilizar esta configuração, pode configurar vários recursos do Azure para enviar o respetivo registo para um Hub de eventos e fazer com que estes registos sejam automaticamente encaminhados para New Relic. O modelo também permite configurar facilmente seu <DNT>**subscription**</DNT> registro de atividades para ser enviado à New Relic.

Para enviar o log do seu hub de eventos:

1. [implantar](#eventhub-arm-setup) o modelo New Relic evento Hub ARM.
2. Opcional: [configure seu registro de atividades <DNT>**subscription**</DNT> para ser enviado ao New Relic](#subscription-activity-logs).
3. Opcional: [configure um determinado recurso do Azure para enviar seu log de atividades individual](#resource-activity-logs).
4. [Explore seus dados log ](#find-data).

### Implantar o modelo ARM do New Relic evento Hub [#eventhub-arm-setup]

Siga esses passos:

1. Certifique-se de ter um <InlinePopover type="licenseKey" />.

2. Em <DNT>**[one.newrelic.com](https://one.newrelic.com/launcher/logger.log-launcher)**</DNT>, clique em <DNT>**Integrations &amp; Agents**</DNT> na navegação esquerda.

3. Na categoria <DNT>**Logging**</DNT> , clique no bloco <DNT>**Microsoft Azure Event Hub**</DNT> na lista de fontes de dados.

4. Selecione a conta para a qual deseja enviar o registro e clique em <DNT>**Continue**</DNT>.

5. Clique em <DNT>**Generate API key**</DNT> e copie a chave de API gerada.

6. Clique em <DNT>**Deploy to Azure**</DNT> e uma nova aba será aberta com o modelo ARM carregado no Azure.

7. Selecione o <DNT>**Resource group**</DNT> onde deseja criar os recursos necessários e um <DNT>**Region**</DNT>. Apesar de não ser obrigatório, recomendamos instalar o modelo em um novo grupo de recursos, para evitar a exclusão acidental de qualquer um dos componentes que ele cria.

8. No campo <DNT>**New Relic license key**</DNT> , cole a chave de API copiada anteriormente.

9. Certifique-se de que o [endpoint do New Relic](/docs/logs/log-api/introduction-log-api/#endpoint) esteja definido como aquele correspondente à sua conta.

10. Selecione o modo de escala. O valor padrão é `Basic`.

11. Opcional: Configure o parâmetro de agrupamento do EventHub (disponível na versão 2.8.0 ou superior) para otimizar o desempenho:

    * **Tamanho máximo do lote de eventos**: Número máximo de eventos por lote (padrão: 500, mínimo: 1)
    * **Tamanho mínimo do lote de eventos**: Número mínimo de eventos por lote (padrão: 20, mínimo: 1)
    * **Tempo máximo de espera**: Tempo máximo de espera para construir um lote no formato HH:MM:SS (padrão: 00:00:30)

12. Opcional: defina como `true` os [logs de atividades de assinatura do Azure](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log) que você deseja encaminhar. Consulte [as informações de assinatura](#subscription-activity-logs) neste documento para obter mais detalhes.

13. Clique em <DNT>**Review + create**</DNT>, revise os dados inseridos e clique em <DNT>**Create**</DNT>.

Observe que o modelo é idempotente. Você pode iniciar o encaminhamento do log do Event Hub e, em seguida, executar novamente o mesmo modelo para configurar o encaminhamento [do log de atividades do Azure assinatura](#subscription-activity-logs) , concluindo a etapa 10.

### Configure o agrupamento e o dimensionamento do EventHub (opcional) [#eventhub-configuration]

A partir da versão 2.8.0, o modelo ARM oferece suporte a opções avançadas de configuração do EventHub para otimizar o desempenho e as taxas de transferência:

**Parâmetro de lote do gatilho do EventHub:**

Você pode configurar o comportamento de agrupamento para controlar como os eventos são processados. Essas configurações são definidas como configurações do aplicativo Azure Functions:

* **Tamanho máximo do lote de eventos** : Número máximo de eventos entregues em um lote à função (padrão: 500, mínimo: 1). Isso controla o limite máximo de eventos processados em conjunto.

* **Tamanho mínimo do lote de eventos** : Número mínimo de eventos entregues em um lote para a função (padrão: 20, mínimo: 1). A função aguardará até acumular pelo menos esse número de eventos antes de processá-los, a menos que o tempo máximo de espera seja atingido.

* **Tempo máximo de espera** : Tempo máximo de espera para a formação de um lote antes de enviá-lo para a função (padrão: 00:00:30, formato: HH:MM:SS). Isso garante o processamento em tempo hábil mesmo quando o volume de eventos é baixo.

Esses parâmetros ajudam a otimizar as taxas de transferência e a utilização de recursos com base no volume de logs e nos requisitos de processamento. Ajuste esses valores de acordo com o seu caso de uso específico:

* Aumente o tamanho dos lotes para cenários de alto volume para melhorar as taxas de transferência
* Diminua o tamanho dos lotes para atender aos requisitos de baixa latência.
* Ajuste o tempo de espera para equilibrar a latência e a eficiência do processamento em lote.

**Dimensionando a configuração (v2.7.0+):**

O modelo permite configurar o modo de dimensionamento Azure Functions, possibilitando otimizar custos e desempenho com base na sua workload:

* **Modo de dimensionamento básico**: usa um plano baseado no consumo de SKU dinâmico (nível Y1) por padrão, onde Azure adiciona e remove automaticamente instâncias de funções com base no número de eventos recebidos.

  * Se a opção `disablePublicAccessToStorageAccount` estiver ativada, será utilizado um plano SKU Básico (nível B1) para suportar a integração com a VNet.
  * Este modo é ideal para cargas de trabalho variáveis e proporciona otimização automática de custos com preços por execução.
  * O namespace EventHub inclui 4 partições com escala de unidade de taxas de transferência padrão.

* **Modo de escalonamento empresarial**: Oferece recursos avançados de escalonamento com recursos de computação dedicados e maior controle sobre o escalonamento instantâneo. Este modo oferece:

  * Funcionalidade de dimensionamento automático para o Aplicativo de Funções e o Hub de Eventos.
  * Plano de hospedagem Elastic Premium (EP1) com escalonamento por site ativado.
  * Inflação automática do EventHub habilitada com taxas máximas de transferência de unidades de 40
  * Aumento do número de partições (32 partições em vez de 4 no modo Básico) para melhor paralelismo.
  * Desempenho previsível e menor latência com instância pré-aquecida
  * Mais adequado para cenários de encaminhamento de logs de alto volume e missão crítica.

**Observações importantes:**

* Ao atualizar do modo Básico para o modo Empresarial, você precisará provisionar novamente o EventHub devido à limitação do Azure de que uma SKU Standard não pode alterar a quantidade de partições após a criação.

<InstallFeedback />

### Opcional: envie o log de atividades do Azure da sua assinatura [#subscription-activity-logs]

[Os Logs de Atividades do Azure](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log) fornecem:

* Mais visibilidade dos seus recursos do Azure
* Atividade dos recursos do Azure
* Informações sobre ações realizadas
* Evento e seu carimbo de data/hora
* O usuário que executou uma ação, se aplicável

Estes são todos o nível da assinatura do evento. Se você desejar encaminhar o log de atividades de um recurso específico, consulte as [informações do log de atividades do recurso](#resource-activity-logs) neste documento.

Para obter mais informações sobre o formato do log de atividades, consulte o [esquema de evento de log de atividadesMicrosoft Azure ](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log-schema).

A [implantação do modelo New Relic evento Hub ARM](#eventhub-arm-setup) permite opcionalmente selecionar qual [log de atividades do Azure](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log) você deseja encaminhar para o New Relic, incluindo:

* Log de atividades administrativas do Azure
* Alerta Log de atividades do Azure
* Log de atividades do Azure de escalonamento automático
* Log de atividades do Azure da política
* Recomendação: logs de atividades do Azure
* Registo de atividades do Azure Health Resource
* Log de atividades do Azure de segurança
* Log de atividades do Azure de integridade do serviço

### Opcional: configure um recurso do Azure para enviar seu log de atividades [#resource-activity-logs]

Por padrão, este modelo configura apenas a função e os recursos necessários para encaminhar o log de um hub de eventos para New Relic. Também podemos configurar o log de atividades da assinatura para ser encaminhado, mas não há um encaminhamento padrão de logs dos seus recursos do Azure. Se quiser encaminhar o log de qualquer recurso que os produza, será necessário configurá-lo criando uma configuração de diagnóstico para o recurso determinado.

Por exemplo, se você tiver uma função em execução no Azure e quiser encaminhar o log para New Relic, precisará definir uma configuração de diagnóstico para encaminhar o log para o evento Hub. Para obter mais informações, consulte a [documentação da Microsoft para criar configurações de diagnóstico para envio de log e métrica da plataforma para diferentes destinos](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/diagnostic-settings?tabs=CMD).

No exemplo a seguir, demonstraremos como encaminhar o log de atividades de um recurso do Serviço Kubernetes em execução no Azure.

1. [implantar o modelo ARM do New Relic evento Hub](#eventhub-arm-setup).

2. Navegue até seu serviço Kubernetes:

   <img alt="Kubernetes Service Button" src="/images/serverless_screenshot-crop_Azure-event-hub-K8s-service.webp" />

3. No menu à esquerda, selecione <DNT>**Monitoring`>`Diagnostic Settings**</DNT>:

   <img alt="Diagnostic Settings menu" src="/images/serverless_screenshot-crop_Azure-event-hub-diagnostic-settings.webp" />

4. Clique em <DNT>**Add diagnostic setting**</DNT>.

5. No campo <DNT>**Diagnostic setting name**</DNT> , dê um nome significativo à sua nova configuração.

6. Selecione o log do Kubernetes (painel de controle) que você deseja coletar (por exemplo, `kube-apiserver`, `kube-audit`, `kube-scheduler`).

7. Em <DNT>**Destination details**</DNT>, selecione <DNT>**Stream to an event hub**</DNT> e configure `Event hub namespace`, `Event hub name` e `Event hub policy name`. Caso você tenha optado por criar um novo evento Hub e um namespace durante a [implantação do modelo ARM](#eventhub-arm-setup), selecione as seguintes configurações criadas automaticamente (o nome do namespace terá um sufixo diferente):

   <img alt="Destination details settings" src="/images/serverless_screenshot-crop_Azure-event-hub-destination-details-settings.webp" />

8. Clique em <DNT>**Save**</DNT> para começar a encaminhar seu log Kubernetes para o New Relic:

## Enviar log do armazenamento de Blobs do Azure [#azure-blob-storage]

[O Azure Blob Storage](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction) permite armazenar grandes quantidades de dados não estruturados, incluindo arquivo de log. Usando o [modelo ARM do New Relic Blob Storage](https://github.com/newrelic/newrelic-azure-functions/blob/master/armTemplates/azuredeploy-blobforwarder.json), você poderá criar uma função que encaminha o conteúdo de um [contêiner colocado em uma conta de armazenamento](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction#blob-storage-resources).

<Callout variant="important">
  New Relic Blob Storage implanta uma função que encaminha todos os arquivos blob dentro do contêiner <DNT>**at their current state**</DNT> especificado. Se algum desses blobs for modificado posteriormente, o conteúdo <DNT>**complete**</DNT> do arquivo será reenviado.

  Esta solução AI Monitoring para encaminhar arquivos blob estáticos para New Relic e não oferece suporte a rastreamento de arquivos. Se você precisar encaminhar um fluxo de log, recomendamos enviar o log do aplicativo para um `Event Hub` e usar o [modelo baseado no Event Hub](#azure-eventhub) .
</Callout>

Para enviar os blobs de um contêiner na sua conta de armazenamento, siga estas etapas:

1. [implantar](#blobstorage-arm-setup) o modelo ARM do New Relic Blob Storage.
2. [Explore seus dados log ](#find-data).

### Implantar o modelo ARM do New Relic Blob Storage [#blobstorage-arm-setup]

Siga esses passos:

1. Certifique-se de ter um <InlinePopover type="licenseKey" />.
2. Vá para <DNT>**[the logs UI](https://one.newrelic.com/launcher/logger.log-launcher)**</DNT> e, à esquerda, clique em <DNT>**Integrations &amp; Agents**</DNT>.
3. Em <DNT>**Logging**</DNT>, clique no bloco `Microsoft Azure Blob Storage` .
4. Selecione a conta para a qual deseja enviar o registro e clique em <DNT>**Continue**</DNT>.
5. Clique em <DNT>**Generate API key**</DNT> e copie o <DNT>**API key**</DNT> gerado.
6. Clique em <DNT>**Deploy to Azure**</DNT> e uma nova aba será aberta com o modelo ARM carregado no Azure.
7. Selecione o <DNT>**Resource group**</DNT> onde deseja criar os recursos necessários e um <DNT>**Region**</DNT>. Apesar de não ser obrigatório, recomendamos instalar o modelo em um novo grupo de recursos, para evitar a exclusão acidental de qualquer um dos componentes que ele cria.
8. No campo <DNT>**New Relic license key**</DNT> , cole o <DNT>**API key**</DNT> copiado anteriormente.
9. Introduza os nomes da conta de armazenamento e do contêiner que deseja encaminhar.
10. Certifique-se de que o [endpoint do New Relic](/docs/logs/log-api/introduction-log-api/#endpoint) esteja definido como aquele correspondente à sua conta.
11. Clique em <DNT>**Review + create**</DNT>, revise os dados inseridos e clique em <DNT>**Create**</DNT>.

## Ver dados log [#find-data]

Se tudo estiver configurado corretamente e seus dados estiverem sendo coletados, você deverá ver os dados de log em ambos os locais:

* Nossa [interface de registros](https://one.newrelic.com/launcher/logger.log-launcher)
* Nossas ferramentas para executar [a consulta NRQL](/docs/chart-builder/use-chart-builder/choose-data/use-advanced-nrql-mode-specify-data). Por exemplo, você pode executar uma consulta como esta:

```sql
SELECT * FROM Log
```

Se você quiser consultar apenas o log vindo do Azure, execute a seguinte consulta:

```sql
SELECT * FROM Log WHERE plugin.type = 'azure'
```

## Resolução de problemas [#troubleshoot]

Se você encontrar problemas ao configurar seu direcionador de logs, tente estas dicas de resolução de problemas:

<CollapserGroup>
  <Collapser className="freq-link" id="log-data" title="Nenhum dado log">
    Se nenhum dado aparecer após você ativar nossos recursos de gerenciamento de logs, siga nossos [procedimentos padrão de resolução de problemas de log](/docs/logs/log-management/troubleshooting/no-log-data-appears-ui/).
  </Collapser>

  <Collapser className="freq-link" id="large-files" title="Arquivos de log grandes">
    A invocação do Azure Functions para encaminhar nosso log falha em arquivos acima de um determinado tamanho (aproximadamente 105 MB). Isso se deve a um erro de falta de memória causado pelo fato de a associação Node.js do Azure Functions [não suportar streaming](https://github.com/Azure/azure-functions-host/issues/1361). Este é um problema conhecido e não pode ser mitigado, exceto reduzindo o tamanho do log que você carrega.
  </Collapser>
</CollapserGroup>

## Recomendações de segurança para os seus recursos do Azure [#azure-security-recommendations]

Em maio de 2023, incluímos algumas melhorias de segurança nos nossos modelos ARM que modificam as definições na conta de armazenamento e na aplicação de funções implantar utilizando esses modelos. Os recursos do Azure são protegidos por padrão e essas configurações alteradas impedem que esse estado padrão seguro seja modificado.

Se você implantar nossos modelos ARM antes de maio de 2023, modifique sua configuração existente:

* [Desativando o acesso à rede pública para a conta de armazenamento](#disabling-public-network-access-storage-account)
* [Desabilitar o acesso público aos blobs/contêiner na conta de armazenamento](#disabling-public-access-to-blobs)
* [Desativando o acesso FTP ao aplicativo Function](#disabling-ftp-access-to-function-app)
* [Aplicando HTTPS ao aplicativo de funções](#enforcing-https-function-app)
* [Desativando o acesso à rede pública para o Function App](#disabling-public-network-access-function-app)

Se você tiver alguma dúvida sobre este aviso, entre em contato com [nossa equipe de suporte](https://support.newrelic.com).

<CollapserGroup>
  <Collapser id="disabling-public-network-access-storage-account" title="Desativando o acesso à rede pública para sua conta de armazenamento">
    Modificar esta configuração é bastante complexo, pois envolve:

    * Criando outra conta de armazenamento de acesso privado.

    * Movendo todos os compartilhamentos de arquivos e blobs para esta nova conta de armazenamento de acesso privado.

    * Criação de ponto final privado para a nova conta de armazenamento de acesso privado.

    * Criando registros DNS para o novo ponto final privado.

    * Modificando a configuração de rede do aplicativo de funções adequadamente.

      Devido a esta complexidade, recomendamos que você reimplante nosso modelo ARM do zero em vez de tentar modificar manualmente esta configuração.

      <Callout variant="tip">
        Se você não conseguir concluir uma reimplantação completa, leia como realizar uma reimplantação de uma conta de armazenamento existente na [documentação da Microsoft](https://learn.microsoft.com/en-us/azure/azure-functions/configure-networking-how-to?tabs=portal#existing-function-app) ou nesta [postagem do blog](https://techcommunity.microsoft.com/t5/apps-on-azure-blog/secure-storage-account-linked-to-function-app-with-private/ba-p/2644772). Ao seguir as instruções, evite adicionar a opção `WEBSITE_VNET_ROUTE_ALL` .
      </Callout>
  </Collapser>

  <Collapser id="disabling-public-access-to-blobs" title="Desabilitar o acesso público aos blobs/contêiner na conta de armazenamento">
    1. Acesse a conta de armazenamento criada pelo modelo ARM.

    2. No menu esquerdo, vá para <DNT>**Settings &gt; Configuration**</DNT>.

    3. Em <DNT>**Allow Blob public access**</DNT>, selecione <DNT>**Disabled**</DNT>.

       <img title="Disabling public access to the blobs/containers in the Storage account" alt="Disabling public access to the blobs/containers in the Storage account" src="/images/disable-public-blob-access-storage-account.webp" />

    4. Clique em <DNT>**Save**</DNT>.
  </Collapser>

  <Collapser id="disabling-ftp-access-to-function-app" title="Desativando o acesso FTP ao aplicativo Function">
    1. Acesse o Aplicativo de Funções que foi criado pelo modelo ARM.

    2. No menu esquerdo, vá para <DNT>**Settings &gt; Configuration**</DNT>.

    3. Selecione a guia <DNT>**General settings**</DNT> .

    4. Em <DNT>**Platform settings**</DNT>, para <DNT>**FTP state**</DNT>, selecione <DNT>**Disabled**</DNT>.

       <img title="Disabling FTP access to the Function App" alt="Disabling FTP access to the Function App" src="/images/disable-ftp-access-storage-account.webp" />

    5. Clique em <DNT>**Save**</DNT>.
  </Collapser>

  <Collapser id="enforcing-https-function-app" title="Aplicando HTTPS ao aplicativo de funções">
    1. Acesse o Aplicativo de Funções que foi criado pelo modelo ARM.

    2. No menu esquerdo, vá para <DNT>**Settings &gt; Configuration**</DNT>.

    3. Selecione a guia <DNT>**General settings**</DNT> .

    4. Em <DNT>**Platform settings**</DNT>, para <DNT>**HTTPS Only**</DNT>, selecione <DNT>**On**</DNT>.

       <img title="Enforcing HTTPS to the Function App" alt="Enforcing HTTPS to the Function App" src="/images/enforce-https-function-app.webp" />

    5. Clique em <DNT>**Save**</DNT>.
  </Collapser>

  <Collapser id="disabling-public-network-access-function-app" title="Desativando o acesso à rede pública para o Function App">
    1. Acesse o Aplicativo de Funções que foi criado pelo modelo ARM.

    2. No menu esquerdo, vá para <DNT>**Settings &gt; Networking**</DNT>.

    3. Dentro da caixa <DNT>**Inbound Traffic**</DNT> , clique em <DNT>**Access restriction**</DNT>.

       <img title="Disabling public network access to the Function App" alt="Disabling public network access to the Function App" src="/images/disable-public-network-access-function-app.webp" />

    4. Em <DNT>**App access**</DNT>, desmarque a caixa de seleção <DNT>**Allow public access**</DNT> .

    5. Clique em <DNT>**Save**</DNT>.
  </Collapser>
</CollapserGroup>

## Qual é o próximo? [#what-next]

Explore os dados de registro em sua plataforma com nossa [interface de registros](/docs/logs/log-management/ui-data/use-logs-ui/).

* Obtenha visibilidade mais profunda dos dados de desempenho do seu aplicativo e da sua plataforma encaminhando seu log com nossos recursos [logs contextualizados](/docs/logs/enable-log-management-new-relic/configure-logs-context/configure-logs-context-apm-agents/) .
* Configure [o alerta](/docs/alerts-applied-intelligence/new-relic-alerts/alert-conditions/create-alert-conditions/).
* [consulte seus dados](/docs/query-your-data/explore-query-data/get-started/introduction-querying-new-relic-data/) e [crie dashboard](/docs/query-your-data/explore-query-data/dashboards/introduction-dashboards/).

## Desativar encaminhamento de logs [#disable]

Para desabilitar os recursos de encaminhamento de logs, siga os procedimentos padrão na [documentação do log de atividadesMicrosoft Azure ](https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/activity-log). Você não precisa fazer mais nada no New Relic.
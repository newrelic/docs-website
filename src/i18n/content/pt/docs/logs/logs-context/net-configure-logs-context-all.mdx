---
title: Logs contextualizados do agente .NET
tags:
  - Logs
  - Enable log management in New Relic
  - Configure logs in context
metaDescription: 'For apps monitored by .NET, learn how to link log data with related data across the rest of the New Relic platform.'
freshnessValidatedDate: never
translationType: machine
---

Com nosso <InlinePopover type="apm" />agente .NET, você pode obter o <DNT>**logs in context**</DNT>, que permite ver o registro do seu aplicativo no contexto de outros dados New Relic . Para informações gerais sobre este recurso, consulte [logs contextualizados APM](/docs/apm/new-relic-apm/getting-started/get-started-logs-context).

<Callout variant="tip">
  Tem muito log .Net? Confira nosso [tutorial sobre como otimizá-los e gerenciá-los](/docs/tutorial-large-logs/get-started-managing-large-logs/).
</Callout>

## Opções de logs contextualizadosn automático [#automatic]

Você tem três opções para configurar o <InlinePopover type="apm" />log in context para enviar o log do seu aplicativo e vincular metadados automaticamente ao New Relic. A estrutura suportada para logs contextualizados automático usando encaminhamento de agente inclui:

<table>
  <thead>
    <tr>
      <th style={{ width: "200px" }}>
        Frameworks
      </th>

      <th>
        Versão mínima framework
      </th>

      <th>
        Versão mínima do agente
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        Log4Net
      </td>

      <td>
        Para framework.NET: v1.2.10

        Para .NET Core: v2.0.10
      </td>

      <td>
        v9.7.0
      </td>
    </tr>

    <tr>
      <td>
        Serilog
      </td>

      <td>
        Para framework.NET: v2.0.0

        Para .NET Core: v2.5.0
      </td>

      <td>
        v9.7.0
      </td>
    </tr>

    <tr>
      <td>
        NLog
      </td>

      <td>
        Para framework.NET: v4.1.0

        Para .NET Core: v4.5.0
      </td>

      <td>
        v9.7.0
      </td>
    </tr>

    <tr>
      <td>
        Microsoft.Extensions.Logging
      </td>

      <td>
        v3.0.0
      </td>

      <td>
        Para framework.NET: agente v9.7.0

        Para ..NET Core: agente v10.0.0
      </td>
    </tr>
  </tbody>
</table>

<Callout variant="tip">
  Muitas versões do Sitecore usam Sitecore.Logging, que é baseado em um fork do log4net, mas independente. O suporte para esta biblioteca foi adicionado na versão 10.14.0 do agente .NET.
</Callout>

<CollapserGroup>
  <Collapser id="1-agent" title="Opção 1 (mais simples): Deixe o agente encaminhar as mensagens do seu log.">
    Esta é a abordagem mais simples e é uma ótima opção para desenvolvedores que podem não ter acesso ou interesse em configurar um direcionador de logs ou para contas que desejam ver o poder do log e outros metadados de vinculação no contexto de seus aplicativos sem muita sobrecarga.

    Usando esta opção, seu registro inclui `span.id`, `trace.id`, `hostname`, `entity.guid` e `entity.name`. [Saiba mais sobre as limitações de encaminhamento de logs.](/docs/logs/logs-context/get-started-logs-context#forwarding-details)

    Tudo o que você precisa fazer é instalar uma versão do agente com recursos de encaminhamento de logs ([agente .NET 9.7.0 ou superior](/docs/release-notes/agent-release-notes/net-release-notes)). Se o encaminhamento estiver desabilitado, você poderá habilitá-lo adicionando o seguinte ao arquivo de configuração do agente:

    ```xml
    <applicationLogging enabled="true">
      <forwarding enabled="true" maxSamplesStored="10000" />
      <localDecorating enabled="false" />
    </applicationLogging>
    ```

    Variáveis ambientais:

    ```ini
    NEW_RELIC_APPLICATION_LOGGING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_MAX_SAMPLES_STORED=10000
    NEW_RELIC_APPLICATION_LOGGING_LOCAL_DECORATING_ENABLED=false
    ```

    <Callout variant="important">
      O valor da variável de ambiente, se presente, tem precedência sobre o valor do arquivo de configuração.
    </Callout>

    A partir da versão 9.8.0 do agente, esse recurso é habilitado por padrão.

    A partir da versão 10.4.0 do agente, o agente também suporta a captura e encaminhamento de dados de contexto (atributo personalizado) de evento de log. Este sub-recurso está desabilitado por padrão. Para habilitar, use a seguinte configuração:

    ```xml
    <applicationLogging enabled="true">
      <forwarding enabled="true" maxSamplesStored="10000">
        <contextData enabled="true" include="" exclude="" />
      </forwarding>
      <localDecorating enabled="false" />
    </applicationLogging>
    ```

    Variáveis ambientais:

    ```ini
    NEW_RELIC_APPLICATION_LOGGING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_CONTEXT_DATA_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_MAX_SAMPLES_STORED=10000
    NEW_RELIC_APPLICATION_LOGGING_LOCAL_DECORATING_ENABLED=false
    ```

    New Relic usa dados de contexto prefixados com &quot;contexto&quot;. Por exemplo, um atributo de log customizado denominado `myKey` com valor `myValue` para New Relic é `context.myKey : myValue`.

    A biblioteca de registro do .NET que usamos normalmente armazena pares de valores principais de dados de contexto em cada evento de registro como um `Dictionary<string,object>`. Para converter os valores em strings antes de serem enviados para o New Relic, primeiro tentamos usar `Newtonsoft.Json.JsonConvert.SerializeObject`. Se isso falhar, tentamos chamar `.ToString()` no objeto; como último recurso enviaremos o nome do tipo.

    Você pode filtrar dados de contexto usando as opções de configuração `include` e `exclude` . Estas são listas separadas por vírgulas de nomes de atributos. Os valores padrão para ambos são strings vazias; um campo `include` vazio significa &quot;incluir tudo&quot;. Essas opções de inclusão/exclusão seguem as mesmas regras de outras [opções de configuração do agente atributo](/docs/apm/agents/net-agent/attributes/enable-disable-attributes-net/#attruls).

    Por exemplo, para incluir todos os atributos que começam com &quot;a&quot; exceto &quot;apple&quot;, e excluir todos os atributos que começam com &quot;b&quot; exceto &quot;banana&quot;, utilize a seguinte configuração:

    ```xml
    <applicationLogging enabled="true">
      <forwarding enabled="true" maxSamplesStored="10000">
        <contextData enabled="true" include="a*, banana" exclude="b*, apple" />
      </forwarding>
      <localDecorating enabled="false" />
    </applicationLogging>
    ```

    Variáveis ambientais:

    ```ini
    NEW_RELIC_APPLICATION_LOGGING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_CONTEXT_DATA_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_CONTEXT_DATA_INCLUDE="a*, banana"
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_CONTEXT_DATA_EXCLUDE="b*, apple"
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_MAX_SAMPLES_STORED=10000
    NEW_RELIC_APPLICATION_LOGGING_LOCAL_DECORATING_ENABLED=false
    ```

    <DNT>
      **Optional adjustments:**
    </DNT>

    Depois que o encaminhamento de logs estiver habilitado, você também terá controle sobre o número máximo de logs enviados para New Relic a cada minuto. O valor padrão é 10.000. Se mais de 10.000 logs forem recebidos em uma janela de 60 segundos, seu log começará a ser amostrado.

    Defina-o para um número mais alto para receber mais log. Defina-o para um número menor para receber menos log. Qualquer número inteiro é válido.

    ```xml
    <applicationLogging enabled="true">
      <forwarding enabled="true" maxSamplesStored="10000" />
      <localDecorating enabled="false" />
    </applicationLogging>
    ```

    Variáveis ambientais:

    ```ini
    NEW_RELIC_APPLICATION_LOGGING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=true
    NEW_RELIC_APPLICATION_LOGGING_FORWARDING_MAX_SAMPLES_STORED=10000
    NEW_RELIC_APPLICATION_LOGGING_LOCAL_DECORATING_ENABLED=false
    ```

    <Callout variant="important">
      O valor da variável de ambiente, se presente, tem precedência sobre o valor do arquivo de configuração.
    </Callout>

    Se você tiver uma solução de encaminhamento de logs existente e estiver atualizando seu agente para usar o logs contextualizados automáticos, certifique-se de <DNT>**disable your manual log forwarder**</DNT>. Caso contrário, seu aplicativo enviará linhas de log duplas. Dependendo da sua conta, isso pode resultar em cobrança dupla. Para obter mais informações, siga os procedimentos para desabilitar seu [direcionador de logs específico](/docs/logs/forward-logs/enable-log-management-new-relic#log-forwarding).
  </Collapser>

  <Collapser id="2-decorate" title="Opção 2: Deixe o agente decorar seu log.">
    Já tem um encaminhador de logs que você gosta? Estamos protegendo você! O agente de linguagem pode decorar seu log com os metadados de link necessários para fornecer acesso ao recurso de log-in-context automático.

    Esta opção não deve ser usada com encaminhamento no agente. Usar um [encaminhador de logs externo](/docs/logs/forward-logs/enable-log-management-new-relic#log-forwarding) para enviar log para New Relic enquanto o encaminhamento no agente estiver habilitado fará com que seu log seja enviado duas vezes para New Relic. Dependendo da sua conta, isso pode resultar em cobrança dupla.

    <Callout variant="important">
      A decoração log local para o agente .NET não altera diretamente a mensagem do log. A configuração framework de registro precisará ser atualizada para gravar o token `NR-LINKING` nas mensagens. Para saída JSON em log4net e Serilog, será necessária configuração ou código adicional.
    </Callout>

    1. Se você quiser usar esta opção, certifique-se de ter a opção de configuração de encaminhamento no agente desabilitada.

    2. Habilite a decoração de log em sua configuração e reinicie o agente para começar a decorar seu log.

       ```xml
       <applicationLogging enabled="true">
         <forwarding enabled="false" />
         <localDecorating enabled="true" />
       </applicationLogging>
       ```

       Variáveis ambientais:

       ```ini
       NEW_RELIC_APPLICATION_LOGGING_ENABLED=true
       NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=false
       NEW_RELIC_APPLICATION_LOGGING_LOCAL_DECORATING_ENABLED=true
       ```

       <Callout variant="important">
         O valor da variável de ambiente, se presente, tem precedência sobre o valor do arquivo de configuração.
       </Callout>

       Nosso decorador adiciona cinco atributos a cada log `message` (texto simples): `entity.guid`, `entity.name`, `hostname`, `trace.id` e `span.id`. Exemplo:

       ```
       This is my log message. NR-LINKING|{entity.guid}|{hostname}|{trace.id}|{span.id}|{entity.name}
       ```

       <Callout variant="important">
         Para JSON, os dados `NR-LINKING` devem estar na propriedade `message` .
       </Callout>

       Se a mensagem do log estiver vazia ou em branco, a mensagem de saída também estará vazia. Exemplo:

       ```
       NR-LINKING|{entity.guid}|{hostname}|{trace.id}|{span.id}|{entity.name}|.
       ```

       A mensagem do log de saída será uma string vazia.

       Alguns atributos podem ficar vazios se o log ocorreu fora de uma transação ou se não forem aplicáveis ao contexto do seu aplicativo. Recomendamos esta opção em vez do processo manual de usar um formatador de decoração.

       <Callout variant="important">
         A chave usada para ler o token `NR-LINKING` de uma framework de registro é `NR_LINKING` e não `NR-LINKING` para oferecer suporte à estrutura de registro que não permite hífens em nomes de chave.
       </Callout>

       ### Configuração log4net

       Para log4net, o agente .NET armazena o token `NR-LINKING` como uma propriedade chamada `NR_LINKING` no objeto de evento de log. Os exemplos de layout comuns a seguir demonstram como configurar o log4net para gravar o token `NR-LINKING` . Outros layouts são suportados, mas não estão listados abaixo. SimpleLayout não é suportado porque não pode ser alterado.

       <DNT>**`PatternLayout`/`DynamicPatternLayout`**</DNT>: atualize `conversionPattern` para incluir a propriedade `NR_LINKING` no final da linha.

       ```xml
       <layout type="log4net.Layout.PatternLayout">
         <conversionPattern value="%date %5level %logger.%method [%line] - MESSAGE: %message %property{NR_LINKING}%newline %exception" />
       </layout>
       ```

       <DNT>**`log4net.Ext.Json`**</DNT>: atualize o layout para incluir um membro chamado `NR_LINKING` na propriedade JSON da mensagem.

       <DNT>**`log4net.Appender.AdoNetAppender`**</DNT>: Este appender tem uma configuração ligeiramente diferente de outros layouts. Você precisará atualizar o parâmetro `message` para incluir os metadados. O exemplo a seguir demonstra isso usando um `PatternLayout`.

       ```xml
       <parameter>
         <parameterName value="@message" />
         <dbType value="String" />
         <size value="4000" />
         <layout type="log4net.Layout.PatternLayout">
           <conversionPattern value="%message %property{NR_LINKING}" />
         </layout>
       </parameter>
       ```

       ### Configuração Serilog

       Para Serilog, o agente .NET armazena o token `NR-LINKING` como uma propriedade chamada `NR_LINKING` no objeto de evento de log. Os exemplos comuns de formatador e coletor a seguir demonstram como configurar o Serilog para gravar o token `NR-LINKING` . Outros coletores e formatadores são suportados, mas não estão listados abaixo.

       <DNT>**Plain text using an `outputTemplate`**</DNT>: atualize `outputTemplate` para incluir a propriedade `NR_LINKING` no final da linha.

       ```csharp
       Log.Logger = new LoggerConfiguration()
           .MinimumLevel.Override("Microsoft", LogEventLevel.Information)
           .Enrich.FromLogContext()
           .WriteTo.File(
               path: @"plaintext_log.txt",
               fileSizeLimitBytes: 1_000_000,
               rollOnFileSizeLimit: true,
               shared: true,
               flushToDiskInterval: TimeSpan.FromSeconds(1),
               outputTemplate: "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level:u3}] {Message:lj} {NR_LINKING} {NewLine}{Exception}"
           )
           .CreateLogger();
       ```

       <DNT>**JSON Formatter with automatic property output**</DNT>: o JsonFormatter padrão não gravará os metadados `NR_LINKING` na propriedade da mensagem; em vez disso, ele grava cada propriedade em seu próprio objeto JSON. Você precisará criar um formatador JSON personalizado para gravar os dados `NR_LINKING` no final da propriedade `message` antes que o logs contextualizados funcione.

       ### Configuração de Microsoft.Extensions.Logging

       Para Microsoft.Extensions.Logging, o agente .NET armazena o token `NR-LINKING` com a mensagem em um escopo recém-criado. Como Microsoft.Extensions.Logging depende de outra estrutura para saída, consulte a configuração log4net ou Serilog acima para obter detalhes.

       ### Configuração do NLog

       Para NLog, o agente .NET é capaz de anexar automaticamente o token `NR-LINKING` diretamente ao final da mensagem, portanto, nenhuma configuração adicional é necessária.
  </Collapser>

  <Collapser id="3-old-formatter" title="Opção 3: Use o processo manual para encaminhar e decorar o log.">
    Antes que o agente de linguagem pudesse encaminhar e decorar log, você poderia habilitar o logs contextualizados atualizando seu aplicativo para enviar metadados de link.

    Esta opção ainda é suportada, mas não é mais incentivada. Para obter instruções sobre como usar essa abordagem, consulte [logs contextualizados manual na opção](#enable-logs-net).

    Além disso, este método requer que você instale um direcionador de logs antes de ativar o logs contextualizados. Se você não tiver um direcionador de logs, a interface do New Relic prompt que você use nosso [agente de infraestrutura](/docs/logs/forward-logs/forward-your-logs-using-infrastructure-agent/).

    Se você decidir usar sua solução de encaminhamento de logs existente e posteriormente decidir atualizar seu agente para usar o logs contextualizados automático, certifique-se de <DNT>**disable your manual log forwarder**</DNT>. Caso contrário, seu aplicativo enviará linhas de log duplas. Dependendo da sua conta, isso pode resultar em cobrança dupla. Para obter mais informações, siga os procedimentos para desabilitar seu [direcionador de logs específico](/docs/logs/forward-logs/enable-log-management-new-relic#log-forwarding).
  </Collapser>
</CollapserGroup>

<InstallFeedback />

## Proteja seus dados [#obfuscation]

Seu registro pode incluir informações confidenciais protegidas pela HIPAA ou outros protocolos de conformidade. Por padrão, ofuscamos padrões numéricos que parecem ser de itens como cartões de crédito ou números de Seguro Social, mas pode ser necessário aplicar hash ou mascarar informações adicionais.

Para mais informações, veja [Expressão de ofuscação e regras](/docs/logs/ui-data/obfuscation-ui/). Você pode aplicar hash ou mascarar seus dados log usando a interface New Relic ou NerdGraph, nossa API GraphQL.

## Explore seus dados [#view-ui]

Para aproveitar ao máximo seus dados de registro:

* Na [página <DNT>**Summary**</DNT> doAPM ](/docs/apm/apm-ui-pages/monitoring/apm-summary-page-view-transaction-apdex-usage-data), clique no gráfico <DNT>**Web transaction time**</DNT> para visualizar o registro associado a um momento específico.
* Verifique [<DNT>**Errors inbox**</DNT>](/docs/errors-inbox/errors-inbox) do seu aplicativo para visualizar o registro associado aos seus erros.
* Use [distributed tracing](/docs/distributed-tracing/ui-data/understand-use-distributed-tracing-ui) para ver o log associado ao rastreamento individual.
* Explore mais dados de registro em sua plataforma com nossa [interface de registro](/docs/logs/log-management/ui-data/use-logs-ui/).
* Configure [alertas](/docs/alerts-applied-intelligence/new-relic-alerts/alert-conditions/create-alert-conditions/) com base na saída e na gravidade do log.
* [consulte seus dados](/docs/logs/ui-data/query-syntax-logs/) usando nossa interface especializada para dados de log e [crie um painel](/docs/query-your-data/explore-query-data/dashboards/introduction-dashboards/) com os resultados.

## Dicas de resolução de problemas [#troubleshooting]

Normalmente, seu log começará a aparecer menos de um minuto depois de você ativar o logs contextualizados APM. Verifique a seção <DNT>**Triage &gt; Logs**</DNT> do seu aplicativo. Você também começará a ver [Padrões de log](/docs/logs/ui-data/find-unusual-logs-log-patterns) relacionados ao erro ali.

Se você não vir nenhum log de erros ou rastreamento, talvez não haja nenhum para seu aplicativo. Tente atualizar a página da interface ou altere o [período selecionado](/docs/new-relic-one/ui-data/basic-ui-features/#data-analysis).

## Desabilitar o registro automático [#disable-automatic]

O logs contextualizados APM encaminha automaticamente <InlinePopover type="apm" />dados log do agente e é ativado por padrão. Isso pode ter um impacto negativo na segurança, conformidade, faturamento ou desempenho do sistema. Para obter mais informações ou se precisar ajustar a configuração padrão, siga os procedimentos para [desativar o registro automático](/docs/logs/logs-context/disable-automatic-logging).

## Opção de logs contextualizados manual [#enable-logs-net]

Se você precisar usar o processo manual para configurar o logs contextualizados para .NET, siga estas etapas:

1. Certifique-se de já ter [configurado o login no New Relic](/docs/logs/enable-log-management-new-relic/enable-log-monitoring-new-relic/enable-log-management-new-relic/). Isso inclui a configuração de um encaminhador de logs compatível que coleta seu log do aplicativo e estende os metadados que são encaminhados para New Relic.
2. [Instale](/install/dotnet) ou [atualize](/docs/agents/net-agent/installation/update-net-agent) para a versão mais recente do agente .NET e [habilite distributed tracing](/docs/distributed-tracing/enable-configure/quick-start/). Use [o agente .NET versão 8.21 ou superior](/docs/release-notes/agent-release-notes/net-release-notes/) e a [API New Relic .NET do agente versão 8.21 ou superior](/docs/agents/net-agent/net-agent-api) para logs contextualizados.
3. Instale ou atualize para o Microsoft [.NET Framework 4.5 ou superior](https://dotnet.microsoft.com/download/dotnet-framework) ou [.NET Core 2.0 ou superior](https://dotnet.microsoft.com/download/dotnet-core).
4. Instale e configure qualquer uma das seguintes extensões de log para enriquecer seus dados de log, incluindo:

* [log4net](#log4net)
* [NLog](#nlog)
* [Serilog](#serilog)

5. Verifique seus dados log na interface New Relic .

### Configurar extensão log4net [#log4net]

Você pode usar a extensão [Apache log4net versão 2.0.8 ou superior](https://logging.apache.org/log4net/) para vincular seus dados de log a dados relacionados no restante da plataforma New Relic.

<CollapserGroup>
  <Collapser id="example-log4net" title="Diagrama de fluxo de trabalho log4net">
    O diagrama a seguir ilustra o fluxo da mensagem do log através do Apache log4net, destacando componentes específicos da extensão log4net New Relic . Muitos encaminhadores de logs estão disponíveis. Este exemplo usa [Fluentd](https://www.fluentd.org/).

    <img title="log4net extension for logs in context with New Relic's .NET agent" alt="Logs In Context - Log4Net" src="/images/logs_diagram_dotnet-logs-in-context.webp" />

    <DNT>**Appender:**</DNT> O `NewRelicAppender` adiciona informações contextuais do agente .NET (usando a API) ao evento de log gerado pelo aplicativo. Essas informações contextuais, conhecidas como linking metadados, são utilizadas pela New Relic para vincular mensagens do log à transação e aos spans a partir dos quais foram criadas. Este anexador passará o evento de log enriquecido para anexadores downstream para processamento adicional.

    Como `NewRelicAppender` é do tipo `ForwardingAppender` , ele precisa ser o primeiro anexador na cadeia. Também requer outro anexador que possa gravar em um destino de saída real como seu filho para funcionar.

    <DNT>**Layout:**</DNT> O `NewRelicLayout` formata o evento de log enriquecido no formato JSON esperado pela New Relic. O anexador, ao qual esse layout é atribuído, instrui o log4net a enviar o JSON para um arquivo no local esperado pelo direcionador de logs.

    <DNT>**Log Forwarder**</DNT>: O encaminhador de logs monitora uma pasta de saída e envia incrementalmente as informações adequadamente formatadas e enriquecidas log para o de New Relic registro endpoint.
  </Collapser>

  <Collapser id="config-log4net" title="Configuração log4net 2.0.8 ou superior">
    Log4net usa `appender` e `layout` para armazenar e formatar mensagem do log. [`NewRelicAppender`](https://github.com/newrelic/newrelic-logenricher-dotnet/tree/master/src/Log4Net) enriquece a mensagem do log com informações contextuais do agente New Relic .NET se ele estiver anexado ao seu aplicativo. O anexador passa mensagem do log enriquecida para anexadores downstream para lidar com casos de uso específicos para mensagem do log.

    Para obter mais informações sobre criação de log com log4net, consulte a documentação [de primeiros passos](https://logging.apache.org/log4net/) do Apache log4net.

    Para configurar o logs contextualizados com a extensão log4net:

    1. Usando o [gerenciador de pacote do Visual Studio NuGet](https://docs.microsoft.com/en-us/nuget/consume-packages/install-use-packages-visual-studio), localize e instale o pacote [`NewRelic.LogEnrichers.Log4Net`](https://www.nuget.org/packages/NewRelic.LogEnrichers.Log4Net/) .

    2. No arquivo de configuração do log4net, atualize a configuração de geração de registros para usar `NewRelicAppender` como o anexador de primeiro nível e faça referência aos anexadores existentes como seus filhos. Substitua também o layout do anexador que grava a mensagem do log em um destino de saída pelo `NewRelicLayout`.

       O exemplo de configuração do log4net a seguir enriquece o evento de log com metadados de vinculação New Relic . Além do arquivo de log existente, ele gera um novo arquivo de log em formato JSON específico em `C:\logs\log4netExample.log.json` para consumo do direcionador de logs:

       ```xml
       <log4net>
         <root>
           <level value="ALL" />
           <appender-ref ref="NewRelicAppender" />
         </root>

         <appender name="NewRelicAppender" type="NewRelic.LogEnrichers.Log4Net.NewRelicAppender, NewRelic.LogEnrichers.Log4Net" >
           <threshold value="ALL"/>
           <appender-ref ref="FileAppender" />
         </appender>

         <appender name="FileAppender" type="log4net.Appender.FileAppender">
           <file value="C:\logs\log4netExample.log.json" />
           <param name="AppendToFile" value="true" />
           <layout type="NewRelic.LogEnrichers.Log4Net.NewRelicLayout, NewRelic.LogEnrichers.Log4Net">
           </layout>
         </appender>
       </log4net>
       ```

       Depois de configurar a extensão log4net e atualizar seu arquivo de log, você poderá configurar sua extensão para enviar dados para o New Relic. Existem [várias opções](/docs/logs/forward-logs/enable-log-management-new-relic/#log-forwarding) para encaminhar seus logs. Aqui está um exemplo de configuração usando o agente de infraestrutura para logs contextualizados:

       ```yml
       logs:
         - name: application-log
           file: C:\logs\log4netExample.log.json # Path to a single log file
       ```

       [Documentação para usar o encaminhador do agente de infraestrutura](/docs/logs/forward-logs/forward-your-logs-using-infrastructure-agent/#file)
  </Collapser>
</CollapserGroup>

### Configurar extensão NLog [#nlog]

Você pode usar nossa extensão [NLog 4.5 ou superior](https://nlog-project.org/) para vincular seus dados log com dados relacionados no restante da plataforma New Relic .

<CollapserGroup>
  <Collapser id="example-nlog" title="Diagrama de fluxo de trabalho do NLog">
    A [New Relic extensão NLog](https://github.com/newrelic/newrelic-logenricher-dotnet) fornece um `NewRelicJsonLayout` que formata um evento de log da maneira exigida pelo de New Relic registro endpoint. Em seguida, ele adiciona informações contextuais do agente .NET quando anexado ao seu aplicativo. Em seguida, um destino pode ser configurado para gravar dados de log em uma pasta de saída. O encaminhador de logs pode monitor esta pasta e enviar informações log de forma incremental para New Relic.

    O diagrama a seguir ilustra o fluxo de mensagem do log através do NLog, destacando componentes específicos da extensão New Relic NLog.

    <img title="NLog extension for logs in context with New Relic's .NET agent" alt="Logs In Context - NLog" src="/images/logs_diagram_dotnet-logs-in-context.webp" />

    <DNT>**New Relic JSON Layout**</DNT>: O `NewRelicJsonLayout` adiciona informações contextuais do agente .NET (usando a API) ao evento de log gerado pelo aplicativo e gera mensagem do log no formato JSON esperado pelo New Relic. Essas informações contextuais, conhecidas como linking metadados, são utilizadas pela New Relic para vincular mensagens do log à transação e aos spans onde foram criadas.

    Como `NewRelicAppender` é do tipo `ForwardingAppender` , ele precisa ser o primeiro anexador na cadeia. Também requer outro anexador que possa gravar em um destino de saída real como seu filho para funcionar.

    <DNT>**File Target**</DNT>: Um `FileTarget` define um arquivo no disco onde as mensagens do log são gravadas. Adicionar `NewRelicJsonLayout` a esse destino permite que a saída seja formatada corretamente para encaminhamento ao New Relic.

    <DNT>**Log Forwarder**</DNT>: o encaminhador de logs é configurado para enviar os log dados devidamente formatados e enriquecidos da `FileTarget` saída para o de geração de registros New Relic endpoint.

    Para obter mais informações sobre registro em log com NLog, consulte a [documentação do nlog-project.org](https://nlog-project.org/download/).
  </Collapser>

  <Collapser id="config-nlog" title="Configuração NLog 4.5 ou superior">
    Use nossa extensão [NLog 4.5 ou superior](https://nlog-project.org/) para vincular seus dados log com dados relacionados no restante da plataforma New Relic .

    1. Usando o [gerenciador de pacote do Visual Studio NuGet](https://docs.microsoft.com/en-us/nuget/consume-packages/install-use-packages-visual-studio), localize e instale o pacote [`NewRelic.LogEnrichers.NLog`](https://www.nuget.org/packages/NewRelic.LogEnrichers.NLog/) .

    2. No código do aplicativo, atualize a configuração de geração de registros para adicionar `NewRelicJsonLayout` e decida se deseja coletar dados MappedDiagnosticsContext (<DNT>**MDC**</DNT>) ou MappedDiagnosticsLogicalContext (<DNT>**MDLC**</DNT>).

       Os exemplos de configuração a seguir resultam em novos arquivos JSON gravados no disco. Algumas dessas [opções de configuração](https://github.com/nlog/NLog/wiki/File-target) podem ser úteis para gerenciar a quantidade de espaço em disco usado e/ou o desempenho do destino.

    * `archiveAboveSize`

    * `maxArchiveFiles`

    * `bufferSize`

    * `enableArchiveFileCompression`

    * `autoFlush`

    * `concurrentWrites`

      Embora o [destino NLog AsyncWrapper](https://github.com/nlog/NLog/wiki/AsyncWrapper-target) não seja necessário, ele pode ajudar a melhorar o desempenho executando a formatação e a saída do arquivo de log em um thread diferente.

      <DNT>
        **Don&apos;t collect MDC or the MDLC data (default):**
      </DNT>

      O exemplo de código a seguir enriquece o evento de log com metadados de vinculação New Relic , mas não com dados MDC ou MDLC. Além do arquivo de log existente, ele gera um novo arquivo de log em formato JSON específico em `C:\logs\NLogExample.log.json` para consumo do direcionador de logs:

      ```cs
      var loggerConfig = new LoggingConfiguration();
      var newRelicFileTarget = new FileTarget("NewRelicFileTarget");
      newRelicFileTarget.Layout = new NewRelicJsonLayout();
      newRelicFileTarget.FileName = "C:\logs\NLogExample.json";
      loggerConfig.AddTarget(newRelicFileTarget);
      loggerConfig.AddRuleForAllLevels("NewRelicFileTarget");
      LogManager.Configuration = loggerConfig;
      var logger = LogManager.GetLogger("Example");
      ```

      <DNT>
        **Collect MDC or the MDLC data:**
      </DNT>

      Se seu aplicativo usar o MDC ou o MDLC, você poderá configurar o `NewRelicJsonLayout` para incluir itens nessas coleções. O exemplo de código a seguir adiciona a configuração adicional para permitir a coleta de dados MDC e MDLC. Assim como no exemplo anterior, ele gera um novo arquivo de log em formato JSON específico em `C:\logs\NLogExample.log.json` para consumo do direcionador de logs:

      ```cs
      var loggerConfig = new LoggingConfiguration();
      var newRelicFileTarget = new FileTarget("NewRelicFileTarget");
      var newRelicLayout = new NewRelicJsonLayout
      {
          IncludeScopeProperties = true
      };

      newRelicFileTarget.Layout = newRelicLayout;
      newRelicFileTarget.FileName = @"C:\logs\NLogExample.json";
      loggerConfig.AddTarget(newRelicFileTarget);
      loggerConfig.AddRuleForAllLevels("NewRelicFileTarget");
      LogManager.Configuration = loggerConfig;
      var logger = LogManager.GetLogger("Example");
      ```

      Depois de configurar a extensão NLog e atualizar seu arquivo de log, você pode configurar sua extensão para enviar dados para o New Relic. Existem [várias opções](/docs/logs/forward-logs/enable-log-management-new-relic/#log-forwarding) para encaminhar seus logs. Aqui está um exemplo de configuração usando o agente de infraestrutura para logs contextualizados:

      ```yml
      logs:
        - name: application-log
          file: C:\logs\log4netExample.log.json # Path to a single log file
      ```

      [Documentação para usar o encaminhador do agente de infraestrutura](/docs/logs/forward-logs/forward-your-logs-using-infrastructure-agent/#file)
  </Collapser>

  <Collapser id="nlog-file" title="Configuração baseada em arquivo NLog">
    Você também pode configurar a extensão New Relic NLog com provedores de configuração baseados em arquivo. O código de exemplo a seguir cria um agente com base nas configurações contidas em um arquivo `App.config` .

    <DNT>
      **Instantiating Logger using `.config` file**
    </DNT>

    ```cs
    var logger = LogManager.GetLogger("NewRelicLog");
    logger.Info("Hello, New Relic!");
    ```

    <DNT>
      **Sample `App.config` file**
    </DNT>

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <configuration>
      <configSections>
        <section name="nlog" type="NLog.Config.ConfigSectionHandler, NLog"/>
      </configSections>
      <startup>
        <supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.5" />
      </startup>
      <nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <extensions>
          <add assembly="NewRelic.LogEnrichers.NLog" />
        </extensions>
        <targets>
          <target name="NewRelicLogFile" xsi:type="File" fileName="C:/path/to/NewRelicLog.json">
            <layout xsi:type="newrelic-jsonlayout">
            </layout>
          </target>
        </targets>
        <rules>
          <logger name="NewRelicLog" minlevel="Info" writeTo="newRelicLogFile" />
        </rules>
      </nlog>
    </configuration>
    ```
  </Collapser>
</CollapserGroup>

### Configurar extensão Serilog 2.5 ou superior [#serilog]

Você pode usar nossa extensão [Serilog](https://serilog.net/) para vincular seus dados log com dados relacionados no restante da plataforma New Relic . Isto exige:

* [Serilog 2.5 ou superior](https://serilog.net/)
* [Serilog File Sinks v4.0 ou superior](https://www.nuget.org/packages/Serilog.Sinks.File/)

<CollapserGroup>
  <Collapser id="example-serilog" title="Diagrama de fluxo de trabalho Serilog">
    Serilog é uma framework de log estruturada que registra a mensagem do log do seu aplicativo e cria um `LogEvent` para armazenar os dados da mensagem. Usando [Enrichers](https://github.com/serilog/serilog/wiki/Enrichment), você pode adicionar informações adicionais ao evento de log. [Pias](https://github.com/serilog/serilog/wiki/Provided-Sinks) e [Formatadores](https://github.com/serilog/serilog/wiki/Formatting-Output) permitem formatar e gerar esses eventos de log para consumo e visualização downstream.

    O diagrama a seguir ilustra o fluxo da mensagem do log através do Serilog, destacando componentes específicos da extensão New Relic Serilog. Muitos encaminhadores de logs estão disponíveis. Este exemplo usa [Fluentd](https://www.fluentd.org/).

    <img title="Serilog extension for logs in context with New Relic's .NET agent" alt="Logs-in-context Serilog" src="/images/logs_diagram_dotnet-logs-in-context-serilog.webp" />

    <DNT>**New Relic Enricher**</DNT>: O `NewRelicEnricher` adiciona informações contextuais do agente .NET (usando a API) ao evento de log gerado pelo aplicativo. Essas informações contextuais, chamadas de metadados de vinculação, são utilizadas pela New Relic para vincular mensagens do log à transação e aos spans onde foram criadas.

    <DNT>**New Relic Formatter**</DNT>: o `NewRelicFormatter` traduz o evento de log enriquecido para o formato JSON esperado pela New Relic. Um coletor instrui o Serilog a enviar o JSON para um arquivo no local esperado pelo direcionador de logs.

    <DNT>**New Relic Log Forwarder**</DNT>: o encaminhador de logs é configurado para enviar os log dados devidamente formatados e enriquecidos da `FileTarget` saída para o de geração de registros New Relic endpoint.

    Para obter mais informações sobre o evento de log do Serilog, consulte a [documentação do Serilog no GitHub](https://github.com/serilog/serilog/wiki/Getting-Started).
  </Collapser>

  <Collapser id="config-serilog" title="Configuração do Serilog 2.5 ou superior">
    Para configurar o logs contextualizados com a extensão Serilog:

    1. Use o [gerenciador de pacote do Visual Studio NuGet](https://docs.microsoft.com/en-us/nuget/consume-packages/install-use-packages-visual-studio) para localizar e instalar o pacote [`NewRelic.LogEnrichers.Serilog`](https://www.nuget.org/packages/NewRelic.LogEnrichers.Serilog) .

    2. No código do aplicativo, atualize a configuração de geração de registros para adicionar `NewRelicEnricher` e `NewRelicFormatter`.

       O exemplo de código a seguir enriquece o evento de log com metadados de vinculação New Relic . Além do arquivo de log existente, ele gera um novo arquivo de log em formato JSON específico em `C:\logs\SerilogExample.log.json` para consumo do direcionador de logs:

       ```cs
       var loggerConfig = new LoggerConfiguration();

       loggerConfig
           .Enrich.WithThreadName()
           .Enrich.WithThreadId()
           .Enrich.WithNewRelicLogsInContext()
           .WriteTo.File( path: @"C:\logs\ExistingLoggingOutput.txt")
           .WriteTo.File(
               formatter: new NewRelicFormatter(),
               path: @"C:\logs\SerilogExample.log.json");

       var log = loggerConfig.CreateLogger();
       ```

       Essa configuração resulta em novos arquivos JSON gravados no disco. Algumas dessas [opções de configuração](https://github.com/serilog/serilog-sinks-file) podem ser úteis para gerenciar a quantidade de espaço em disco usado e/ou o desempenho do coletor.

    * `restrictedToMinimumLevel`

    * `buffered`

    * `rollingInterval`

    * `rollOnFileSizeLimit`

    * `retainedFileCountLimit`

      Embora não seja obrigatório, o uso do [Serilog Asynchronous Sink Wrapper](https://www.nuget.org/packages/Serilog.Sinks.Async) pode ajudar a melhorar o desempenho realizando a formatação e saída do arquivo de log em uma thread diferente.

    3. Depois de configurar a extensão Serilog e atualizar seu arquivo de log, há [várias opções](/docs/logs/forward-logs/enable-log-management-new-relic/#log-forwarding) para encaminhar seus logs. Aqui está um exemplo de configuração usando o agente de infraestrutura para logs contextualizados:

       ```yml
       logs:
         - name: application-log
           file: C:\logs\log4netExample.log.json # Path to a single log file
       ```

       [Documentação para usar o encaminhador do agente de infraestrutura](/docs/logs/forward-logs/forward-your-logs-using-infrastructure-agent/#file)
  </Collapser>

  <Collapser id="serilog-file" title="Configuração baseada em arquivo Serilog">
    Você também pode configurar a extensão New Relic Serilog com provedores de configuração baseados em arquivo. Os seguintes pacotes NuGet adicionais são necessários:

    * [Microsoft.Extensions.Configuration](https://www.nuget.org/packages/Microsoft.Extensions.Configuration/)

    * [Serilog.Settings.Configuration](https://www.nuget.org/packages/Serilog.Settings.Configuration)

      O código de exemplo a seguir cria um agente com base nas configurações contidas em um arquivo `appSettings.json` .

      <DNT>
        **Instantiating logger using `appsettings.json`**
      </DNT>

      ```cs
      var builder = new ConfigurationBuilder()
          .AddJsonFile("appsettings.json");

      var configuration = builder.Build();

      var logger = new LoggerConfiguration()
          .ReadFrom.Configuration(configuration)
          .CreateLogger();
      ```

      <DNT>
        **Sample `appsettings.json` file**
      </DNT>

      ```json
      {
          "Serilog": {
              "Using": [
                  "Serilog.Sinks.Console",
                  "Serilog.Sinks.File",
                  "NewRelic.LogEnrichers.Serilog"
              ],
              "MinimumLevel": "Debug",
              "Enrich": [
                  "WithNewRelicLogsInContext"
              ],
              "WriteTo": [
                  {
                      "Name": "File",
                      "Args": {
                          "path": "C:\\Logs\\SerilogExample.log.json",
                          "formatter": "NewRelic.LogEnrichers.Serilog.NewRelicFormatter, NewRelic.LogEnrichers.Serilog"
                      }
                  }
              ],
              "Properties": {
                  "Application": "NewRelic Logging Serilog Example"
              }
          }
      }
      ```

      O código de exemplo a seguir cria um agente com base nas configurações contidas em um arquivo `web.config` . O pacote [Serilog.Settings.AppSettings](https://www.nuget.org/packages/Serilog.Settings.AppSettings) NuGet é necessário.

      <DNT>
        **Instantiating logger using `.config` file**
      </DNT>

      ```cs
      var logger = new LoggerConfiguration()
          .ReadFrom.AppSettings()
          .CreateLogger();
      ```

      <DNT>
        **Sample `web.config` file**
      </DNT>

      ```xml
      <?xml version="1.0" encoding="utf-8"?>
      <configuration>
        <appSettings>
          <add key="serilog:using:NewRelic" value="NewRelic.LogEnrichers.Serilog" />
          <add key="serilog:using:File" value="Serilog.Sinks.File" />
          <!--Add other enrichers here-->
          <add key="serilog:enrich:WithNewRelicLogsInContext" />
          <add key="serilog:write-to:File.path" value="C:\logs\SerilogExample.log.json" />
          <add key="serilog:write-to:File.formatter" value="NewRelic.LogEnrichers.Serilog.NewRelicFormatter, NewRelic.LogEnrichers.Serilog" />
        </appSettings>
      ```
  </Collapser>
</CollapserGroup>
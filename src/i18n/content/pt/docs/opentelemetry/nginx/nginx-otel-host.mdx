---
title: Monitore o NGINX auto-hospedado com OpenTelemetry
metaDescription: 'Complete step-by-step guide to configure NGINX monitoring with OpenTelemetry. Includes prerequisites, configuration, environment setup, and troubleshooting.'
freshnessValidatedDate: never
translationType: machine
---

Este guia fornece instruções completas de configuração para monitorar o NGINX auto-hospedado com OpenTelemetry. Siga estas etapas para configurar seu servidor NGINX, o OpenTelemetry Collector e a integração com o New Relic.

/\* &lt;Callout variant=&quot;important&quot;&gt; \*\*Antes de começar\*\*: Revise a \[visão geral do NGINX OpenTelemetry]\(/docs/opentelemetry/nginx/nginx-otel-overview/) para entender o que você irá monitorar e os benefícios desta integração. \*\*Outras opções de monitoramento do NGINX:\*\* - Para monitorar o \*\*NGINX Plus\*\*, consulte \[Monitorar o NGINX Plus com OpenTelemetry]\(/docs/opentelemetry/nginx-plus/nginx-plus-otel/). - Para monitorar o \*\*NGINX no Kubernetes\*\*, consulte \[Monitorar o NGINX no Kubernetes com OpenTelemetry]\(/docs/opentelemetry/nginx/nginx-otel-kubernetes/). &lt;/Callout&gt; &lt;Callout variant=&quot;tip&quot;&gt; \*\*Tempo de configuração\*\*: aproximadamente 20 minutos | \*\*Nível de habilidade\*\*: Intermediário (requer conhecimento básico de Linux/NGINX) &lt;/Callout&gt; \*/

## Antes de você começar [#prerequisites]

Antes de começar, certifique-se de ter:

* Uma [conta New Relic](https://newrelic.com/signup) com uma<InlinePopover type="licenseKey" />

* NGINX com o módulo [HTTP stub status](https://nginx.org/en/docs/http/ngx_http_stub_status_module.html) habilitado

* [OpenTelemetry Collector Contrib](https://github.com/open-telemetry/opentelemetry-collector-contrib/releases/latest) instalado e em execução em um host Linux

* Acesso à rede do host Linux para:

  * Endpoint de status stub HTTP do NGINX
  * Endpoint [OTLP](https://docs.newrelic.com/docs/opentelemetry/best-practices/opentelemetry-otlp/#configure-endpoint-port-protocol)do New Relic

### Verifique sua configuração

Verifique o módulo de status do NGINX:

```bash
nginx -V 2>&1 | grep -o with-http_stub_status_module
```

Resultado esperado: `with-http_stub_status_module`

Verifique o OpenTelemetry Collector:

```bash
otelcol-contrib --version
```

Saída esperada: Informações da versão (mínimo v0.88.0 requerido)

Teste a conectividade de rede:

```bash
# For US region
curl -I https://otlp.nr-data.net:443
```

Saída esperada: cabeçalhos de resposta HTTP (não conexão recusada)

<Callout variant="tip">
  Se qualquer etapa de verificação falhar, instale os componentes ausentes antes de continuar. Precisa de ajuda para instalar o Collector? Consulte o [guia de instalação do OpenTelemetry Collector](https://github.com/open-telemetry/opentelemetry-collector-contrib).
</Callout>

## Etapa 1: Configure o status stub do NGINX [#configure-nginx]

Configure o módulo [stub\_status](https://nginx.org/en/docs/http/ngx_http_stub_status_module.html) para expor métricas do seu servidor NGINX. Este módulo fornece estatísticas básicas de desempenho que o OpenTelemetry coletará.

<CollapserGroup>
  <Collapser id="step1-add-config" title="Adicione a configuração de status stub">
    Adicione esta configuração ao seu arquivo de configuração NGINX (`/etc/nginx/nginx.conf`):

    ```nginx
    server {
        listen 8080;
        server_name localhost;

        location /nginx_status {
            stub_status on;
            access_log off;        # Don't log monitoring requests
            allow 127.0.0.1;       # Only allow localhost access
            allow ::1;             # Allow IPv6 localhost
            deny all;              # Deny all other access
        }
    }
    ```
  </Collapser>

  <Collapser id="step1-apply-config" title="Aplicar a configuração">
    1. Teste sua configuração do NGINX:

       ```bash
       sudo nginx -t
       ```

    2. Se o teste for aprovado, recarregue o NGINX:

       ```bash
       sudo nginx -s reload
       ```
  </Collapser>

  <Collapser id="step1-verify" title="Verifique se o status do stub está funcionando">
    Teste o endpoint:

    ```bash
    curl http://127.0.0.1:8080/nginx_status
    ```

    Resultado esperado:

    ```
    Active connections: 1
    server accepts handled requests
     16 16 16
    Reading: 0 Writing: 1 Waiting: 0
    ```

    Teste a resposta HTTP:

    ```bash
    curl -I http://127.0.0.1:8080/nginx_status
    ```

    Saída esperada: Deve começar com `HTTP/1.1 200 OK`
  </Collapser>
</CollapserGroup>

## Etapa 2: Configurar o OpenTelemetry Collector [#configure-collector]

Configure o OpenTelemetry Collector para coletar métricas do seu endpoint de status stub do NGINX e enviá-las para o New Relic.

<CollapserGroup>
  <Collapser id="step2-understanding" title="Entenda a configuração">
    O OpenTelemetry Collector usa três componentes principais para monitoramento NGINX:

    * **Receptores** - Conecte-se ao seu endpoint de status stub do NGINX para coletar métricas
    * **Processadores** - Adicione a identificação do servidor e métricas em lote para transmissão eficiente
    * **Exporters** - Envie as métricas processadas para sua conta New Relic via OTLP HTTP
  </Collapser>

  <Collapser id="step2-prepare" title="Prepare seu ambiente">
    Antes de editar a configuração, você precisará de duas informações principais:

    1. **Sua URL de status stub** - Da Etapa 1 (padrão: `http://127.0.0.1:8080/nginx_status`)
    2. **Um nome de implantação exclusivo** - Escolha um nome que identifique este servidor NGINX específico (por exemplo, `production-web-01`, `staging-api`, `prod-lb-01`)

    O nome da implantação aparecerá nos dashboards do New Relic e ajudará você a identificar servidores específicos quando tiver várias instâncias do NGINX.
  </Collapser>

  <Collapser id="step2-configuration" title="Adicionar a configuração do coletor">
    <Callout variant="important">
      **Antes de editar:** Faça backup da sua configuração existente: `sudo cp /etc/otelcol-contrib/config.yaml /etc/otelcol-contrib/config.yaml.backup`
    </Callout>

    Edite o arquivo de configuração do seu Collector (normalmente `/etc/otelcol-contrib/config.yaml`) e adicione as seguintes seções. Se você já tiver seções de receptores, processadores ou exportadores, mescle-as com sua configuração existente:

    **1. Configure o receptor NGINX:**

    ```yaml
    receivers:
      nginx:
        endpoint: http://127.0.0.1:8080/nginx_status  # Replace with your stub status URL
        collection_interval: 30s                      # How often to collect metrics
        metrics:
          nginx.requests:
            enabled: true
          nginx.connections_accepted:
            enabled: true
          nginx.connections_handled:
            enabled: true
          nginx.connections_current:
            enabled: true
    ```

    **2. Configure os processadores para metadados e batching:**

    ```yaml
    processors:
      # Detect system information (hostname, etc.)
      resourcedetection:
        detectors: [system]
        system:
          resource_attributes:
            host.name:
              enabled: true
            host.id:
              enabled: true

      # Add NGINX-specific identification
      resource:
        attributes:
          - key: nginx.server.endpoint
            value: "http://127.0.0.1:8080/nginx_status"  # Replace with your endpoint
            action: upsert
          - key: nginx.deployment.name
            value: "production-web-01"                    # Replace with your server name
            action: upsert

      # Batch metrics for efficient sending
      batch:
        timeout: 30s
        send_batch_size: 1024

      # Transform metrics for better display in New Relic
      transform/nginx_metrics:
        metric_statements:
          - context: resource
            statements:
              # Customize the display name as needed for your New Relic dashboard
              - set(attributes["nginx.display.name"], Concat(["server", attributes["nginx.deployment.name"]], ":"))
    ```

    **3. Configure o exportador New Relic:**

    ```yaml
    exporters:
      # Send metrics to New Relic via OTLP
      otlphttp/newrelic:
        endpoint: ${env:NEWRELIC_OTLP_ENDPOINT}
        headers:
          api-key: ${env:NEWRELIC_LICENSE_KEY}
    ```

    **4. Conecte tudo com um pipeline:**

    ```yaml
    service:
      pipelines:
        metrics:
          receivers: [nginx]
          processors: [resourcedetection, resource, batch, transform/nginx_metrics]
          exporters: [otlphttp/newrelic]
    ```
  </Collapser>

  <Collapser id="step2-customize" title="Personalize a configuração">
    **Substitua esses valores na configuração acima:**

    1. **URL do endpoint**: Altere `http://127.0.0.1:8080/nginx_status` para corresponder à sua configuração de status stub da Etapa 1
    2. **Nome da implantação**: Substitua `production-web-01` por um identificador exclusivo para este servidor NGINX

    **Escolhendo um bom nome de implantação:**

    * Use nomes descritivos como `production-web-01`, `staging-api` ou `prod-lb-01`
    * Deve ser exclusivo em todos os servidores NGINX dentro de sua conta New Relic
    * Este nome aparecerá nos dashboards e ajudará você a identificar servidores específicos
    * Mantenha-o curto, mas significativo para facilitar a filtragem e o alerta
  </Collapser>
</CollapserGroup>

## Etapa 3: Configurar a autenticação [#set-environment]

Configure a autenticação segura para que o OpenTelemetry Collector possa enviar dados para sua conta New Relic. Esta etapa configura variáveis de ambiente para manter suas credenciais seguras.

<CollapserGroup>
  <Collapser id="step3-get-credentials" title="Obtenha suas credenciais do New Relic">
    Antes de configurar a autenticação, reúna estas duas informações:

    1. \*\* Sua Chave de Licença:\*\*

       * Acesse [one.newrelic.com](https://one.newrelic.com) → **API Keys**
       * Encontre a seção &quot;Ingest - License&quot; → Clique em **Show key**
       * Copie a chave de licença (começa com &quot;NRAK-...&quot;)

    2. \*\* Seu Endpoint OTLP:\*\* Use o endpoint apropriado para sua região New Relic. Consulte [Configurar endpoint, porta e protocolo](https://docs.newrelic.com/docs/opentelemetry/best-practices/opentelemetry-otlp/#configure-endpoint-port-protocol) para obter a lista completa de endpoints e portas suportadas para sua região. Por exemplo:

       * **Região dos EUA**: `https://otlp.nr-data.net:4318`
       * **Região da UE**: `https://otlp.eu01.nr-data.net:4318`
  </Collapser>

  <Collapser id="step3-configure-credentials" title="Configure as credenciais">
    1. **Crie um diretório de substituição do systemd:**

       ```bash
       sudo mkdir -p /etc/systemd/system/otelcol-contrib.service.d
       ```

    2. **Crie o arquivo de configuração do ambiente:**

       ```bash
       cat <<EOF | sudo tee /etc/systemd/system/otelcol-contrib.service.d/environment.conf
       [Service]
       Environment="NEWRELIC_OTLP_ENDPOINT=https://otlp.nr-data.net:4318"
       Environment="NEWRELIC_LICENSE_KEY=YOUR_LICENSE_KEY_HERE"
       EOF
       ```

    3. **Atualize a configuração com suas credenciais:**

       * Substitua `https://otlp.nr-data.net:4318` pelo endpoint da sua região
       * Substitua `YOUR_LICENSE_KEY_HERE` pela sua chave de licença real acima
  </Collapser>
</CollapserGroup>

## Etapa 4: Comece a monitorar [#start-monitoring]

Agora que tudo está configurado, inicie o OpenTelemetry Collector e verifique se os dados estão fluindo para o New Relic.

<CollapserGroup>
  <Collapser id="step4-start-collector" title="Iniciar o Coletor">
    1. **Aplique as alterações de configuração:**

       ```bash
       sudo systemctl daemon-reload
       sudo systemctl restart otelcol-contrib.service
       ```

    2. **Verifique se o serviço está em execução:**

       ```bash
       sudo systemctl status otelcol-contrib.service
       ```

       Saída esperada: `Active: active (running)` sem erros recentes
  </Collapser>

  <Collapser id="step4-verify-data" title="Verificar coleta de dados">
    3. **Verifique os logs de inicialização:**

       ```bash
       sudo journalctl -u otelcol-contrib.service -n 20
       ```

       **Procure estes indicadores de sucesso:**

       * ✅ `"Everything is ready. Begin running and processing data."`
       * ✅ `"Scraping metrics"` - Coletando com sucesso do NGINX
       * ✅ `"Exporting metrics"` - Enviando com sucesso para New Relic

    4. **Gere tráfego de teste (para criar métricas):**

       ```bash
       # Make a few requests to your NGINX server
       curl http://localhost
       ```

    5. Aguarde um tempo para que os dados iniciais apareçam no New Relic e, em seguida, [acesse seu dashboard NGINX](/docs/opentelemetry/nginx/find-and-query-your-data#find-data) para verificar a coleta de dados.
  </Collapser>
</CollapserGroup>

## Etapa 5: (Opcional) Encaminhar logs do NGINX [#forward-logs]

Além das métricas, você pode enviar [logs de acesso e erro](https://docs.nginx.com/nginx/admin-guide/monitoring/logging/) do NGINX para o New Relic para monitoramento e solução de problemas abrangentes. Esses logs complementam as [métricas principais do NGINX](/docs/opentelemetry/nginx/nginx-otel-metrics-reference#core-metrics) e fornecem insights detalhados no nível da solicitação.

<Callout variant="tip">
  **Ignore esta etapa se:** Você só precisa de métricas básicas do NGINX e não precisa de logs de solicitação detalhados.
</Callout>

<CollapserGroup>
  <Collapser id="step5-configure-nginx-logs" title="Configure o logging estruturado no NGINX">
    Primeiro, configure o NGINX para gerar logs formatados em JSON que são mais fáceis de analisar e consultar.

    **Adicione isso à sua configuração do NGINX (`/etc/nginx/nginx.conf`):**

    ```nginx
    http {
        # JSON log format for better parsing
        log_format json_combined escape=json
        '{'
          '"time":"$time_local",'
          '"remote_addr":"$remote_addr",'
          '"request":"$request",'
          '"status":$status,'
          '"bytes_sent":$body_bytes_sent,'
          '"request_time":$request_time,'
          '"referer":"$http_referer",'
          '"user_agent":"$http_user_agent"'
        '}';

        # Use the JSON format for access logs
        access_log /var/log/nginx/access.log json_combined;
        error_log /var/log/nginx/error.log warn;

        # Your existing configuration...
    }
    ```

    **Recarregue o NGINX para aplicar as alterações:**

    ```bash
    sudo nginx -t && sudo nginx -s reload
    ```
  </Collapser>

  <Collapser id="step5-configure-collector-logs" title="Configure o coletor para encaminhamento de logs">
    **Adicione estas seções ao seu `/etc/otelcol-contrib/config.yaml`:**

    ```yaml
    receivers:
      # Your existing nginx receiver...
      nginx:
        # existing configuration...

      # Add log receivers
      filelog/nginx_access:
        include:
          - /var/log/nginx/access.log

      filelog/nginx_error:
        include:
          - /var/log/nginx/error.log

    processors:
      # Your existing processors...

      # Add log processor
      transform/nginx_access_logs:
        log_statements:
        - context: resource
          statements:
            - set(attributes["nginx.display.name"], Concat(["server", attributes["nginx.deployment.name"]], ":"))
            - set(attributes["logtype"], "nginx")
      transform/nginx_error_logs:
        log_statements:
        - context: resource
          statements:
            - set(attributes["nginx.display.name"], Concat(["server", attributes["nginx.deployment.name"]], ":"))
            - set(attributes["logtype"], "nginx-error")

    service:
      pipelines:
        # Your existing metrics pipeline...
        metrics:
          receivers: [nginx]
          processors: [resourcedetection, resource, batch, transform/nginx_metrics]
          exporters: [otlphttp/newrelic]

        # Add log pipelines
        logs/nginx-access:
          receivers: [filelog/nginx_access]
          processors: [resource, batch, transform/nginx_access_logs]
          exporters: [otlphttp/newrelic]

        logs/nginx-error:
          receivers: [filelog/nginx_error]
          processors: [resource, batch, transform/nginx_error_logs]
          exporters: [otlphttp/newrelic]
    ```
  </Collapser>

  <Collapser id="step5-permissions-apply" title="Defina permissões e aplique a configuração">
    **Permitir que o Collector leia os arquivos de log do NGINX:**

    ```bash
    # Add collector user to adm group (has read access to logs)
    sudo usermod -a -G adm otelcol-contrib

    # Ensure log files are readable
    sudo chmod 644 /var/log/nginx/access.log
    sudo chmod 644 /var/log/nginx/error.log
    ```

    **Reinicie o Collector:**

    ```bash
    sudo systemctl restart otelcol-contrib.service
    ```
  </Collapser>
</CollapserGroup>

## Visualize seus dados no New Relic [#find-data]

Depois que sua configuração estiver concluída e os dados estiverem fluindo, você poderá acessar suas métricas NGINX nos dashboards do New Relic e criar alertas personalizados.

Para obter instruções completas sobre como acessar dashboards, consultar dados com NRQL e criar alertas, consulte [Encontre e consulte seus dados do NGINX](/docs/opentelemetry/nginx/find-and-query-your-data).

## Resolução de problemas [#troubleshooting]

Se você encontrar problemas durante a configuração, use este guia de solução de problemas para diagnosticar e resolver problemas comuns.

<CollapserGroup>
  <Collapser id="troubleshoot-nginx-stub-status" title="Problemas de status stub do NGINX">
    **Obtendo 404 Not Found:**

    ```bash
    curl http://127.0.0.1:8080/nginx_status
    ```

    **Soluções:**

    * Verifique se o caminho do local corresponde à URL da sua solicitação
    * Verifique se a configuração foi adicionada ao bloco de servidor correto
    * Execute `sudo nginx -T | grep -A5 nginx_status` para confirmar se a configuração foi carregada

    **Obtendo 403 Proibido:**

    * Certifique-se de que você está testando do localhost (127.0.0.1)
    * Verifique suas diretivas `allow`/`deny` na configuração do NGINX
    * Verifique se nenhuma outra restrição de acesso está bloqueando a solicitação

    **Conexão recusada:**

    * Verifique se o NGINX está em execução: `sudo systemctl status nginx`
    * Verifique se a porta 8080 não está bloqueada: `sudo netstat -tlnp | grep :8080`
    * Verifique as regras do firewall, se aplicável
  </Collapser>

  <Collapser id="troubleshoot-collector-service" title="O serviço do Collector não será iniciado">
    **Verifique o status do serviço:**

    ```bash
    sudo systemctl status otelcol-contrib.service
    sudo journalctl -u otelcol-contrib.service -n 50
    ```

    **Causas e correções comuns:**

    * **Erros de sintaxe YAML** - Corrija a indentação e os problemas de sintaxe
    * **Variáveis de ambiente ausentes** - Verifique se as credenciais estão definidas no arquivo de ambiente
    * **Problemas de permissão de arquivo** - Execute `sudo chown otelcol-contrib:otelcol-contrib /etc/otelcol-contrib/config.yaml`
    * **URLs de endpoint inválidas** - Verifique o endpoint NGINX e o endpoint New Relic OTLP
    * **Configurações de componentes ausentes** - Certifique-se de que todos os receivers, processors e exporters referenciados na seção de pipelines de serviço estejam realmente definidos em suas respectivas seções de configuração acima

    **Reinicie após as correções:**

    ```bash
    sudo systemctl restart otelcol-contrib.service
    ```
  </Collapser>

  <Collapser id="troubleshoot-no-data" title="Nenhum dado aparece no New Relic">
    **Diagnóstico passo a passo:**

    1. **Verifique se o status stub do NGINX funciona:**

       ```bash
       curl http://127.0.0.1:8080/nginx_status
       ```

       Deve retornar estatísticas de conexão.

    2. **Verifique se o Collector está em execução e íntegro:**

       ```bash
       sudo systemctl status otelcol-contrib.service
       sudo journalctl -u otelcol-contrib -n 20
       ```

       Os logs fornecerão contexto detalhado se houver algum problema de configuração ou tempo de execução com o OpenTelemetry Collector.

    3. **Verifique se há dados com NRQL:**

       ```sql
       FROM Metric SELECT * WHERE nginx.deployment.name LIKE '%production%' LIMIT 1
       ```
  </Collapser>

  <Collapser id="troubleshoot-log-forwarding" title="Problemas de encaminhamento de logs">
    **Nenhum log aparecendo no New Relic:**

    ```bash
    # Check Collector logs for file errors
    sudo journalctl -u otelcol-contrib -f | grep -i "filelog\|error"
    ```

    **Problemas comuns:**

    * **Erros de permissão de arquivo** - Adicione o collector ao grupo adm: `sudo usermod -a -G adm otelcol-contrib`
    * **Caminhos de arquivo errados** - Verifique os locais dos arquivos de log em sua configuração
  </Collapser>
</CollapserGroup>

### Obter ajuda

Se você continuar com problemas:

1. Revise [As melhores práticas do OpenTelemetry da New Relic](/docs/opentelemetry/best-practices/opentelemetry-otlp/)
2. Pesquise no [New Relic Explorers Hub](https://discuss.newrelic.com/) por problemas semelhantes

## Próximos passos [#next-steps]

**Saiba mais sobre seus dados:**

* [Encontre e consulte seus dados do NGINX](/docs/opentelemetry/nginx/find-and-query-your-data/) - Acesse dashboards, crie consultas personalizadas e configure alertas
* [Referência de métricas e atributos do NGINX OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-metrics-reference/) - Referência completa de métricas com descrições e exemplos
* [Visão geral do NGINX OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-overview/) - Entenda as métricas, atributos e casos de uso coletados
* [Documentação do receptor NGINX](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/nginxreceiver/documentation.md) - Detalhes técnicos e configuração avançada

**Explore o monitoramento relacionado:**

* [Monitore o NGINX Plus com OpenTelemetry](/docs/opentelemetry/nginx-plus/nginx-plus-otel/) - Para implantações comerciais do NGINX Plus
* [Monitorar o NGINX no Kubernetes](/docs/opentelemetry/nginx/nginx-otel-kubernetes/) - Para ambientes em contêineres
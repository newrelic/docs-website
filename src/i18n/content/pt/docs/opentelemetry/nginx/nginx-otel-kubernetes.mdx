---
title: Monitore o NGINX no Kubernetes com OpenTelemetry
metaDescription: Send your NGINX metrics from Kubernetes to New Relic using the OpenTelemetry Collector.
freshnessValidatedDate: never
translationType: machine
---

Monitore seus servidores NGINX em execução em clusters Kubernetes usando o [OpenTelemetry Collector](https://github.com/open-telemetry/opentelemetry-collector-contrib) para enviar métricas e dados de telemetria para o New Relic.

Esta integração específica do Kubernetes descobre automaticamente os pods NGINX em seu cluster e coleta métricas sem configuração manual para cada instância. Ele utiliza o [nginxreceiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/nginxreceiver) e o [receivercreator](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/receivercreator) OpenTelemetry para monitorar dinamicamente as métricas de desempenho do NGINX, estatísticas de conexão e integridade do servidor em seu ambiente em contêineres.

## Antes de você começar [#prerequisites]

Certifique-se de ter:

* Uma [conta New Relic](https://newrelic.com/signup) com uma<InlinePopover type="licenseKey" />
* Habilite o módulo [HTTP stub status](https://nginx.org/en/docs/http/ngx_http_stub_status_module.html) no pod do NGINX que precisa ser monitorado
* Adicione os rótulos `app` e `role` a cada pod NGINX que precisa ser monitorado

## Instale e configure o OpenTelemetry Collector [#install-collector]

Implante o OpenTelemetry Collector em seu cluster Kubernetes usando Helm. O coletor descobrirá e coletará automaticamente métricas de seus pods NGINX.

<CollapserGroup>
  <Collapser id="k8s-create-secret" title="Crie um segredo do Kubernetes para credenciais">
    Crie um segredo do Kubernetes para armazenar suas credenciais do New Relic. Substitua `YOUR_LICENSE_KEY` e `YOUR_OTLP_ENDPOINT` pelos seus valores reais. Consulte a [documentação](https://docs.newrelic.com/docs/opentelemetry/best-practices/opentelemetry-otlp/#configure-endpoint-port-protocol) de configuração do endpoint OTLP para selecionar o endpoint apropriado para sua região.

    ```bash
    kubectl create namespace newrelic
    kubectl create secret generic newrelic-licenses --from-literal=NEWRELIC_LICENSE_KEY=YOUR_LICENSE_KEY --from-literal=NEWRELIC_OTLP_ENDPOINT=YOUR_OTLP_ENDPOINT
    ```
  </Collapser>

  <Collapser id="k8s-values-yaml" title="Criar configuração values.yaml">
    Crie um arquivo `values.yaml` para configurar o OpenTelemetry Collector. Atualize os espaços reservados para o nome do seu cluster, rótulos de pod do NGINX, porta e caminho de status stub.

    ```yaml
    opentelemetry-collector:
      mode: deployment

      image:
        repository: otel/opentelemetry-collector-contrib
        pullPolicy: IfNotPresent

      command:
        name: otelcol-contrib

      resources:
        limits:
          cpu: 500m
          memory: 300Mi
        requests:
          cpu: 100m
          memory: 100Mi

      extraEnvs:
        - name: NEWRELIC_LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: newrelic-licenses
              key: NEWRELIC_LICENSE_KEY
        - name: NEWRELIC_OTLP_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: newrelic-licenses
              key: NEWRELIC_OTLP_ENDPOINT
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: K8S_CLUSTER_NAME
          value: nginx-cluster # Update with your cluster name

      clusterRole:
        create: true
        rules:
          - apiGroups: [""]
            resources: ["pods", "nodes", "nodes/stats", "nodes/proxy"]
            verbs: ["get", "list", "watch"]
          - apiGroups: ["apps"]
            resources: ["replicasets"]
            verbs: ["get", "list", "watch"]
        clusterRoleBinding:
          name: ""

      config:
        extensions:
          health_check:
            endpoint: 0.0.0.0:13133
          k8s_observer:
            auth_type: serviceAccount
            observe_pods: true
            observe_nodes: true

        receivers:
          receiver_creator/nginx:
            watch_observers: [k8s_observer]
            receivers:
              nginx:
                rule: type == "pod" && labels["app"] == "nginx" && labels["role"] == "reverse-proxy" # Update with your labels
                config:
                  endpoint: 'http://`endpoint`:<stub_status_port>/status'
                  metrics:
                    nginx.requests:
                      enabled: true
                    nginx.connections_accepted:
                      enabled: true
                    nginx.connections_handled:
                      enabled: true
                    nginx.connections_current:
                      enabled: true
                  collection_interval: 30s
                resource_attributes:
                  nginx.server.endpoint: 'http://`endpoint`:<stub_status_port>/status'
                  nginx.port: '<stub_status_port>'

        processors:
          batch:
            send_batch_size: 1024
            timeout: 30s

          resource/cluster:
            attributes:
              - key: k8s.cluster.name
                value: "${env:K8S_CLUSTER_NAME}"
                action: insert

          transform/nginx:
            metric_statements:
              - context: resource
                statements:
                  - set(attributes["nginx.display.name"], Concat([
                      "server",
                      "k8s",
                      attributes["k8s.cluster.name"],
                      attributes["k8s.namespace.name"],
                      "pod",
                      attributes["k8s.pod.name"],
                      "nginx",
                      attributes["nginx.port"]
                      ], ":"))
                  - set(attributes["nginx.deployment.name"], attributes["k8s.pod.name"])

          transform/metadata_nullify:
            metric_statements:
              - context: metric
                statements:
                  - set(description, "")
                  - set(unit, "")

        exporters:
          otlp_http:
            endpoint: "${env:NEWRELIC_OTLP_ENDPOINT}"
            headers:
              api-key: "${env:NEWRELIC_LICENSE_KEY}"

        service:
          extensions: [health_check, k8s_observer]
          pipelines:
            metrics/nginx:
              receivers: [receiver_creator/nginx]
              processors: [batch, resource/cluster, transform/nginx, transform/metadata_nullify]
              exporters: [otlp_http]
    ```
  </Collapser>

  <Collapser id="k8s-install-helm" title="Instalar com Helm">
    Instale o [gráfico Helm](https://github.com/open-telemetry/opentelemetry-helm-charts) usando seu arquivo values.yaml.

    ```bash
    helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
    helm repo update
    helm upgrade --install nginx-otel-collector open-telemetry/opentelemetry-collector --namespace newrelic --create-namespace -f values.yaml
    ```
  </Collapser>

  <Collapser id="k8s-verify-deployment" title="Verificar a implantação e a coleta de dados">
    1. **Certifique-se de que os pods foram iniciados com sucesso:**

       ```bash
       kubectl get pods -n newrelic --watch
       ```

       Você deve ver pods com nomes como `nginx-otel-collector-<hash>` em um estado `Running` no namespace `newrelic`.

    2. **Execute uma consulta NRQL no New Relic para confirmar se os dados estão chegando.** Substitua o nome do cluster pelo valor definido no arquivo de valores:

       ```sql
       FROM Metric
       SELECT *
       WHERE metricName LIKE 'nginx.%'
         AND instrumentation.provider = 'opentelemetry'
         AND k8s.cluster.name = 'nginx-cluster'
       SINCE 10 minutes ago
       ```
  </Collapser>
</CollapserGroup>

## Encontre e use dados [#find-data]

1. Acesse **[one.newrelic.com](https://one.newrelic.com) &gt; Integrations &amp; Agents**.
2. Selecione **Dashboards** e clique em **NGINX OTel overview dashboard**.
3. Na janela pop-up, selecione sua conta.
4. Clique em \[View dashboard] e veja seus dados do NGINX no New Relic.

As métricas do NGINX são anexadas ao `Metric` [tipo de evento](/docs/using-new-relic/data/understand-data/new-relic-data-types#events-new-relic). Você pode [consultar esses dados](/docs/using-new-relic/data/understand-data/query-new-relic-data) para fins de solução de problemas ou para criar gráficos e dashboards personalizados.

## Referência de métricas e atributos [#metrics]

Esta integração coleta as mesmas métricas principais do NGINX que a implantação no host, com atributos de recursos específicos do Kubernetes adicionais para identificação de cluster, namespace e pod.

**Para referência completa de métricas e atributos:** Consulte [Referência de métricas e atributos do NGINX OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-metrics-reference/) para descrições detalhadas de todas as métricas, tipos e atributos de recursos para implantações do Kubernetes.

## Próximos passos [#next-steps]

**Saiba mais sobre seus dados:**

* [Encontre e consulte seus dados do NGINX](/docs/opentelemetry/nginx/find-and-query-your-data/) - Acesse dashboards, crie consultas personalizadas e configure alertas
* [Referência de métricas e atributos do NGINX OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-metrics-reference/) - Referência completa de métricas com descrições e exemplos
* [Visão geral do NGINX OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-overview/) - Entenda as métricas, atributos e casos de uso coletados
* [Documentação do receptor NGINX](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/nginxreceiver/documentation.md) - Detalhes técnicos e configuração avançada

**Explore o monitoramento relacionado:**

* [Monitore o NGINX Plus com OpenTelemetry](/docs/opentelemetry/nginx-plus/nginx-plus-otel/) - Para implantações comerciais do NGINX Plus
* [Monitore o NGINX auto-hospedado com OpenTelemetry](/docs/opentelemetry/nginx/nginx-otel-host/) - Para implantações tradicionais de servidor
* [Melhores práticas do OpenTelemetry](/docs/opentelemetry/best-practices/opentelemetry-otlp/) - Otimize sua configuração do OpenTelemetry

**Recursos específicos do Kubernetes:**

* [OpenTelemetry Collector no Kubernetes](https://opentelemetry.io/docs/kubernetes/) - Configurações avançadas do coletor
---
title: Distributed tracing para seus serviços Node.js.
tags:
  - Understand dependencies
  - Distributed tracing
  - Enable and configure
metaDescription: How to enable distributed tracing or Infinite Tracing for APM agents.
freshnessValidatedDate: never
translationType: machine
---

import apmNodejsLogo from 'images/apm_logo_nodejs-logo.webp'

Distributed tracing permite que você veja toda a jornada de suas solicitações em [sistemas distribuídos](/docs/distributed-tracing/concepts/introduction-distributed-tracing). Para o agente Node.js, oferecemos dois tipos de distributed tracing (para obter mais detalhes, consulte [Como funciona a amostragem de extensão](/docs/understand-dependencies/distributed-tracing/get-started/how-new-relic-distributed-tracing-works#sampling)):

* Padrão (Amostragem head-based): Antes de qualquer rastreamento chegar, determinamos uma porcentagem definida de rastreamento para aceitar e analisar. Isso fornece um ponto de partida sólido para ver como o rastreamento pode ajudá-lo. Ele está ativado por padrão no agente Node.js 8.3.0 e superior.
* Rastreamento Infinito (amostragem tail-based): Nosso serviço baseado em nuvem aceita todos os seus rastreamentos e depois os classifica para encontrar o mais importante. Depois de configurar o rastreamento padrão, recomendamos adicionar essa opção porque ela analisa todo o seu rastreamento e oferece opções de configuração para obter uma amostra do rastreamento mais importante para você.

Todas as etapas necessárias para começar a usar o distributed tracing estão aqui:

* [Novo agente Node.js:](#new-agents) etapas para instalação de head- e amostragem tail-based para nova instalação de agente
* [Agente Node.js mais antigo:](#older-agents) opções de rastreamento se você tiver um agente Node.js mais antigo
* [Instrumentação manual:](#manual-instrumentation) Dicas caso a instrumentação automática não funcione

## Novo agente Node.js [#new-agents]

Se você deseja apenas experimentar distributed tracing padrão (Amostragem head-based) ou também configurar o Infinite Tracing (Amostragem tail-based), você precisa começar configurando o rastreamento padrão. Orientaremos você na instalação do agente APM para iniciar a Amostragem head-based. Depois disso, você pode configurar o Rastreamento Infinito, que é opcional, mas recomendado.

### Instale um agente para obter distributed tracingpadrão [#quick-start-apm]

Esta é a melhor abordagem para configurar [distributed tracingpadrão](/docs/distributed-tracing/concepts/how-new-relic-distributed-tracing-works/#head-based) se você ainda não instalou nenhum agente APM para seus serviços ou se deseja instrumentar serviços adicionais.

Se você já possui alguns serviços instrumentados com este agente APM e deseja incluí-los no distributed tracing, será necessário habilitar manualmente distributed tracing para cada serviço. Consulte [Opções para agentes Node.js mais antigos](#older-agents).

<Callout variant="tip">
  Você precisará de uma conta New Relic para configurar distributed tracing. Se ainda não tiver uma, você pode [criar rapidamente uma conta gratuita](https://newrelic.com/signup).
</Callout>

#### Passo 1. Identificar serviços [#identify]

Descubra quais serviços você deseja usar para que cada um envie dados trace para o New Relic.

#### Passo 2. Instrumentar cada serviço com um agente APM [#update-agents]

Você repetirá a rotina de instalação do agente para cada serviço envolvido na sua transação. Se alguns dos seus serviços utilizarem outros idiomas, basta repetir as [etapas de instalação](/docs/distributed-tracing/enable-configure/quick-start) para esses idiomas.

Para iniciar a rotina de instalação, clique no bloco abaixo. Quando terminar de instalar cada agente, volte aqui para ver dicas para [visualizar seu rastreamento](#view-traces).

<TechTileGrid>
  <TechTile
    name="Start installation"
    to="https://one.newrelic.com/launcher/nr1-core.settings?pane=eyJuZXJkbGV0SWQiOiJ0dWNzb24ucGxnLWluc3RydW1lbnQtZXZlcnl0aGluZyJ9&cards[0]=eyJuZXJkbGV0SWQiOiJzZXR1cC1uZXJkbGV0cy5zZXR1cC1ub2RlLWludGVncmF0aW9uIiwiYWNjb3VudElkIjoyNjQwNDA5fQ==&platform[accountId]=2498654&platform[timeRange][duration]=1800000&platform[$isFallbackTimeRange]=true"
    icon={<img variant="TechTile" src={apmNodejsLogo} alt="Node.js"/>}
  />
</TechTileGrid>

#### Etapa 3. Ver rastreamento [#view-traces]

Depois de instrumentar cada um de seus serviços com o agente APM, gere algum tráfego em sua aplicação para que possamos capturar algum rastro. Aqui estão duas maneiras de visualizar seu rastreamento na interface:

<CollapserGroup>
  <Collapser
    id="entity-explorer"
    title="Ver rastreamento que inclui um serviço específico"
  >
    Esta é uma maneira de ver o rastreamento de um serviço específico:

    1. Vá para

       <DoNotTranslate>**[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > APM & services**</DoNotTranslate>

       .

    2. Clique na sua entidade (serviço).

    3. Na seção

       <DoNotTranslate>**Monitor**</DoNotTranslate>

       do painel esquerdo, clique em

       <DoNotTranslate>**Distributed tracing**</DoNotTranslate>

       .

    4. Para obter detalhes, clique em um trace individual. Se

       <DoNotTranslate>**Group similar traces**</DoNotTranslate>

       estiver ativado no menu superior, clique em um grupo trace e, em seguida, clique em um trace individual.

    5. Se você não encontrar o rastreamento desejado, poderá filtrar por `trace.id`.
  </Collapser>

  <Collapser
    id="cross-acct-traces"
    title="Ver rastreamento entre contas"
  >
    Para ver o rastreamento que cruza contas:

    1. Vá para

       <DoNotTranslate>**[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > Traces**</DoNotTranslate>

       .

    2. Selecione sua entidade (serviço) no painel esquerdo.

    3. Para obter detalhes, clique em um trace individual. Se

       <DoNotTranslate>**Group similar traces**</DoNotTranslate>

       estiver ativado no menu superior, clique em um grupo trace e, em seguida, clique em um trace individual.

    4. Se você não encontrar o rastreamento desejado, poderá filtrar por `trace.id`.
  </Collapser>

  <Collapser
    id="logs-context"
    title="Examinar o log relacionado ao rastreamento"
  >
    Você pode reunir seus detalhes de registro e rastreamento para tornar a resolução de problemas mais fácil e rápida. Com [logs contextualizados](/docs/logs/logs-context/configure-logs-context-apm-agents/), você pode ver a mensagem do log junto com o trace na interface do New Relic.

    Depois de localizar um trace interessante usando as etapas em [Exibir rastreamento que inclui um serviço específico](#entity-explorer) ou [Exibir rastreamento entre contas](#cross-acct-traces), faça o seguinte:

    1. Se você ativou o logs contextualizados, clique na guia

       <DoNotTranslate>**Logs**</DoNotTranslate>

       (ao lado de

       <DoNotTranslate>**Trace details**</DoNotTranslate>

       ).

    2. Para visualizar detalhes relacionados a um log individual, clique diretamente na mensagem.
  </Collapser>
</CollapserGroup>

Para obter mais ajuda para encontrar seu rastreamento na interface:

* [Compreender e usar a interface distributed tracing](/docs/distributed-tracing/ui-data/understand-use-distributed-tracing-ui)
* [Consultar dados distributed trace](/docs/understand-dependencies/distributed-tracing/ui-data/query-distributed-trace-data)

### Configurar rastreamento infinito [#infinite-tracing]

distributed tracing padrão para o agente APM ([acima](#quick-start-apm)) captura até 10% do seu rastreamento, mas se você quiser que analisemos todos os seus dados e encontremos o rastreamento mais relevante, você pode configurar o Rastreamento Infinito.

<Callout variant="tip">
  Para saber mais sobre esse recurso, consulte [Rastreamento infinito](/docs/understand-dependencies/distributed-tracing/infinite-tracing/introduction-infinite-tracing).
</Callout>

Antes de começar, primeiro certifique-se de atender [aos requisitos](/docs/understand-dependencies/distributed-tracing/infinite-tracing/introduction-infinite-tracing#requirements).

#### Etapa 1. Conclua a instalação do novo agente [#install-agents-first]

A configuração do Rastreamento Infinito baseia-se na etapa de instrumentação da [instalação do novo agente](#quick-start-apm) para distributed tracing padrão. Após concluir a instalação do agente, continue com a configuração do observador trace .

#### Etapa 2. Configurar o observador trace [#provision-trace-observer]

O observador trace é um serviço New Relic baseado em AWS que coleta e analisa todos os seus rastreamentos. Siga as instruções em [Configurar o observador de rastreamento](/docs/understand-dependencies/distributed-tracing/infinite-tracing/set-trace-observer). Quando terminar, retorne aqui com as informações do observador trace e continue com a próxima etapa para configurar o agente.

#### Etapa 3: configurar o agente para rastreamento infinito [#configure-agent-inf]

As definições de configuração do Infinite Tracing incluem o distributed tracing padrão, além de informações sobre o observador trace . Encontre as configurações do seu agente de idiomas abaixo:

<CollapserGroup>
  <Collapser
    id="node-config"
    title="Configuração de rastreamento infinito do Node.js"
  >
    Aqui está uma visão geral das configurações. Para obter mais ajuda com a configuração, consulte [Configuração do agente Node.js.](/docs/agents/nodejs-agent/installation-configuration/nodejs-agent-configuration#distributed-tracing)

    <table>
      <thead>
        <tr>
          <th style={{ width: "200px" }}>
            Tipo
          </th>

          <th>
            Configuração necessária
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Rastreamento infinito
          </td>

          <td>
            Opções de configuração:

            Arquivo de configuração (`newrelic.js`):

            ```
            distributed_tracing: {
              enabled: true
            }
            infinite_tracing: {
              trace_observer: {
                host: '<a href="/docs/understand-dependencies/distributed-tracing/infinite-tracing/set-trace-observer#ui-endpoints">YOUR_TRACE_OBSERVER_HOST</a>'
              }
            }
            ```

            Variáveis ambientais:

            ```
            NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
            NEW_RELIC_INFINITE_TRACING_TRACE_OBSERVER_HOST="YOUR_TRACE_OBSERVER_HOST"
            ```
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

#### Etapa 4. (Opcional) Personalizar rastreamento infinito [#customize-inf]

Depois de adicionar as definições de configuração do agente, você deverá começar a ver os dados na interface do New Relic. Depois de passar algum tempo analisando seus dados, você pode querer ajustar alguns recursos do Infinite Tracing:

* [Configurar o monitoramento do observador trace](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-trace-observer-monitoring)
* [Configurar filtro trace de atributo span](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-span-attribute-trace-filter)
* [Configurar filtro trace aleatório](/docs/distributed-tracing/infinite-tracing/infinite-tracing-configure-random-trace-filter)

## Opções para agente Node.js mais antigo [#older-agents]

Se você tiver um agente Node.js mais antigo, confirme se o recurso distributed tracing que você deseja tem suporte antes de habilitá-lo.

### Guia de compatibilidade [#compatibility-guide]

Encontre seu agente de idioma abaixo para confirmar se você pode usar seu agente existente com distributed tracing:

<CollapserGroup>
  <Collapser
    id="node-version"
    title="Node.js compatibilidade do agente"
  >
    [Instale](/docs/agents/nodejs-agent/installation-configuration/install-nodejs-agent) ou [atualize](/docs/agents/nodejs-agent/installation-configuration/upgrade-nodejs-agent) para a versão necessária do agente Node.js. Para obter melhores resultados, atualize para a [versão mais recente do agente Node.js.](/docs/release-notes/agent-release-notes/nodejs-release-notes)

    <table>
      <thead>
        <tr>
          <th style={{ width: "250px" }}>
            Opção
          </th>

          <th>
            Versão do agente Node.js.
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Distributed tracing padrão
          </td>

          <td>
            4.7.0 ou superior

            Com W3C Trace Context: 6.4 ou superior
          </td>
        </tr>

        <tr>
          <td>
            Rastreamento infinito
          </td>

          <td>
            7.3.0 (inclui W3C Trace Context)

            Ambientes suportados: Node.js versão 10.10.0 ou superior
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

### Configure seu agente Node.js antigo [#configure-agents]

Veja as configurações abaixo para ativar distributed tracing.

<Callout variant="tip">
  Se você estiver usando um agente mais antigo sem distributed tracing, antes de ativar o distributed tracing, consulte [Impactos no APM](/docs/apm/distributed-tracing/getting-started/transition-guide-distributed-tracing).
</Callout>

<CollapserGroup>
  <Collapser
    id="node-config-standard"
    title="Configuração do agente Node.js"
  >
    Aqui está uma visão geral das configurações. Para obter mais ajuda com a configuração, consulte [Configuração do agente Node.js.](/docs/apm/agents/nodejs-agent/installation-configuration/nodejs-agent-configuration#dt-main)

    <table>
      <thead>
        <tr>
          <th style={{ width: "200px" }}>
            Tipo
          </th>

          <th>
            Configuração necessária
          </th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>
            Distributed tracing padrão
          </td>

          <td>
            Opções de configuração:

            Arquivo de configuração (`newrelic.js`):

            ```
            distributed_tracing: {
              enabled: true
            }
            ```

            Variável de ambiente:

            ```
            NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
            ```
          </td>
        </tr>

        <tr>
          <td>
            Rastreamento infinito
          </td>

          <td>
            Se o seu agente mais antigo oferecer suporte ao Rastreamento Infinito, consulte as etapas de configuração [acima](#infinite-tracing).
          </td>
        </tr>
      </tbody>
    </table>
  </Collapser>
</CollapserGroup>

<Callout variant="tip">
  Se precisar de ajuda com a configuração do proxy, consulte [Suporte ao proxy](/docs/understand-dependencies/distributed-tracing/other-requirements/infinite-tracing-proxy-support).
</Callout>

## Instrumentação manual (se a instrumentação automática não funcionar) [#manual-instrumentation]

<DoNotTranslate>**Recommendation:**</DoNotTranslate> Antes de executar qualquer instrumentação personalizada, leia:

* [Como funciona distributed tracing](/docs/apm/distributed-tracing/getting-started/how-new-relic-distributed-tracing-works)
* [Solucionar problemas de dados ausentes](/docs/apm/distributed-tracing/troubleshooting/troubleshooting-missing-trace-data)

Se um serviço não estiver passando o cabeçalho de trace para outros serviços, você poderá usar a de distributed tracing carga útil API para instrumentar o [serviço de](#calling-service) chamada e o [serviço chamado](#called-service). O serviço de chamada usa uma chamada de API para gerar uma carga útil, que é aceita pelo serviço chamado.

<CollapserGroup>
  <Collapser
    id="calling-service"
    title="Instrumento o serviço de chamada"
  >
    Para instrumentar o serviço de chamada:

    1. Certifique-se de que a [versão do agente APM](#compatibility-requirements) que monitora o serviço de chamada oferece suporte distributed tracing.

    2. Invoque a chamada da API do agente para gerar uma carga útil distributed trace (consulte a [API do agente Node.js.](/docs/agents/nodejs-agent/api-guides/nodejs-agent-api#transaction-handle-createDistributedTracePayload)

       <Callout variant="important">
         Para manter a ordem adequada dos períodos em um trace, certifique-se de <DoNotTranslate>**generate the payload in the context of the span that sends it**</DoNotTranslate>.
       </Callout>

    3. Adicione essa carga à chamada feita ao serviço de destino (por exemplo, em um cabeçalho).

    4. (Opcional) Identifique a chamada como uma chamada externa (consulte a [API do agente Node.js.](/docs/agents/nodejs-agent/api-guides/nodejs-agent-api#custom-instrumentation-api)
  </Collapser>

  <Collapser
    id="called-service"
    title="Instrumento o serviço chamado"
  >
    Para instrumentalizar o serviço chamado:

    1. Certifique-se de que a [versão do agente APM](#compatibility-requirements) que monitora o serviço chamado oferece suporte distributed tracing.

    2. Se o agente New Relic no serviço chamado não identificar uma transação New Relic, use a API do agente para declarar uma transação. Uma maneira de saber se uma transação não está em andamento é que o log do agente Node.js reportará um erro semelhante a este:

       ```
       No transaction found when calling Transaction.acceptDistributedTracePayload.
       ```

       Use [`startWebTransaction`](/docs/agents/nodejs-agent/api-guides/nodejs-agent-api#startWebTransaction) para criar uma transação web ou [`startBackgroundTransaction`](/docs/agents/nodejs-agent/api-guides/nodejs-agent-api#startBackgroundTransaction) para capturar uma [transação fora da web](/docs/apm/transactions/intro-transactions/monitor-background-processes-other-non-web-transactions).

    3. Extraia a carga da chamada que você recebeu (por exemplo, em um cabeçalho).

    4. Invoque a chamada para aceitar a carga útil (consulte a [API do agente Node.js.](/docs/agents/nodejs-agent/api-guides/nodejs-agent-api#transaction-handle-acceptDistributedTracePayload)
  </Collapser>
</CollapserGroup>
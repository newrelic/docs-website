---
title: PHPUnit runs out of memory
type: troubleshooting
tags:
  - Agents
  - PHP agent
  - Troubleshooting
metaDescription: Troubleshooting PHPUnit out-of-memory errors
freshnessValidatedDate: never
---

## Problem

When you use [PHPUnit](https://phpunit.de/) version 11 or newer to manage and run your unit tests, and have New Relic PHP Agent installed and enabled, 
executing `phpunit` script (the PHPUnit command-line test runner) to run unit tests will cause the script to use all memory available on the system,
before actually running the test.

## Solution

To prevent out-of-memory errors you must <DNT>**explicitly disable**</DNT> the agent by setting `newrelic.enabled` to `false`. You can disable the it while using `phpunit` like this:
```
php -d newrelic.enabled=false phpunit ...remaining arguments...
```
This workaround disables all instrumentation of unit tests.

## Cause

The reason for this incompatibility is the new code that was added in PHPUnit 11.x: 
[Reapply "Check and restore error/exception global handlers" Â· sebastianbergmann/phpunit@0214cf8](https://github.com/sebastianbergmann/phpunit/commit/0214cf81d8b12a1191932e6096d22c8496943911).
This new code retrieves the list of active exception handlers using a method that requires popping each exception handler off the exception handler stack.
However, the default behavior of New Relic PHP Agent is to install its own exception handler and then prevent it from being removed from the exception handler stack. 
New Relic PHP Agent detects that its exception handler is being removed from the exception handler stack and puts it back on. This causes an infinite loop in `phpunit` script:
the unit test can never finish popping the handlers off as the New Relic PHP Agent keeps putting one back on!

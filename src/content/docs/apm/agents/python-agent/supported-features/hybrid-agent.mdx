---
title: Hybrid Agent Integration with OpenTelemetry
tags:
  - Agents
  - Python agent
  - Supported features
metaDescription: Python agent hybrid agent opentelemetry integration
freshnessValidatedDate: never
---

The Python Hybrid Agent is expanding its capabilities with this release, focusing on core OpenTelemetry Tracing and sampling compatibility to support mixed-mode environments. While the Metrics API is currently in development, Python users can now utilize OTel-compatible sampling and tracing features. This update lays the groundwork for full OpenTelemetry API integration, allowing for a gradual transition to vendor-agnostic instrumentation.

<Callout variant="important">
  For now, if OpenTelemetry mode is enabled in the agent, any OpenTelemetry APIs and instrumentation frameworks installed on a user's system will be used instead of any existing New Relic instrumentation hooks.  The ability to select which tracers to enable and disable is currently in development.
</Callout>

## Getting started [#getting-started]

1. Installation

<CollapserGroup>
  <Collapser
    id="installation_native_instrumentation"
    title="If using only native instrumentation:"
  >

    If using only native OpenTelemetry frameworks, such as [Strawberry](https://strawberry.rocks/docs/extensions/opentelemetry), simply install `opentelemetry-api`.
  </Collapser>

  <Collapser
    id="installation_instrumentation_libraries"
    title="If using OpenTelemetry instrumentation libraries:"
  >

    If using [OpenTelemetry instrumentation libraries](https://github.com/open-telemetry/opentelemetry-python-contrib/tree/main/instrumentation#readme), install the `opentelemetry-distro` package and run the `opentelemetry-bootstrap` command to find and install any OpenTelemetry instrumentation libraries that the application might use.

    ```shell
    pip install opentelemetry-distro
    opentelemetry-bootstrap -a install
    ```

    <Callout variant="caution">
      For now, the following instrumentation frameworks are not supported by the Hybrid Agent:
      * boto
      * boto3sqs
      * botocore
      * aws-lambda
      * gRPC
      * AI/ML frameworks
    </Callout>

  </Collapser>
</CollapserGroup>

2. Enable OpenTelemetry setting

By default, the Hybrid Agent integration is disabled.  Enable this setting by setting [`opentelemetry.enabled` to `true`](#opentelemetry.enabled)

## Hybrid agent configuration settings [#configuration-settings]

<CollapserGroup>
  <Collapser
    id="opentelemetry.enabled"
    title="opentelemetry.enabled"
  >
    <table>
      <tbody>
        <tr>
          <th>
            Type:
          </th>

          <td>
            Boolean
          </td>
        </tr>

        <tr>
          <th>
            Default:
          </th>

          <td>
            False
          </td>
        </tr>

        <tr>
          <th>
            [Set in](/docs/apm/agents/python-agent/configuration/python-agent-configuration.mdx#options)
          </th>

          <td>
            Config file, environment variable
          </td>
        </tr>

        <tr>
          <th>
            [Environ variable](/docs/apm/agents/python-agent/configuration/python-agent-configuration.mdx#environment-variables)
          </th>

          <td>
            `NEW_RELIC_OPENTELEMETRY_ENABLED`
          </td>
        </tr>
      </tbody>
    </table>

    If enabled, any OpenTelemetry API and [OpenTelemetry instrumented framework](https://github.com/open-telemetry/opentelemetry-python-contrib/tree/main/instrumentation#readme) that is installed will be used.
  </Collapser>

  <Collapser
    id="opentelemetry.traces.enabled"
    title="opentelemetry.traces.enabled"
  >
    <table>
      <tbody>
        <tr>
          <th>
            Type:
          </th>

          <td>
            Boolean
          </td>
        </tr>

        <tr>
          <th>
            Default:
          </th>

          <td>
            True
          </td>
        </tr>

        <tr>
          <th>
            [Set in](/docs/apm/agents/python-agent/configuration/python-agent-configuration.mdx#options)
          </th>

          <td>
            Config file, environment variable
          </td>
        </tr>

        <tr>
          <th>
            [Environ variable](/docs/apm/agents/python-agent/configuration/python-agent-configuration.mdx#environment-variables)
          </th>

          <td>
            `NEW_RELIC_OPENTELEMETRY_TRACES_ENABLED`
          </td>
        </tr>
      </tbody>
    </table>

    If enabled, any OpenTelemetry span and trace APIs will be used.
  </Collapser>
</CollapserGroup>

## Supported OpenTelemetry instrumentation frameworks [#otel-instrumentation-libraries]

This [list of user contributed libraries](https://github.com/open-telemetry/opentelemetry-python-contrib/tree/main/instrumentation#readme) can be used with the Hybrid Agent to monitor OpenTelemetry instrumentation within New Relic. This includes libraries that are not officially supported by New Relic but are supported in OpenTelemetry.

<Callout variant="caution">
  For now, the following instrumentation frameworks are not supported by the Hybrid Agent:
  * boto
  * boto3sqs
  * botocore
  * aws-lambda
  * gRPC
  * AI/ML frameworks
</Callout>

## Custom OpenTelemetry API integration

In addition to the native OpenTelemetry instrumentation and OpenTelemetry instrumentation libraries, OpenTelemetry APIs can be used at the same time as New Relic APIs.

### Mix and Matching

```python
import newrelic.agent
from opentelemetry import trace

tracer = trace.get_tracer("example1")

@newrelic.agent.background_task(name="Foo")
def example_function():
  with tracer.start_as_current_span(name="Bar", kind=trace.SpanKind.INTERNAL):
    trace.get_current_span().set_attribute("spanNumber", 1)
    with newrelic.agent.FunctionTrace(name="Baz"):
      trace.get_current_span().set_attribute("spanNumber", 2)
```

<img
  title="Mix and Matching OTel and New Relic APIs"
  alt="mixandmatchTT.png"
  src="/static/images/apm_screenshot_python_mixandmatchTT.png"
/>

<figcaption>
  With a mix of New Relic and OpenTelemetry APIs, span hierarchies are preserved.
</figcaption>

### OpenTelemetry SpanEvents and SpanLink Events

```python
import newrelic.agent
from opentelemetry import trace

tracer = trace.get_tracer("example2")

@newrelic.agent.background_task(name="Bar")
def linked_function():
  with tracer.start_as_current_span("linking_span") as span:
    return span.get_span_context()

@newrelic.agent.background_task(name="Foo")
def example_function(linked_span_context):
  with tracer.start_as_current_span(
    "otelspan", links=[trace.Link(linked_span_context, attributes={"key1": "value1", "key2": 42})]
  ) as otel_span:
    otel_span.add_event("otelevent", attributes={"key": "value", "universe": 42})
    newrelic.agent.record_custom_event("newrelic_event", params={"key_nr": "value_nr"})

if __name__ == "__main__":
    linked_span_context = linked_function()
    example_function(linked_span_context)
```

From the transaction view in the UI, links to the SpanEvent and SpanLink events can be seen here:

<img
  title="SpanEvent and SpanLink Events Overview"
  alt="spanlinkview.png"
  src="/static/images/apm_screenshot_python_spanlinkview.png"
/>

<figcaption>
  Links to the SpanEvent and SpanLink events from the transaction view
</figcaption>

From the transaction "Foo", the linked span can be seen as a "Backward" span:

<img
  title="Backward View of SpanLink Event"
  alt="spanlinkbackward.png"
  src="/static/images/apm_screenshot_python_spanlinkbackward.png"
/>

<figcaption>
  The linked span from transaction "Foo"
</figcaption>

Similarly, from the transaction "Bar", the linked span can be seen as a "Forward" span:

<img
  title="Forward View of SpanLink Event"
  alt="spanlinkforward.png"
  src="/static/images/apm_screenshot_python_spanlinkforward.png"
/>

<figcaption>
  The linked span from transaction "Bar"
</figcaption>

The SpanEvent event from this example app can be seen here:

<img
  title="View of SpanEvent Event"
  alt="spaneventview.png"
  src="/static/images/apm_screenshot_python_spaneventview.png"
/>

<figcaption>
  The SpanEvent event from transaction "Foo"
</figcaption>

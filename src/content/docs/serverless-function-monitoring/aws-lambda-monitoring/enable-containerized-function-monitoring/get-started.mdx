---
title: "Get started with Lambda containerized functions"
metaDescription: Create Lambda containerized functions with New Relic
redirects:
freshnessValidatedDate: never
---

(INTRO)


<CollapserGroup>
 <Collapser
   id="node-16"
   title="Create a Lambda containerized function with the Node.js 16.x agent"
 >
<Steps>
<Step>
### Install python 

Run the following in your local system

```
brew install python@3.9
```

</Step>
<Step>
## Create an IAM role 

After you've installed python, you must create an IAM role that  grants the following IAM permissions in your AWS account:

* Resource: "*"
    * Action:
        * "cloudwatch:GetMetricStatistics"
        * "cloudwatch:ListMetrics"
        * "cloudwatch:GetMetricData"
        * "lambda:GetAccountSettings"
        * "lambda:ListFunctions"
        * "lambda:ListAliases"
        * "lambda:ListTags"
        * "lambda:ListEventSourceMappings"

</Step>
<Step>
### Install the AWS CLI 

First you must run, 

```
python3 -m pip install awscli
aws configure
AWS Access Key ID: <MYACCESSKEY>
AWS Secret Access Key: <MYSECRETKEY>
Default region name [us-east-1]: 
Default output format [None]: 
```

Then:

```
python3 -m pip install awscli
aws configure
AWS Access Key ID: <MYACCESSKEY>
AWS Secret Access Key: <MYSECRETKEY>
Default region name [us-east-1]: 
Default output format [None]: 
```

You can read more about AWS CLI and how to install it [here](https://github.com/aws/aws-cli#getting-started).

</Step>
<Step>
## Install New Relic's Lambda CLI

First run:

```
pip3 install newrelic-lambda-cli
```

Then run:

```
    newrelic-lambda integrations install \
    --nr-account-id <account id> \
    --nr-api-key <api key> --nr-region staging
```

For more information please see our [New Relic Lambda documentation](https://github.com/newrelic/newrelic-lambda-cli#installation)
</Step>
<Step>
## Install the Lambda serverless framework

Run the following script: 

```
npm install -g serverless

```
</Step>
<Step>
### Install the New Relic serverless framework

Run the following script: 

```
npm install --save-dev serverless-newrelic-lambda-layers
```
Then run:

```
npm add --dev serverless-newrelic-lambda-layers

```
</Step>
<Step>
## Add the plugin to your serverless.yml 

You can choose any of the example code in the serverless-newrelic-lambda-layers repository. Once you've selected the code,  edit `serverless.yml` file and add the plugin and details below.

```
plugins: 
- serverless-newrelic-lambda-layers
```
You can set name using the service name function in `serverless.yml` file.

```
service: <funcion name>
```

The following is an example:

```
custom:
  newRelic:
    accountId: <accountId>
    apiKey: <apiKey>
    enableIntegration: true
       	    enableFunctionLogs: true
    enableExtension: true
    logLevel: debug
    linkedAccount: New Relic Lambda Integration - <accountId>
```
</Step>
<Step>
## Deploy 

Run the following script:

```
sls deploy
```

After you've successfully deployed the containarized function you can test the function using the following command:  

```
newrelic-lambda functions list

```
</Step>
<Step>
## Add New Relic layers
Now that you've successfully deployed, you're ready to create layers and add subscriptions. You can do this by running the following commands:

```
newrelic-lambda layers install --nr-account-id <accountId> --function <function name>
```
And:

```
newrelic-lambda subscriptions install --function <funcion name>
```
</Step>
</Steps>

New Relic for Node.js automatically instruments most standard web requests, but sometimes you will want expanded instrumentation. With the agent's custom instrumentation API, you can create instrumentation for otherwise unsupported web frameworks, datastores, and message service clients.
</Collapser>
</CollapserGroup>

<CollapserGroup>
 <Collapser
   id="node-18"
   title="Create a Lambda containerized function with the Node.js 18.x agent"
 >
## Before you begin

To  create a Lambda containarized function using the Node18.x agent you will need the following:

* [AWS Command Line Interface (AWS CLI) version 2] (https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
* [Docker ](https://docs.docker.com/get-docker/)
* Node.js

<Steps>
<Step>
## Create a project directory 

```
mkdir example_node
cd example_node
npm init
vi index.js and add the following code.
exports.handler = async (event) => {
    const response = {
        statusCode: 200,
        body: JSON.stringify('Hello from Lambda!'),
    };
    return response;
};
```
Then you will need to create a new Docker file with the following configuration:

```
FROM public.ecr.aws/lambda/nodejs:18
# Copy function code COPY index.js
${LAMBDA_TASK_ROOT} 
# Set the CMD to your handler (could also be done as a parameter override outside of the Dockerfile) 
CMD [ "index.handler" ]

```
Next build the Docker image with the docker build.

```
docker build --platform linux/amd64 -t docker-image:test 
```
</Step>
<Step>
## Test the image locally (optional)

First, start the Docker image with the docker run command:

```
docker run -p 9000:8080 docker-image:test
```
Next, from a new terminal window, post an event to the following endpoint using a curl command:

```
curl "http://localhost:9000/2015-03-31/functions/function/invocations" -d '{}'
```

Now, get the container ID.

```
docker ps
```
Now, use the docker kill command to stop the container. When you use this command, replace 3766c4ab331c with the container ID from the previous step.

```
docker kill 3766c4ab331c
```
</Step>

<Step>
## Deploy the image

In order to upload the image to Amazon ECR and create the Lambda function you will need to complete the following.  

1. First, run the `get-login-password` command to authenticate the Docker CLI to your Amazon ECR registry.
2. Set the `--region` value to the AWS Region where you want to create the Amazon ECR repository.
3. Replace 111122223333 with your AWS account ID.
```
    aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 111122223333.dkr.ecr.us-east-1.amazonaws.com
```
4. Create a repository in Amazon ECR using the create-repository command.
```
aws ecr create-repository --repository-name hello-world --image-scanning-configuration scanOnPush=true --image-tag-mutability MUTABLE
```
5. Copy the `repositoryUri` from the output in the previous step.
6. Run the [docker tag](https://docs.docker.com/reference/cli/docker/image/tag/) command to tag your local image into your Amazon ECR repository as the latest version. In this command, replace `docker-image:test` with the name and tag of your Docker image. Then replace &lt; ECRrepositoryUri &gt; with the `repositoryUri` that you copied. Make sure to include `:latest` at the end of the URI.

```
docker tag docker-image:test <ECRrepositoryUri> :latest
EX: docker tag docker-image:test 111122223333.dkr.ecr.us-east-1.amazonaws.com/hello-world:latest
```
7. Now, run the docker push command to deploy your local image to the Amazon ECR repository. Make sure to include `:latest` at the end of the repository URI.
```
docker push 111122223333.dkr.ecr.us-east-1.amazonaws.com/hello-world:latest
```
</Step>
<Step>
## Create a Lambda containerized function

Now you're ready to create a Lambda containerized function. 

To do this you'll need to first create an execution role for the function, if you don't already have one. If you're not sure how to do this please refer to the [AWS documentation](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-awscli.html#with-userapp-walkthrough-custom-events-create-iam-role). For the next step, you will need the Amazon Resource Name, or ARN, of the role. 

Now, you are ready to create the Lambda function. When you're completing the following command, you must specific the repostiry URI from earlier for the `Image` and `ImageUri` fields. Make sure to include `:latest` at the end of the URI.

```
aws lambda create-function \ --function-name hello-world \ --package-type Image \ --code ImageUri=111122223333.dkr.ecr.us-east-1.amazonaws.com/hello-world:latest \ --role arn:aws:iam::111122223333:role/lambda-ex
```
Next, you have to invoke the function:

```
aws lambda invoke --function-name hello-world response.json
```

If you have any questions see [AWS's documentation for deploying Lambda functions with container images](https://docs.aws.amazon.com/lambda/latest/dg/nodejs-image.html).
</Step>

<Step>
## Add a New Relic Lambda layer as an image

Now you're ready for the final step and can create a New Relic Lambda layer as an image.

1. First, you can see which ARN layers are available [here](https://layers.newrelic-external.com/#/get-layers/get).
2. To create new docker image, use the following code:

```
FROM alpine:latest as layer-copy 
# Create a build stage to copy the files from S3 using credentials ARG AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-"region"} 
ARG AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-"accessKey"} 
ARG AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-"secretkey"} ENV AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} 
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} 
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} 
RUN apk add aws-cli curl unzip 
RUN mkdir -p /opt 
RUN curl $(aws lambda get-layer-version-by-arn --arn <your ARN Link> --query 'Content.Location' --output text) --output layer.zip 
RUN unzip layer.zip -d /opt 
RUN rm layer.zip 
FROM scratch 
# Start second stage from blank image to squash all previous history, including credentials. 
WORKDIR /opt 
COPY --from=layer-copy /opt .
```
3. Now, push that image to Amazon ECR.

```
docker build -t layer-image1:latest .
```
4. Deploy the image.
5. Once you created & deployed the image in ECR,  then you can use that image with the URI in your actual Dockerfile. Here is an example:

```

FROM <image uri> AS layer
FROM public.ecr.aws/lambda/python:3.11

# Layer code
WORKDIR /opt
COPY --from=layer /opt/ .

# Copy requirements.txt
COPY requirements.txt ${LAMBDA_TASK_ROOT}

# Copy function code
COPY lambda_function.py ${LAMBDA_TASK_ROOT}

# Install the specified packages
RUN pip freeze > requirements.txt

# Set the CMD to your handler (could also be done as a parameter override outside of the Dockerfile)
CMD [ "lambda_function.handler" ]

```
5. You can also create a docker image with code shown above and push that image to Amazon ECR.

```
docker build -t docker-image1:latest 
```
6. Deploy the image.
</Step>
</Steps>
</Collapser>
</CollapserGroup>









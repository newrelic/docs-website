---
title: Configure span filtering for APM agents
tags:
  - Understand dependencies
  - Distributed tracing
  - Span configuration
  - APM agents
metaDescription: Configure APM agents to filter spans and reduce trace data volume by 50-85% while preserving service connectivity.
freshnessValidatedDate: never
---

APM agents can filter which spans get sent to New Relic, reducing your distributed tracing data volume by 50-85%. You control which span types are captured—removing in-process spans, reducing attributes, and compressing duplicates—while maintaining complete service-to-service visibility.

## Before you begin [#before-you-begin]

Make sure you have:

* **APM agent monitoring:** This only works with New Relic APM agents (Java, .NET, Node.js, Python, Go, Ruby, PHP)—not OpenTelemetry
* [Distributed tracing enabled](/docs/distributed-tracing/concepts/quick-start) on your services
* Agent versions that support span filtering (see [requirements](#requirements) below)
* Permission to modify agent configuration files (YAML) or set environment variables
* A plan for which services to configure (we recommend starting with non-critical services)

<Callout variant="tip">
  Test span filtering on a development or staging environment first to understand the impact before applying to production.
</Callout>

## How span types work [#span-types]

To understand partial granularity tracing, you need to know about the three types of spans in distributed tracing:

### Entry spans

The first span in a service's part of the trace. This represents the incoming request to your service.

**Example:** An HTTP request arriving at your API service.

### Exit spans

Spans that represent calls from your service to downstream services or external resources.

**Examples:**
* HTTP calls to other microservices
* Database queries
* Cache operations
* External API calls

### In-process spans

Spans that represent internal method calls within your service. These show the detailed execution path inside your code.

**Examples:**
* Individual function calls
* Internal service layers
* Business logic methods

## Span filtering configuration options [#span-filter-options]

APM agents provide three configuration levels to reduce span data:

<table>
  <thead>
    <tr>
      <th width={150}>
        Configuration
      </th>
      <th>
        What gets captured
      </th>
      <th>
        Typical span reduction
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        **Full granularity** (default)
      </td>
      <td>
        Entry spans + exit spans + in-process spans
      </td>
      <td>
        0% (baseline)
      </td>
    </tr>

    <tr>
      <td>
        **Reduced granularity**
      </td>
      <td>
        Entry spans + exit spans (including AI spans)
        (removes in-process spans)
      </td>
      <td>
        50-80%
      </td>
    </tr>

    <tr>
      <td>
        **Essential granularity**
      </td>
      <td>
        Entry spans + exit spans with reduced attributes
        (reduced + removes most attributes)
      </td>
      <td>
        60-75%
      </td>
    </tr>

    <tr>
      <td>
        **Compact granularity**
      </td>
      <td>
        Entry spans + unique exit spans with reduced attributes
        (essential + compresses duplicate calls to same URLs/databases)
      </td>
      <td>
        70-85%
      </td>
    </tr>
  </tbody>
</table>

These options are sequential—essential granularity includes all of reduced granularity's reductions plus attribute reduction, and compact granularity includes both previous options plus duplicate span compression. Compact granularity's compression means if your service makes multiple identical calls to the same downstream service URL or database, only the first call gets reported as a span, preserving the service-to-service relationship while reducing redundant data.

## Requirements [#requirements]

Minimum agent versions for span filtering:

<table>
  <thead>
    <tr>
      <th width={200}>
        Agent
      </th>
      <th>
        Minimum version
      </th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>
        Java
      </td>
      <td>
        TBD (check with Engineering)
      </td>
    </tr>

    <tr>
      <td>
        .NET
      </td>
      <td>
        TBD (check with Engineering)
      </td>
    </tr>

    <tr>
      <td>
        Node.js
      </td>
      <td>
        TBD (check with Engineering)
      </td>
    </tr>

    <tr>
      <td>
        Python
      </td>
      <td>
        TBD (check with Engineering)
      </td>
    </tr>

    <tr>
      <td>
        Go
      </td>
      <td>
        TBD (check with Engineering)
      </td>
    </tr>

    <tr>
      <td>
        Ruby
      </td>
      <td>
        TBD (check with Engineering)
      </td>
    </tr>

    <tr>
      <td>
        PHP
      </td>
      <td>
        TBD (check with Engineering)
      </td>
    </tr>
  </tbody>
</table>

## Configure span filtering [#configure]

Choose your agent language to see configuration instructions:

<CollapserGroup>
  <Collapser
    id="java"
    title="Java agent"
  >
    To configure span filtering for your Java application, add the `span_events.span_type_filter` setting to your `newrelic.yml` configuration file.

    **Configuration file approach:**

    1. Open your `newrelic.yml` file (typically in your application's root directory).
    2. Under the `distributed_tracing` section, add the `span_events` configuration:

    ```yml
    distributed_tracing:
      enabled: true
      span_events:
        span_type_filter: minimal  # Options: all, entry_exit, minimal
    ```

    3. Save the file and restart your Java application.

    **Environment variable approach:**

    Set the environment variable before starting your application:

    ```bash
    export NEW_RELIC_DISTRIBUTED_TRACING_SPAN_EVENTS_SPAN_TYPE_FILTER=minimal
    ```

    **Configuration values:**
    * `all`: Capture all span types (default—full granularity)
    * `entry_exit`: Reduced granularity—Capture entry and exit spans only (removes in-process spans)
    * `minimal`: Compact granularity—Capture entry spans and unique exit spans (includes reduced granularity + compresses duplicates)

  </Collapser>

  <Collapser
    id="dotnet"
    title=".NET agent"
  >
    To configure span filtering for your .NET application, add the `spanTypeFilter` attribute to your `newrelic.config` file.

    **Configuration file approach:**

    1. Open your `newrelic.config` file.
    2. Add the `spanTypeFilter` attribute to the `distributedTracing` element:

    ```xml
    <configuration>
      <distributedTracing enabled="true">
        <spanEvents spanTypeFilter="minimal" />
      </distributedTracing>
    </configuration>
    ```

    3. Save the file and restart your .NET application or IIS.

    **Environment variable approach:**

    ```bash
    set NEW_RELIC_DISTRIBUTED_TRACING_SPAN_EVENTS_SPAN_TYPE_FILTER=minimal
    ```

    **Configuration values:**
    * `all`: Capture all span types (default—full granularity)
    * `entry_exit`: Reduced granularity—Capture entry and exit spans only (removes in-process spans)
    * `minimal`: Compact granularity—Capture entry spans and unique exit spans (includes reduced granularity + compresses duplicates)

  </Collapser>

  <Collapser
    id="nodejs"
    title="Node.js agent"
  >
    To configure span filtering for your Node.js application, add the `span_type_filter` setting to your `newrelic.js` configuration file.

    **Configuration file approach:**

    1. Open your `newrelic.js` file.
    2. Add the `span_events` configuration under `distributed_tracing`:

    ```js
    'use strict'

    exports.config = {
      distributed_tracing: {
        enabled: true
      },
      span_events: {
        span_type_filter: 'minimal' // Options: 'all', 'entry_exit', 'minimal'
      }
    }
    ```

    3. Save the file and restart your Node.js application.

    **Environment variable approach:**

    ```bash
    export NEW_RELIC_DISTRIBUTED_TRACING_SPAN_EVENTS_SPAN_TYPE_FILTER=minimal
    ```

    **Configuration values:**
    * `all`: Capture all span types (default—full granularity)
    * `entry_exit`: Reduced granularity—Capture entry and exit spans only (removes in-process spans)
    * `minimal`: Compact granularity—Capture entry spans and unique exit spans (includes reduced granularity + compresses duplicates)

  </Collapser>

  <Collapser
    id="python"
    title="Python agent"
  >
    To configure span filtering for your Python application, add the `span_events.span_type_filter` setting to your `newrelic.ini` file.

    **Configuration file approach:**

    1. Open your `newrelic.ini` file.
    2. Add the setting under the `[newrelic]` section:

    ```ini
    [newrelic]
    distributed_tracing.enabled = true
    span_events.span_type_filter = minimal
    ```

    3. Save the file and restart your Python application.

    **Environment variable approach:**

    ```bash
    export NEW_RELIC_DISTRIBUTED_TRACING_SPAN_EVENTS_SPAN_TYPE_FILTER=minimal
    ```

    **Configuration values:**
    * `all`: Capture all span types (default—full granularity)
    * `entry_exit`: Reduced granularity—Capture entry and exit spans only (removes in-process spans)
    * `minimal`: Compact granularity—Capture entry spans and unique exit spans (includes reduced granularity + compresses duplicates)

  </Collapser>

  <Collapser
    id="go"
    title="Go agent"
  >
    To configure span filtering for your Go application, set the configuration when initializing the New Relic application.

    **Code-based configuration:**

    ```go
    app, err := newrelic.NewApplication(
        newrelic.ConfigAppName("Your Application Name"),
        newrelic.ConfigLicense("YOUR_LICENSE_KEY"),
        newrelic.ConfigDistributedTracerEnabled(true),
        func(cfg *newrelic.Config) {
            cfg.SpanEvents.SpanTypeFilter = "minimal" // Options: "all", "entry_exit", "minimal"
        },
    )
    ```

    **Environment variable approach:**

    ```bash
    export NEW_RELIC_DISTRIBUTED_TRACING_SPAN_EVENTS_SPAN_TYPE_FILTER=minimal
    ```

    **Configuration values:**
    * `all`: Capture all span types (default—full granularity)
    * `entry_exit`: Reduced granularity—Capture entry and exit spans only (removes in-process spans)
    * `minimal`: Compact granularity—Capture entry spans and unique exit spans (includes reduced granularity + compresses duplicates)

  </Collapser>

  <Collapser
    id="ruby"
    title="Ruby agent"
  >
    To configure span filtering for your Ruby application, add the `span_events.span_type_filter` setting to your `newrelic.yml` file.

    **Configuration file approach:**

    1. Open your `newrelic.yml` file.
    2. Add the setting under the `common` section:

    ```yml
    common: &default_settings
      distributed_tracing:
        enabled: true
      span_events:
        span_type_filter: minimal  # Options: all, entry_exit, minimal
    ```

    3. Save the file and restart your Ruby application.

    **Environment variable approach:**

    ```bash
    export NEW_RELIC_DISTRIBUTED_TRACING_SPAN_EVENTS_SPAN_TYPE_FILTER=minimal
    ```

    **Configuration values:**
    * `all`: Capture all span types (default—full granularity)
    * `entry_exit`: Reduced granularity—Capture entry and exit spans only (removes in-process spans)
    * `minimal`: Compact granularity—Capture entry spans and unique exit spans (includes reduced granularity + compresses duplicates)

  </Collapser>

  <Collapser
    id="php"
    title="PHP agent"
  >
    To configure span filtering for your PHP application, add the setting to your `newrelic.ini` file or use `ini_set()` in your code.

    **Configuration file approach:**

    1. Open your `newrelic.ini` file.
    2. Add the setting:

    ```ini
    newrelic.distributed_tracing.enabled = true
    newrelic.span_events.span_type_filter = "minimal"
    ```

    3. Save the file and restart your web server.

    **Runtime configuration:**

    ```php
    ini_set('newrelic.span_events.span_type_filter', 'minimal');
    ```

    **Configuration values:**
    * `all`: Capture all span types (default—full granularity)
    * `entry_exit`: Reduced granularity—Capture entry and exit spans only (removes in-process spans)
    * `minimal`: Compact granularity—Capture entry spans and unique exit spans (includes reduced granularity + compresses duplicates)

  </Collapser>
</CollapserGroup>

## Verify span filtering is working [#verify]

After configuring span filtering, verify it's working correctly:

### Check span counts

Run this NRQL query to see if span volume has decreased:

```sql
SELECT count(*)
FROM Span
WHERE entity.name = 'YOUR_SERVICE_NAME'
SINCE 1 day ago
COMPARE WITH 1 day ago
```

You should see a reduction of 40-70% depending on your configuration.

### Verify span types

Check which span types are being captured:

```sql
SELECT count(*),
       filter(count(*), WHERE span.kind = 'server') as 'Entry Spans',
       filter(count(*), WHERE span.kind = 'client') as 'Exit Spans',
       filter(count(*), WHERE span.kind = 'internal') as 'In-Process Spans'
FROM Span
WHERE entity.name = 'YOUR_SERVICE_NAME'
SINCE 30 minutes ago
```

* **Reduced granularity config:** You should see entry and exit spans, but in-process spans should be 0
* **Compact granularity config:** You should see entry spans and reduced exit spans

### Check trace completeness

Ensure your traces still show complete service-to-service flows:

1. Go to **[one.newrelic.com > All capabilities](https://one.newrelic.com/all-capabilities) > APM & services > Distributed tracing**.
2. Select a recent trace that includes your service with span filtering configured.
3. Verify you can still see:
   * All services in the request path
   * Service-to-service connections
   * Request flow from start to finish

## Troubleshoot issues [#troubleshoot]

### Configuration not taking effect

**Problem:** You configured span filtering but span counts haven't changed.

**Solutions:**

1. Verify you restarted your application after configuration changes.
2. Check agent logs for configuration errors:
   ```bash
   grep -i "span_type_filter\|minimal\|entry_exit" /path/to/agent.log
   ```
3. Confirm your agent version supports span filtering (see [requirements](#requirements)).
4. Validate configuration syntax matches your agent's format exactly.

### Traces appear incomplete

**Problem:** Traces show gaps or missing services after enabling span filtering.

**Solutions:**

1. Span filtering only affects span volume, not trace context propagation. If traces are incomplete, check:
   * Distributed tracing is enabled on all services
   * Trace context headers are propagating correctly
   * No proxies or middleware are stripping headers

2. Verify the "missing" services aren't filtered out by [trace sampling](/docs/distributed-tracing/concepts/how-new-relic-distributed-tracing-works/#sampling).

### Can't see service-to-service calls

**Problem:** After enabling compact granularity, you can't see calls between specific services.

**Solutions:**

1. Check if the downstream service is instrumented with distributed tracing.
2. Verify exit spans are being captured (query for `span.kind = 'client'`).
3. If using compact granularity, unique exit spans should still appear—duplicate calls to the same service are compressed but the first call is captured.

<Callout variant="important">
  If you need more detailed troubleshooting help, see [Troubleshoot missing trace data](/docs/distributed-tracing/troubleshooting/missing-trace-data) or contact [New Relic Support](https://support.newrelic.com).
</Callout>

## What's next [#whats-next]

Now that you've configured span filtering, consider these next steps:

* [Configure attribute reduction](/docs/distributed-tracing/core-tracing/configure-low-granularity-tracing) to reduce span attributes for additional cost savings (essential and compact granularity)
* [Optimize your configuration strategy](/docs/distributed-tracing/core-tracing/cost-optimization-strategies) with a service prioritization framework
* Review the main [distributed tracing introduction](/docs/distributed-tracing/concepts/introduction-distributed-tracing) to understand how these configurations fit into your overall observability strategy

<Callout variant="important">
  Remember: If your team relies on specific custom attributes or traced functions, verify these dependencies before enabling partial granularity options.
</Callout>

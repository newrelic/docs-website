---
headingText: Build your Helm values file
componentType: default
---

Populate a values file that configures the OpenTelemetry Collector deployment and the receiver creator that scrapes your NGINX pods.

1. Choose identifiers for your cluster and NGINX pod labels. Example values:
   - Cluster name: `nginx-cluster`
   - `labels["app"]`: `nginx`
   - `labels["role"]`: `reverse-proxy`
2. Create `otel-collector-values.yaml` with content similar to the following. Update the placeholders for your cluster, labels, and stub status endpoint if they differ.

```yaml
opentelemetry-collector:
  mode: deployment

  image:
    repository: otel/opentelemetry-collector-contrib
    pullPolicy: IfNotPresent

  command:
    name: otelcol-contrib

  resources:
    limits:
      cpu: 500m
      memory: 300Mi
    requests:
      cpu: 100m
      memory: 100Mi

  extraEnvs:
    - name: NEWRELIC_LICENSE_KEY
      valueFrom:
        secretKeyRef:
          name: newrelic-licenses
          key: NEWRELIC_LICENSE_KEY
    - name: NEWRELIC_OTLP_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: newrelic-licenses
          key: NEWRELIC_OTLP_ENDPOINT
    - name: K8S_NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: K8S_CLUSTER_NAME
      value: nginx-cluster

  clusterRole:
    create: true
    rules:
      - apiGroups: [""]
        resources: ["pods", "nodes", "nodes/stats", "nodes/proxy"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["apps"]
        resources: ["replicasets"]
        verbs: ["get", "list", "watch"]
    clusterRoleBinding:
      name: ""

  config:
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      k8s_observer:
        auth_type: serviceAccount
        observe_pods: true
        observe_nodes: true

    receivers:
      receiver_creator/nginx:
        watch_observers: [k8s_observer]
        receivers:
          nginx:
            rule: type == "pod" && labels["app"] == "nginx" && labels["role"] == "reverse-proxy"
            config:
              endpoint: 'http://`endpoint`:8080/status'
              metrics:
                nginx.requests:
                  enabled: true
                nginx.connections_accepted:
                  enabled: true
                nginx.connections_handled:
                  enabled: true
                nginx.connections_current:
                  enabled: true
              collection_interval: 30s
            resource_attributes:
              nginx.server.endpoint: 'http://`endpoint`:8080/status'
              nginx.port: '8080'

    processors:
      batch:
        send_batch_size: 1024
        timeout: 30s

      resource/cluster:
        attributes:
          - key: k8s.cluster.name
            value: "nginx-cluster"
            action: insert

      transform/nginx:
        metric_statements:
          - context: resource
            statements:
              - set(attributes["nginx.display.name"], Concat([
                  "server",
                  "k8s",
                  attributes["k8s.cluster.name"],
                  attributes["k8s.namespace.name"],
                  "pod",
                  attributes["k8s.pod.name"],
                  "nginx",
                  attributes["nginx.port"]
                ], ":"))
              - set(attributes["nginx.deployment.name"], attributes["k8s.pod.name"])

    exporters:
      otlphttp:
        endpoint: "${NEWRELIC_OTLP_ENDPOINT}"
        headers:
          api-key: "${NEWRELIC_LICENSE_KEY}"
      debug:
        verbosity: detailed

    service:
      telemetry:
        logs:
          level: debug
      extensions: [health_check, k8s_observer]
      pipelines:
        metrics/nginx:
          receivers: [receiver_creator/nginx]
          processors: [batch, resource/cluster, transform/nginx]
          exporters: [otlphttp, debug]
```

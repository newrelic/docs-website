---
headingText: Enable query-level monitoring
componentType: default
---

You can view query-level analysis to monitor your SQL queries within your Microsoft SQL database to assess their performance and impact. This feature provides insights into execution times, resource consumption, and potential bottlenecks, enabling you to optimize database operations. For more information, refer to [Query-Level Analysis](/docs/infrastructure/infrastructure-data/query-level-monitoring).

<CollapserGroup>

    <Collapser
        id="host"
        title="For on-host Microsoft SQL databases and Azure SQL VMs"
    >

    1. Enable the login on the SQL Server and Windows Authentication mode. For more information, refer [Microsoft change authentication mode documentation](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/change-server-authentication-mode?view=sql-server-ver16&tabs=ssms).
    2. To Enable TCP:
        1. Ensure TCP is enabled for remote access on your instance using the [documentation](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/configure-a-server-to-listen-on-a-specific-tcp-port?view=sql-server-ver16)
        2. Check firewall settings to ensure that your firewall allows traffic on port `1433`. This is the listening port for Microsoft SQL Server:
            - Open **Windows Defender Firewall with Advanced Security**.
            - In the left menu, click **Inbound Rules.**
            - Find any rule for SQL Server (typically named SQL Server (TCP-In) or SQL Server TCP 1433).
            - If a rule doesn't exist, create a new rule to allow TCP traffic on port 1433.
    3. Enable the query store by running the following SQL command:
        ```sql
            ALTER DATABASE DATABASE_NAME SET QUERY_STORE = ON ( QUERY_CAPTURE_MODE = ALL, DATA_FLUSH_INTERVAL_SECONDS = 900 )
        ```
    4. Validate that the query store is enabled by running the following SQL command:
        ```sql
            SELECT is_query_store_on FROM sys.databases where physical_database_name = DATABASE_NAME
        ```

        If the output is `1`, the query store is enabled.
    5. To change the directory to the integration configuration folder, run:
        ```bash
            cd "C:\Program Files\New Relic\newrelic-infra\integrations.d\"
        ``` 
    6. Edit the [`mssql-config.yml`](#basic-config) file for query-level monitoring:
        <table>
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>`ENABLE_QUERY_MONITORING`</td>
                    <td>Enable query performance monitoring. The default value is set to `false`.</td>
                </tr>
                <tr>
                    <td>`QUERY_MONITORING_RESPONSE_TIME_THRESHOLD`</td>
                    <td>Set the threshold for query response time in ms to retrieve individual query performance metrics. The Default value is set to `500 ms`.</td>
                </tr>
                <tr>
                    <td>`QUERY_MONITORING_COUNT_THRESHOLD`</td>
                    <td>The number of records for each query performance metrics. The Default value is set to `20`.</td>
                </tr>
            </tbody>
        </table>


    </Collapser>

    <Collapser
        id="azure"
        title="For Azure SQL managed instances"
    >

    1. To Enable TCP:
        1. Ensure TCP is enabled for remote access on your instance using the [documentation](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/configure-a-server-to-listen-on-a-specific-tcp-port?view=sql-server-ver16)
        2. Check firewall settings to ensure that your firewall allows traffic on port `1433`. This is the listening port for Microsoft SQL Server:
            - Open **Windows Defender Firewall with Advanced Security**.
            - In the left menu, click **Inbound Rules.**
            - Find any rule for SQL Server (typically named SQL Server (TCP-In) or SQL Server TCP 1433).
            - If a rule doesn't exist, create a new rule to allow TCP traffic on port 1433.
    2. Enable the query store by running the following SQL command:
        ```sql
            ALTER DATABASE DATABASE_NAME SET QUERY_STORE = ON ( QUERY_CAPTURE_MODE = ALL, DATA_FLUSH_INTERVAL_SECONDS = 900 )
        ```
    3. Validate that the query store is enabled by running the following SQL command:
        ```sql
            SELECT is_query_store_on FROM sys.databases where name = DATABASE_NAME
        ```

        If the output is `1`, the query store is enabled.
    4. To change the directory to the integration configuration folder, run:
        ```bash
            cd "C:\Program Files\New Relic\newrelic-infra\integrations.d\"
        ``` 
    5. Edit the [`mssql-config.yml`](#basic-config) file for query-level monitoring:
        <table>
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>`ENABLE_QUERY_MONITORING`</td>
                    <td>Enable query performance monitoring. The default value is set to `false`.</td>
                </tr>
                <tr>
                    <td>`QUERY_MONITORING_RESPONSE_TIME_THRESHOLD`</td>
                    <td>Set the threshold for query response time in ms to retrieve individual query performance metrics. The Default value is set to `500 ms`.</td>
                </tr>
                <tr>
                    <td>`QUERY_MONITORING_COUNT_THRESHOLD`</td>
                    <td>The number of records for each query performance metrics. The Default value is set to `20`.</td>
                </tr>
            </tbody>
        </table>

    </Collapser>

</CollapserGroup>
